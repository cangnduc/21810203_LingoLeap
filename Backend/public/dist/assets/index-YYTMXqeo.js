import{j as w,r as p,o as su,W as Ei,Y as cp,R as q,Z as lp,_ as Do,$ as up,a0 as dp,U as hp,M as fp,d as pp,u as mp,a1 as gp,a2 as vp,a3 as bp,a4 as yp,B as Nt,a5 as $a,a6 as kp}from"./index-DVmOQZrp.js";import{s as Sp}from"./Samples-DUG5vYRn.js";const Cp=({title:t,description:e})=>w.jsxs("div",{className:"mb-6",children:[w.jsx("h1",{className:"text-2xl font-bold mb-2",children:t}),e&&w.jsx("p",{className:"text-gray-600",children:e})]}),Tp=({sections:t})=>{const[e,n]=p.useState(!1),i=su(),r=o=>{const a=Sp.find(c=>c.name===o);return a==null?void 0:a.icon},s=(o,a)=>{o.preventDefault();const c=document.getElementById(`section-${a}`);c&&(c.scrollIntoView({behavior:"smooth"}),n(!1))};return w.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 transition-colors",children:[w.jsx("button",{onClick:()=>i(Ei(!0)),children:"Clear answers"}),w.jsxs("div",{className:"flex justify-between items-center lg:hidden mb-2",children:[w.jsx("h2",{className:"text-lg font-semibold dark:text-gray-200",children:"Test Information"}),w.jsx("button",{onClick:()=>n(!e),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e?w.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"▼"}):w.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"▶"})})]}),w.jsx("h2",{className:"text-lg font-semibold mb-4 dark:text-gray-200 hidden lg:block",children:"Test Sections"}),w.jsx("nav",{className:`${e?"block":"hidden"} lg:block`,children:t==null?void 0:t.map(o=>{var a,c;return w.jsxs("a",{href:`#section-${o._id}`,onClick:l=>s(l,o._id),className:`flex items-center p-2 hover:bg-gray-100 \r
                     dark:hover:bg-gray-700 rounded transition-colors\r
                     mb-1 gap-4 last:mb-0`,children:[w.jsx("span",{className:"mr-2 dark:text-gray-400 text-2xl",children:r(o.name)}),w.jsxs("div",{className:"flex-1",children:[w.jsx("div",{className:"font-medium capitalize dark:text-gray-200",children:o.name}),w.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:o.name==="reading"||o.name==="listening"?`${((a=o.passages)==null?void 0:a.length)||0} passages / ${(o.passages||[]).reduce((l,u)=>{var d,h;return l+(((h=(d=u._id)==null?void 0:d.questions)==null?void 0:h.length)||0)},0)} questions`:`${((c=o.questions)==null?void 0:c.length)||0} questions`})]})]},o._id)})})]})},Ep=({passage:t,index:e})=>{var r;const i=(s=>s?`${cp}/uploads/audio/${s}`:"")(t==null?void 0:t.soundFile);return w.jsxs("div",{className:`mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow \r
                    transition-colors`,children:[w.jsxs("h3",{className:"text-xl font-semibold mb-3 dark:text-gray-200",children:["No. ",e+1,": ",t==null?void 0:t.title]}),(t==null?void 0:t.passageType)==="listening"&&(t==null?void 0:t.soundFile)&&w.jsx("div",{className:"mb-4",children:w.jsxs("audio",{controls:!0,className:"w-full dark:bg-gray-700",children:[w.jsx("source",{src:i,type:"audio/mpeg"}),"Your browser does not support the audio element."]})}),w.jsx("div",{className:"prose dark:prose-invert max-w-none",children:(r=t==null?void 0:t.text)==null?void 0:r.split(`
`).map((s,o)=>w.jsx("p",{className:"mb-4 dark:text-gray-300",children:s},o))})]})},wp=({question:t,onAnswerChange:e,currentAnswer:n})=>{const i=n||[];return w.jsxs("div",{className:"mb-6",children:[w.jsx("h3",{className:"font-medium mb-2",children:t.questionText}),t.instruction&&w.jsx("p",{className:"text-gray-600 mb-2",children:t.instruction}),w.jsx("div",{className:"space-y-2",children:t.answers.map((r,s)=>w.jsxs("label",{className:"flex items-center space-x-2",children:[w.jsx("input",{type:"checkbox",checked:i.includes(r),onChange:o=>{const a=o.target.checked?[...i,r]:i.filter(c=>c!==r);e(a)},className:"form-checkbox"}),w.jsx("span",{children:r})]},s))})]})},Pp=({question:t,onAnswerChange:e,currentAnswer:n})=>{const i=n||null,[r,s]=p.useState([]);return p.useEffect(()=>{s((a=>{const c=[...a];for(let l=c.length-1;l>0;l--){const u=Math.floor(Math.random()*(l+1));[c[l],c[u]]=[c[u],c[l]]}return c})(t.answers))},[t.answers]),w.jsxs("div",{className:"mb-6",children:[w.jsx("h3",{className:"font-medium mb-2",children:t.questionText}),t.instruction&&w.jsx("p",{className:"text-gray-600 mb-2",children:t.instruction}),w.jsx("div",{className:"space-y-2",children:r.map((o,a)=>w.jsxs("label",{className:"flex items-center space-x-2",children:[w.jsx("input",{type:"radio",name:t._id,checked:i===o,onChange:()=>e(o),className:"form-radio"}),w.jsx("span",{children:o})]},a))})]})},xp=({question:t,onAnswerChange:e,currentAnswer:n})=>{const i=n??null;return w.jsxs("div",{className:"mb-6",children:[w.jsx("h3",{className:"font-medium mb-2",children:t.questionText}),t.instruction&&w.jsx("p",{className:"text-gray-600 mb-2",children:t.instruction}),w.jsx("div",{className:"space-y-2",children:["True","False"].map(r=>w.jsxs("label",{className:"flex items-center space-x-2",children:[w.jsx("input",{type:"radio",name:t._id,checked:i===(r==="True"),onChange:()=>e(r==="True"),className:"form-radio"}),w.jsx("span",{children:r})]},r))})]})},Rp=({question:t,onAnswerChange:e,currentAnswer:n={}})=>{const i=(o,a)=>{const c={...n,[o]:a};e(c)},r=o=>{var c;const a=(c=t.blanks)==null?void 0:c[o];return a!=null&&a.options&&(a==null?void 0:a.options.length)>0?w.jsxs("select",{value:n[o]||"",onChange:l=>i(o,l.target.value),className:`border-b-2 border-gray-300 dark:border-gray-600 \r
                    focus:border-blue-500 dark:focus:border-blue-400 \r
                    outline-none px-2 py-1 mx-2 rounded\r
                    dark:bg-gray-800 text-blue-500 dark:text-blue-300`,children:[w.jsx("option",{value:"",children:"Select answer"}),a.options.map((l,u)=>w.jsx("option",{value:l,children:l},u))]},o):w.jsx("input",{type:"text",className:`border-b-2 border-gray-300 dark:border-gray-600 \r
                  focus:border-blue-500 dark:focus:border-blue-400 \r
                  outline-none px-2 py-1 mx-2\r
                  dark:bg-gray-800 text-blue-500 dark:text-blue-300`,value:n[o]||"",placeholder:`${o+1}`,onChange:l=>i(o,l.target.value)},o)},s=t.text.split("_____");return w.jsxs("div",{className:"mb-6",children:[t.instruction&&w.jsx("p",{className:"font-medium mb-2 dark:text-gray-200",children:t.instruction}),w.jsx("div",{className:"mt-4 dark:text-gray-200",children:s.map((o,a)=>w.jsxs(q.Fragment,{children:[w.jsx("span",{className:"whitespace-pre-line",children:o}),a<s.length-1&&r(a)]},a))})]})};function Hn(t){"@babel/helpers - typeof";return Hn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Hn(t)}function Ip(t,e){if(Hn(t)!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var i=n.call(t,e||"default");if(Hn(i)!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function Dp(t){var e=Ip(t,"string");return Hn(e)=="symbol"?e:e+""}function Op(t,e,n){return(e=Dp(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Ga(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Wa(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Ga(Object(n),!0).forEach(function(i){Op(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ga(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function Te(t){return"Minified Redux error #"+t+"; visit https://redux.js.org/Errors?code="+t+" for the full message or use the non-minified dev environment for full errors. "}var qa=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}(),ts=function(){return Math.random().toString(36).substring(7).split("").join(".")},Ha={INIT:"@@redux/INIT"+ts(),REPLACE:"@@redux/REPLACE"+ts(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+ts()}};function _p(t){if(typeof t!="object"||t===null)return!1;for(var e=t;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}function ou(t,e,n){var i;if(typeof e=="function"&&typeof n=="function"||typeof n=="function"&&typeof arguments[3]=="function")throw new Error(Te(0));if(typeof e=="function"&&typeof n>"u"&&(n=e,e=void 0),typeof n<"u"){if(typeof n!="function")throw new Error(Te(1));return n(ou)(t,e)}if(typeof t!="function")throw new Error(Te(2));var r=t,s=e,o=[],a=o,c=!1;function l(){a===o&&(a=o.slice())}function u(){if(c)throw new Error(Te(3));return s}function d(m){if(typeof m!="function")throw new Error(Te(4));if(c)throw new Error(Te(5));var b=!0;return l(),a.push(m),function(){if(b){if(c)throw new Error(Te(6));b=!1,l();var T=a.indexOf(m);a.splice(T,1),o=null}}}function h(m){if(!_p(m))throw new Error(Te(7));if(typeof m.type>"u")throw new Error(Te(8));if(c)throw new Error(Te(9));try{c=!0,s=r(s,m)}finally{c=!1}for(var b=o=a,v=0;v<b.length;v++){var T=b[v];T()}return m}function f(m){if(typeof m!="function")throw new Error(Te(10));r=m,h({type:Ha.REPLACE})}function g(){var m,b=d;return m={subscribe:function(T){if(typeof T!="object"||T===null)throw new Error(Te(11));function E(){T.next&&T.next(u())}E();var k=b(E);return{unsubscribe:k}}},m[qa]=function(){return this},m}return h({type:Ha.INIT}),i={dispatch:h,subscribe:d,getState:u,replaceReducer:f},i[qa]=g,i}function za(t,e){return function(){return e(t.apply(this,arguments))}}function Ka(t,e){if(typeof t=="function")return za(t,e);if(typeof t!="object"||t===null)throw new Error(Te(16));var n={};for(var i in t){var r=t[i];typeof r=="function"&&(n[i]=za(r,e))}return n}function au(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return e.length===0?function(i){return i}:e.length===1?e[0]:e.reduce(function(i,r){return function(){return i(r.apply(void 0,arguments))}})}function Ap(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return function(i){return function(){var r=i.apply(void 0,arguments),s=function(){throw new Error(Te(15))},o={getState:r.getState,dispatch:function(){return s.apply(void 0,arguments)}},a=e.map(function(c){return c(o)});return s=au.apply(void 0,a)(r.dispatch),Wa(Wa({},r),{},{dispatch:s})}}}var cu={exports:{}},lu={};/**
 * @license React
 * use-sync-external-store-shim.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var un=p;function Np(t,e){return t===e&&(t!==0||1/t===1/e)||t!==t&&e!==e}var Mp=typeof Object.is=="function"?Object.is:Np,Lp=un.useState,Up=un.useEffect,Fp=un.useLayoutEffect,Bp=un.useDebugValue;function jp(t,e){var n=e(),i=Lp({inst:{value:n,getSnapshot:e}}),r=i[0].inst,s=i[1];return Fp(function(){r.value=n,r.getSnapshot=e,ns(r)&&s({inst:r})},[t,n,e]),Up(function(){return ns(r)&&s({inst:r}),t(function(){ns(r)&&s({inst:r})})},[t]),Bp(n),n}function ns(t){var e=t.getSnapshot;t=t.value;try{var n=e();return!Mp(t,n)}catch{return!0}}function Vp(t,e){return e()}var $p=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?Vp:jp;lu.useSyncExternalStore=un.useSyncExternalStore!==void 0?un.useSyncExternalStore:$p;cu.exports=lu;var uu=cu.exports,Gp={};/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var cr=p,Wp=uu;function qp(t,e){return t===e&&(t!==0||1/t===1/e)||t!==t&&e!==e}var Hp=typeof Object.is=="function"?Object.is:qp,zp=Wp.useSyncExternalStore,Kp=cr.useRef,Jp=cr.useEffect,Yp=cr.useMemo,Qp=cr.useDebugValue;Gp.useSyncExternalStoreWithSelector=function(t,e,n,i,r){var s=Kp(null);if(s.current===null){var o={hasValue:!1,value:null};s.current=o}else o=s.current;s=Yp(function(){function c(f){if(!l){if(l=!0,u=f,f=i(f),r!==void 0&&o.hasValue){var g=o.value;if(r(g,f))return d=g}return d=f}if(g=d,Hp(u,f))return g;var m=i(f);return r!==void 0&&r(g,m)?g:(u=f,d=m)}var l=!1,u,d,h=n===void 0?null:n;return[function(){return c(e())},h===null?void 0:function(){return c(h())}]},[e,n,i,r]);var a=zp(t,s[0],s[1]);return Jp(function(){o.hasValue=!0,o.value=a},[a]),Qp(a),a};function Xp(t){t()}let du=Xp;const Zp=t=>du=t,em=()=>du,Ja=Symbol.for("react-redux-context"),Ya=typeof globalThis<"u"?globalThis:{};function tm(){var t;if(!p.createContext)return{};const e=(t=Ya[Ja])!=null?t:Ya[Ja]=new Map;let n=e.get(p.createContext);return n||(n=p.createContext(null),e.set(p.createContext,n)),n}const hu=tm(),nm=()=>{throw new Error("uSES not initialized!")};function Tt(){return Tt=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)({}).hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t},Tt.apply(null,arguments)}function fu(t,e){if(t==null)return{};var n={};for(var i in t)if({}.hasOwnProperty.call(t,i)){if(e.includes(i))continue;n[i]=t[i]}return n}var pu={exports:{}},H={};/** @license React v16.13.1
 * react-is.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var de=typeof Symbol=="function"&&Symbol.for,Oo=de?Symbol.for("react.element"):60103,_o=de?Symbol.for("react.portal"):60106,lr=de?Symbol.for("react.fragment"):60107,ur=de?Symbol.for("react.strict_mode"):60108,dr=de?Symbol.for("react.profiler"):60114,hr=de?Symbol.for("react.provider"):60109,fr=de?Symbol.for("react.context"):60110,Ao=de?Symbol.for("react.async_mode"):60111,pr=de?Symbol.for("react.concurrent_mode"):60111,mr=de?Symbol.for("react.forward_ref"):60112,gr=de?Symbol.for("react.suspense"):60113,im=de?Symbol.for("react.suspense_list"):60120,vr=de?Symbol.for("react.memo"):60115,br=de?Symbol.for("react.lazy"):60116,rm=de?Symbol.for("react.block"):60121,sm=de?Symbol.for("react.fundamental"):60117,om=de?Symbol.for("react.responder"):60118,am=de?Symbol.for("react.scope"):60119;function Ae(t){if(typeof t=="object"&&t!==null){var e=t.$$typeof;switch(e){case Oo:switch(t=t.type,t){case Ao:case pr:case lr:case dr:case ur:case gr:return t;default:switch(t=t&&t.$$typeof,t){case fr:case mr:case br:case vr:case hr:return t;default:return e}}case _o:return e}}}function mu(t){return Ae(t)===pr}H.AsyncMode=Ao;H.ConcurrentMode=pr;H.ContextConsumer=fr;H.ContextProvider=hr;H.Element=Oo;H.ForwardRef=mr;H.Fragment=lr;H.Lazy=br;H.Memo=vr;H.Portal=_o;H.Profiler=dr;H.StrictMode=ur;H.Suspense=gr;H.isAsyncMode=function(t){return mu(t)||Ae(t)===Ao};H.isConcurrentMode=mu;H.isContextConsumer=function(t){return Ae(t)===fr};H.isContextProvider=function(t){return Ae(t)===hr};H.isElement=function(t){return typeof t=="object"&&t!==null&&t.$$typeof===Oo};H.isForwardRef=function(t){return Ae(t)===mr};H.isFragment=function(t){return Ae(t)===lr};H.isLazy=function(t){return Ae(t)===br};H.isMemo=function(t){return Ae(t)===vr};H.isPortal=function(t){return Ae(t)===_o};H.isProfiler=function(t){return Ae(t)===dr};H.isStrictMode=function(t){return Ae(t)===ur};H.isSuspense=function(t){return Ae(t)===gr};H.isValidElementType=function(t){return typeof t=="string"||typeof t=="function"||t===lr||t===pr||t===dr||t===ur||t===gr||t===im||typeof t=="object"&&t!==null&&(t.$$typeof===br||t.$$typeof===vr||t.$$typeof===hr||t.$$typeof===fr||t.$$typeof===mr||t.$$typeof===sm||t.$$typeof===om||t.$$typeof===am||t.$$typeof===rm)};H.typeOf=Ae;pu.exports=H;var cm=pu.exports,No=cm,lm={childContextTypes:!0,contextType:!0,contextTypes:!0,defaultProps:!0,displayName:!0,getDefaultProps:!0,getDerivedStateFromError:!0,getDerivedStateFromProps:!0,mixins:!0,propTypes:!0,type:!0},um={name:!0,length:!0,prototype:!0,caller:!0,callee:!0,arguments:!0,arity:!0},dm={$$typeof:!0,render:!0,defaultProps:!0,displayName:!0,propTypes:!0},gu={$$typeof:!0,compare:!0,defaultProps:!0,displayName:!0,propTypes:!0,type:!0},Mo={};Mo[No.ForwardRef]=dm;Mo[No.Memo]=gu;function Qa(t){return No.isMemo(t)?gu:Mo[t.$$typeof]||lm}var hm=Object.defineProperty,fm=Object.getOwnPropertyNames,Xa=Object.getOwnPropertySymbols,pm=Object.getOwnPropertyDescriptor,mm=Object.getPrototypeOf,Za=Object.prototype;function vu(t,e,n){if(typeof e!="string"){if(Za){var i=mm(e);i&&i!==Za&&vu(t,i,n)}var r=fm(e);Xa&&(r=r.concat(Xa(e)));for(var s=Qa(t),o=Qa(e),a=0;a<r.length;++a){var c=r[a];if(!um[c]&&!(n&&n[c])&&!(o&&o[c])&&!(s&&s[c])){var l=pm(e,c);try{hm(t,c,l)}catch{}}}}return t}var gm=vu;const ec=lp(gm);var bu={exports:{}},z={};/**
 * @license React
 * react-is.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Lo=Symbol.for("react.element"),Uo=Symbol.for("react.portal"),yr=Symbol.for("react.fragment"),kr=Symbol.for("react.strict_mode"),Sr=Symbol.for("react.profiler"),Cr=Symbol.for("react.provider"),Tr=Symbol.for("react.context"),vm=Symbol.for("react.server_context"),Er=Symbol.for("react.forward_ref"),wr=Symbol.for("react.suspense"),Pr=Symbol.for("react.suspense_list"),xr=Symbol.for("react.memo"),Rr=Symbol.for("react.lazy"),bm=Symbol.for("react.offscreen"),yu;yu=Symbol.for("react.module.reference");function $e(t){if(typeof t=="object"&&t!==null){var e=t.$$typeof;switch(e){case Lo:switch(t=t.type,t){case yr:case Sr:case kr:case wr:case Pr:return t;default:switch(t=t&&t.$$typeof,t){case vm:case Tr:case Er:case Rr:case xr:case Cr:return t;default:return e}}case Uo:return e}}}z.ContextConsumer=Tr;z.ContextProvider=Cr;z.Element=Lo;z.ForwardRef=Er;z.Fragment=yr;z.Lazy=Rr;z.Memo=xr;z.Portal=Uo;z.Profiler=Sr;z.StrictMode=kr;z.Suspense=wr;z.SuspenseList=Pr;z.isAsyncMode=function(){return!1};z.isConcurrentMode=function(){return!1};z.isContextConsumer=function(t){return $e(t)===Tr};z.isContextProvider=function(t){return $e(t)===Cr};z.isElement=function(t){return typeof t=="object"&&t!==null&&t.$$typeof===Lo};z.isForwardRef=function(t){return $e(t)===Er};z.isFragment=function(t){return $e(t)===yr};z.isLazy=function(t){return $e(t)===Rr};z.isMemo=function(t){return $e(t)===xr};z.isPortal=function(t){return $e(t)===Uo};z.isProfiler=function(t){return $e(t)===Sr};z.isStrictMode=function(t){return $e(t)===kr};z.isSuspense=function(t){return $e(t)===wr};z.isSuspenseList=function(t){return $e(t)===Pr};z.isValidElementType=function(t){return typeof t=="string"||typeof t=="function"||t===yr||t===Sr||t===kr||t===wr||t===Pr||t===bm||typeof t=="object"&&t!==null&&(t.$$typeof===Rr||t.$$typeof===xr||t.$$typeof===Cr||t.$$typeof===Tr||t.$$typeof===Er||t.$$typeof===yu||t.getModuleId!==void 0)};z.typeOf=$e;bu.exports=z;var ym=bu.exports;const km=["initMapStateToProps","initMapDispatchToProps","initMergeProps"];function Sm(t,e,n,i,{areStatesEqual:r,areOwnPropsEqual:s,areStatePropsEqual:o}){let a=!1,c,l,u,d,h;function f(T,E){return c=T,l=E,u=t(c,l),d=e(i,l),h=n(u,d,l),a=!0,h}function g(){return u=t(c,l),e.dependsOnOwnProps&&(d=e(i,l)),h=n(u,d,l),h}function m(){return t.dependsOnOwnProps&&(u=t(c,l)),e.dependsOnOwnProps&&(d=e(i,l)),h=n(u,d,l),h}function b(){const T=t(c,l),E=!o(T,u);return u=T,E&&(h=n(u,d,l)),h}function v(T,E){const k=!s(E,l),y=!r(T,c,E,l);return c=T,l=E,k&&y?g():k?m():y?b():h}return function(E,k){return a?v(E,k):f(E,k)}}function Cm(t,e){let{initMapStateToProps:n,initMapDispatchToProps:i,initMergeProps:r}=e,s=fu(e,km);const o=n(t,s),a=i(t,s),c=r(t,s);return Sm(o,a,c,t,s)}function Tm(t,e){const n={};for(const i in t){const r=t[i];typeof r=="function"&&(n[i]=(...s)=>e(r(...s)))}return n}function Ls(t){return function(n){const i=t(n);function r(){return i}return r.dependsOnOwnProps=!1,r}}function tc(t){return t.dependsOnOwnProps?!!t.dependsOnOwnProps:t.length!==1}function ku(t,e){return function(i,{displayName:r}){const s=function(a,c){return s.dependsOnOwnProps?s.mapToProps(a,c):s.mapToProps(a,void 0)};return s.dependsOnOwnProps=!0,s.mapToProps=function(a,c){s.mapToProps=t,s.dependsOnOwnProps=tc(t);let l=s(a,c);return typeof l=="function"&&(s.mapToProps=l,s.dependsOnOwnProps=tc(l),l=s(a,c)),l},s}}function Fo(t,e){return(n,i)=>{throw new Error(`Invalid value of type ${typeof t} for ${e} argument when connecting component ${i.wrappedComponentName}.`)}}function Em(t){return t&&typeof t=="object"?Ls(e=>Tm(t,e)):t?typeof t=="function"?ku(t):Fo(t,"mapDispatchToProps"):Ls(e=>({dispatch:e}))}function wm(t){return t?typeof t=="function"?ku(t):Fo(t,"mapStateToProps"):Ls(()=>({}))}function Pm(t,e,n){return Tt({},n,t,e)}function xm(t){return function(n,{displayName:i,areMergedPropsEqual:r}){let s=!1,o;return function(c,l,u){const d=t(c,l,u);return s?r(d,o)||(o=d):(s=!0,o=d),o}}}function Rm(t){return t?typeof t=="function"?xm(t):Fo(t,"mergeProps"):()=>Pm}function Im(){const t=em();let e=null,n=null;return{clear(){e=null,n=null},notify(){t(()=>{let i=e;for(;i;)i.callback(),i=i.next})},get(){let i=[],r=e;for(;r;)i.push(r),r=r.next;return i},subscribe(i){let r=!0,s=n={callback:i,next:null,prev:n};return s.prev?s.prev.next=s:e=s,function(){!r||e===null||(r=!1,s.next?s.next.prev=s.prev:n=s.prev,s.prev?s.prev.next=s.next:e=s.next)}}}}const nc={notify(){},get:()=>[]};function Su(t,e){let n,i=nc,r=0,s=!1;function o(m){u();const b=i.subscribe(m);let v=!1;return()=>{v||(v=!0,b(),d())}}function a(){i.notify()}function c(){g.onStateChange&&g.onStateChange()}function l(){return s}function u(){r++,n||(n=e?e.addNestedSub(c):t.subscribe(c),i=Im())}function d(){r--,n&&r===0&&(n(),n=void 0,i.clear(),i=nc)}function h(){s||(s=!0,u())}function f(){s&&(s=!1,d())}const g={addNestedSub:o,notifyNestedSubs:a,handleChangeWrapper:c,isSubscribed:l,trySubscribe:h,tryUnsubscribe:f,getListeners:()=>i};return g}const Dm=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",Vi=Dm?p.useLayoutEffect:p.useEffect;function ic(t,e){return t===e?t!==0||e!==0||1/t===1/e:t!==t&&e!==e}function is(t,e){if(ic(t,e))return!0;if(typeof t!="object"||t===null||typeof e!="object"||e===null)return!1;const n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return!1;for(let r=0;r<n.length;r++)if(!Object.prototype.hasOwnProperty.call(e,n[r])||!ic(t[n[r]],e[n[r]]))return!1;return!0}const Om=["reactReduxForwardedRef"];let Cu=nm;const _m=t=>{Cu=t},Am=[null,null];function Nm(t,e,n){Vi(()=>t(...e),n)}function Mm(t,e,n,i,r,s){t.current=i,n.current=!1,r.current&&(r.current=null,s())}function Lm(t,e,n,i,r,s,o,a,c,l,u){if(!t)return()=>{};let d=!1,h=null;const f=()=>{if(d||!a.current)return;const m=e.getState();let b,v;try{b=i(m,r.current)}catch(T){v=T,h=T}v||(h=null),b===s.current?o.current||l():(s.current=b,c.current=b,o.current=!0,u())};return n.onStateChange=f,n.trySubscribe(),f(),()=>{if(d=!0,n.tryUnsubscribe(),n.onStateChange=null,h)throw h}}function Um(t,e){return t===e}function Tu(t,e,n,{pure:i,areStatesEqual:r=Um,areOwnPropsEqual:s=is,areStatePropsEqual:o=is,areMergedPropsEqual:a=is,forwardRef:c=!1,context:l=hu}={}){const u=l,d=wm(t),h=Em(e),f=Rm(n),g=!!t;return b=>{const v=b.displayName||b.name||"Component",T=`Connect(${v})`,E={shouldHandleStateChanges:g,displayName:T,wrappedComponentName:v,WrappedComponent:b,initMapStateToProps:d,initMapDispatchToProps:h,initMergeProps:f,areStatesEqual:r,areStatePropsEqual:o,areOwnPropsEqual:s,areMergedPropsEqual:a};function k(x){const[_,A,N]=p.useMemo(()=>{const{reactReduxForwardedRef:Ze}=x,Rn=fu(x,Om);return[x.context,Ze,Rn]},[x]),M=p.useMemo(()=>_&&_.Consumer&&ym.isContextConsumer(p.createElement(_.Consumer,null))?_:u,[_,u]),B=p.useContext(M),K=!!x.store&&!!x.store.getState&&!!x.store.dispatch,Q=!!B&&!!B.store,ie=K?x.store:B.store,Ne=Q?B.getServerState:ie.getState,Ge=p.useMemo(()=>Cm(ie.dispatch,E),[ie]),[At,Fa]=p.useMemo(()=>{if(!g)return Am;const Ze=Su(ie,K?void 0:B.subscription),Rn=Ze.notifyNestedSubs.bind(Ze);return[Ze,Rn]},[ie,K,B]),Ba=p.useMemo(()=>K?B:Tt({},B,{subscription:At}),[K,B,At]),Yr=p.useRef(),Qr=p.useRef(N),xn=p.useRef(),ja=p.useRef(!1);p.useRef(!1);const Xr=p.useRef(!1),Zr=p.useRef();Vi(()=>(Xr.current=!0,()=>{Xr.current=!1}),[]);const Va=p.useMemo(()=>()=>xn.current&&N===Qr.current?xn.current:Ge(ie.getState(),N),[ie,N]),ap=p.useMemo(()=>Rn=>At?Lm(g,ie,At,Ge,Qr,Yr,ja,Xr,xn,Fa,Rn):()=>{},[At]);Nm(Mm,[Qr,Yr,ja,N,xn,Fa]);let gi;try{gi=Cu(ap,Va,Ne?()=>Ge(Ne(),N):Va)}catch(Ze){throw Zr.current&&(Ze.message+=`
The error may be correlated with this previous error:
${Zr.current.stack}

`),Ze}Vi(()=>{Zr.current=void 0,xn.current=void 0,Yr.current=gi});const es=p.useMemo(()=>p.createElement(b,Tt({},gi,{ref:A})),[A,b,gi]);return p.useMemo(()=>g?p.createElement(M.Provider,{value:Ba},es):es,[M,es,Ba])}const C=p.memo(k);if(C.WrappedComponent=b,C.displayName=k.displayName=T,c){const _=p.forwardRef(function(N,M){return p.createElement(C,Tt({},N,{reactReduxForwardedRef:M}))});return _.displayName=T,_.WrappedComponent=b,ec(_,b)}return ec(C,b)}}function Fm({store:t,context:e,children:n,serverState:i,stabilityCheck:r="once",noopCheck:s="once"}){const o=p.useMemo(()=>{const l=Su(t);return{store:t,subscription:l,getServerState:i?()=>i:void 0,stabilityCheck:r,noopCheck:s}},[t,i,r,s]),a=p.useMemo(()=>t.getState(),[t]);Vi(()=>{const{subscription:l}=o;return l.onStateChange=l.notifyNestedSubs,l.trySubscribe(),a!==t.getState()&&l.notifyNestedSubs(),()=>{l.tryUnsubscribe(),l.onStateChange=void 0}},[o,a]);const c=e||hu;return p.createElement(c.Provider,{value:o},n)}_m(uu.useSyncExternalStore);Zp(Do.unstable_batchedUpdates);function Bm(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}function Eu(t,e){var n=p.useState(function(){return{inputs:e,result:t()}})[0],i=p.useRef(!0),r=p.useRef(n),s=i.current||!!(e&&r.current.inputs&&Bm(e,r.current.inputs)),o=s?r.current:{inputs:e,result:t()};return p.useEffect(function(){i.current=!1,r.current=o},[o]),o.result}function jm(t,e){return Eu(function(){return t},e)}var $=Eu,j=jm,Vm="Invariant failed";function $m(t,e){throw new Error(Vm)}var Ke=function(e){var n=e.top,i=e.right,r=e.bottom,s=e.left,o=i-s,a=r-n,c={top:n,right:i,bottom:r,left:s,width:o,height:a,x:s,y:n,center:{x:(i+s)/2,y:(r+n)/2}};return c},Bo=function(e,n){return{top:e.top-n.top,left:e.left-n.left,bottom:e.bottom+n.bottom,right:e.right+n.right}},rc=function(e,n){return{top:e.top+n.top,left:e.left+n.left,bottom:e.bottom-n.bottom,right:e.right-n.right}},Gm=function(e,n){return{top:e.top+n.y,left:e.left+n.x,bottom:e.bottom+n.y,right:e.right+n.x}},rs={top:0,right:0,bottom:0,left:0},jo=function(e){var n=e.borderBox,i=e.margin,r=i===void 0?rs:i,s=e.border,o=s===void 0?rs:s,a=e.padding,c=a===void 0?rs:a,l=Ke(Bo(n,r)),u=Ke(rc(n,o)),d=Ke(rc(u,c));return{marginBox:l,borderBox:Ke(n),paddingBox:u,contentBox:d,margin:r,border:o,padding:c}},Me=function(e){var n=e.slice(0,-2),i=e.slice(-2);if(i!=="px")return 0;var r=Number(n);return isNaN(r)&&$m(),r},Wm=function(){return{x:window.pageXOffset,y:window.pageYOffset}},$i=function(e,n){var i=e.borderBox,r=e.border,s=e.margin,o=e.padding,a=Gm(i,n);return jo({borderBox:a,border:r,margin:s,padding:o})},Gi=function(e,n){return n===void 0&&(n=Wm()),$i(e,n)},wu=function(e,n){var i={top:Me(n.marginTop),right:Me(n.marginRight),bottom:Me(n.marginBottom),left:Me(n.marginLeft)},r={top:Me(n.paddingTop),right:Me(n.paddingRight),bottom:Me(n.paddingBottom),left:Me(n.paddingLeft)},s={top:Me(n.borderTopWidth),right:Me(n.borderRightWidth),bottom:Me(n.borderBottomWidth),left:Me(n.borderLeftWidth)};return jo({borderBox:e,margin:i,padding:r,border:s})},Pu=function(e){var n=e.getBoundingClientRect(),i=window.getComputedStyle(e);return wu(n,i)},sc=Number.isNaN||function(e){return typeof e=="number"&&e!==e};function qm(t,e){return!!(t===e||sc(t)&&sc(e))}function Hm(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!qm(t[n],e[n]))return!1;return!0}function le(t,e){e===void 0&&(e=Hm);var n=null;function i(){for(var r=[],s=0;s<arguments.length;s++)r[s]=arguments[s];if(n&&n.lastThis===this&&e(r,n.lastArgs))return n.lastResult;var o=t.apply(this,r);return n={lastResult:o,lastArgs:r,lastThis:this},o}return i.clear=function(){n=null},i}var zn=function(e){var n=[],i=null,r=function(){for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];n=a,!i&&(i=requestAnimationFrame(function(){i=null,e.apply(void 0,n)}))};return r.cancel=function(){i&&(cancelAnimationFrame(i),i=null)},r};function xu(t,e){}xu.bind(null,"warn");xu.bind(null,"error");function Et(){}function zm(t,e){return{...t,...e}}function Fe(t,e,n){const i=e.map(r=>{const s=zm(n,r.options);return t.addEventListener(r.eventName,r.fn,s),function(){t.removeEventListener(r.eventName,r.fn,s)}});return function(){i.forEach(s=>{s()})}}const Km="Invariant failed";class Wi extends Error{}Wi.prototype.toString=function(){return this.message};function L(t,e){throw new Wi(Km)}class Jm extends q.Component{constructor(...e){super(...e),this.callbacks=null,this.unbind=Et,this.onWindowError=n=>{const i=this.getCallbacks();i.isDragging()&&i.tryAbort(),n.error instanceof Wi&&n.preventDefault()},this.getCallbacks=()=>{if(!this.callbacks)throw new Error("Unable to find AppCallbacks in <ErrorBoundary/>");return this.callbacks},this.setCallbacks=n=>{this.callbacks=n}}componentDidMount(){this.unbind=Fe(window,[{eventName:"error",fn:this.onWindowError}])}componentDidCatch(e){if(e instanceof Wi){this.setState({});return}throw e}componentWillUnmount(){this.unbind()}render(){return this.props.children(this.setCallbacks)}}const Ym=`
  Press space bar to start a drag.
  When dragging you can use the arrow keys to move the item around and escape to cancel.
  Some screen readers may require you to be in focus mode or to use your pass through key
`,qi=t=>t+1,Qm=t=>`
  You have lifted an item in position ${qi(t.source.index)}
`,Ru=(t,e)=>{const n=t.droppableId===e.droppableId,i=qi(t.index),r=qi(e.index);return n?`
      You have moved the item from position ${i}
      to position ${r}
    `:`
    You have moved the item from position ${i}
    in list ${t.droppableId}
    to list ${e.droppableId}
    in position ${r}
  `},Iu=(t,e,n)=>e.droppableId===n.droppableId?`
      The item ${t}
      has been combined with ${n.draggableId}`:`
      The item ${t}
      in list ${e.droppableId}
      has been combined with ${n.draggableId}
      in list ${n.droppableId}
    `,Xm=t=>{const e=t.destination;if(e)return Ru(t.source,e);const n=t.combine;return n?Iu(t.draggableId,t.source,n):"You are over an area that cannot be dropped on"},oc=t=>`
  The item has returned to its starting position
  of ${qi(t.index)}
`,Zm=t=>{if(t.reason==="CANCEL")return`
      Movement cancelled.
      ${oc(t.source)}
    `;const e=t.destination,n=t.combine;return e?`
      You have dropped the item.
      ${Ru(t.source,e)}
    `:n?`
      You have dropped the item.
      ${Iu(t.draggableId,t.source,n)}
    `:`
    The item has been dropped while not over a drop area.
    ${oc(t.source)}
  `},eg={dragHandleUsageInstructions:Ym,onDragStart:Qm,onDragUpdate:Xm,onDragEnd:Zm};var wi=eg;const ue={x:0,y:0},pe=(t,e)=>({x:t.x+e.x,y:t.y+e.y}),xe=(t,e)=>({x:t.x-e.x,y:t.y-e.y}),wt=(t,e)=>t.x===e.x&&t.y===e.y,Sn=t=>({x:t.x!==0?-t.x:0,y:t.y!==0?-t.y:0}),jt=(t,e,n=0)=>t==="x"?{x:e,y:n}:{x:n,y:e},Kn=(t,e)=>Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2),ac=(t,e)=>Math.min(...e.map(n=>Kn(t,n))),Du=t=>e=>({x:t(e.x),y:t(e.y)});var tg=(t,e)=>{const n=Ke({top:Math.max(e.top,t.top),right:Math.min(e.right,t.right),bottom:Math.min(e.bottom,t.bottom),left:Math.max(e.left,t.left)});return n.width<=0||n.height<=0?null:n};const ui=(t,e)=>({top:t.top+e.y,left:t.left+e.x,bottom:t.bottom+e.y,right:t.right+e.x}),cc=t=>[{x:t.left,y:t.top},{x:t.right,y:t.top},{x:t.left,y:t.bottom},{x:t.right,y:t.bottom}],ng={top:0,right:0,bottom:0,left:0},ig=(t,e)=>e?ui(t,e.scroll.diff.displacement):t,rg=(t,e,n)=>n&&n.increasedBy?{...t,[e.end]:t[e.end]+n.increasedBy[e.line]}:t,sg=(t,e)=>e&&e.shouldClipSubject?tg(e.pageMarginBox,t):Ke(t);var dn=({page:t,withPlaceholder:e,axis:n,frame:i})=>{const r=ig(t.marginBox,i),s=rg(r,n,e),o=sg(s,i);return{page:t,withPlaceholder:e,active:o}},Vo=(t,e)=>{t.frame||L();const n=t.frame,i=xe(e,n.scroll.initial),r=Sn(i),s={...n,scroll:{initial:n.scroll.initial,current:e,diff:{value:i,displacement:r},max:n.scroll.max}},o=dn({page:t.subject.page,withPlaceholder:t.subject.withPlaceholder,axis:t.axis,frame:s});return{...t,frame:s,subject:o}};const Ou=le(t=>t.reduce((e,n)=>(e[n.descriptor.id]=n,e),{})),_u=le(t=>t.reduce((e,n)=>(e[n.descriptor.id]=n,e),{})),Ir=le(t=>Object.values(t)),og=le(t=>Object.values(t));var Cn=le((t,e)=>og(e).filter(i=>t===i.descriptor.droppableId).sort((i,r)=>i.descriptor.index-r.descriptor.index));function $o(t){return t.at&&t.at.type==="REORDER"?t.at.destination:null}function Dr(t){return t.at&&t.at.type==="COMBINE"?t.at.combine:null}var Or=le((t,e)=>e.filter(n=>n.descriptor.id!==t.descriptor.id)),ag=({isMovingForward:t,draggable:e,destination:n,insideDestination:i,previousImpact:r})=>{if(!n.isCombineEnabled||!$o(r))return null;function o(f){const g={type:"COMBINE",combine:{draggableId:f,droppableId:n.descriptor.id}};return{...r,at:g}}const a=r.displaced.all,c=a.length?a[0]:null;if(t)return c?o(c):null;const l=Or(e,i);if(!c){if(!l.length)return null;const f=l[l.length-1];return o(f.descriptor.id)}const u=l.findIndex(f=>f.descriptor.id===c);u===-1&&L();const d=u-1;if(d<0)return null;const h=l[d];return o(h.descriptor.id)},Tn=(t,e)=>t.descriptor.droppableId===e.descriptor.id;const Au={point:ue,value:0},Jn={invisible:{},visible:{},all:[]},cg={displaced:Jn,displacedBy:Au,at:null};var lg=cg,je=(t,e)=>n=>t<=n&&n<=e,Nu=t=>{const e=je(t.top,t.bottom),n=je(t.left,t.right);return i=>{if(e(i.top)&&e(i.bottom)&&n(i.left)&&n(i.right))return!0;const s=e(i.top)||e(i.bottom),o=n(i.left)||n(i.right);if(s&&o)return!0;const c=i.top<t.top&&i.bottom>t.bottom,l=i.left<t.left&&i.right>t.right;return c&&l?!0:c&&o||l&&s}},ug=t=>{const e=je(t.top,t.bottom),n=je(t.left,t.right);return i=>e(i.top)&&e(i.bottom)&&n(i.left)&&n(i.right)};const Go={direction:"vertical",line:"y",crossAxisLine:"x",start:"top",end:"bottom",size:"height",crossAxisStart:"left",crossAxisEnd:"right",crossAxisSize:"width"},Mu={direction:"horizontal",line:"x",crossAxisLine:"y",start:"left",end:"right",size:"width",crossAxisStart:"top",crossAxisEnd:"bottom",crossAxisSize:"height"};var dg=t=>e=>{const n=je(e.top,e.bottom),i=je(e.left,e.right);return r=>t===Go?n(r.top)&&n(r.bottom):i(r.left)&&i(r.right)};const hg=(t,e)=>{const n=e.frame?e.frame.scroll.diff.displacement:ue;return ui(t,n)},fg=(t,e,n)=>e.subject.active?n(e.subject.active)(t):!1,pg=(t,e,n)=>n(e)(t),Wo=({target:t,destination:e,viewport:n,withDroppableDisplacement:i,isVisibleThroughFrameFn:r})=>{const s=i?hg(t,e):t;return fg(s,e,r)&&pg(s,n,r)},mg=t=>Wo({...t,isVisibleThroughFrameFn:Nu}),Lu=t=>Wo({...t,isVisibleThroughFrameFn:ug}),gg=t=>Wo({...t,isVisibleThroughFrameFn:dg(t.destination.axis)}),vg=(t,e,n)=>{if(typeof n=="boolean")return n;if(!e)return!0;const{invisible:i,visible:r}=e;if(i[t])return!1;const s=r[t];return s?s.shouldAnimate:!0};function bg(t,e){const n=t.page.marginBox,i={top:e.point.y,right:0,bottom:0,left:e.point.x};return Ke(Bo(n,i))}function Yn({afterDragging:t,destination:e,displacedBy:n,viewport:i,forceShouldAnimate:r,last:s}){return t.reduce(function(a,c){const l=bg(c,n),u=c.descriptor.id;if(a.all.push(u),!mg({target:l,destination:e,viewport:i,withDroppableDisplacement:!0}))return a.invisible[c.descriptor.id]=!0,a;const h=vg(u,s,r),f={draggableId:u,shouldAnimate:h};return a.visible[u]=f,a},{all:[],visible:{},invisible:{}})}function yg(t,e){if(!t.length)return 0;const n=t[t.length-1].descriptor.index;return e.inHomeList?n:n+1}function lc({insideDestination:t,inHomeList:e,displacedBy:n,destination:i}){const r=yg(t,{inHomeList:e});return{displaced:Jn,displacedBy:n,at:{type:"REORDER",destination:{droppableId:i.descriptor.id,index:r}}}}function Hi({draggable:t,insideDestination:e,destination:n,viewport:i,displacedBy:r,last:s,index:o,forceShouldAnimate:a}){const c=Tn(t,n);if(o==null)return lc({insideDestination:e,inHomeList:c,displacedBy:r,destination:n});const l=e.find(g=>g.descriptor.index===o);if(!l)return lc({insideDestination:e,inHomeList:c,displacedBy:r,destination:n});const u=Or(t,e),d=e.indexOf(l),h=u.slice(d);return{displaced:Yn({afterDragging:h,destination:n,displacedBy:r,last:s,viewport:i.frame,forceShouldAnimate:a}),displacedBy:r,at:{type:"REORDER",destination:{droppableId:n.descriptor.id,index:o}}}}function Rt(t,e){return!!e.effected[t]}var kg=({isMovingForward:t,destination:e,draggables:n,combine:i,afterCritical:r})=>{if(!e.isCombineEnabled)return null;const s=i.draggableId,a=n[s].descriptor.index;return Rt(s,r)?t?a:a-1:t?a+1:a},Sg=({isMovingForward:t,isInHomeList:e,insideDestination:n,location:i})=>{if(!n.length)return null;const r=i.index,s=t?r+1:r-1,o=n[0].descriptor.index,a=n[n.length-1].descriptor.index,c=e?a:a+1;return s<o||s>c?null:s},Cg=({isMovingForward:t,isInHomeList:e,draggable:n,draggables:i,destination:r,insideDestination:s,previousImpact:o,viewport:a,afterCritical:c})=>{const l=o.at;if(l||L(),l.type==="REORDER"){const d=Sg({isMovingForward:t,isInHomeList:e,location:l.destination,insideDestination:s});return d==null?null:Hi({draggable:n,insideDestination:s,destination:r,viewport:a,last:o.displaced,displacedBy:o.displacedBy,index:d})}const u=kg({isMovingForward:t,destination:r,displaced:o.displaced,draggables:i,combine:l.combine,afterCritical:c});return u==null?null:Hi({draggable:n,insideDestination:s,destination:r,viewport:a,last:o.displaced,displacedBy:o.displacedBy,index:u})},Tg=({displaced:t,afterCritical:e,combineWith:n,displacedBy:i})=>{const r=!!(t.visible[n]||t.invisible[n]);return Rt(n,e)?r?ue:Sn(i.point):r?i.point:ue},Eg=({afterCritical:t,impact:e,draggables:n})=>{const i=Dr(e);i||L();const r=i.draggableId,s=n[r].page.borderBox.center,o=Tg({displaced:e.displaced,afterCritical:t,combineWith:r,displacedBy:e.displacedBy});return pe(s,o)};const Uu=(t,e)=>e.margin[t.start]+e.borderBox[t.size]/2,wg=(t,e)=>e.margin[t.end]+e.borderBox[t.size]/2,qo=(t,e,n)=>e[t.crossAxisStart]+n.margin[t.crossAxisStart]+n.borderBox[t.crossAxisSize]/2,uc=({axis:t,moveRelativeTo:e,isMoving:n})=>jt(t.line,e.marginBox[t.end]+Uu(t,n),qo(t,e.marginBox,n)),dc=({axis:t,moveRelativeTo:e,isMoving:n})=>jt(t.line,e.marginBox[t.start]-wg(t,n),qo(t,e.marginBox,n)),Pg=({axis:t,moveInto:e,isMoving:n})=>jt(t.line,e.contentBox[t.start]+Uu(t,n),qo(t,e.contentBox,n));var xg=({impact:t,draggable:e,draggables:n,droppable:i,afterCritical:r})=>{const s=Cn(i.descriptor.id,n),o=e.page,a=i.axis;if(!s.length)return Pg({axis:a,moveInto:i.page,isMoving:o});const{displaced:c,displacedBy:l}=t,u=c.all[0];if(u){const h=n[u];if(Rt(u,r))return dc({axis:a,moveRelativeTo:h.page,isMoving:o});const f=$i(h.page,l.point);return dc({axis:a,moveRelativeTo:f,isMoving:o})}const d=s[s.length-1];if(d.descriptor.id===e.descriptor.id)return o.borderBox.center;if(Rt(d.descriptor.id,r)){const h=$i(d.page,Sn(r.displacedBy.point));return uc({axis:a,moveRelativeTo:h,isMoving:o})}return uc({axis:a,moveRelativeTo:d.page,isMoving:o})},Us=(t,e)=>{const n=t.frame;return n?pe(e,n.scroll.diff.displacement):e};const Rg=({impact:t,draggable:e,droppable:n,draggables:i,afterCritical:r})=>{const s=e.page.borderBox.center,o=t.at;return!n||!o?s:o.type==="REORDER"?xg({impact:t,draggable:e,draggables:i,droppable:n,afterCritical:r}):Eg({impact:t,draggables:i,afterCritical:r})};var _r=t=>{const e=Rg(t),n=t.droppable;return n?Us(n,e):e},Fu=(t,e)=>{const n=xe(e,t.scroll.initial),i=Sn(n);return{frame:Ke({top:e.y,bottom:e.y+t.frame.height,left:e.x,right:e.x+t.frame.width}),scroll:{initial:t.scroll.initial,max:t.scroll.max,current:e,diff:{value:n,displacement:i}}}};function hc(t,e){return t.map(n=>e[n])}function Ig(t,e){for(let n=0;n<e.length;n++){const i=e[n].visible[t];if(i)return i}return null}var Dg=({impact:t,viewport:e,destination:n,draggables:i,maxScrollChange:r})=>{const s=Fu(e,pe(e.scroll.current,r)),o=n.frame?Vo(n,pe(n.frame.scroll.current,r)):n,a=t.displaced,c=Yn({afterDragging:hc(a.all,i),destination:n,displacedBy:t.displacedBy,viewport:s.frame,last:a,forceShouldAnimate:!1}),l=Yn({afterDragging:hc(a.all,i),destination:o,displacedBy:t.displacedBy,viewport:e.frame,last:a,forceShouldAnimate:!1}),u={},d={},h=[a,c,l];return a.all.forEach(g=>{const m=Ig(g,h);if(m){d[g]=m;return}u[g]=!0}),{...t,displaced:{all:a.all,invisible:u,visible:d}}},Og=(t,e)=>pe(t.scroll.diff.displacement,e),Ho=({pageBorderBoxCenter:t,draggable:e,viewport:n})=>{const i=Og(n,t),r=xe(i,e.page.borderBox.center);return pe(e.client.borderBox.center,r)},Bu=({draggable:t,destination:e,newPageBorderBoxCenter:n,viewport:i,withDroppableDisplacement:r,onlyOnMainAxis:s=!1})=>{const o=xe(n,t.page.borderBox.center),c={target:ui(t.page.borderBox,o),destination:e,withDroppableDisplacement:r,viewport:i};return s?gg(c):Lu(c)},_g=({isMovingForward:t,draggable:e,destination:n,draggables:i,previousImpact:r,viewport:s,previousPageBorderBoxCenter:o,previousClientSelection:a,afterCritical:c})=>{if(!n.isEnabled)return null;const l=Cn(n.descriptor.id,i),u=Tn(e,n),d=ag({isMovingForward:t,draggable:e,destination:n,insideDestination:l,previousImpact:r})||Cg({isMovingForward:t,isInHomeList:u,draggable:e,draggables:i,destination:n,insideDestination:l,previousImpact:r,viewport:s,afterCritical:c});if(!d)return null;const h=_r({impact:d,draggable:e,droppable:n,draggables:i,afterCritical:c});if(Bu({draggable:e,destination:n,newPageBorderBoxCenter:h,viewport:s.frame,withDroppableDisplacement:!1,onlyOnMainAxis:!0}))return{clientSelection:Ho({pageBorderBoxCenter:h,draggable:e,viewport:s}),impact:d,scrollJumpRequest:null};const g=xe(h,o),m=Dg({impact:d,viewport:s,destination:n,draggables:i,maxScrollChange:g});return{clientSelection:a,impact:m,scrollJumpRequest:g}};const Ce=t=>{const e=t.subject.active;return e||L(),e};var Ag=({isMovingForward:t,pageBorderBoxCenter:e,source:n,droppables:i,viewport:r})=>{const s=n.subject.active;if(!s)return null;const o=n.axis,a=je(s[o.start],s[o.end]),c=Ir(i).filter(u=>u!==n).filter(u=>u.isEnabled).filter(u=>!!u.subject.active).filter(u=>Nu(r.frame)(Ce(u))).filter(u=>{const d=Ce(u);return t?s[o.crossAxisEnd]<d[o.crossAxisEnd]:d[o.crossAxisStart]<s[o.crossAxisStart]}).filter(u=>{const d=Ce(u),h=je(d[o.start],d[o.end]);return a(d[o.start])||a(d[o.end])||h(s[o.start])||h(s[o.end])}).sort((u,d)=>{const h=Ce(u)[o.crossAxisStart],f=Ce(d)[o.crossAxisStart];return t?h-f:f-h}).filter((u,d,h)=>Ce(u)[o.crossAxisStart]===Ce(h[0])[o.crossAxisStart]);if(!c.length)return null;if(c.length===1)return c[0];const l=c.filter(u=>je(Ce(u)[o.start],Ce(u)[o.end])(e[o.line]));return l.length===1?l[0]:l.length>1?l.sort((u,d)=>Ce(u)[o.start]-Ce(d)[o.start])[0]:c.sort((u,d)=>{const h=ac(e,cc(Ce(u))),f=ac(e,cc(Ce(d)));return h!==f?h-f:Ce(u)[o.start]-Ce(d)[o.start]})[0]};const fc=(t,e)=>{const n=t.page.borderBox.center;return Rt(t.descriptor.id,e)?xe(n,e.displacedBy.point):n},Ng=(t,e)=>{const n=t.page.borderBox;return Rt(t.descriptor.id,e)?ui(n,Sn(e.displacedBy.point)):n};var Mg=({pageBorderBoxCenter:t,viewport:e,destination:n,insideDestination:i,afterCritical:r})=>i.filter(o=>Lu({target:Ng(o,r),destination:n,viewport:e.frame,withDroppableDisplacement:!0})).sort((o,a)=>{const c=Kn(t,Us(n,fc(o,r))),l=Kn(t,Us(n,fc(a,r)));return c<l?-1:l<c?1:o.descriptor.index-a.descriptor.index})[0]||null,di=le(function(e,n){const i=n[e.line];return{value:i,point:jt(e.line,i)}});const Lg=(t,e,n)=>{const i=t.axis;if(t.descriptor.mode==="virtual")return jt(i.line,e[i.line]);const r=t.subject.page.contentBox[i.size],c=Cn(t.descriptor.id,n).reduce((l,u)=>l+u.client.marginBox[i.size],0)+e[i.line]-r;return c<=0?null:jt(i.line,c)},ju=(t,e)=>({...t,scroll:{...t.scroll,max:e}}),Vu=(t,e,n)=>{const i=t.frame;Tn(e,t)&&L(),t.subject.withPlaceholder&&L();const r=di(t.axis,e.displaceBy).point,s=Lg(t,r,n),o={placeholderSize:r,increasedBy:s,oldFrameMaxScroll:t.frame?t.frame.scroll.max:null};if(!i){const u=dn({page:t.subject.page,withPlaceholder:o,axis:t.axis,frame:t.frame});return{...t,subject:u}}const a=s?pe(i.scroll.max,s):i.scroll.max,c=ju(i,a),l=dn({page:t.subject.page,withPlaceholder:o,axis:t.axis,frame:c});return{...t,subject:l,frame:c}},Ug=t=>{const e=t.subject.withPlaceholder;e||L();const n=t.frame;if(!n){const o=dn({page:t.subject.page,axis:t.axis,frame:null,withPlaceholder:null});return{...t,subject:o}}const i=e.oldFrameMaxScroll;i||L();const r=ju(n,i),s=dn({page:t.subject.page,axis:t.axis,frame:r,withPlaceholder:null});return{...t,subject:s,frame:r}};var Fg=({previousPageBorderBoxCenter:t,moveRelativeTo:e,insideDestination:n,draggable:i,draggables:r,destination:s,viewport:o,afterCritical:a})=>{if(!e){if(n.length)return null;const d={displaced:Jn,displacedBy:Au,at:{type:"REORDER",destination:{droppableId:s.descriptor.id,index:0}}},h=_r({impact:d,draggable:i,droppable:s,draggables:r,afterCritical:a}),f=Tn(i,s)?s:Vu(s,i,r);return Bu({draggable:i,destination:f,newPageBorderBoxCenter:h,viewport:o.frame,withDroppableDisplacement:!1,onlyOnMainAxis:!0})?d:null}const c=t[s.axis.line]<=e.page.borderBox.center[s.axis.line],l=(()=>{const d=e.descriptor.index;return e.descriptor.id===i.descriptor.id||c?d:d+1})(),u=di(s.axis,i.displaceBy);return Hi({draggable:i,insideDestination:n,destination:s,viewport:o,displacedBy:u,last:Jn,index:l})},Bg=({isMovingForward:t,previousPageBorderBoxCenter:e,draggable:n,isOver:i,draggables:r,droppables:s,viewport:o,afterCritical:a})=>{const c=Ag({isMovingForward:t,pageBorderBoxCenter:e,source:i,droppables:s,viewport:o});if(!c)return null;const l=Cn(c.descriptor.id,r),u=Mg({pageBorderBoxCenter:e,viewport:o,destination:c,insideDestination:l,afterCritical:a}),d=Fg({previousPageBorderBoxCenter:e,destination:c,draggable:n,draggables:r,moveRelativeTo:u,insideDestination:l,viewport:o,afterCritical:a});if(!d)return null;const h=_r({impact:d,draggable:n,droppable:c,draggables:r,afterCritical:a});return{clientSelection:Ho({pageBorderBoxCenter:h,draggable:n,viewport:o}),impact:d,scrollJumpRequest:null}},Ie=t=>{const e=t.at;return e?e.type==="REORDER"?e.destination.droppableId:e.combine.droppableId:null};const jg=(t,e)=>{const n=Ie(t);return n?e[n]:null};var Vg=({state:t,type:e})=>{const n=jg(t.impact,t.dimensions.droppables),i=!!n,r=t.dimensions.droppables[t.critical.droppable.id],s=n||r,o=s.axis.direction,a=o==="vertical"&&(e==="MOVE_UP"||e==="MOVE_DOWN")||o==="horizontal"&&(e==="MOVE_LEFT"||e==="MOVE_RIGHT");if(a&&!i)return null;const c=e==="MOVE_DOWN"||e==="MOVE_RIGHT",l=t.dimensions.draggables[t.critical.draggable.id],u=t.current.page.borderBoxCenter,{draggables:d,droppables:h}=t.dimensions;return a?_g({isMovingForward:c,previousPageBorderBoxCenter:u,draggable:l,destination:s,draggables:d,viewport:t.viewport,previousClientSelection:t.current.client.selection,previousImpact:t.impact,afterCritical:t.afterCritical}):Bg({isMovingForward:c,previousPageBorderBoxCenter:u,draggable:l,isOver:s,draggables:d,droppables:h,viewport:t.viewport,afterCritical:t.afterCritical})};function Lt(t){return t.phase==="DRAGGING"||t.phase==="COLLECTING"}function $u(t){const e=je(t.top,t.bottom),n=je(t.left,t.right);return function(r){return e(r.y)&&n(r.x)}}function $g(t,e){return t.left<e.right&&t.right>e.left&&t.top<e.bottom&&t.bottom>e.top}function Gg({pageBorderBox:t,draggable:e,candidates:n}){const i=e.page.borderBox.center,r=n.map(s=>{const o=s.axis,a=jt(s.axis.line,t.center[o.line],s.page.borderBox.center[o.crossAxisLine]);return{id:s.descriptor.id,distance:Kn(i,a)}}).sort((s,o)=>o.distance-s.distance);return r[0]?r[0].id:null}function Wg({pageBorderBox:t,draggable:e,droppables:n}){const i=Ir(n).filter(r=>{if(!r.isEnabled)return!1;const s=r.subject.active;if(!s||!$g(t,s))return!1;if($u(s)(t.center))return!0;const o=r.axis,a=s.center[o.crossAxisLine],c=t[o.crossAxisStart],l=t[o.crossAxisEnd],u=je(s[o.crossAxisStart],s[o.crossAxisEnd]),d=u(c),h=u(l);return!d&&!h?!0:d?c<a:l>a});return i.length?i.length===1?i[0].descriptor.id:Gg({pageBorderBox:t,draggable:e,candidates:i}):null}const Gu=(t,e)=>Ke(ui(t,e));var qg=(t,e)=>{const n=t.frame;return n?Gu(e,n.scroll.diff.value):e};function Wu({displaced:t,id:e}){return!!(t.visible[e]||t.invisible[e])}function Hg({draggable:t,closest:e,inHomeList:n}){return e?n&&e.descriptor.index>t.descriptor.index?e.descriptor.index-1:e.descriptor.index:null}var zg=({pageBorderBoxWithDroppableScroll:t,draggable:e,destination:n,insideDestination:i,last:r,viewport:s,afterCritical:o})=>{const a=n.axis,c=di(n.axis,e.displaceBy),l=c.value,u=t[a.start],d=t[a.end],f=Or(e,i).find(m=>{const b=m.descriptor.id,v=m.page.borderBox.center[a.line],T=Rt(b,o),E=Wu({displaced:r,id:b});return T?E?d<=v:u<v-l:E?d<=v+l:u<v})||null,g=Hg({draggable:e,closest:f,inHomeList:Tn(e,n)});return Hi({draggable:e,insideDestination:i,destination:n,viewport:s,last:r,displacedBy:c,index:g})};const Kg=4;var Jg=({draggable:t,pageBorderBoxWithDroppableScroll:e,previousImpact:n,destination:i,insideDestination:r,afterCritical:s})=>{if(!i.isCombineEnabled)return null;const o=i.axis,a=di(i.axis,t.displaceBy),c=a.value,l=e[o.start],u=e[o.end],h=Or(t,r).find(g=>{const m=g.descriptor.id,b=g.page.borderBox,T=b[o.size]/Kg,E=Rt(m,s),k=Wu({displaced:n.displaced,id:m});return E?k?u>b[o.start]+T&&u<b[o.end]-T:l>b[o.start]-c+T&&l<b[o.end]-c-T:k?u>b[o.start]+c+T&&u<b[o.end]+c-T:l>b[o.start]+T&&l<b[o.end]-T});return h?{displacedBy:a,displaced:n.displaced,at:{type:"COMBINE",combine:{draggableId:h.descriptor.id,droppableId:i.descriptor.id}}}:null},qu=({pageOffset:t,draggable:e,draggables:n,droppables:i,previousImpact:r,viewport:s,afterCritical:o})=>{const a=Gu(e.page.borderBox,t),c=Wg({pageBorderBox:a,draggable:e,droppables:i});if(!c)return lg;const l=i[c],u=Cn(l.descriptor.id,n),d=qg(l,a);return Jg({pageBorderBoxWithDroppableScroll:d,draggable:e,previousImpact:r,destination:l,insideDestination:u,afterCritical:o})||zg({pageBorderBoxWithDroppableScroll:d,draggable:e,destination:l,insideDestination:u,last:r.displaced,viewport:s,afterCritical:o})},zo=(t,e)=>({...t,[e.descriptor.id]:e});const Yg=({previousImpact:t,impact:e,droppables:n})=>{const i=Ie(t),r=Ie(e);if(!i||i===r)return n;const s=n[i];if(!s.subject.withPlaceholder)return n;const o=Ug(s);return zo(n,o)};var Qg=({draggable:t,draggables:e,droppables:n,previousImpact:i,impact:r})=>{const s=Yg({previousImpact:i,impact:r,droppables:n}),o=Ie(r);if(!o)return s;const a=n[o];if(Tn(t,a)||a.subject.withPlaceholder)return s;const c=Vu(a,t,e);return zo(s,c)},Bn=({state:t,clientSelection:e,dimensions:n,viewport:i,impact:r,scrollJumpRequest:s})=>{const o=i||t.viewport,a=n||t.dimensions,c=e||t.current.client.selection,l=xe(c,t.initial.client.selection),u={offset:l,selection:c,borderBoxCenter:pe(t.initial.client.borderBoxCenter,l)},d={selection:pe(u.selection,o.scroll.current),borderBoxCenter:pe(u.borderBoxCenter,o.scroll.current),offset:pe(u.offset,o.scroll.diff.value)},h={client:u,page:d};if(t.phase==="COLLECTING")return{...t,dimensions:a,viewport:o,current:h};const f=a.draggables[t.critical.draggable.id],g=r||qu({pageOffset:d.offset,draggable:f,draggables:a.draggables,droppables:a.droppables,previousImpact:t.impact,viewport:o,afterCritical:t.afterCritical}),m=Qg({draggable:f,impact:g,previousImpact:t.impact,draggables:a.draggables,droppables:a.droppables});return{...t,current:h,dimensions:{draggables:a.draggables,droppables:m},impact:g,viewport:o,scrollJumpRequest:s||null,forceShouldAnimate:s?!1:null}};function Xg(t,e){return t.map(n=>e[n])}var Hu=({impact:t,viewport:e,draggables:n,destination:i,forceShouldAnimate:r})=>{const s=t.displaced,o=Xg(s.all,n),a=Yn({afterDragging:o,destination:i,displacedBy:t.displacedBy,viewport:e.frame,forceShouldAnimate:r,last:s});return{...t,displaced:a}},zu=({impact:t,draggable:e,droppable:n,draggables:i,viewport:r,afterCritical:s})=>{const o=_r({impact:t,draggable:e,draggables:i,droppable:n,afterCritical:s});return Ho({pageBorderBoxCenter:o,draggable:e,viewport:r})},Ku=({state:t,dimensions:e,viewport:n})=>{t.movementMode!=="SNAP"&&L();const i=t.impact,r=n||t.viewport,s=e||t.dimensions,{draggables:o,droppables:a}=s,c=o[t.critical.draggable.id],l=Ie(i);l||L();const u=a[l],d=Hu({impact:i,viewport:r,destination:u,draggables:o}),h=zu({impact:d,draggable:c,droppable:u,draggables:o,viewport:r,afterCritical:t.afterCritical});return Bn({impact:d,clientSelection:h,state:t,dimensions:s,viewport:r})},Zg=t=>({index:t.index,droppableId:t.droppableId}),Ju=({draggable:t,home:e,draggables:n,viewport:i})=>{const r=di(e.axis,t.displaceBy),s=Cn(e.descriptor.id,n),o=s.indexOf(t);o===-1&&L();const a=s.slice(o+1),c=a.reduce((h,f)=>(h[f.descriptor.id]=!0,h),{}),l={inVirtualList:e.descriptor.mode==="virtual",displacedBy:r,effected:c};return{impact:{displaced:Yn({afterDragging:a,destination:e,displacedBy:r,last:null,viewport:i.frame,forceShouldAnimate:!1}),displacedBy:r,at:{type:"REORDER",destination:Zg(t.descriptor)}},afterCritical:l}},ev=(t,e)=>({draggables:t.draggables,droppables:zo(t.droppables,e)}),tv=({draggable:t,offset:e,initialWindowScroll:n})=>{const i=$i(t.client,e),r=Gi(i,n);return{...t,placeholder:{...t.placeholder,client:i},client:i,page:r}},nv=t=>{const e=t.frame;return e||L(),e},iv=({additions:t,updatedDroppables:e,viewport:n})=>{const i=n.scroll.diff.value;return t.map(r=>{const s=r.descriptor.droppableId,o=e[s],c=nv(o).scroll.diff.value,l=pe(i,c);return tv({draggable:r,offset:l,initialWindowScroll:n.scroll.initial})})},rv=({state:t,published:e})=>{const n=e.modified.map(v=>{const T=t.dimensions.droppables[v.droppableId];return Vo(T,v.scroll)}),i={...t.dimensions.droppables,...Ou(n)},r=_u(iv({additions:e.additions,updatedDroppables:i,viewport:t.viewport})),s={...t.dimensions.draggables,...r};e.removals.forEach(v=>{delete s[v]});const o={droppables:i,draggables:s},a=Ie(t.impact),c=a?o.droppables[a]:null,l=o.draggables[t.critical.draggable.id],u=o.droppables[t.critical.droppable.id],{impact:d,afterCritical:h}=Ju({draggable:l,home:u,draggables:s,viewport:t.viewport}),f=c&&c.isCombineEnabled?t.impact:d,g=qu({pageOffset:t.current.page.offset,draggable:o.draggables[t.critical.draggable.id],draggables:o.draggables,droppables:o.droppables,previousImpact:f,viewport:t.viewport,afterCritical:h}),m={...t,phase:"DRAGGING",impact:g,onLiftImpact:d,dimensions:o,afterCritical:h,forceShouldAnimate:!1};return t.phase==="COLLECTING"?m:{...m,phase:"DROP_PENDING",reason:t.reason,isWaiting:!1}};const Fs=t=>t.movementMode==="SNAP",ss=(t,e,n)=>{const i=ev(t.dimensions,e);return!Fs(t)||n?Bn({state:t,dimensions:i}):Ku({state:t,dimensions:i})};function os(t){return t.isDragging&&t.movementMode==="SNAP"?{...t,scrollJumpRequest:null}:t}const pc={phase:"IDLE",completed:null,shouldFlush:!1};var sv=(t=pc,e)=>{if(e.type==="FLUSH")return{...pc,shouldFlush:!0};if(e.type==="INITIAL_PUBLISH"){t.phase!=="IDLE"&&L();const{critical:n,clientSelection:i,viewport:r,dimensions:s,movementMode:o}=e.payload,a=s.draggables[n.draggable.id],c=s.droppables[n.droppable.id],l={selection:i,borderBoxCenter:a.client.borderBox.center,offset:ue},u={client:l,page:{selection:pe(l.selection,r.scroll.initial),borderBoxCenter:pe(l.selection,r.scroll.initial),offset:pe(l.selection,r.scroll.diff.value)}},d=Ir(s.droppables).every(m=>!m.isFixedOnPage),{impact:h,afterCritical:f}=Ju({draggable:a,home:c,draggables:s.draggables,viewport:r});return{phase:"DRAGGING",isDragging:!0,critical:n,movementMode:o,dimensions:s,initial:u,current:u,isWindowScrollAllowed:d,impact:h,afterCritical:f,onLiftImpact:h,viewport:r,scrollJumpRequest:null,forceShouldAnimate:null}}if(e.type==="COLLECTION_STARTING")return t.phase==="COLLECTING"||t.phase==="DROP_PENDING"?t:(t.phase!=="DRAGGING"&&L(),{...t,phase:"COLLECTING"});if(e.type==="PUBLISH_WHILE_DRAGGING")return t.phase==="COLLECTING"||t.phase==="DROP_PENDING"||L(),rv({state:t,published:e.payload});if(e.type==="MOVE"){if(t.phase==="DROP_PENDING")return t;Lt(t)||L();const{client:n}=e.payload;return wt(n,t.current.client.selection)?t:Bn({state:t,clientSelection:n,impact:Fs(t)?t.impact:null})}if(e.type==="UPDATE_DROPPABLE_SCROLL"){if(t.phase==="DROP_PENDING"||t.phase==="COLLECTING")return os(t);Lt(t)||L();const{id:n,newScroll:i}=e.payload,r=t.dimensions.droppables[n];if(!r)return t;const s=Vo(r,i);return ss(t,s,!1)}if(e.type==="UPDATE_DROPPABLE_IS_ENABLED"){if(t.phase==="DROP_PENDING")return t;Lt(t)||L();const{id:n,isEnabled:i}=e.payload,r=t.dimensions.droppables[n];r||L(),r.isEnabled===i&&L();const s={...r,isEnabled:i};return ss(t,s,!0)}if(e.type==="UPDATE_DROPPABLE_IS_COMBINE_ENABLED"){if(t.phase==="DROP_PENDING")return t;Lt(t)||L();const{id:n,isCombineEnabled:i}=e.payload,r=t.dimensions.droppables[n];r||L(),r.isCombineEnabled===i&&L();const s={...r,isCombineEnabled:i};return ss(t,s,!0)}if(e.type==="MOVE_BY_WINDOW_SCROLL"){if(t.phase==="DROP_PENDING"||t.phase==="DROP_ANIMATING")return t;Lt(t)||L(),t.isWindowScrollAllowed||L();const n=e.payload.newScroll;if(wt(t.viewport.scroll.current,n))return os(t);const i=Fu(t.viewport,n);return Fs(t)?Ku({state:t,viewport:i}):Bn({state:t,viewport:i})}if(e.type==="UPDATE_VIEWPORT_MAX_SCROLL"){if(!Lt(t))return t;const n=e.payload.maxScroll;if(wt(n,t.viewport.scroll.max))return t;const i={...t.viewport,scroll:{...t.viewport.scroll,max:n}};return{...t,viewport:i}}if(e.type==="MOVE_UP"||e.type==="MOVE_DOWN"||e.type==="MOVE_LEFT"||e.type==="MOVE_RIGHT"){if(t.phase==="COLLECTING"||t.phase==="DROP_PENDING")return t;t.phase!=="DRAGGING"&&L();const n=Vg({state:t,type:e.type});return n?Bn({state:t,impact:n.impact,clientSelection:n.clientSelection,scrollJumpRequest:n.scrollJumpRequest}):t}if(e.type==="DROP_PENDING"){const n=e.payload.reason;return t.phase!=="COLLECTING"&&L(),{...t,phase:"DROP_PENDING",isWaiting:!0,reason:n}}if(e.type==="DROP_ANIMATE"){const{completed:n,dropDuration:i,newHomeClientOffset:r}=e.payload;return t.phase==="DRAGGING"||t.phase==="DROP_PENDING"||L(),{phase:"DROP_ANIMATING",completed:n,dropDuration:i,newHomeClientOffset:r,dimensions:t.dimensions}}if(e.type==="DROP_COMPLETE"){const{completed:n}=e.payload;return{phase:"IDLE",completed:n,shouldFlush:!1}}return t};const ov=t=>({type:"BEFORE_INITIAL_CAPTURE",payload:t}),av=t=>({type:"LIFT",payload:t}),cv=t=>({type:"INITIAL_PUBLISH",payload:t}),lv=t=>({type:"PUBLISH_WHILE_DRAGGING",payload:t}),uv=()=>({type:"COLLECTION_STARTING",payload:null}),dv=t=>({type:"UPDATE_DROPPABLE_SCROLL",payload:t}),hv=t=>({type:"UPDATE_DROPPABLE_IS_ENABLED",payload:t}),fv=t=>({type:"UPDATE_DROPPABLE_IS_COMBINE_ENABLED",payload:t}),Yu=t=>({type:"MOVE",payload:t}),pv=t=>({type:"MOVE_BY_WINDOW_SCROLL",payload:t}),mv=t=>({type:"UPDATE_VIEWPORT_MAX_SCROLL",payload:t}),gv=()=>({type:"MOVE_UP",payload:null}),vv=()=>({type:"MOVE_DOWN",payload:null}),bv=()=>({type:"MOVE_RIGHT",payload:null}),yv=()=>({type:"MOVE_LEFT",payload:null}),Ko=()=>({type:"FLUSH",payload:null}),kv=t=>({type:"DROP_ANIMATE",payload:t}),Jo=t=>({type:"DROP_COMPLETE",payload:t}),Qu=t=>({type:"DROP",payload:t}),Sv=t=>({type:"DROP_PENDING",payload:t}),Xu=()=>({type:"DROP_ANIMATION_FINISHED",payload:null});var Cv=t=>({getState:e,dispatch:n})=>i=>r=>{if(r.type!=="LIFT"){i(r);return}const{id:s,clientSelection:o,movementMode:a}=r.payload,c=e();c.phase==="DROP_ANIMATING"&&n(Jo({completed:c.completed})),e().phase!=="IDLE"&&L(),n(Ko()),n(ov({draggableId:s,movementMode:a}));const u={draggableId:s,scrollOptions:{shouldPublishImmediately:a==="SNAP"}},{critical:d,dimensions:h,viewport:f}=t.startPublishing(u);n(cv({critical:d,dimensions:h,clientSelection:o,movementMode:a,viewport:f}))},Tv=t=>()=>e=>n=>{n.type==="INITIAL_PUBLISH"&&t.dragging(),n.type==="DROP_ANIMATE"&&t.dropping(n.payload.completed.result.reason),(n.type==="FLUSH"||n.type==="DROP_COMPLETE")&&t.resting(),e(n)};const Yo={outOfTheWay:"cubic-bezier(0.2, 0, 0, 1)",drop:"cubic-bezier(.2,1,.1,1)"},Qn={opacity:{drop:0,combining:.7},scale:{drop:.75}},Zu={outOfTheWay:.2,minDropTime:.33,maxDropTime:.55},Mt=`${Zu.outOfTheWay}s ${Yo.outOfTheWay}`,jn={fluid:`opacity ${Mt}`,snap:`transform ${Mt}, opacity ${Mt}`,drop:t=>{const e=`${t}s ${Yo.drop}`;return`transform ${e}, opacity ${e}`},outOfTheWay:`transform ${Mt}`,placeholder:`height ${Mt}, width ${Mt}, margin ${Mt}`},mc=t=>wt(t,ue)?void 0:`translate(${t.x}px, ${t.y}px)`,Bs={moveTo:mc,drop:(t,e)=>{const n=mc(t);if(n)return e?`${n} scale(${Qn.scale.drop})`:n}},{minDropTime:js,maxDropTime:ed}=Zu,Ev=ed-js,gc=1500,wv=.6;var Pv=({current:t,destination:e,reason:n})=>{const i=Kn(t,e);if(i<=0)return js;if(i>=gc)return ed;const r=i/gc,s=js+Ev*r,o=n==="CANCEL"?s*wv:s;return Number(o.toFixed(2))},xv=({impact:t,draggable:e,dimensions:n,viewport:i,afterCritical:r})=>{const{draggables:s,droppables:o}=n,a=Ie(t),c=a?o[a]:null,l=o[e.descriptor.droppableId],u=zu({impact:t,draggable:e,draggables:s,afterCritical:r,droppable:c||l,viewport:i});return xe(u,e.client.borderBox.center)},Rv=({draggables:t,reason:e,lastImpact:n,home:i,viewport:r,onLiftImpact:s})=>!n.at||e!=="DROP"?{impact:Hu({draggables:t,impact:s,destination:i,viewport:r,forceShouldAnimate:!0}),didDropInsideDroppable:!1}:n.at.type==="REORDER"?{impact:n,didDropInsideDroppable:!0}:{impact:{...n,displaced:Jn},didDropInsideDroppable:!0};const Iv=({getState:t,dispatch:e})=>n=>i=>{if(i.type!=="DROP"){n(i);return}const r=t(),s=i.payload.reason;if(r.phase==="COLLECTING"){e(Sv({reason:s}));return}if(r.phase==="IDLE")return;r.phase==="DROP_PENDING"&&r.isWaiting&&L(),r.phase==="DRAGGING"||r.phase==="DROP_PENDING"||L();const a=r.critical,c=r.dimensions,l=c.draggables[r.critical.draggable.id],{impact:u,didDropInsideDroppable:d}=Rv({reason:s,lastImpact:r.impact,afterCritical:r.afterCritical,onLiftImpact:r.onLiftImpact,home:r.dimensions.droppables[r.critical.droppable.id],viewport:r.viewport,draggables:r.dimensions.draggables}),h=d?$o(u):null,f=d?Dr(u):null,g={index:a.draggable.index,droppableId:a.droppable.id},m={draggableId:l.descriptor.id,type:l.descriptor.type,source:g,reason:s,mode:r.movementMode,destination:h,combine:f},b=xv({impact:u,draggable:l,dimensions:c,viewport:r.viewport,afterCritical:r.afterCritical}),v={critical:r.critical,afterCritical:r.afterCritical,result:m,impact:u};if(!(!wt(r.current.client.offset,b)||!!m.combine)){e(Jo({completed:v}));return}const E=Pv({current:r.current.client.offset,destination:b,reason:s});e(kv({newHomeClientOffset:b,dropDuration:E,completed:v}))};var Dv=Iv,td=()=>({x:window.pageXOffset,y:window.pageYOffset});function Ov(t){return{eventName:"scroll",options:{passive:!0,capture:!1},fn:e=>{e.target!==window&&e.target!==window.document||t()}}}function _v({onWindowScroll:t}){function e(){t(td())}const n=zn(e),i=Ov(n);let r=Et;function s(){return r!==Et}function o(){s()&&L(),r=Fe(window,[i])}function a(){s()||L(),n.cancel(),r(),r=Et}return{start:o,stop:a,isActive:s}}const Av=t=>t.type==="DROP_COMPLETE"||t.type==="DROP_ANIMATE"||t.type==="FLUSH",Nv=t=>{const e=_v({onWindowScroll:n=>{t.dispatch(pv({newScroll:n}))}});return n=>i=>{!e.isActive()&&i.type==="INITIAL_PUBLISH"&&e.start(),e.isActive()&&Av(i)&&e.stop(),n(i)}};var Mv=Nv,Lv=t=>{let e=!1,n=!1;const i=setTimeout(()=>{n=!0}),r=s=>{e||n||(e=!0,t(s),clearTimeout(i))};return r.wasCalled=()=>e,r},Uv=()=>{const t=[],e=r=>{const s=t.findIndex(a=>a.timerId===r);s===-1&&L();const[o]=t.splice(s,1);o.callback()};return{add:r=>{const s=setTimeout(()=>e(s)),o={timerId:s,callback:r};t.push(o)},flush:()=>{if(!t.length)return;const r=[...t];t.length=0,r.forEach(s=>{clearTimeout(s.timerId),s.callback()})}}};const Fv=(t,e)=>t==null&&e==null?!0:t==null||e==null?!1:t.droppableId===e.droppableId&&t.index===e.index,Bv=(t,e)=>t==null&&e==null?!0:t==null||e==null?!1:t.draggableId===e.draggableId&&t.droppableId===e.droppableId,jv=(t,e)=>{if(t===e)return!0;const n=t.draggable.id===e.draggable.id&&t.draggable.droppableId===e.draggable.droppableId&&t.draggable.type===e.draggable.type&&t.draggable.index===e.draggable.index,i=t.droppable.id===e.droppable.id&&t.droppable.type===e.droppable.type;return n&&i},In=(t,e)=>{e()},vi=(t,e)=>({draggableId:t.draggable.id,type:t.droppable.type,source:{droppableId:t.droppable.id,index:t.draggable.index},mode:e});function as(t,e,n,i){if(!t){n(i(e));return}const r=Lv(n);t(e,{announce:r}),r.wasCalled()||n(i(e))}var Vv=(t,e)=>{const n=Uv();let i=null;const r=(d,h)=>{i&&L(),In("onBeforeCapture",()=>{const f=t().onBeforeCapture;f&&f({draggableId:d,mode:h})})},s=(d,h)=>{i&&L(),In("onBeforeDragStart",()=>{const f=t().onBeforeDragStart;f&&f(vi(d,h))})},o=(d,h)=>{i&&L();const f=vi(d,h);i={mode:h,lastCritical:d,lastLocation:f.source,lastCombine:null},n.add(()=>{In("onDragStart",()=>as(t().onDragStart,f,e,wi.onDragStart))})},a=(d,h)=>{const f=$o(h),g=Dr(h);i||L();const m=!jv(d,i.lastCritical);m&&(i.lastCritical=d);const b=!Fv(i.lastLocation,f);b&&(i.lastLocation=f);const v=!Bv(i.lastCombine,g);if(v&&(i.lastCombine=g),!m&&!b&&!v)return;const T={...vi(d,i.mode),combine:g,destination:f};n.add(()=>{In("onDragUpdate",()=>as(t().onDragUpdate,T,e,wi.onDragUpdate))})},c=()=>{i||L(),n.flush()},l=d=>{i||L(),i=null,In("onDragEnd",()=>as(t().onDragEnd,d,e,wi.onDragEnd))};return{beforeCapture:r,beforeStart:s,start:o,update:a,flush:c,drop:l,abort:()=>{if(!i)return;const d={...vi(i.lastCritical,i.mode),combine:null,destination:null,reason:"CANCEL"};l(d)}}},$v=(t,e)=>{const n=Vv(t,e);return i=>r=>s=>{if(s.type==="BEFORE_INITIAL_CAPTURE"){n.beforeCapture(s.payload.draggableId,s.payload.movementMode);return}if(s.type==="INITIAL_PUBLISH"){const a=s.payload.critical;n.beforeStart(a,s.payload.movementMode),r(s),n.start(a,s.payload.movementMode);return}if(s.type==="DROP_COMPLETE"){const a=s.payload.completed.result;n.flush(),r(s),n.drop(a);return}if(r(s),s.type==="FLUSH"){n.abort();return}const o=i.getState();o.phase==="DRAGGING"&&n.update(o.critical,o.impact)}};const Gv=t=>e=>n=>{if(n.type!=="DROP_ANIMATION_FINISHED"){e(n);return}const i=t.getState();i.phase!=="DROP_ANIMATING"&&L(),t.dispatch(Jo({completed:i.completed}))};var Wv=Gv;const qv=t=>{let e=null,n=null;function i(){n&&(cancelAnimationFrame(n),n=null),e&&(e(),e=null)}return r=>s=>{if((s.type==="FLUSH"||s.type==="DROP_COMPLETE"||s.type==="DROP_ANIMATION_FINISHED")&&i(),r(s),s.type!=="DROP_ANIMATE")return;const o={eventName:"scroll",options:{capture:!0,passive:!1,once:!0},fn:function(){t.getState().phase==="DROP_ANIMATING"&&t.dispatch(Xu())}};n=requestAnimationFrame(()=>{n=null,e=Fe(window,[o])})}};var Hv=qv,zv=t=>()=>e=>n=>{(n.type==="DROP_COMPLETE"||n.type==="FLUSH"||n.type==="DROP_ANIMATE")&&t.stopPublishing(),e(n)},Kv=t=>{let e=!1;return()=>n=>i=>{if(i.type==="INITIAL_PUBLISH"){e=!0,t.tryRecordFocus(i.payload.critical.draggable.id),n(i),t.tryRestoreFocusRecorded();return}if(n(i),!!e){if(i.type==="FLUSH"){e=!1,t.tryRestoreFocusRecorded();return}if(i.type==="DROP_COMPLETE"){e=!1;const r=i.payload.completed.result;r.combine&&t.tryShiftRecord(r.draggableId,r.combine.draggableId),t.tryRestoreFocusRecorded()}}}};const Jv=t=>t.type==="DROP_COMPLETE"||t.type==="DROP_ANIMATE"||t.type==="FLUSH";var Yv=t=>e=>n=>i=>{if(Jv(i)){t.stop(),n(i);return}if(i.type==="INITIAL_PUBLISH"){n(i);const r=e.getState();r.phase!=="DRAGGING"&&L(),t.start(r);return}n(i),t.scroll(e.getState())};const Qv=t=>e=>n=>{if(e(n),n.type!=="PUBLISH_WHILE_DRAGGING")return;const i=t.getState();i.phase==="DROP_PENDING"&&(i.isWaiting||t.dispatch(Qu({reason:i.reason})))};var Xv=Qv;const Zv=au;var eb=({dimensionMarshal:t,focusMarshal:e,styleMarshal:n,getResponders:i,announce:r,autoScroller:s})=>ou(sv,Zv(Ap(Tv(n),zv(t),Cv(t),Dv,Wv,Hv,Xv,Yv(s),Mv,Kv(e),$v(i,r))));const cs=()=>({additions:{},removals:{},modified:{}});function tb({registry:t,callbacks:e}){let n=cs(),i=null;const r=()=>{i||(e.collectionStarting(),i=requestAnimationFrame(()=>{i=null;const{additions:c,removals:l,modified:u}=n,d=Object.keys(c).map(g=>t.draggable.getById(g).getDimension(ue)).sort((g,m)=>g.descriptor.index-m.descriptor.index),h=Object.keys(u).map(g=>{const b=t.droppable.getById(g).callbacks.getScrollWhileDragging();return{droppableId:g,scroll:b}}),f={additions:d,removals:Object.keys(l),modified:h};n=cs(),e.publish(f)}))};return{add:c=>{const l=c.descriptor.id;n.additions[l]=c,n.modified[c.descriptor.droppableId]=!0,n.removals[l]&&delete n.removals[l],r()},remove:c=>{const l=c.descriptor;n.removals[l.id]=!0,n.modified[l.droppableId]=!0,n.additions[l.id]&&delete n.additions[l.id],r()},stop:()=>{i&&(cancelAnimationFrame(i),i=null,n=cs())}}}var nd=({scrollHeight:t,scrollWidth:e,height:n,width:i})=>{const r=xe({x:e,y:t},{x:i,y:n});return{x:Math.max(0,r.x),y:Math.max(0,r.y)}},id=()=>{const t=document.documentElement;return t||L(),t},rd=()=>{const t=id();return nd({scrollHeight:t.scrollHeight,scrollWidth:t.scrollWidth,width:t.clientWidth,height:t.clientHeight})},nb=()=>{const t=td(),e=rd(),n=t.y,i=t.x,r=id(),s=r.clientWidth,o=r.clientHeight,a=i+s,c=n+o;return{frame:Ke({top:n,left:i,right:a,bottom:c}),scroll:{initial:t,current:t,max:e,diff:{value:ue,displacement:ue}}}},ib=({critical:t,scrollOptions:e,registry:n})=>{const i=nb(),r=i.scroll.current,s=t.droppable,o=n.droppable.getAllByType(s.type).map(u=>u.callbacks.getDimensionAndWatchScroll(r,e)),a=n.draggable.getAllByType(t.draggable.type).map(u=>u.getDimension(r));return{dimensions:{draggables:_u(a),droppables:Ou(o)},critical:t,viewport:i}};function vc(t,e,n){return!(n.descriptor.id===e.id||n.descriptor.type!==e.type||t.droppable.getById(n.descriptor.droppableId).descriptor.mode!=="virtual")}var rb=(t,e)=>{let n=null;const i=tb({callbacks:{publish:e.publishWhileDragging,collectionStarting:e.collectionStarting},registry:t}),r=(h,f)=>{t.droppable.exists(h)||L(),n&&e.updateDroppableIsEnabled({id:h,isEnabled:f})},s=(h,f)=>{n&&(t.droppable.exists(h)||L(),e.updateDroppableIsCombineEnabled({id:h,isCombineEnabled:f}))},o=(h,f)=>{n&&(t.droppable.exists(h)||L(),e.updateDroppableScroll({id:h,newScroll:f}))},a=(h,f)=>{n&&t.droppable.getById(h).callbacks.scroll(f)},c=()=>{if(!n)return;i.stop();const h=n.critical.droppable;t.droppable.getAllByType(h.type).forEach(f=>f.callbacks.dragStopped()),n.unsubscribe(),n=null},l=h=>{n||L();const f=n.critical.draggable;h.type==="ADDITION"&&vc(t,f,h.value)&&i.add(h.value),h.type==="REMOVAL"&&vc(t,f,h.value)&&i.remove(h.value)};return{updateDroppableIsEnabled:r,updateDroppableIsCombineEnabled:s,scrollDroppable:a,updateDroppableScroll:o,startPublishing:h=>{n&&L();const f=t.draggable.getById(h.draggableId),g=t.droppable.getById(f.descriptor.droppableId),m={draggable:f.descriptor,droppable:g.descriptor},b=t.subscribe(l);return n={critical:m,unsubscribe:b},ib({critical:m,registry:t,scrollOptions:h.scrollOptions})},stopPublishing:c}},sd=(t,e)=>t.phase==="IDLE"?!0:t.phase!=="DROP_ANIMATING"||t.completed.result.draggableId===e?!1:t.completed.result.reason==="DROP",sb=t=>{window.scrollBy(t.x,t.y)};const ob=le(t=>Ir(t).filter(e=>!(!e.isEnabled||!e.frame))),ab=(t,e)=>ob(e).find(i=>(i.frame||L(),$u(i.frame.pageMarginBox)(t)))||null;var cb=({center:t,destination:e,droppables:n})=>{if(e){const r=n[e];return r.frame?r:null}return ab(t,n)};const Xn={startFromPercentage:.25,maxScrollAtPercentage:.05,maxPixelScroll:28,ease:t=>t**2,durationDampening:{stopDampeningAt:1200,accelerateAt:360},disabled:!1};var lb=(t,e,n=()=>Xn)=>{const i=n(),r=t[e.size]*i.startFromPercentage,s=t[e.size]*i.maxScrollAtPercentage;return{startScrollingFrom:r,maxScrollValueAt:s}},od=({startOfRange:t,endOfRange:e,current:n})=>{const i=e-t;return i===0?0:(n-t)/i},Qo=1,ub=(t,e,n=()=>Xn)=>{const i=n();if(t>e.startScrollingFrom)return 0;if(t<=e.maxScrollValueAt)return i.maxPixelScroll;if(t===e.startScrollingFrom)return Qo;const s=1-od({startOfRange:e.maxScrollValueAt,endOfRange:e.startScrollingFrom,current:t}),o=i.maxPixelScroll*i.ease(s);return Math.ceil(o)},db=(t,e,n)=>{const i=n(),r=i.durationDampening.accelerateAt,s=i.durationDampening.stopDampeningAt,o=e,a=s,l=Date.now()-o;if(l>=s)return t;if(l<r)return Qo;const u=od({startOfRange:r,endOfRange:a,current:l}),d=t*i.ease(u);return Math.ceil(d)},bc=({distanceToEdge:t,thresholds:e,dragStartTime:n,shouldUseTimeDampening:i,getAutoScrollerOptions:r})=>{const s=ub(t,e,r);return s===0?0:i?Math.max(db(s,n,r),Qo):s},yc=({container:t,distanceToEdges:e,dragStartTime:n,axis:i,shouldUseTimeDampening:r,getAutoScrollerOptions:s})=>{const o=lb(t,i,s);return e[i.end]<e[i.start]?bc({distanceToEdge:e[i.end],thresholds:o,dragStartTime:n,shouldUseTimeDampening:r,getAutoScrollerOptions:s}):-1*bc({distanceToEdge:e[i.start],thresholds:o,dragStartTime:n,shouldUseTimeDampening:r,getAutoScrollerOptions:s})},hb=({container:t,subject:e,proposedScroll:n})=>{const i=e.height>t.height,r=e.width>t.width;return!r&&!i?n:r&&i?null:{x:r?0:n.x,y:i?0:n.y}};const fb=Du(t=>t===0?0:t);var ad=({dragStartTime:t,container:e,subject:n,center:i,shouldUseTimeDampening:r,getAutoScrollerOptions:s})=>{const o={top:i.y-e.top,right:e.right-i.x,bottom:e.bottom-i.y,left:i.x-e.left},a=yc({container:e,distanceToEdges:o,dragStartTime:t,axis:Go,shouldUseTimeDampening:r,getAutoScrollerOptions:s}),c=yc({container:e,distanceToEdges:o,dragStartTime:t,axis:Mu,shouldUseTimeDampening:r,getAutoScrollerOptions:s}),l=fb({x:c,y:a});if(wt(l,ue))return null;const u=hb({container:e,subject:n,proposedScroll:l});return u?wt(u,ue)?null:u:null};const pb=Du(t=>t===0?0:t>0?1:-1),Xo=(()=>{const t=(e,n)=>e<0?e:e>n?e-n:0;return({current:e,max:n,change:i})=>{const r=pe(e,i),s={x:t(r.x,n.x),y:t(r.y,n.y)};return wt(s,ue)?null:s}})(),cd=({max:t,current:e,change:n})=>{const i={x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)},r=pb(n),s=Xo({max:i,current:e,change:r});return!s||r.x!==0&&s.x===0||r.y!==0&&s.y===0},Zo=(t,e)=>cd({current:t.scroll.current,max:t.scroll.max,change:e}),mb=(t,e)=>{if(!Zo(t,e))return null;const n=t.scroll.max,i=t.scroll.current;return Xo({current:i,max:n,change:e})},ea=(t,e)=>{const n=t.frame;return n?cd({current:n.scroll.current,max:n.scroll.max,change:e}):!1},gb=(t,e)=>{const n=t.frame;return!n||!ea(t,e)?null:Xo({current:n.scroll.current,max:n.scroll.max,change:e})};var vb=({viewport:t,subject:e,center:n,dragStartTime:i,shouldUseTimeDampening:r,getAutoScrollerOptions:s})=>{const o=ad({dragStartTime:i,container:t.frame,subject:e,center:n,shouldUseTimeDampening:r,getAutoScrollerOptions:s});return o&&Zo(t,o)?o:null},bb=({droppable:t,subject:e,center:n,dragStartTime:i,shouldUseTimeDampening:r,getAutoScrollerOptions:s})=>{const o=t.frame;if(!o)return null;const a=ad({dragStartTime:i,container:o.pageMarginBox,subject:e,center:n,shouldUseTimeDampening:r,getAutoScrollerOptions:s});return a&&ea(t,a)?a:null},kc=({state:t,dragStartTime:e,shouldUseTimeDampening:n,scrollWindow:i,scrollDroppable:r,getAutoScrollerOptions:s})=>{const o=t.current.page.borderBoxCenter,c=t.dimensions.draggables[t.critical.draggable.id].page.marginBox;if(t.isWindowScrollAllowed){const d=t.viewport,h=vb({dragStartTime:e,viewport:d,subject:c,center:o,shouldUseTimeDampening:n,getAutoScrollerOptions:s});if(h){i(h);return}}const l=cb({center:o,destination:Ie(t.impact),droppables:t.dimensions.droppables});if(!l)return;const u=bb({dragStartTime:e,droppable:l,subject:c,center:o,shouldUseTimeDampening:n,getAutoScrollerOptions:s});u&&r(l.descriptor.id,u)},yb=({scrollWindow:t,scrollDroppable:e,getAutoScrollerOptions:n=()=>Xn})=>{const i=zn(t),r=zn(e);let s=null;const o=l=>{s||L();const{shouldUseTimeDampening:u,dragStartTime:d}=s;kc({state:l,scrollWindow:i,scrollDroppable:r,dragStartTime:d,shouldUseTimeDampening:u,getAutoScrollerOptions:n})};return{start:l=>{s&&L();const u=Date.now();let d=!1;const h=()=>{d=!0};kc({state:l,dragStartTime:0,shouldUseTimeDampening:!1,scrollWindow:h,scrollDroppable:h,getAutoScrollerOptions:n}),s={dragStartTime:u,shouldUseTimeDampening:d},d&&o(l)},stop:()=>{s&&(i.cancel(),r.cancel(),s=null)},scroll:o}},kb=({move:t,scrollDroppable:e,scrollWindow:n})=>{const i=(a,c)=>{const l=pe(a.current.client.selection,c);t({client:l})},r=(a,c)=>{if(!ea(a,c))return c;const l=gb(a,c);if(!l)return e(a.descriptor.id,c),null;const u=xe(c,l);return e(a.descriptor.id,u),xe(c,u)},s=(a,c,l)=>{if(!a||!Zo(c,l))return l;const u=mb(c,l);if(!u)return n(l),null;const d=xe(l,u);return n(d),xe(l,d)};return a=>{const c=a.scrollJumpRequest;if(!c)return;const l=Ie(a.impact);l||L();const u=r(a.dimensions.droppables[l],c);if(!u)return;const d=a.viewport,h=s(a.isWindowScrollAllowed,d,u);h&&i(a,h)}},Sb=({scrollDroppable:t,scrollWindow:e,move:n,getAutoScrollerOptions:i})=>{const r=yb({scrollWindow:e,scrollDroppable:t,getAutoScrollerOptions:i}),s=kb({move:n,scrollWindow:e,scrollDroppable:t});return{scroll:c=>{if(!(i().disabled||c.phase!=="DRAGGING")){if(c.movementMode==="FLUID"){r.scroll(c);return}c.scrollJumpRequest&&s(c)}},start:r.start,stop:r.stop}};const hn="data-rfd",fn=(()=>{const t=`${hn}-drag-handle`;return{base:t,draggableId:`${t}-draggable-id`,contextId:`${t}-context-id`}})(),Vs=(()=>{const t=`${hn}-draggable`;return{base:t,contextId:`${t}-context-id`,id:`${t}-id`}})(),Cb=(()=>{const t=`${hn}-droppable`;return{base:t,contextId:`${t}-context-id`,id:`${t}-id`}})(),Sc={contextId:`${hn}-scroll-container-context-id`},Tb=t=>e=>`[${e}="${t}"]`,Dn=(t,e)=>t.map(n=>{const i=n.styles[e];return i?`${n.selector} { ${i} }`:""}).join(" "),Eb="pointer-events: none;";var wb=t=>{const e=Tb(t),n=(()=>{const a=`
      cursor: -webkit-grab;
      cursor: grab;
    `;return{selector:e(fn.contextId),styles:{always:`
          -webkit-touch-callout: none;
          -webkit-tap-highlight-color: rgba(0,0,0,0);
          touch-action: manipulation;
        `,resting:a,dragging:Eb,dropAnimating:a}}})(),i=(()=>{const a=`
      transition: ${jn.outOfTheWay};
    `;return{selector:e(Vs.contextId),styles:{dragging:a,dropAnimating:a,userCancel:a}}})(),r={selector:e(Cb.contextId),styles:{always:"overflow-anchor: none;"}},o=[i,n,r,{selector:"body",styles:{dragging:`
        cursor: grabbing;
        cursor: -webkit-grabbing;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        overflow-anchor: none;
      `}}];return{always:Dn(o,"always"),resting:Dn(o,"resting"),dragging:Dn(o,"dragging"),dropAnimating:Dn(o,"dropAnimating"),userCancel:Dn(o,"userCancel")}};const Pb=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u"?p.useLayoutEffect:p.useEffect;var De=Pb;const ls=()=>{const t=document.querySelector("head");return t||L(),t},Cc=t=>{const e=document.createElement("style");return t&&e.setAttribute("nonce",t),e.type="text/css",e};function xb(t,e){const n=$(()=>wb(t),[t]),i=p.useRef(null),r=p.useRef(null),s=j(le(d=>{const h=r.current;h||L(),h.textContent=d}),[]),o=j(d=>{const h=i.current;h||L(),h.textContent=d},[]);De(()=>{!i.current&&!r.current||L();const d=Cc(e),h=Cc(e);return i.current=d,r.current=h,d.setAttribute(`${hn}-always`,t),h.setAttribute(`${hn}-dynamic`,t),ls().appendChild(d),ls().appendChild(h),o(n.always),s(n.resting),()=>{const f=g=>{const m=g.current;m||L(),ls().removeChild(m),g.current=null};f(i),f(r)}},[e,o,s,n.always,n.resting,t]);const a=j(()=>s(n.dragging),[s,n.dragging]),c=j(d=>{if(d==="DROP"){s(n.dropAnimating);return}s(n.userCancel)},[s,n.dropAnimating,n.userCancel]),l=j(()=>{r.current&&s(n.resting)},[s,n.resting]);return $(()=>({dragging:a,dropping:c,resting:l}),[a,c,l])}function ld(t,e){return Array.from(t.querySelectorAll(e))}var ud=t=>t&&t.ownerDocument&&t.ownerDocument.defaultView?t.ownerDocument.defaultView:window;function Ar(t){return t instanceof ud(t).HTMLElement}function Rb(t,e){const n=`[${fn.contextId}="${t}"]`,i=ld(document,n);if(!i.length)return null;const r=i.find(s=>s.getAttribute(fn.draggableId)===e);return!r||!Ar(r)?null:r}function Ib(t){const e=p.useRef({}),n=p.useRef(null),i=p.useRef(null),r=p.useRef(!1),s=j(function(h,f){const g={id:h,focus:f};return e.current[h]=g,function(){const b=e.current;b[h]!==g&&delete b[h]}},[]),o=j(function(h){const f=Rb(t,h);f&&f!==document.activeElement&&f.focus()},[t]),a=j(function(h,f){n.current===h&&(n.current=f)},[]),c=j(function(){i.current||r.current&&(i.current=requestAnimationFrame(()=>{i.current=null;const h=n.current;h&&o(h)}))},[o]),l=j(function(h){n.current=null;const f=document.activeElement;f&&f.getAttribute(fn.draggableId)===h&&(n.current=h)},[]);return De(()=>(r.current=!0,function(){r.current=!1;const h=i.current;h&&cancelAnimationFrame(h)}),[]),$(()=>({register:s,tryRecordFocus:l,tryRestoreFocusRecorded:c,tryShiftRecord:a}),[s,l,c,a])}function Db(){const t={draggables:{},droppables:{}},e=[];function n(d){return e.push(d),function(){const f=e.indexOf(d);f!==-1&&e.splice(f,1)}}function i(d){e.length&&e.forEach(h=>h(d))}function r(d){return t.draggables[d]||null}function s(d){const h=r(d);return h||L(),h}const o={register:d=>{t.draggables[d.descriptor.id]=d,i({type:"ADDITION",value:d})},update:(d,h)=>{const f=t.draggables[h.descriptor.id];f&&f.uniqueId===d.uniqueId&&(delete t.draggables[h.descriptor.id],t.draggables[d.descriptor.id]=d)},unregister:d=>{const h=d.descriptor.id,f=r(h);f&&d.uniqueId===f.uniqueId&&(delete t.draggables[h],t.droppables[d.descriptor.droppableId]&&i({type:"REMOVAL",value:d}))},getById:s,findById:r,exists:d=>!!r(d),getAllByType:d=>Object.values(t.draggables).filter(h=>h.descriptor.type===d)};function a(d){return t.droppables[d]||null}function c(d){const h=a(d);return h||L(),h}const l={register:d=>{t.droppables[d.descriptor.id]=d},unregister:d=>{const h=a(d.descriptor.id);h&&d.uniqueId===h.uniqueId&&delete t.droppables[d.descriptor.id]},getById:c,findById:a,exists:d=>!!a(d),getAllByType:d=>Object.values(t.droppables).filter(h=>h.descriptor.type===d)};function u(){t.draggables={},t.droppables={},e.length=0}return{draggable:o,droppable:l,subscribe:n,clean:u}}function Ob(){const t=$(Db,[]);return p.useEffect(()=>function(){q.version.startsWith("16")||q.version.startsWith("17")?requestAnimationFrame(t.clean):t.clean()},[t]),t}var ta=q.createContext(null),zi=()=>{const t=document.body;return t||L(),t};const _b={position:"absolute",width:"1px",height:"1px",margin:"-1px",border:"0",padding:"0",overflow:"hidden",clip:"rect(0 0 0 0)","clip-path":"inset(100%)"};var Ab=_b;const Nb=t=>`rfd-announcement-${t}`;function Mb(t){const e=$(()=>Nb(t),[t]),n=p.useRef(null);return p.useEffect(function(){const s=document.createElement("div");return n.current=s,s.id=e,s.setAttribute("aria-live","assertive"),s.setAttribute("aria-atomic","true"),Tt(s.style,Ab),zi().appendChild(s),function(){setTimeout(function(){const c=zi();c.contains(s)&&c.removeChild(s),s===n.current&&(n.current=null)})}},[e]),j(r=>{const s=n.current;if(s){s.textContent=r;return}},[])}let Lb=0;const dd={separator:"::"};function Ub(t,e=dd){return $(()=>`${t}${e.separator}${Lb++}`,[e.separator,t])}function Fb(t,e=dd){const n=q.useId();return $(()=>`${t}${e.separator}${n}`,[e.separator,t,n])}var na="useId"in q?Fb:Ub;function Bb({contextId:t,uniqueId:e}){return`rfd-hidden-text-${t}-${e}`}function jb({contextId:t,text:e}){const n=na("hidden-text",{separator:"-"}),i=$(()=>Bb({contextId:t,uniqueId:n}),[n,t]);return p.useEffect(function(){const s=document.createElement("div");return s.id=i,s.textContent=e,s.style.display="none",zi().appendChild(s),function(){const a=zi();a.contains(s)&&a.removeChild(s)}},[i,e]),i}var Nr=q.createContext(null);function hd(t){const e=p.useRef(t);return p.useEffect(()=>{e.current=t}),e}function Vb(){let t=null;function e(){return!!t}function n(o){return o===t}function i(o){t&&L();const a={abandon:o};return t=a,a}function r(){t||L(),t=null}function s(){t&&(t.abandon(),r())}return{isClaimed:e,isActive:n,claim:i,release:r,tryAbandon:s}}function Zn(t){return t.phase==="IDLE"||t.phase==="DROP_ANIMATING"?!1:t.isDragging}const $b=9,Gb=13,ia=27,fd=32,Wb=33,qb=34,Hb=35,zb=36,Kb=37,Jb=38,Yb=39,Qb=40,Xb={[Gb]:!0,[$b]:!0};var pd=t=>{Xb[t.keyCode]&&t.preventDefault()};const Zb=(()=>{const t="visibilitychange";return typeof document>"u"?t:[t,`ms${t}`,`webkit${t}`,`moz${t}`,`o${t}`].find(i=>`on${i}`in document)||t})();var Mr=Zb;const md=0,Tc=5;function ey(t,e){return Math.abs(e.x-t.x)>=Tc||Math.abs(e.y-t.y)>=Tc}const Ec={type:"IDLE"};function ty({cancel:t,completed:e,getPhase:n,setPhase:i}){return[{eventName:"mousemove",fn:r=>{const{button:s,clientX:o,clientY:a}=r;if(s!==md)return;const c={x:o,y:a},l=n();if(l.type==="DRAGGING"){r.preventDefault(),l.actions.move(c);return}l.type!=="PENDING"&&L();const u=l.point;if(!ey(u,c))return;r.preventDefault();const d=l.actions.fluidLift(c);i({type:"DRAGGING",actions:d})}},{eventName:"mouseup",fn:r=>{const s=n();if(s.type!=="DRAGGING"){t();return}r.preventDefault(),s.actions.drop({shouldBlockNextClick:!0}),e()}},{eventName:"mousedown",fn:r=>{n().type==="DRAGGING"&&r.preventDefault(),t()}},{eventName:"keydown",fn:r=>{if(n().type==="PENDING"){t();return}if(r.keyCode===ia){r.preventDefault(),t();return}pd(r)}},{eventName:"resize",fn:t},{eventName:"scroll",options:{passive:!0,capture:!1},fn:()=>{n().type==="PENDING"&&t()}},{eventName:"webkitmouseforcedown",fn:r=>{const s=n();if(s.type==="IDLE"&&L(),s.actions.shouldRespectForcePress()){t();return}r.preventDefault()}},{eventName:Mr,fn:t}]}function ny(t){const e=p.useRef(Ec),n=p.useRef(Et),i=$(()=>({eventName:"mousedown",fn:function(d){if(d.defaultPrevented||d.button!==md||d.ctrlKey||d.metaKey||d.shiftKey||d.altKey)return;const h=t.findClosestDraggableId(d);if(!h)return;const f=t.tryGetLock(h,o,{sourceEvent:d});if(!f)return;d.preventDefault();const g={x:d.clientX,y:d.clientY};n.current(),l(f,g)}}),[t]),r=$(()=>({eventName:"webkitmouseforcewillbegin",fn:u=>{if(u.defaultPrevented)return;const d=t.findClosestDraggableId(u);if(!d)return;const h=t.findOptionsForDraggable(d);h&&(h.shouldRespectForcePress||t.canGetLock(d)&&u.preventDefault())}}),[t]),s=j(function(){const d={passive:!1,capture:!0};n.current=Fe(window,[r,i],d)},[r,i]),o=j(()=>{e.current.type!=="IDLE"&&(e.current=Ec,n.current(),s())},[s]),a=j(()=>{const u=e.current;o(),u.type==="DRAGGING"&&u.actions.cancel({shouldBlockNextClick:!0}),u.type==="PENDING"&&u.actions.abort()},[o]),c=j(function(){const d={capture:!0,passive:!1},h=ty({cancel:a,completed:o,getPhase:()=>e.current,setPhase:f=>{e.current=f}});n.current=Fe(window,h,d)},[a,o]),l=j(function(d,h){e.current.type!=="IDLE"&&L(),e.current={type:"PENDING",point:h,actions:d},c()},[c]);De(function(){return s(),function(){n.current()}},[s])}function iy(){}const ry={[qb]:!0,[Wb]:!0,[zb]:!0,[Hb]:!0};function sy(t,e){function n(){e(),t.cancel()}function i(){e(),t.drop()}return[{eventName:"keydown",fn:r=>{if(r.keyCode===ia){r.preventDefault(),n();return}if(r.keyCode===fd){r.preventDefault(),i();return}if(r.keyCode===Qb){r.preventDefault(),t.moveDown();return}if(r.keyCode===Jb){r.preventDefault(),t.moveUp();return}if(r.keyCode===Yb){r.preventDefault(),t.moveRight();return}if(r.keyCode===Kb){r.preventDefault(),t.moveLeft();return}if(ry[r.keyCode]){r.preventDefault();return}pd(r)}},{eventName:"mousedown",fn:n},{eventName:"mouseup",fn:n},{eventName:"click",fn:n},{eventName:"touchstart",fn:n},{eventName:"resize",fn:n},{eventName:"wheel",fn:n,options:{passive:!0}},{eventName:Mr,fn:n}]}function oy(t){const e=p.useRef(iy),n=$(()=>({eventName:"keydown",fn:function(s){if(s.defaultPrevented||s.keyCode!==fd)return;const o=t.findClosestDraggableId(s);if(!o)return;const a=t.tryGetLock(o,u,{sourceEvent:s});if(!a)return;s.preventDefault();let c=!0;const l=a.snapLift();e.current();function u(){c||L(),c=!1,e.current(),i()}e.current=Fe(window,sy(l,u),{capture:!0,passive:!1})}}),[t]),i=j(function(){const s={passive:!1,capture:!0};e.current=Fe(window,[n],s)},[n]);De(function(){return i(),function(){e.current()}},[i])}const us={type:"IDLE"},ay=120,cy=.15;function ly({cancel:t,getPhase:e}){return[{eventName:"orientationchange",fn:t},{eventName:"resize",fn:t},{eventName:"contextmenu",fn:n=>{n.preventDefault()}},{eventName:"keydown",fn:n=>{if(e().type!=="DRAGGING"){t();return}n.keyCode===ia&&n.preventDefault(),t()}},{eventName:Mr,fn:t}]}function uy({cancel:t,completed:e,getPhase:n}){return[{eventName:"touchmove",options:{capture:!1},fn:i=>{const r=n();if(r.type!=="DRAGGING"){t();return}r.hasMoved=!0;const{clientX:s,clientY:o}=i.touches[0],a={x:s,y:o};i.preventDefault(),r.actions.move(a)}},{eventName:"touchend",fn:i=>{const r=n();if(r.type!=="DRAGGING"){t();return}i.preventDefault(),r.actions.drop({shouldBlockNextClick:!0}),e()}},{eventName:"touchcancel",fn:i=>{if(n().type!=="DRAGGING"){t();return}i.preventDefault(),t()}},{eventName:"touchforcechange",fn:i=>{const r=n();r.type==="IDLE"&&L();const s=i.touches[0];if(!s||!(s.force>=cy))return;const a=r.actions.shouldRespectForcePress();if(r.type==="PENDING"){a&&t();return}if(a){if(r.hasMoved){i.preventDefault();return}t();return}i.preventDefault()}},{eventName:Mr,fn:t}]}function dy(t){const e=p.useRef(us),n=p.useRef(Et),i=j(function(){return e.current},[]),r=j(function(f){e.current=f},[]),s=$(()=>({eventName:"touchstart",fn:function(f){if(f.defaultPrevented)return;const g=t.findClosestDraggableId(f);if(!g)return;const m=t.tryGetLock(g,a,{sourceEvent:f});if(!m)return;const b=f.touches[0],{clientX:v,clientY:T}=b,E={x:v,y:T};n.current(),d(m,E)}}),[t]),o=j(function(){const f={capture:!0,passive:!1};n.current=Fe(window,[s],f)},[s]),a=j(()=>{const h=e.current;h.type!=="IDLE"&&(h.type==="PENDING"&&clearTimeout(h.longPressTimerId),r(us),n.current(),o())},[o,r]),c=j(()=>{const h=e.current;a(),h.type==="DRAGGING"&&h.actions.cancel({shouldBlockNextClick:!0}),h.type==="PENDING"&&h.actions.abort()},[a]),l=j(function(){const f={capture:!0,passive:!1},g={cancel:c,completed:a,getPhase:i},m=Fe(window,uy(g),f),b=Fe(window,ly(g),f);n.current=function(){m(),b()}},[c,i,a]),u=j(function(){const f=i();f.type!=="PENDING"&&L();const g=f.actions.fluidLift(f.point);r({type:"DRAGGING",actions:g,hasMoved:!1})},[i,r]),d=j(function(f,g){i().type!=="IDLE"&&L();const m=setTimeout(u,ay);r({type:"PENDING",point:g,actions:f,longPressTimerId:m}),l()},[l,i,r,u]);De(function(){return o(),function(){n.current();const g=i();g.type==="PENDING"&&(clearTimeout(g.longPressTimerId),r(us))}},[i,o,r]),De(function(){return Fe(window,[{eventName:"touchmove",fn:()=>{},options:{capture:!1,passive:!1}}])},[])}const hy=["input","button","textarea","select","option","optgroup","video","audio"];function gd(t,e){if(e==null)return!1;if(hy.includes(e.tagName.toLowerCase()))return!0;const i=e.getAttribute("contenteditable");return i==="true"||i===""?!0:e===t?!1:gd(t,e.parentElement)}function fy(t,e){const n=e.target;return Ar(n)?gd(t,n):!1}var py=t=>Ke(t.getBoundingClientRect()).center;function my(t){return t instanceof ud(t).Element}const gy=(()=>{const t="matches";return typeof document>"u"?t:[t,"msMatchesSelector","webkitMatchesSelector"].find(i=>i in Element.prototype)||t})();function vd(t,e){return t==null?null:t[gy](e)?t:vd(t.parentElement,e)}function vy(t,e){return t.closest?t.closest(e):vd(t,e)}function by(t){return`[${fn.contextId}="${t}"]`}function yy(t,e){const n=e.target;if(!my(n))return null;const i=by(t),r=vy(n,i);return!r||!Ar(r)?null:r}function ky(t,e){const n=yy(t,e);return n?n.getAttribute(fn.draggableId):null}function Sy(t,e){const n=`[${Vs.contextId}="${t}"]`,r=ld(document,n).find(s=>s.getAttribute(Vs.id)===e);return!r||!Ar(r)?null:r}function Cy(t){t.preventDefault()}function bi({expected:t,phase:e,isLockActive:n,shouldWarn:i}){return!(!n()||t!==e)}function bd({lockAPI:t,store:e,registry:n,draggableId:i}){if(t.isClaimed())return!1;const r=n.draggable.findById(i);return!(!r||!r.options.isEnabled||!sd(e.getState(),i))}function Ty({lockAPI:t,contextId:e,store:n,registry:i,draggableId:r,forceSensorStop:s,sourceEvent:o}){if(!bd({lockAPI:t,store:n,registry:i,draggableId:r}))return null;const c=i.draggable.getById(r),l=Sy(e,c.descriptor.id);if(!l||o&&!c.options.canDragInteractiveElements&&fy(l,o))return null;const u=t.claim(s||Et);let d="PRE_DRAG";function h(){return c.options.shouldRespectForcePress}function f(){return t.isActive(u)}function g(y,C){bi({expected:y,phase:d,isLockActive:f,shouldWarn:!0})&&n.dispatch(C())}const m=g.bind(null,"DRAGGING");function b(y){function C(){t.release(),d="COMPLETED"}d!=="PRE_DRAG"&&(C(),L()),n.dispatch(av(y.liftActionArgs)),d="DRAGGING";function x(_,A={shouldBlockNextClick:!1}){if(y.cleanup(),A.shouldBlockNextClick){const N=Fe(window,[{eventName:"click",fn:Cy,options:{once:!0,passive:!1,capture:!0}}]);setTimeout(N)}C(),n.dispatch(Qu({reason:_}))}return{isActive:()=>bi({expected:"DRAGGING",phase:d,isLockActive:f,shouldWarn:!1}),shouldRespectForcePress:h,drop:_=>x("DROP",_),cancel:_=>x("CANCEL",_),...y.actions}}function v(y){const C=zn(_=>{m(()=>Yu({client:_}))});return{...b({liftActionArgs:{id:r,clientSelection:y,movementMode:"FLUID"},cleanup:()=>C.cancel(),actions:{move:C}}),move:C}}function T(){const y={moveUp:()=>m(gv),moveRight:()=>m(bv),moveDown:()=>m(vv),moveLeft:()=>m(yv)};return b({liftActionArgs:{id:r,clientSelection:py(l),movementMode:"SNAP"},cleanup:Et,actions:y})}function E(){bi({expected:"PRE_DRAG",phase:d,isLockActive:f,shouldWarn:!0})&&t.release()}return{isActive:()=>bi({expected:"PRE_DRAG",phase:d,isLockActive:f,shouldWarn:!1}),shouldRespectForcePress:h,fluidLift:v,snapLift:T,abort:E}}const Ey=[ny,oy,dy];function wy({contextId:t,store:e,registry:n,customSensors:i,enableDefaultSensors:r}){const s=[...r?Ey:[],...i||[]],o=p.useState(()=>Vb())[0],a=j(function(b,v){Zn(b)&&!Zn(v)&&o.tryAbandon()},[o]);De(function(){let b=e.getState();return e.subscribe(()=>{const T=e.getState();a(b,T),b=T})},[o,e,a]),De(()=>o.tryAbandon,[o.tryAbandon]);const c=j(m=>bd({lockAPI:o,registry:n,store:e,draggableId:m}),[o,n,e]),l=j((m,b,v)=>Ty({lockAPI:o,registry:n,contextId:t,store:e,draggableId:m,forceSensorStop:b||null,sourceEvent:v&&v.sourceEvent?v.sourceEvent:null}),[t,o,n,e]),u=j(m=>ky(t,m),[t]),d=j(m=>{const b=n.draggable.findById(m);return b?b.options:null},[n.draggable]),h=j(function(){o.isClaimed()&&(o.tryAbandon(),e.getState().phase!=="IDLE"&&e.dispatch(Ko()))},[o,e]),f=j(()=>o.isClaimed(),[o]),g=$(()=>({canGetLock:c,tryGetLock:l,findClosestDraggableId:u,findOptionsForDraggable:d,tryReleaseLock:h,isLockClaimed:f}),[c,l,u,d,h,f]);for(let m=0;m<s.length;m++)s[m](g)}const Py=t=>({onBeforeCapture:e=>{const n=()=>{t.onBeforeCapture&&t.onBeforeCapture(e)};q.version.startsWith("16")||q.version.startsWith("17")?n():Do.flushSync(n)},onBeforeDragStart:t.onBeforeDragStart,onDragStart:t.onDragStart,onDragEnd:t.onDragEnd,onDragUpdate:t.onDragUpdate}),xy=t=>({...Xn,...t.autoScrollerOptions,durationDampening:{...Xn.durationDampening,...t.autoScrollerOptions}});function On(t){return t.current||L(),t.current}function Ry(t){const{contextId:e,setCallbacks:n,sensors:i,nonce:r,dragHandleUsageInstructions:s}=t,o=p.useRef(null),a=hd(t),c=j(()=>Py(a.current),[a]),l=j(()=>xy(a.current),[a]),u=Mb(e),d=jb({contextId:e,text:s}),h=xb(e,r),f=j(N=>{On(o).dispatch(N)},[]),g=$(()=>Ka({publishWhileDragging:lv,updateDroppableScroll:dv,updateDroppableIsEnabled:hv,updateDroppableIsCombineEnabled:fv,collectionStarting:uv},f),[f]),m=Ob(),b=$(()=>rb(m,g),[m,g]),v=$(()=>Sb({scrollWindow:sb,scrollDroppable:b.scrollDroppable,getAutoScrollerOptions:l,...Ka({move:Yu},f)}),[b.scrollDroppable,f,l]),T=Ib(e),E=$(()=>eb({announce:u,autoScroller:v,dimensionMarshal:b,focusMarshal:T,getResponders:c,styleMarshal:h}),[u,v,b,T,c,h]);o.current=E;const k=j(()=>{const N=On(o);N.getState().phase!=="IDLE"&&N.dispatch(Ko())},[]),y=j(()=>{const N=On(o).getState();return N.phase==="DROP_ANIMATING"?!0:N.phase==="IDLE"?!1:N.isDragging},[]),C=$(()=>({isDragging:y,tryAbort:k}),[y,k]);n(C);const x=j(N=>sd(On(o).getState(),N),[]),_=j(()=>Lt(On(o).getState()),[]),A=$(()=>({marshal:b,focus:T,contextId:e,canLift:x,isMovementAllowed:_,dragHandleUsageInstructionsId:d,registry:m}),[e,b,d,T,x,_,m]);return wy({contextId:e,store:E,registry:m,customSensors:i||null,enableDefaultSensors:t.enableDefaultSensors!==!1}),p.useEffect(()=>k,[k]),q.createElement(Nr.Provider,{value:A},q.createElement(Fm,{context:ta,store:E},t.children))}let Iy=0;function Dy(){return $(()=>`${Iy++}`,[])}function Oy(){return q.useId()}var _y="useId"in q?Oy:Dy;function Ay(t){const e=_y(),n=t.dragHandleUsageInstructions||wi.dragHandleUsageInstructions;return q.createElement(Jm,null,i=>q.createElement(Ry,{nonce:t.nonce,contextId:e,setCallbacks:i,dragHandleUsageInstructions:n,enableDefaultSensors:t.enableDefaultSensors,sensors:t.sensors,onBeforeCapture:t.onBeforeCapture,onBeforeDragStart:t.onBeforeDragStart,onDragStart:t.onDragStart,onDragUpdate:t.onDragUpdate,onDragEnd:t.onDragEnd,autoScrollerOptions:t.autoScrollerOptions},t.children))}const wc={dragging:5e3,dropAnimating:4500},Ny=(t,e)=>e?jn.drop(e.duration):t?jn.snap:jn.fluid,My=(t,e)=>{if(t)return e?Qn.opacity.drop:Qn.opacity.combining},Ly=t=>t.forceShouldAnimate!=null?t.forceShouldAnimate:t.mode==="SNAP";function Uy(t){const n=t.dimension.client,{offset:i,combineWith:r,dropping:s}=t,o=!!r,a=Ly(t),c=!!s,l=c?Bs.drop(i,o):Bs.moveTo(i);return{position:"fixed",top:n.marginBox.top,left:n.marginBox.left,boxSizing:"border-box",width:n.borderBox.width,height:n.borderBox.height,transition:Ny(a,s),transform:l,opacity:My(o,c),zIndex:c?wc.dropAnimating:wc.dragging,pointerEvents:"none"}}function Fy(t){return{transform:Bs.moveTo(t.offset),transition:t.shouldAnimateDisplacement?void 0:"none"}}function By(t){return t.type==="DRAGGING"?Uy(t):Fy(t)}function jy(t,e,n=ue){const i=window.getComputedStyle(e),r=e.getBoundingClientRect(),s=wu(r,i),o=Gi(s,n),a={client:s,tagName:e.tagName.toLowerCase(),display:i.display},c={x:s.marginBox.width,y:s.marginBox.height};return{descriptor:t,placeholder:a,displaceBy:c,client:s,page:o}}function Vy(t){const e=na("draggable"),{descriptor:n,registry:i,getDraggableRef:r,canDragInteractiveElements:s,shouldRespectForcePress:o,isEnabled:a}=t,c=$(()=>({canDragInteractiveElements:s,shouldRespectForcePress:o,isEnabled:a}),[s,a,o]),l=j(f=>{const g=r();return g||L(),jy(n,g,f)},[n,r]),u=$(()=>({uniqueId:e,descriptor:n,options:c,getDimension:l}),[n,l,c,e]),d=p.useRef(u),h=p.useRef(!0);De(()=>(i.draggable.register(d.current),()=>i.draggable.unregister(d.current)),[i.draggable]),De(()=>{if(h.current){h.current=!1;return}const f=d.current;d.current=u,i.draggable.update(u,f)},[u,i.draggable])}var ra=q.createContext(null);function Ki(t){const e=p.useContext(t);return e||L(),e}function $y(t){t.preventDefault()}const Gy=t=>{const e=p.useRef(null),n=j((C=null)=>{e.current=C},[]),i=j(()=>e.current,[]),{contextId:r,dragHandleUsageInstructionsId:s,registry:o}=Ki(Nr),{type:a,droppableId:c}=Ki(ra),l=$(()=>({id:t.draggableId,index:t.index,type:a,droppableId:c}),[t.draggableId,t.index,a,c]),{children:u,draggableId:d,isEnabled:h,shouldRespectForcePress:f,canDragInteractiveElements:g,isClone:m,mapped:b,dropAnimationFinished:v}=t;if(!m){const C=$(()=>({descriptor:l,registry:o,getDraggableRef:i,canDragInteractiveElements:g,shouldRespectForcePress:f,isEnabled:h}),[l,o,i,g,f,h]);Vy(C)}const T=$(()=>h?{tabIndex:0,role:"button","aria-describedby":s,"data-rfd-drag-handle-draggable-id":d,"data-rfd-drag-handle-context-id":r,draggable:!1,onDragStart:$y}:null,[r,s,d,h]),E=j(C=>{b.type==="DRAGGING"&&b.dropping&&C.propertyName==="transform"&&(q.version.startsWith("16")||q.version.startsWith("17")?v():Do.flushSync(v))},[v,b]),k=$(()=>{const C=By(b),x=b.type==="DRAGGING"&&b.dropping?E:void 0;return{innerRef:n,draggableProps:{"data-rfd-draggable-context-id":r,"data-rfd-draggable-id":d,style:C,onTransitionEnd:x},dragHandleProps:T}},[r,T,d,b,E,n]),y=$(()=>({draggableId:l.id,type:l.type,source:{index:l.index,droppableId:l.droppableId}}),[l.droppableId,l.id,l.index,l.type]);return q.createElement(q.Fragment,null,u(k,b.snapshot,y))};var Wy=Gy,yd=(t,e)=>t===e,kd=t=>{const{combine:e,destination:n}=t;return n?n.droppableId:e?e.droppableId:null};const qy=t=>t.combine?t.combine.draggableId:null,Hy=t=>t.at&&t.at.type==="COMBINE"?t.at.combine.draggableId:null;function zy(){const t=le((r,s)=>({x:r,y:s})),e=le((r,s,o=null,a=null,c=null)=>({isDragging:!0,isClone:s,isDropAnimating:!!c,dropAnimation:c,mode:r,draggingOver:o,combineWith:a,combineTargetFor:null})),n=le((r,s,o,a,c=null,l=null,u=null)=>({mapped:{type:"DRAGGING",dropping:null,draggingOver:c,combineWith:l,mode:s,offset:r,dimension:o,forceShouldAnimate:u,snapshot:e(s,a,c,l,null)}}));return(r,s)=>{if(Zn(r)){if(r.critical.draggable.id!==s.draggableId)return null;const o=r.current.client.offset,a=r.dimensions.draggables[s.draggableId],c=Ie(r.impact),l=Hy(r.impact),u=r.forceShouldAnimate;return n(t(o.x,o.y),r.movementMode,a,s.isClone,c,l,u)}if(r.phase==="DROP_ANIMATING"){const o=r.completed;if(o.result.draggableId!==s.draggableId)return null;const a=s.isClone,c=r.dimensions.draggables[s.draggableId],l=o.result,u=l.mode,d=kd(l),h=qy(l),g={duration:r.dropDuration,curve:Yo.drop,moveTo:r.newHomeClientOffset,opacity:h?Qn.opacity.drop:null,scale:h?Qn.scale.drop:null};return{mapped:{type:"DRAGGING",offset:r.newHomeClientOffset,dimension:c,dropping:g,draggingOver:d,combineWith:h,mode:u,forceShouldAnimate:null,snapshot:e(u,a,d,h,g)}}}return null}}function Sd(t=null){return{isDragging:!1,isDropAnimating:!1,isClone:!1,dropAnimation:null,mode:null,draggingOver:null,combineTargetFor:t,combineWith:null}}const Ky={mapped:{type:"SECONDARY",offset:ue,combineTargetFor:null,shouldAnimateDisplacement:!0,snapshot:Sd(null)}};function Jy(){const t=le((o,a)=>({x:o,y:a})),e=le(Sd),n=le((o,a=null,c)=>({mapped:{type:"SECONDARY",offset:o,combineTargetFor:a,shouldAnimateDisplacement:c,snapshot:e(a)}})),i=o=>o?n(ue,o,!0):null,r=(o,a,c,l)=>{const u=c.displaced.visible[o],d=!!(l.inVirtualList&&l.effected[o]),h=Dr(c),f=h&&h.draggableId===o?a:null;if(!u){if(!d)return i(f);if(c.displaced.invisible[o])return null;const b=Sn(l.displacedBy.point),v=t(b.x,b.y);return n(v,f,!0)}if(d)return i(f);const g=c.displacedBy.point,m=t(g.x,g.y);return n(m,f,u.shouldAnimate)};return(o,a)=>{if(Zn(o))return o.critical.draggable.id===a.draggableId?null:r(a.draggableId,o.critical.draggable.id,o.impact,o.afterCritical);if(o.phase==="DROP_ANIMATING"){const c=o.completed;return c.result.draggableId===a.draggableId?null:r(a.draggableId,c.result.draggableId,c.impact,c.afterCritical)}return null}}const Yy=()=>{const t=zy(),e=Jy();return(i,r)=>t(i,r)||e(i,r)||Ky},Qy={dropAnimationFinished:Xu},Xy=Tu(Yy,Qy,null,{context:ta,areStatePropsEqual:yd})(Wy);var Zy=Xy;function Cd(t){return Ki(ra).isUsingCloneFor===t.draggableId&&!t.isClone?null:q.createElement(Zy,t)}function e0(t){const e=typeof t.isDragDisabled=="boolean"?!t.isDragDisabled:!0,n=!!t.disableInteractiveElementBlocking,i=!!t.shouldRespectForcePress;return q.createElement(Cd,Tt({},t,{isClone:!1,isEnabled:e,canDragInteractiveElements:n,shouldRespectForcePress:i}))}const Td=t=>e=>t===e,t0=Td("scroll"),n0=Td("auto"),Pc=(t,e)=>e(t.overflowX)||e(t.overflowY),i0=t=>{const e=window.getComputedStyle(t),n={overflowX:e.overflowX,overflowY:e.overflowY};return Pc(n,t0)||Pc(n,n0)},r0=()=>!1,Ed=t=>t==null?null:t===document.body?r0()?t:null:t===document.documentElement?null:i0(t)?t:Ed(t.parentElement);var $s=t=>({x:t.scrollLeft,y:t.scrollTop});const wd=t=>t?window.getComputedStyle(t).position==="fixed"?!0:wd(t.parentElement):!1;var s0=t=>{const e=Ed(t),n=wd(t);return{closestScrollable:e,isFixedOnPage:n}},o0=({descriptor:t,isEnabled:e,isCombineEnabled:n,isFixedOnPage:i,direction:r,client:s,page:o,closest:a})=>{const c=(()=>{if(!a)return null;const{scrollSize:h,client:f}=a,g=nd({scrollHeight:h.scrollHeight,scrollWidth:h.scrollWidth,height:f.paddingBox.height,width:f.paddingBox.width});return{pageMarginBox:a.page.marginBox,frameClient:f,scrollSize:h,shouldClipSubject:a.shouldClipSubject,scroll:{initial:a.scroll,current:a.scroll,max:g,diff:{value:ue,displacement:ue}}}})(),l=r==="vertical"?Go:Mu,u=dn({page:o,withPlaceholder:null,axis:l,frame:c});return{descriptor:t,isCombineEnabled:n,isFixedOnPage:i,axis:l,isEnabled:e,client:s,page:o,frame:c,subject:u}};const a0=(t,e)=>{const n=Pu(t);if(!e||t!==e)return n;const i=n.paddingBox.top-e.scrollTop,r=n.paddingBox.left-e.scrollLeft,s=i+e.scrollHeight,o=r+e.scrollWidth,c=Bo({top:i,right:o,bottom:s,left:r},n.border);return jo({borderBox:c,margin:n.margin,border:n.border,padding:n.padding})};var c0=({ref:t,descriptor:e,env:n,windowScroll:i,direction:r,isDropDisabled:s,isCombineEnabled:o,shouldClipSubject:a})=>{const c=n.closestScrollable,l=a0(t,c),u=Gi(l,i),d=(()=>{if(!c)return null;const f=Pu(c),g={scrollHeight:c.scrollHeight,scrollWidth:c.scrollWidth};return{client:f,page:Gi(f,i),scroll:$s(c),scrollSize:g,shouldClipSubject:a}})();return o0({descriptor:e,isEnabled:!s,isCombineEnabled:o,isFixedOnPage:n.isFixedOnPage,direction:r,client:l,page:u,closest:d})};const l0={passive:!1},u0={passive:!0};var xc=t=>t.shouldPublishImmediately?l0:u0;const yi=t=>t&&t.env.closestScrollable||null;function d0(t){const e=p.useRef(null),n=Ki(Nr),i=na("droppable"),{registry:r,marshal:s}=n,o=hd(t),a=$(()=>({id:t.droppableId,type:t.type,mode:t.mode}),[t.droppableId,t.mode,t.type]),c=p.useRef(a),l=$(()=>le((k,y)=>{e.current||L();const C={x:k,y};s.updateDroppableScroll(a.id,C)}),[a.id,s]),u=j(()=>{const k=e.current;return!k||!k.env.closestScrollable?ue:$s(k.env.closestScrollable)},[]),d=j(()=>{const k=u();l(k.x,k.y)},[u,l]),h=$(()=>zn(d),[d]),f=j(()=>{const k=e.current,y=yi(k);if(k&&y||L(),k.scrollOptions.shouldPublishImmediately){d();return}h()},[h,d]),g=j((k,y)=>{e.current&&L();const C=o.current,x=C.getDroppableRef();x||L();const _=s0(x),A={ref:x,descriptor:a,env:_,scrollOptions:y};e.current=A;const N=c0({ref:x,descriptor:a,env:_,windowScroll:k,direction:C.direction,isDropDisabled:C.isDropDisabled,isCombineEnabled:C.isCombineEnabled,shouldClipSubject:!C.ignoreContainerClipping}),M=_.closestScrollable;return M&&(M.setAttribute(Sc.contextId,n.contextId),M.addEventListener("scroll",f,xc(A.scrollOptions))),N},[n.contextId,a,f,o]),m=j(()=>{const k=e.current,y=yi(k);return k&&y||L(),$s(y)},[]),b=j(()=>{const k=e.current;k||L();const y=yi(k);e.current=null,y&&(h.cancel(),y.removeAttribute(Sc.contextId),y.removeEventListener("scroll",f,xc(k.scrollOptions)))},[f,h]),v=j(k=>{const y=e.current;y||L();const C=yi(y);C||L(),C.scrollTop+=k.y,C.scrollLeft+=k.x},[]),T=$(()=>({getDimensionAndWatchScroll:g,getScrollWhileDragging:m,dragStopped:b,scroll:v}),[b,g,m,v]),E=$(()=>({uniqueId:i,descriptor:a,callbacks:T}),[T,a,i]);De(()=>(c.current=E.descriptor,r.droppable.register(E),()=>{e.current&&b(),r.droppable.unregister(E)}),[T,a,b,E,s,r.droppable]),De(()=>{e.current&&s.updateDroppableIsEnabled(c.current.id,!t.isDropDisabled)},[t.isDropDisabled,s]),De(()=>{e.current&&s.updateDroppableIsCombineEnabled(c.current.id,t.isCombineEnabled)},[t.isCombineEnabled,s])}function ds(){}const Rc={width:0,height:0,margin:ng},h0=({isAnimatingOpenOnMount:t,placeholder:e,animate:n})=>t||n==="close"?Rc:{height:e.client.borderBox.height,width:e.client.borderBox.width,margin:e.client.margin},f0=({isAnimatingOpenOnMount:t,placeholder:e,animate:n})=>{const i=h0({isAnimatingOpenOnMount:t,placeholder:e,animate:n});return{display:e.display,boxSizing:"border-box",width:i.width,height:i.height,marginTop:i.margin.top,marginRight:i.margin.right,marginBottom:i.margin.bottom,marginLeft:i.margin.left,flexShrink:"0",flexGrow:"0",pointerEvents:"none",transition:n!=="none"?jn.placeholder:null}},p0=t=>{const e=p.useRef(null),n=j(()=>{e.current&&(clearTimeout(e.current),e.current=null)},[]),{animate:i,onTransitionEnd:r,onClose:s,contextId:o}=t,[a,c]=p.useState(t.animate==="open");p.useEffect(()=>a?i!=="open"?(n(),c(!1),ds):e.current?ds:(e.current=setTimeout(()=>{e.current=null,c(!1)}),n):ds,[i,a,n]);const l=j(d=>{d.propertyName==="height"&&(r(),i==="close"&&s())},[i,s,r]),u=f0({isAnimatingOpenOnMount:a,animate:t.animate,placeholder:t.placeholder});return q.createElement(t.placeholder.tagName,{style:u,"data-rfd-placeholder-context-id":o,onTransitionEnd:l,ref:t.innerRef})};var m0=q.memo(p0);class g0 extends q.PureComponent{constructor(...e){super(...e),this.state={isVisible:!!this.props.on,data:this.props.on,animate:this.props.shouldAnimate&&this.props.on?"open":"none"},this.onClose=()=>{this.state.animate==="close"&&this.setState({isVisible:!1})}}static getDerivedStateFromProps(e,n){return e.shouldAnimate?e.on?{isVisible:!0,data:e.on,animate:"open"}:n.isVisible?{isVisible:!0,data:n.data,animate:"close"}:{isVisible:!1,animate:"close",data:null}:{isVisible:!!e.on,data:e.on,animate:"none"}}render(){if(!this.state.isVisible)return null;const e={onClose:this.onClose,data:this.state.data,animate:this.state.animate};return this.props.children(e)}}const v0=t=>{const e=p.useContext(Nr);e||L();const{contextId:n,isMovementAllowed:i}=e,r=p.useRef(null),s=p.useRef(null),{children:o,droppableId:a,type:c,mode:l,direction:u,ignoreContainerClipping:d,isDropDisabled:h,isCombineEnabled:f,snapshot:g,useClone:m,updateViewportMaxScroll:b,getContainerForClone:v}=t,T=j(()=>r.current,[]),E=j((M=null)=>{r.current=M},[]);j(()=>s.current,[]);const k=j((M=null)=>{s.current=M},[]),y=j(()=>{i()&&b({maxScroll:rd()})},[i,b]);d0({droppableId:a,type:c,mode:l,direction:u,isDropDisabled:h,isCombineEnabled:f,ignoreContainerClipping:d,getDroppableRef:T});const C=$(()=>q.createElement(g0,{on:t.placeholder,shouldAnimate:t.shouldAnimatePlaceholder},({onClose:M,data:B,animate:K})=>q.createElement(m0,{placeholder:B,onClose:M,innerRef:k,animate:K,contextId:n,onTransitionEnd:y})),[n,y,t.placeholder,t.shouldAnimatePlaceholder,k]),x=$(()=>({innerRef:E,placeholder:C,droppableProps:{"data-rfd-droppable-id":a,"data-rfd-droppable-context-id":n}}),[n,a,C,E]),_=m?m.dragging.draggableId:null,A=$(()=>({droppableId:a,type:c,isUsingCloneFor:_}),[a,_,c]);function N(){if(!m)return null;const{dragging:M,render:B}=m,K=q.createElement(Cd,{draggableId:M.draggableId,index:M.source.index,isClone:!0,isEnabled:!0,shouldRespectForcePress:!1,canDragInteractiveElements:!0},(Q,ie)=>B(Q,ie,M));return up.createPortal(K,v())}return q.createElement(ra.Provider,{value:A},o(x,g),N())};var b0=v0;function y0(){return document.body||L(),document.body}const Ic={mode:"standard",type:"DEFAULT",direction:"vertical",isDropDisabled:!1,isCombineEnabled:!1,ignoreContainerClipping:!1,renderClone:null,getContainerForClone:y0},Pd=t=>{let e={...t},n;for(n in Ic)t[n]===void 0&&(e={...e,[n]:Ic[n]});return e},hs=(t,e)=>t===e.droppable.type,Dc=(t,e)=>e.draggables[t.draggable.id],k0=()=>{const t={placeholder:null,shouldAnimatePlaceholder:!0,snapshot:{isDraggingOver:!1,draggingOverWith:null,draggingFromThisWith:null,isUsingPlaceholder:!1},useClone:null},e={...t,shouldAnimatePlaceholder:!1},n=le(s=>({draggableId:s.id,type:s.type,source:{index:s.index,droppableId:s.droppableId}})),i=le((s,o,a,c,l,u)=>{const d=l.descriptor.id;if(l.descriptor.droppableId===s){const g=u?{render:u,dragging:n(l.descriptor)}:null,m={isDraggingOver:a,draggingOverWith:a?d:null,draggingFromThisWith:d,isUsingPlaceholder:!0};return{placeholder:l.placeholder,shouldAnimatePlaceholder:!1,snapshot:m,useClone:g}}if(!o)return e;if(!c)return t;const f={isDraggingOver:a,draggingOverWith:d,draggingFromThisWith:null,isUsingPlaceholder:!0};return{placeholder:l.placeholder,shouldAnimatePlaceholder:!0,snapshot:f,useClone:null}});return(s,o)=>{const a=Pd(o),c=a.droppableId,l=a.type,u=!a.isDropDisabled,d=a.renderClone;if(Zn(s)){const h=s.critical;if(!hs(l,h))return e;const f=Dc(h,s.dimensions),g=Ie(s.impact)===c;return i(c,u,g,g,f,d)}if(s.phase==="DROP_ANIMATING"){const h=s.completed;if(!hs(l,h.critical))return e;const f=Dc(h.critical,s.dimensions);return i(c,u,kd(h.result)===c,Ie(h.impact)===c,f,d)}if(s.phase==="IDLE"&&s.completed&&!s.shouldFlush){const h=s.completed;if(!hs(l,h.critical))return e;const f=Ie(h.impact)===c,g=!!(h.impact.at&&h.impact.at.type==="COMBINE"),m=h.critical.droppable.id===c;return f?g?t:e:m?t:e}return e}},S0={updateViewportMaxScroll:mv},C0=Tu(k0,S0,(t,e,n)=>({...Pd(n),...t,...e}),{context:ta,areStatePropsEqual:yd})(b0);var T0=C0;const E0=({question:t,onAnswerChange:e,currentAnswer:n=[]})=>{const i=s=>{if(!s.destination)return;const o=n.length?n:t.items.map(l=>l.id),a=Array.from(o),[c]=a.splice(s.source.index,1);a.splice(s.destination.index,0,c),e(a)},r=n.length?n.map(s=>t.items.find(o=>o.id===s)):t.items;return w.jsxs("div",{className:"mb-6",children:[w.jsx("h3",{className:"font-medium mb-2",children:t.questionText}),t.instruction&&w.jsx("p",{className:"text-gray-600 mb-2",children:t.instruction}),w.jsx(Ay,{onDragEnd:i,children:w.jsx(T0,{droppableId:"ordering",children:s=>w.jsxs("div",{...s.droppableProps,ref:s.innerRef,className:"space-y-2",children:[r.map((o,a)=>w.jsx(e0,{draggableId:o==null?void 0:o.id,index:a,children:c=>w.jsxs("div",{ref:c.innerRef,...c.draggableProps,...c.dragHandleProps,className:"p-3 bg-white border rounded shadow-sm hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700 cursor-grab active:cursor-grabbing",children:[a+1,". ",(o==null?void 0:o.text)||"Invalid item"]})},o==null?void 0:o.id)),s.placeholder]})})})]})},w0=({question:t,onAnswerChange:e,currentAnswer:n=""})=>{const i=o=>o.trim().split(/\s+/).filter(Boolean).length,r=o=>{e(o.target.value)},s=i(n);return w.jsxs("div",{className:"mb-6",children:[w.jsx("h3",{className:"font-medium mb-2 dark:text-gray-200",children:t.questionText}),t.instruction&&w.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-2",children:t.instruction}),w.jsxs("div",{className:"mt-4",children:[w.jsx("textarea",{value:n,onChange:r,className:`w-full h-64 p-3 border rounded focus:ring-2 focus:ring-blue-500 \r
                   dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200`,placeholder:"Write your essay here..."}),w.jsxs("div",{className:"mt-2 text-sm text-gray-600 dark:text-gray-400",children:["Word count: ",s," / ",t.minWords,"-",t.maxWords,s<t.minWords&&w.jsxs("span",{className:"text-red-500 dark:text-red-400 ml-2",children:["(Need ",t.minWords-s," more words)"]}),s>t.maxWords&&w.jsxs("span",{className:"text-red-500 dark:text-red-400 ml-2",children:["(",s-t.maxWords," words over limit)"]})]}),t.rubric&&w.jsxs("div",{className:"mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded",children:[w.jsx("h4",{className:"font-medium mb-2 dark:text-gray-200",children:"Rubric:"}),w.jsx("pre",{className:"whitespace-pre-wrap text-sm dark:text-gray-300",children:t.rubric})]})]})]})},P0=({question:t,onAnswerChange:e,currentAnswer:n=[]})=>{const[i,r]=p.useState(!1),[s,o]=p.useState(null),a=p.useRef(null),c=p.useRef(null),l=p.useRef([]),u=p.useRef([]),d=v=>String.fromCharCode(65+v);p.useEffect(()=>(h(),window.addEventListener("resize",h),()=>window.removeEventListener("resize",h)),[n]);const h=()=>{const v=a.current,T=v.getContext("2d");T.clearRect(0,0,v.width,v.height);const E=c.current;E&&(v.width=E.offsetWidth,v.height=E.offsetHeight,n.forEach(k=>{const y=t.leftColumn.findIndex(A=>A.id===k.left),C=t.rightColumn.findIndex(A=>A.id===k.right),x=l.current[y],_=u.current[C];x&&_&&f(T,x,_)}))},f=(v,T,E)=>{const k=T.getBoundingClientRect(),y=E.getBoundingClientRect(),C=c.current.getBoundingClientRect(),x=k.right-C.left,_=k.top-C.top+k.height/2,A=y.left-C.left,N=y.top-C.top+y.height/2;v.beginPath(),v.moveTo(x,_),v.lineTo(A,N),v.strokeStyle="#3b82f6",v.lineWidth=2,v.stroke()},g=(v,T)=>{r(!0),o({index:v,id:t.leftColumn[v].id,element:T.currentTarget})},m=(v,T)=>{if(i&&s){const E=t.rightColumn[v].id,y=n.filter(C=>C.right!==E).filter(C=>C.left!==s.id);y.push({left:s.id,right:E}),e(y),r(!1),o(null)}},b=(v,T)=>{const E=T.find(k=>k.id===v);return E?E.text:""};return w.jsxs("div",{className:"mb-6",children:[w.jsx("h3",{className:"font-medium mb-2 text-gray-200",children:t.questionText}),t.instruction&&w.jsx("p",{className:"text-gray-400 mb-2",children:t.instruction}),w.jsxs("div",{ref:c,className:"relative flex justify-between mt-4 min-h-[200px]",children:[w.jsx("canvas",{ref:a,className:"absolute inset-0 pointer-events-none"}),w.jsx("div",{className:"w-[45%] flex flex-col space-y-4",children:t.leftColumn.map((v,T)=>w.jsx("div",{ref:E=>l.current[T]=E,onClick:E=>g(T,E),className:`p-3 rounded-lg border border-gray-600 cursor-pointer
                hover:bg-gray-700 transition-colors
                ${(s==null?void 0:s.index)===T?"bg-blue-500/20 border-blue-500":"bg-gray-800"}`,children:w.jsxs("span",{className:"text-gray-300",children:[T+1,". ",v.text]})},v.id))}),w.jsx("div",{className:"w-[45%] flex flex-col space-y-4",children:t.rightColumn.map((v,T)=>w.jsx("div",{ref:E=>u.current[T]=E,onClick:E=>m(T),className:`p-3 rounded-lg border border-gray-600 cursor-pointer
                hover:bg-gray-700 transition-colors
                ${i?"bg-gray-700":"bg-gray-800"}`,children:w.jsxs("span",{className:"text-gray-300",children:[d(T),". ",v.text]})},v.id))})]}),w.jsxs("div",{className:"mt-6 p-4 bg-gray-800 rounded-lg",children:[w.jsx("h4",{className:"text-gray-300 font-medium mb-2",children:"Current Matches:"}),n.length===0?w.jsx("p",{className:"text-gray-400",children:"No matches made yet"}):w.jsx("div",{className:"space-y-2",children:n.map((v,T)=>w.jsxs("div",{className:"text-gray-300",children:[v.left,". ",b(v.left,t.leftColumn),w.jsx("span",{className:"text-gray-400 mx-2",children:"→"}),v.right,"."," ",b(v.right,t.rightColumn)]},T))})]})]})};var Oc={};function x0(t,e){return e.forEach(function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach(function(i){if(i!=="default"&&!(i in t)){var r=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,r.get?r:{enumerable:!0,get:function(){return n[i]}})}})}),Object.freeze(t)}var R0=Object.defineProperty,I0=(t,e,n)=>e in t?R0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,_c=(t,e,n)=>I0(t,typeof e!="symbol"?e+"":e,n);class Re{constructor(){_c(this,"_locking"),_c(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let e;const n=new Promise(r=>e=()=>{this._locks-=1,r()}),i=this._locking.then(()=>e);return this._locking=this._locking.then(()=>n),i}}function oe(t,e){if(!t)throw new Error(e)}const D0=34028234663852886e22,O0=-34028234663852886e22,_0=4294967295,A0=2147483647,N0=-2147483648;function Pi(t){if(typeof t!="number")throw new Error("invalid int 32: "+typeof t);if(!Number.isInteger(t)||t>A0||t<N0)throw new Error("invalid int 32: "+t)}function Gs(t){if(typeof t!="number")throw new Error("invalid uint 32: "+typeof t);if(!Number.isInteger(t)||t>_0||t<0)throw new Error("invalid uint 32: "+t)}function xd(t){if(typeof t!="number")throw new Error("invalid float 32: "+typeof t);if(Number.isFinite(t)&&(t>D0||t<O0))throw new Error("invalid float 32: "+t)}const Rd=Symbol("@bufbuild/protobuf/enum-type");function M0(t){const e=t[Rd];return oe(e,"missing enum type on enum object"),e}function Id(t,e,n,i){t[Rd]=Dd(e,n.map(r=>({no:r.no,name:r.name,localName:t[r.no]})))}function Dd(t,e,n){const i=Object.create(null),r=Object.create(null),s=[];for(const o of e){const a=Od(o);s.push(a),i[o.name]=a,r[o.no]=a}return{typeName:t,values:s,findName(o){return i[o]},findNumber(o){return r[o]}}}function L0(t,e,n){const i={};for(const r of e){const s=Od(r);i[s.localName]=s.no,i[s.no]=s.localName}return Id(i,t,e),i}function Od(t){return"localName"in t?t:Object.assign(Object.assign({},t),{localName:t.name})}class sa{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,n){const i=this.getType(),r=i.runtime.bin,s=r.makeReadOptions(n);return r.readMessage(this,s.readerFactory(e),e.byteLength,s),this}fromJson(e,n){const i=this.getType(),r=i.runtime.json,s=r.makeReadOptions(n);return r.readMessage(i,e,s,this),this}fromJsonString(e,n){let i;try{i=JSON.parse(e)}catch(r){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(r instanceof Error?r.message:String(r)))}return this.fromJson(i,n)}toBinary(e){const n=this.getType(),i=n.runtime.bin,r=i.makeWriteOptions(e),s=r.writerFactory();return i.writeMessage(this,s,r),s.finish()}toJson(e){const n=this.getType(),i=n.runtime.json,r=i.makeWriteOptions(e);return i.writeMessage(this,r)}toJsonString(e){var n;const i=this.toJson(e);return JSON.stringify(i,null,(n=e==null?void 0:e.prettySpaces)!==null&&n!==void 0?n:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function U0(t,e,n,i){var r;const s=(r=i==null?void 0:i.localName)!==null&&r!==void 0?r:e.substring(e.lastIndexOf(".")+1),o={[s]:function(a){t.util.initFields(this),t.util.initPartial(a,this)}}[s];return Object.setPrototypeOf(o.prototype,new sa),Object.assign(o,{runtime:t,typeName:e,fields:t.util.newFieldList(n),fromBinary(a,c){return new o().fromBinary(a,c)},fromJson(a,c){return new o().fromJson(a,c)},fromJsonString(a,c){return new o().fromJsonString(a,c)},equals(a,c){return t.util.equals(o,a,c)}}),o}function F0(){let t=0,e=0;for(let i=0;i<28;i+=7){let r=this.buf[this.pos++];if(t|=(r&127)<<i,!(r&128))return this.assertBounds(),[t,e]}let n=this.buf[this.pos++];if(t|=(n&15)<<28,e=(n&112)>>4,!(n&128))return this.assertBounds(),[t,e];for(let i=3;i<=31;i+=7){let r=this.buf[this.pos++];if(e|=(r&127)<<i,!(r&128))return this.assertBounds(),[t,e]}throw new Error("invalid varint")}function fs(t,e,n){for(let s=0;s<28;s=s+7){const o=t>>>s,a=!(!(o>>>7)&&e==0),c=(a?o|128:o)&255;if(n.push(c),!a)return}const i=t>>>28&15|(e&7)<<4,r=!!(e>>3);if(n.push((r?i|128:i)&255),!!r){for(let s=3;s<31;s=s+7){const o=e>>>s,a=!!(o>>>7),c=(a?o|128:o)&255;if(n.push(c),!a)return}n.push(e>>>31&1)}}const xi=4294967296;function Ac(t){const e=t[0]==="-";e&&(t=t.slice(1));const n=1e6;let i=0,r=0;function s(o,a){const c=Number(t.slice(o,a));r*=n,i=i*n+c,i>=xi&&(r=r+(i/xi|0),i=i%xi)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),e?Ad(i,r):oa(i,r)}function B0(t,e){let n=oa(t,e);const i=n.hi&2147483648;i&&(n=Ad(n.lo,n.hi));const r=_d(n.lo,n.hi);return i?"-"+r:r}function _d(t,e){if({lo:t,hi:e}=j0(t,e),e<=2097151)return String(xi*e+t);const n=t&16777215,i=(t>>>24|e<<8)&16777215,r=e>>16&65535;let s=n+i*6777216+r*6710656,o=i+r*8147497,a=r*2;const c=1e7;return s>=c&&(o+=Math.floor(s/c),s%=c),o>=c&&(a+=Math.floor(o/c),o%=c),a.toString()+Nc(o)+Nc(s)}function j0(t,e){return{lo:t>>>0,hi:e>>>0}}function oa(t,e){return{lo:t|0,hi:e|0}}function Ad(t,e){return e=~e,t?t=~t+1:e+=1,oa(t,e)}const Nc=t=>{const e=String(t);return"0000000".slice(e.length)+e};function Mc(t,e){if(t>=0){for(;t>127;)e.push(t&127|128),t=t>>>7;e.push(t)}else{for(let n=0;n<9;n++)e.push(t&127|128),t=t>>7;e.push(1)}}function V0(){let t=this.buf[this.pos++],e=t&127;if(!(t&128))return this.assertBounds(),e;if(t=this.buf[this.pos++],e|=(t&127)<<7,!(t&128))return this.assertBounds(),e;if(t=this.buf[this.pos++],e|=(t&127)<<14,!(t&128))return this.assertBounds(),e;if(t=this.buf[this.pos++],e|=(t&127)<<21,!(t&128))return this.assertBounds(),e;t=this.buf[this.pos++],e|=(t&15)<<28;for(let n=5;t&128&&n<10;n++)t=this.buf[this.pos++];if(t&128)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function $0(){const t=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof t.getBigInt64=="function"&&typeof t.getBigUint64=="function"&&typeof t.setBigInt64=="function"&&typeof t.setBigUint64=="function"&&(typeof process!="object"||typeof Oc!="object"||Oc.BUF_BIGINT_DISABLE!=="1")){const r=BigInt("-9223372036854775808"),s=BigInt("9223372036854775807"),o=BigInt("0"),a=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>s||l<r)throw new Error("int64 invalid: ".concat(c));return l},uParse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>a||l<o)throw new Error("uint64 invalid: ".concat(c));return l},enc(c){return t.setBigInt64(0,this.parse(c),!0),{lo:t.getInt32(0,!0),hi:t.getInt32(4,!0)}},uEnc(c){return t.setBigInt64(0,this.uParse(c),!0),{lo:t.getInt32(0,!0),hi:t.getInt32(4,!0)}},dec(c,l){return t.setInt32(0,c,!0),t.setInt32(4,l,!0),t.getBigInt64(0,!0)},uDec(c,l){return t.setInt32(0,c,!0),t.setInt32(4,l,!0),t.getBigUint64(0,!0)}}}const n=r=>oe(/^-?[0-9]+$/.test(r),"int64 invalid: ".concat(r)),i=r=>oe(/^[0-9]+$/.test(r),"uint64 invalid: ".concat(r));return{zero:"0",supported:!1,parse(r){return typeof r!="string"&&(r=r.toString()),n(r),r},uParse(r){return typeof r!="string"&&(r=r.toString()),i(r),r},enc(r){return typeof r!="string"&&(r=r.toString()),n(r),Ac(r)},uEnc(r){return typeof r!="string"&&(r=r.toString()),i(r),Ac(r)},dec(r,s){return B0(r,s)},uDec(r,s){return _d(r,s)}}}const ne=$0();var O;(function(t){t[t.DOUBLE=1]="DOUBLE",t[t.FLOAT=2]="FLOAT",t[t.INT64=3]="INT64",t[t.UINT64=4]="UINT64",t[t.INT32=5]="INT32",t[t.FIXED64=6]="FIXED64",t[t.FIXED32=7]="FIXED32",t[t.BOOL=8]="BOOL",t[t.STRING=9]="STRING",t[t.BYTES=12]="BYTES",t[t.UINT32=13]="UINT32",t[t.SFIXED32=15]="SFIXED32",t[t.SFIXED64=16]="SFIXED64",t[t.SINT32=17]="SINT32",t[t.SINT64=18]="SINT64"})(O||(O={}));var It;(function(t){t[t.BIGINT=0]="BIGINT",t[t.STRING=1]="STRING"})(It||(It={}));function yt(t,e,n){if(e===n)return!0;if(t==O.BYTES){if(!(e instanceof Uint8Array)||!(n instanceof Uint8Array)||e.length!==n.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==n[i])return!1;return!0}switch(t){case O.UINT64:case O.FIXED64:case O.INT64:case O.SFIXED64:case O.SINT64:return e==n}return!1}function pn(t,e){switch(t){case O.BOOL:return!1;case O.UINT64:case O.FIXED64:case O.INT64:case O.SFIXED64:case O.SINT64:return e==0?ne.zero:"0";case O.DOUBLE:case O.FLOAT:return 0;case O.BYTES:return new Uint8Array(0);case O.STRING:return"";default:return 0}}function Nd(t,e){switch(t){case O.BOOL:return e===!1;case O.STRING:return e==="";case O.BYTES:return e instanceof Uint8Array&&!e.byteLength;default:return e==0}}var ae;(function(t){t[t.Varint=0]="Varint",t[t.Bit64=1]="Bit64",t[t.LengthDelimited=2]="LengthDelimited",t[t.StartGroup=3]="StartGroup",t[t.EndGroup=4]="EndGroup",t[t.Bit32=5]="Bit32"})(ae||(ae={}));class G0{constructor(e){this.stack=[],this.textEncoder=e??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let r=0;r<this.chunks.length;r++)e+=this.chunks[r].length;let n=new Uint8Array(e),i=0;for(let r=0;r<this.chunks.length;r++)n.set(this.chunks[r],i),i+=this.chunks[r].length;return this.chunks=[],n}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),n=this.stack.pop();if(!n)throw new Error("invalid state, fork stack empty");return this.chunks=n.chunks,this.buf=n.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,n){return this.uint32((e<<3|n)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(Gs(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return Pi(e),Mc(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let n=this.textEncoder.encode(e);return this.uint32(n.byteLength),this.raw(n)}float(e){xd(e);let n=new Uint8Array(4);return new DataView(n.buffer).setFloat32(0,e,!0),this.raw(n)}double(e){let n=new Uint8Array(8);return new DataView(n.buffer).setFloat64(0,e,!0),this.raw(n)}fixed32(e){Gs(e);let n=new Uint8Array(4);return new DataView(n.buffer).setUint32(0,e,!0),this.raw(n)}sfixed32(e){Pi(e);let n=new Uint8Array(4);return new DataView(n.buffer).setInt32(0,e,!0),this.raw(n)}sint32(e){return Pi(e),e=(e<<1^e>>31)>>>0,Mc(e,this.buf),this}sfixed64(e){let n=new Uint8Array(8),i=new DataView(n.buffer),r=ne.enc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(n)}fixed64(e){let n=new Uint8Array(8),i=new DataView(n.buffer),r=ne.uEnc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(n)}int64(e){let n=ne.enc(e);return fs(n.lo,n.hi,this.buf),this}sint64(e){let n=ne.enc(e),i=n.hi>>31,r=n.lo<<1^i,s=(n.hi<<1|n.lo>>>31)^i;return fs(r,s,this.buf),this}uint64(e){let n=ne.uEnc(e);return fs(n.lo,n.hi,this.buf),this}}class W0{constructor(e,n){this.varint64=F0,this.uint32=V0,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=n??new TextDecoder}tag(){let e=this.uint32(),n=e>>>3,i=e&7;if(n<=0||i<0||i>5)throw new Error("illegal tag: field no "+n+" wire type "+i);return[n,i]}skip(e,n){let i=this.pos;switch(e){case ae.Varint:for(;this.buf[this.pos++]&128;);break;case ae.Bit64:this.pos+=4;case ae.Bit32:this.pos+=4;break;case ae.LengthDelimited:let r=this.uint32();this.pos+=r;break;case ae.StartGroup:for(;;){const[s,o]=this.tag();if(o===ae.EndGroup){if(n!==void 0&&s!==n)throw new Error("invalid end group tag");break}this.skip(o,s)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(i,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return ne.dec(...this.varint64())}uint64(){return ne.uDec(...this.varint64())}sint64(){let[e,n]=this.varint64(),i=-(e&1);return e=(e>>>1|(n&1)<<31)^i,n=n>>>1^i,ne.dec(e,n)}bool(){let[e,n]=this.varint64();return e!==0||n!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return ne.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return ne.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),n=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(n,n+e)}string(){return this.textDecoder.decode(this.bytes())}}function q0(t,e,n,i){let r;return{typeName:e,extendee:n,get field(){if(!r){const s=typeof i=="function"?i():i;s.name=e.split(".").pop(),s.jsonName="[".concat(e,"]"),r=t.util.newFieldList([s]).list()[0]}return r},runtime:t}}function Md(t){const e=t.field.localName,n=Object.create(null);return n[e]=H0(t),[n,()=>n[e]]}function H0(t){const e=t.field;if(e.repeated)return[];if(e.default!==void 0)return e.default;switch(e.kind){case"enum":return e.T.values[0].no;case"scalar":return pn(e.T,e.L);case"message":const n=e.T,i=new n;return n.fieldWrapper?n.fieldWrapper.unwrapField(i):i;case"map":throw"map fields are not allowed to be extensions"}}function z0(t,e){if(!e.repeated&&(e.kind=="enum"||e.kind=="scalar")){for(let n=t.length-1;n>=0;--n)if(t[n].no==e.no)return[t[n]];return[]}return t.filter(n=>n.no===e.no)}let dt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),Lr=[];for(let t=0;t<dt.length;t++)Lr[dt[t].charCodeAt(0)]=t;Lr[45]=dt.indexOf("+");Lr[95]=dt.indexOf("/");const Ld={dec(t){let e=t.length*3/4;t[t.length-2]=="="?e-=2:t[t.length-1]=="="&&(e-=1);let n=new Uint8Array(e),i=0,r=0,s,o=0;for(let a=0;a<t.length;a++){if(s=Lr[t.charCodeAt(a)],s===void 0)switch(t[a]){case"=":r=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(r){case 0:o=s,r=1;break;case 1:n[i++]=o<<2|(s&48)>>4,o=s,r=2;break;case 2:n[i++]=(o&15)<<4|(s&60)>>2,o=s,r=3;break;case 3:n[i++]=(o&3)<<6|s,r=0;break}}if(r==1)throw Error("invalid base64 string.");return n.subarray(0,i)},enc(t){let e="",n=0,i,r=0;for(let s=0;s<t.length;s++)switch(i=t[s],n){case 0:e+=dt[i>>2],r=(i&3)<<4,n=1;break;case 1:e+=dt[r|i>>4],r=(i&15)<<2,n=2;break;case 2:e+=dt[r|i>>6],e+=dt[i&63],n=0;break}return n&&(e+=dt[r],e+="=",n==1&&(e+="=")),e}};function K0(t,e,n){Fd(e,t);const i=e.runtime.bin.makeReadOptions(n),r=z0(t.getType().runtime.bin.listUnknownFields(t),e.field),[s,o]=Md(e);for(const a of r)e.runtime.bin.readField(s,i.readerFactory(a.data),e.field,a.wireType,i);return o()}function J0(t,e,n,i){Fd(e,t);const r=e.runtime.bin.makeReadOptions(i),s=e.runtime.bin.makeWriteOptions(i);if(Ud(t,e)){const l=t.getType().runtime.bin.listUnknownFields(t).filter(u=>u.no!=e.field.no);t.getType().runtime.bin.discardUnknownFields(t);for(const u of l)t.getType().runtime.bin.onUnknownField(t,u.no,u.wireType,u.data)}const o=s.writerFactory();let a=e.field;!a.opt&&!a.repeated&&(a.kind=="enum"||a.kind=="scalar")&&(a=Object.assign(Object.assign({},e.field),{opt:!0})),e.runtime.bin.writeField(a,n,o,s);const c=r.readerFactory(o.finish());for(;c.pos<c.len;){const[l,u]=c.tag(),d=c.skip(u,l);t.getType().runtime.bin.onUnknownField(t,l,u,d)}}function Ud(t,e){const n=t.getType();return e.extendee.typeName===n.typeName&&!!n.runtime.bin.listUnknownFields(t).find(i=>i.no==e.field.no)}function Fd(t,e){oe(t.extendee.typeName==e.getType().typeName,"extension ".concat(t.typeName," can only be applied to message ").concat(t.extendee.typeName))}function Bd(t,e){const n=t.localName;if(t.repeated)return e[n].length>0;if(t.oneof)return e[t.oneof.localName].case===n;switch(t.kind){case"enum":case"scalar":return t.opt||t.req?e[n]!==void 0:t.kind=="enum"?e[n]!==t.T.values[0].no:!Nd(t.T,e[n]);case"message":return e[n]!==void 0;case"map":return Object.keys(e[n]).length>0}}function Lc(t,e){const n=t.localName,i=!t.opt&&!t.req;if(t.repeated)e[n]=[];else if(t.oneof)e[t.oneof.localName]={case:void 0};else switch(t.kind){case"map":e[n]={};break;case"enum":e[n]=i?t.T.values[0].no:void 0;break;case"scalar":e[n]=i?pn(t.T,t.L):void 0;break;case"message":e[n]=void 0;break}}function Ut(t,e){if(t===null||typeof t!="object"||!Object.getOwnPropertyNames(sa.prototype).every(i=>i in t&&typeof t[i]=="function"))return!1;const n=t.getType();return n===null||typeof n!="function"||!("typeName"in n)||typeof n.typeName!="string"?!1:e===void 0?!0:n.typeName==e.typeName}function jd(t,e){return Ut(e)||!t.fieldWrapper?e:t.fieldWrapper.wrapField(e)}O.DOUBLE,O.FLOAT,O.INT64,O.UINT64,O.INT32,O.UINT32,O.BOOL,O.STRING,O.BYTES;const Uc={ignoreUnknownFields:!1},Fc={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function Y0(t){return t?Object.assign(Object.assign({},Uc),t):Uc}function Q0(t){return t?Object.assign(Object.assign({},Fc),t):Fc}const Ji=Symbol(),Ri=Symbol();function X0(){return{makeReadOptions:Y0,makeWriteOptions:Q0,readMessage(t,e,n,i){if(e==null||Array.isArray(e)||typeof e!="object")throw new Error("cannot decode message ".concat(t.typeName," from JSON: ").concat(nt(e)));i=i??new t;const r=new Map,s=n.typeRegistry;for(const[o,a]of Object.entries(e)){const c=t.fields.findJsonName(o);if(c){if(c.oneof){if(a===null&&c.kind=="scalar")continue;const l=r.get(c.oneof);if(l!==void 0)throw new Error("cannot decode message ".concat(t.typeName,' from JSON: multiple keys for oneof "').concat(c.oneof.name,'" present: "').concat(l,'", "').concat(o,'"'));r.set(c.oneof,o)}Bc(i,a,c,n,t)}else{let l=!1;if(s!=null&&s.findExtension&&o.startsWith("[")&&o.endsWith("]")){const u=s.findExtension(o.substring(1,o.length-1));if(u&&u.extendee.typeName==t.typeName){l=!0;const[d,h]=Md(u);Bc(d,a,u.field,n,u),J0(i,u,h(),n)}}if(!l&&!n.ignoreUnknownFields)throw new Error("cannot decode message ".concat(t.typeName,' from JSON: key "').concat(o,'" is unknown'))}}return i},writeMessage(t,e){const n=t.getType(),i={};let r;try{for(r of n.fields.byNumber()){if(!Bd(r,t)){if(r.req)throw"required field not set";if(!e.emitDefaultValues||!ek(r))continue}const o=r.oneof?t[r.oneof.localName].value:t[r.localName],a=jc(r,o,e);a!==void 0&&(i[e.useProtoFieldName?r.name:r.jsonName]=a)}const s=e.typeRegistry;if(s!=null&&s.findExtensionFor)for(const o of n.runtime.bin.listUnknownFields(t)){const a=s.findExtensionFor(n.typeName,o.no);if(a&&Ud(t,a)){const c=K0(t,a,e),l=jc(a.field,c,e);l!==void 0&&(i[a.field.jsonName]=l)}}}catch(s){const o=r?"cannot encode field ".concat(n.typeName,".").concat(r.name," to JSON"):"cannot encode message ".concat(n.typeName," to JSON"),a=s instanceof Error?s.message:String(s);throw new Error(o+(a.length>0?": ".concat(a):""))}return i},readScalar(t,e,n){return Vn(t,e,n??It.BIGINT,!0)},writeScalar(t,e,n){if(e!==void 0&&(n||Nd(t,e)))return Ii(t,e)},debug:nt}}function nt(t){if(t===null)return"null";switch(typeof t){case"object":return Array.isArray(t)?"array":"object";case"string":return t.length>100?"string":'"'.concat(t.split('"').join('\\"'),'"');default:return String(t)}}function Bc(t,e,n,i,r){let s=n.localName;if(n.repeated){if(oe(n.kind!="map"),e===null)return;if(!Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(nt(e)));const o=t[s];for(const a of e){if(a===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(nt(a)));switch(n.kind){case"message":o.push(n.T.fromJson(a,i));break;case"enum":const c=ps(n.T,a,i.ignoreUnknownFields,!0);c!==Ri&&o.push(c);break;case"scalar":try{o.push(Vn(n.T,a,n.L,!0))}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(nt(a));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}}else if(n.kind=="map"){if(e===null)return;if(typeof e!="object"||Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(nt(e)));const o=t[s];for(const[a,c]of Object.entries(e)){if(c===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: map value null"));let l;try{l=Z0(n.K,a)}catch(u){let d="cannot decode map key for field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(nt(e));throw u instanceof Error&&u.message.length>0&&(d+=": ".concat(u.message)),new Error(d)}switch(n.V.kind){case"message":o[l]=n.V.T.fromJson(c,i);break;case"enum":const u=ps(n.V.T,c,i.ignoreUnknownFields,!0);u!==Ri&&(o[l]=u);break;case"scalar":try{o[l]=Vn(n.V.T,c,It.BIGINT,!0)}catch(d){let h="cannot decode map value for field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(nt(e));throw d instanceof Error&&d.message.length>0&&(h+=": ".concat(d.message)),new Error(h)}break}}}else switch(n.oneof&&(t=t[n.oneof.localName]={case:s},s="value"),n.kind){case"message":const o=n.T;if(e===null&&o.typeName!="google.protobuf.Value")return;let a=t[s];Ut(a)?a.fromJson(e,i):(t[s]=a=o.fromJson(e,i),o.fieldWrapper&&!n.oneof&&(t[s]=o.fieldWrapper.unwrapField(a)));break;case"enum":const c=ps(n.T,e,i.ignoreUnknownFields,!1);switch(c){case Ji:Lc(n,t);break;case Ri:break;default:t[s]=c;break}break;case"scalar":try{const l=Vn(n.T,e,n.L,!1);switch(l){case Ji:Lc(n,t);break;default:t[s]=l;break}}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(nt(e));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}function Z0(t,e){if(t===O.BOOL)switch(e){case"true":e=!0;break;case"false":e=!1;break}return Vn(t,e,It.BIGINT,!0).toString()}function Vn(t,e,n,i){if(e===null)return i?pn(t,n):Ji;switch(t){case O.DOUBLE:case O.FLOAT:if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""||typeof e=="string"&&e.trim().length!==e.length||typeof e!="string"&&typeof e!="number")break;const r=Number(e);if(Number.isNaN(r)||!Number.isFinite(r))break;return t==O.FLOAT&&xd(r),r;case O.INT32:case O.FIXED32:case O.SFIXED32:case O.SINT32:case O.UINT32:let s;if(typeof e=="number"?s=e:typeof e=="string"&&e.length>0&&e.trim().length===e.length&&(s=Number(e)),s===void 0)break;return t==O.UINT32||t==O.FIXED32?Gs(s):Pi(s),s;case O.INT64:case O.SFIXED64:case O.SINT64:if(typeof e!="number"&&typeof e!="string")break;const o=ne.parse(e);return n?o.toString():o;case O.FIXED64:case O.UINT64:if(typeof e!="number"&&typeof e!="string")break;const a=ne.uParse(e);return n?a.toString():a;case O.BOOL:if(typeof e!="boolean")break;return e;case O.STRING:if(typeof e!="string")break;try{encodeURIComponent(e)}catch{throw new Error("invalid UTF8")}return e;case O.BYTES:if(e==="")return new Uint8Array(0);if(typeof e!="string")break;return Ld.dec(e)}throw new Error}function ps(t,e,n,i){if(e===null)return t.typeName=="google.protobuf.NullValue"?0:i?t.values[0].no:Ji;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const r=t.findName(e);if(r!==void 0)return r.no;if(n)return Ri;break}throw new Error("cannot decode enum ".concat(t.typeName," from JSON: ").concat(nt(e)))}function ek(t){return t.repeated||t.kind=="map"?!0:!(t.oneof||t.kind=="message"||t.opt||t.req)}function jc(t,e,n){if(t.kind=="map"){oe(typeof e=="object"&&e!=null);const i={},r=Object.entries(e);switch(t.V.kind){case"scalar":for(const[o,a]of r)i[o.toString()]=Ii(t.V.T,a);break;case"message":for(const[o,a]of r)i[o.toString()]=a.toJson(n);break;case"enum":const s=t.V.T;for(const[o,a]of r)i[o.toString()]=ms(s,a,n.enumAsInteger);break}return n.emitDefaultValues||r.length>0?i:void 0}if(t.repeated){oe(Array.isArray(e));const i=[];switch(t.kind){case"scalar":for(let r=0;r<e.length;r++)i.push(Ii(t.T,e[r]));break;case"enum":for(let r=0;r<e.length;r++)i.push(ms(t.T,e[r],n.enumAsInteger));break;case"message":for(let r=0;r<e.length;r++)i.push(e[r].toJson(n));break}return n.emitDefaultValues||i.length>0?i:void 0}switch(t.kind){case"scalar":return Ii(t.T,e);case"enum":return ms(t.T,e,n.enumAsInteger);case"message":return jd(t.T,e).toJson(n)}}function ms(t,e,n){var i;if(oe(typeof e=="number"),t.typeName=="google.protobuf.NullValue")return null;if(n)return e;const r=t.findNumber(e);return(i=r==null?void 0:r.name)!==null&&i!==void 0?i:e}function Ii(t,e){switch(t){case O.INT32:case O.SFIXED32:case O.SINT32:case O.FIXED32:case O.UINT32:return oe(typeof e=="number"),e;case O.FLOAT:case O.DOUBLE:return oe(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e;case O.STRING:return oe(typeof e=="string"),e;case O.BOOL:return oe(typeof e=="boolean"),e;case O.UINT64:case O.FIXED64:case O.INT64:case O.SFIXED64:case O.SINT64:return oe(typeof e=="bigint"||typeof e=="string"||typeof e=="number"),e.toString();case O.BYTES:return oe(e instanceof Uint8Array),Ld.enc(e)}}const Kt=Symbol("@bufbuild/protobuf/unknown-fields"),Vc={readUnknownFields:!0,readerFactory:t=>new W0(t)},$c={writeUnknownFields:!0,writerFactory:()=>new G0};function tk(t){return t?Object.assign(Object.assign({},Vc),t):Vc}function nk(t){return t?Object.assign(Object.assign({},$c),t):$c}function ik(){return{makeReadOptions:tk,makeWriteOptions:nk,listUnknownFields(t){var e;return(e=t[Kt])!==null&&e!==void 0?e:[]},discardUnknownFields(t){delete t[Kt]},writeUnknownFields(t,e){const i=t[Kt];if(i)for(const r of i)e.tag(r.no,r.wireType).raw(r.data)},onUnknownField(t,e,n,i){const r=t;Array.isArray(r[Kt])||(r[Kt]=[]),r[Kt].push({no:e,wireType:n,data:i})},readMessage(t,e,n,i,r){const s=t.getType(),o=r?e.len:e.pos+n;let a,c;for(;e.pos<o&&([a,c]=e.tag(),!(r===!0&&c==ae.EndGroup));){const l=s.fields.find(a);if(!l){const u=e.skip(c,a);i.readUnknownFields&&this.onUnknownField(t,a,c,u);continue}Gc(t,e,l,c,i)}if(r&&(c!=ae.EndGroup||a!==n))throw new Error("invalid end group tag")},readField:Gc,writeMessage(t,e,n){const i=t.getType();for(const r of i.fields.byNumber()){if(!Bd(r,t)){if(r.req)throw new Error("cannot encode field ".concat(i.typeName,".").concat(r.name," to binary: required field not set"));continue}const s=r.oneof?t[r.oneof.localName].value:t[r.localName];Wc(r,s,e,n)}return n.writeUnknownFields&&this.writeUnknownFields(t,e),e},writeField(t,e,n,i){e!==void 0&&Wc(t,e,n,i)}}}function Gc(t,e,n,i,r){let{repeated:s,localName:o}=n;switch(n.oneof&&(t=t[n.oneof.localName],t.case!=o&&delete t.value,t.case=o,o="value"),n.kind){case"scalar":case"enum":const a=n.kind=="enum"?O.INT32:n.T;let c=Yi;if(n.kind=="scalar"&&n.L>0&&(c=sk),s){let h=t[o];if(i==ae.LengthDelimited&&a!=O.STRING&&a!=O.BYTES){let g=e.uint32()+e.pos;for(;e.pos<g;)h.push(c(e,a))}else h.push(c(e,a))}else t[o]=c(e,a);break;case"message":const l=n.T;s?t[o].push(Di(e,new l,r,n)):Ut(t[o])?Di(e,t[o],r,n):(t[o]=Di(e,new l,r,n),l.fieldWrapper&&!n.oneof&&!n.repeated&&(t[o]=l.fieldWrapper.unwrapField(t[o])));break;case"map":let[u,d]=rk(n,e,r);t[o][u]=d;break}}function Di(t,e,n,i){const r=e.getType().runtime.bin,s=i==null?void 0:i.delimited;return r.readMessage(e,t,s?i.no:t.uint32(),n,s),e}function rk(t,e,n){const i=e.uint32(),r=e.pos+i;let s,o;for(;e.pos<r;){const[a]=e.tag();switch(a){case 1:s=Yi(e,t.K);break;case 2:switch(t.V.kind){case"scalar":o=Yi(e,t.V.T);break;case"enum":o=e.int32();break;case"message":o=Di(e,new t.V.T,n,void 0);break}break}}if(s===void 0&&(s=pn(t.K,It.BIGINT)),typeof s!="string"&&typeof s!="number"&&(s=s.toString()),o===void 0)switch(t.V.kind){case"scalar":o=pn(t.V.T,It.BIGINT);break;case"enum":o=t.V.T.values[0].no;break;case"message":o=new t.V.T;break}return[s,o]}function sk(t,e){const n=Yi(t,e);return typeof n=="bigint"?n.toString():n}function Yi(t,e){switch(e){case O.STRING:return t.string();case O.BOOL:return t.bool();case O.DOUBLE:return t.double();case O.FLOAT:return t.float();case O.INT32:return t.int32();case O.INT64:return t.int64();case O.UINT64:return t.uint64();case O.FIXED64:return t.fixed64();case O.BYTES:return t.bytes();case O.FIXED32:return t.fixed32();case O.SFIXED32:return t.sfixed32();case O.SFIXED64:return t.sfixed64();case O.SINT64:return t.sint64();case O.UINT32:return t.uint32();case O.SINT32:return t.sint32()}}function Wc(t,e,n,i){oe(e!==void 0);const r=t.repeated;switch(t.kind){case"scalar":case"enum":let s=t.kind=="enum"?O.INT32:t.T;if(r)if(oe(Array.isArray(e)),t.packed)ak(n,s,t.no,e);else for(const o of e)$n(n,s,t.no,o);else $n(n,s,t.no,e);break;case"message":if(r){oe(Array.isArray(e));for(const o of e)qc(n,i,t,o)}else qc(n,i,t,e);break;case"map":oe(typeof e=="object"&&e!=null);for(const[o,a]of Object.entries(e))ok(n,i,t,o,a);break}}function ok(t,e,n,i,r){t.tag(n.no,ae.LengthDelimited),t.fork();let s=i;switch(n.K){case O.INT32:case O.FIXED32:case O.UINT32:case O.SFIXED32:case O.SINT32:s=Number.parseInt(i);break;case O.BOOL:oe(i=="true"||i=="false"),s=i=="true";break}switch($n(t,n.K,1,s),n.V.kind){case"scalar":$n(t,n.V.T,2,r);break;case"enum":$n(t,O.INT32,2,r);break;case"message":oe(r!==void 0),t.tag(2,ae.LengthDelimited).bytes(r.toBinary(e));break}t.join()}function qc(t,e,n,i){const r=jd(n.T,i);n.delimited?t.tag(n.no,ae.StartGroup).raw(r.toBinary(e)).tag(n.no,ae.EndGroup):t.tag(n.no,ae.LengthDelimited).bytes(r.toBinary(e))}function $n(t,e,n,i){oe(i!==void 0);let[r,s]=Vd(e);t.tag(n,r)[s](i)}function ak(t,e,n,i){if(!i.length)return;t.tag(n,ae.LengthDelimited).fork();let[,r]=Vd(e);for(let s=0;s<i.length;s++)t[r](i[s]);t.join()}function Vd(t){let e=ae.Varint;switch(t){case O.BYTES:case O.STRING:e=ae.LengthDelimited;break;case O.DOUBLE:case O.FIXED64:case O.SFIXED64:e=ae.Bit64;break;case O.FIXED32:case O.SFIXED32:case O.FLOAT:e=ae.Bit32;break}const n=O[t].toLowerCase();return[e,n]}function ck(){return{setEnumType:Id,initPartial(t,e){if(t===void 0)return;const n=e.getType();for(const i of n.fields.byMember()){const r=i.localName,s=e,o=t;if(o[r]!=null)switch(i.kind){case"oneof":const a=o[r].case;if(a===void 0)continue;const c=i.findField(a);let l=o[r].value;c&&c.kind=="message"&&!Ut(l,c.T)?l=new c.T(l):c&&c.kind==="scalar"&&c.T===O.BYTES&&(l=_n(l)),s[r]={case:a,value:l};break;case"scalar":case"enum":let u=o[r];i.T===O.BYTES&&(u=i.repeated?u.map(_n):_n(u)),s[r]=u;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===O.BYTES)for(const[f,g]of Object.entries(o[r]))s[r][f]=_n(g);else Object.assign(s[r],o[r]);break;case"message":const h=i.V.T;for(const f of Object.keys(o[r])){let g=o[r][f];h.fieldWrapper||(g=new h(g)),s[r][f]=g}break}break;case"message":const d=i.T;if(i.repeated)s[r]=o[r].map(h=>Ut(h,d)?h:new d(h));else{const h=o[r];d.fieldWrapper?d.typeName==="google.protobuf.BytesValue"?s[r]=_n(h):s[r]=h:s[r]=Ut(h,d)?h:new d(h)}break}}},equals(t,e,n){return e===n?!0:!e||!n?!1:t.fields.byMember().every(i=>{const r=e[i.localName],s=n[i.localName];if(i.repeated){if(r.length!==s.length)return!1;switch(i.kind){case"message":return r.every((o,a)=>i.T.equals(o,s[a]));case"scalar":return r.every((o,a)=>yt(i.T,o,s[a]));case"enum":return r.every((o,a)=>yt(O.INT32,o,s[a]))}throw new Error("repeated cannot contain ".concat(i.kind))}switch(i.kind){case"message":return i.T.equals(r,s);case"enum":return yt(O.INT32,r,s);case"scalar":return yt(i.T,r,s);case"oneof":if(r.case!==s.case)return!1;const o=i.findField(r.case);if(o===void 0)return!0;switch(o.kind){case"message":return o.T.equals(r.value,s.value);case"enum":return yt(O.INT32,r.value,s.value);case"scalar":return yt(o.T,r.value,s.value)}throw new Error("oneof cannot contain ".concat(o.kind));case"map":const a=Object.keys(r).concat(Object.keys(s));switch(i.V.kind){case"message":const c=i.V.T;return a.every(u=>c.equals(r[u],s[u]));case"enum":return a.every(u=>yt(O.INT32,r[u],s[u]));case"scalar":const l=i.V.T;return a.every(u=>yt(l,r[u],s[u]))}break}})},clone(t){const e=t.getType(),n=new e,i=n;for(const r of e.fields.byMember()){const s=t[r.localName];let o;if(r.repeated)o=s.map(ki);else if(r.kind=="map"){o=i[r.localName];for(const[a,c]of Object.entries(s))o[a]=ki(c)}else r.kind=="oneof"?o=r.findField(s.case)?{case:s.case,value:ki(s.value)}:{case:void 0}:o=ki(s);i[r.localName]=o}for(const r of e.runtime.bin.listUnknownFields(t))e.runtime.bin.onUnknownField(i,r.no,r.wireType,r.data);return n}}}function ki(t){if(t===void 0)return t;if(Ut(t))return t.clone();if(t instanceof Uint8Array){const e=new Uint8Array(t.byteLength);return e.set(t),e}return t}function _n(t){return t instanceof Uint8Array?t:new Uint8Array(t)}function lk(t,e,n){return{syntax:t,json:X0(),bin:ik(),util:Object.assign(Object.assign({},ck()),{newFieldList:e,initFields:n}),makeMessageType(i,r,s){return U0(this,i,r,s)},makeEnum:L0,makeEnumType:Dd,getEnumType:M0,makeExtension(i,r,s){return q0(this,i,r,s)}}}class uk{constructor(e,n){this._fields=e,this._normalizer=n}findJsonName(e){if(!this.jsonNames){const n={};for(const i of this.list())n[i.jsonName]=n[i.name]=i;this.jsonNames=n}return this.jsonNames[e]}find(e){if(!this.numbers){const n={};for(const i of this.list())n[i.no]=i;this.numbers=n}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,n)=>e.no-n.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let n;for(const i of this.list())i.oneof?i.oneof!==n&&(n=i.oneof,e.push(n)):e.push(i)}return this.members}}function $d(t,e){const n=Gd(t);return e?n:gk(mk(n))}function dk(t){return $d(t,!1)}const hk=Gd;function Gd(t){let e=!1;const n=[];for(let i=0;i<t.length;i++){let r=t.charAt(i);switch(r){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":n.push(r),e=!1;break;default:e&&(e=!1,r=r.toUpperCase()),n.push(r);break}}return n.join("")}const fk=new Set(["constructor","toString","toJSON","valueOf"]),pk=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),Wd=t=>"".concat(t,"$"),mk=t=>pk.has(t)?Wd(t):t,gk=t=>fk.has(t)?Wd(t):t;class vk{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=dk(e)}addField(e){oe(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let n=0;n<this.fields.length;n++)this._lookup[this.fields[n].localName]=this.fields[n]}return this._lookup[e]}}function bk(t,e){var n,i,r,s,o,a;const c=[];let l;for(const u of typeof t=="function"?t():t){const d=u;if(d.localName=$d(u.name,u.oneof!==void 0),d.jsonName=(n=u.jsonName)!==null&&n!==void 0?n:hk(u.name),d.repeated=(i=u.repeated)!==null&&i!==void 0?i:!1,u.kind=="scalar"&&(d.L=(r=u.L)!==null&&r!==void 0?r:It.BIGINT),d.delimited=(s=u.delimited)!==null&&s!==void 0?s:!1,d.req=(o=u.req)!==null&&o!==void 0?o:!1,d.opt=(a=u.opt)!==null&&a!==void 0?a:!1,u.packed===void 0&&(d.packed=u.kind=="enum"||u.kind=="scalar"&&u.T!=O.BYTES&&u.T!=O.STRING),u.oneof!==void 0){const h=typeof u.oneof=="string"?u.oneof:u.oneof.name;(!l||l.name!=h)&&(l=new vk(h)),d.oneof=l,l.addField(d)}c.push(d)}return c}const R=lk("proto3",t=>new uk(t,e=>bk(e)),t=>{for(const e of t.getType().fields.byMember()){if(e.opt)continue;const n=e.localName,i=t;if(e.repeated){i[n]=[];continue}switch(e.kind){case"oneof":i[n]={case:void 0};break;case"enum":i[n]=0;break;case"map":i[n]={};break;case"scalar":i[n]=pn(e.T,e.L);break}}});class Ee extends sa{constructor(e){super(),this.seconds=ne.zero,this.nanos=0,R.util.initPartial(e,this)}fromJson(e,n){if(typeof e!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(R.json.debug(e)));const i=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const r=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(r))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(r<Date.parse("0001-01-01T00:00:00Z")||r>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=ne.parse(r/1e3),this.nanos=0,i[7]&&(this.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9),this}toJson(e){const n=Number(this.seconds)*1e3;if(n<Date.parse("0001-01-01T00:00:00Z")||n>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let i="Z";if(this.nanos>0){const r=(this.nanos+1e9).toString().substring(1);r.substring(3)==="000000"?i="."+r.substring(0,3)+"Z":r.substring(6)==="000"?i="."+r.substring(0,6)+"Z":i="."+r+"Z"}return new Date(n).toISOString().replace(".000Z",i)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Ee.fromDate(new Date)}static fromDate(e){const n=e.getTime();return new Ee({seconds:ne.parse(Math.floor(n/1e3)),nanos:n%1e3*1e6})}static fromBinary(e,n){return new Ee().fromBinary(e,n)}static fromJson(e,n){return new Ee().fromJson(e,n)}static fromJsonString(e,n){return new Ee().fromJsonString(e,n)}static equals(e,n){return R.util.equals(Ee,e,n)}}Ee.runtime=R;Ee.typeName="google.protobuf.Timestamp";Ee.fields=R.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const yk=R.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Ee},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:kk,repeated:!0},{no:5,name:"events",kind:"message",T:Ck,repeated:!0}]),kk=R.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:Sk,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),Sk=R.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Ee},{no:3,name:"value",kind:"scalar",T:2}]),Ck=R.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Ee},{no:7,name:"normalized_end_timestamp",kind:"message",T:Ee,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),He=R.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),be=R.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),aa=R.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),Un=R.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),ei=R.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),en=R.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"}]),Jt=R.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),Tk=R.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),it=R.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"}]),ca=R.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:Qi,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:nh}]),Qi=R.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),Ek=R.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:R.getEnumType(be),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),ti=R.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:R.getEnumType(Ws)},{no:4,name:"tracks",kind:"message",T:Xt,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:Ek},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:R.getEnumType(Xi)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:R.getEnumType(en)}]),Ws=R.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),Xi=R.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"}]),Le=R.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),wk=R.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:Ft,repeated:!0}]),Xt=R.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:R.getEnumType(He)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:R.getEnumType(be)},{no:10,name:"layers",kind:"message",T:Ft,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:wk,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:R.getEnumType(Le)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:nh},{no:19,name:"audio_features",kind:"enum",T:R.getEnumType(it),repeated:!0}]),Ft=R.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:R.getEnumType(aa)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13}]),kt=R.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:R.getEnumType(ee)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:Hd,oneof:"value"},{no:3,name:"speaker",kind:"message",T:Pk,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:zd,oneof:"value"},{no:7,name:"transcription",kind:"message",T:xk,oneof:"value"},{no:8,name:"metrics",kind:"message",T:yk,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:qs,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:Kd,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:Jd,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:Yd,oneof:"value"}]),ee=R.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),Pk=R.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:qd,repeated:!0}]),qd=R.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),Hd=R.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0}]),zd=R.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),xk=R.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:Rk,repeated:!0}]),Rk=R.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),qs=R.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),Kd=R.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),Jd=R.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),Yd=R.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:Qd,oneof:"value"}]),Qd=R.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),Xd=R.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),Ik=R.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:R.getEnumType(Zd)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),Zd=R.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),Dk=R.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:R.getEnumType(eh)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),eh=R.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"}]),th=R.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:Hc},{no:2,name:"screen",kind:"message",T:Hc},{no:3,name:"resume_connection",kind:"enum",T:R.getEnumType(ei)},{no:4,name:"disabled_codecs",kind:"message",T:Ok},{no:5,name:"force_relay",kind:"enum",T:R.getEnumType(ei)}]),Hc=R.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:R.getEnumType(ei)}]),Ok=R.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:Qi,repeated:!0},{no:2,name:"publish",kind:"message",T:Qi,repeated:!0}]),nh=R.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),ze=R.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),Hs=R.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),_k=R.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),Ak=R.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:Vt,oneof:"message"},{no:2,name:"answer",kind:"message",T:Vt,oneof:"message"},{no:3,name:"trickle",kind:"message",T:la,oneof:"message"},{no:4,name:"add_track",kind:"message",T:Ks,oneof:"message"},{no:5,name:"mute",kind:"message",T:ua,oneof:"message"},{no:6,name:"subscription",kind:"message",T:Ur,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:ih,oneof:"message"},{no:8,name:"leave",kind:"message",T:Fr,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:sh,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:lh,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:uh,oneof:"message"},{no:13,name:"simulate",kind:"message",T:tt,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:oh,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:hh,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:rh,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:Fk,oneof:"message"}]),zc=R.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:Nk,oneof:"message"},{no:2,name:"answer",kind:"message",T:Vt,oneof:"message"},{no:3,name:"offer",kind:"message",T:Vt,oneof:"message"},{no:4,name:"trickle",kind:"message",T:la,oneof:"message"},{no:5,name:"update",kind:"message",T:Uk,oneof:"message"},{no:6,name:"track_published",kind:"message",T:da,oneof:"message"},{no:8,name:"leave",kind:"message",T:Fr,oneof:"message"},{no:9,name:"mute",kind:"message",T:ua,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:Bk,oneof:"message"},{no:11,name:"room_update",kind:"message",T:jk,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:$k,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:Wk,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:Hk,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:zk,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:Lk,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:Mk,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Kk,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:Qk,oneof:"message"},{no:22,name:"request_response",kind:"message",T:Xk,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:Zk,oneof:"message"}]),zs=R.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]),Ks=R.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:R.getEnumType(He)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:R.getEnumType(be)},{no:9,name:"layers",kind:"message",T:Ft,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:zs,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:R.getEnumType(Le)},{no:15,name:"stream",kind:"scalar",T:9}]),la=R.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:R.getEnumType(ze)},{no:3,name:"final",kind:"scalar",T:8}]),ua=R.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),Nk=R.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:ca},{no:2,name:"participant",kind:"message",T:ti},{no:3,name:"other_participants",kind:"message",T:ti,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:ah,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:th},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:Ik},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:Qi,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),Mk=R.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:ah,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:th}]),da=R.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:Xt}]),Lk=R.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),Vt=R.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9}]),Uk=R.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:ti,repeated:!0}]),Ur=R.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:Xd,repeated:!0}]),ih=R.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:R.getEnumType(aa)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),rh=R.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:R.getEnumType(it),repeated:!0}]),Fk=R.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),Fr=R.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:R.getEnumType(en)},{no:3,name:"action",kind:"enum",T:R.getEnumType(tn)},{no:4,name:"regions",kind:"message",T:Jk}]),tn=R.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),sh=R.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:Ft,repeated:!0}]),oh=R.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),ah=R.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),Bk=R.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:qd,repeated:!0}]),jk=R.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:ca}]),Vk=R.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:R.getEnumType(Un)},{no:3,name:"score",kind:"scalar",T:2}]),$k=R.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:Vk,repeated:!0}]),Gk=R.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:R.getEnumType(Hs)}]),Wk=R.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:Gk,repeated:!0}]),ha=R.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:R.getEnumType(aa)},{no:2,name:"enabled",kind:"scalar",T:8}]),qk=R.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:ha,repeated:!0}]),Hk=R.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:ha,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:qk,repeated:!0}]),ch=R.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),lh=R.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:ch,repeated:!0}]),zk=R.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),uh=R.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:Vt},{no:2,name:"subscription",kind:"message",T:Ur},{no:3,name:"publish_tracks",kind:"message",T:da,repeated:!0},{no:4,name:"data_channels",kind:"message",T:dh,repeated:!0},{no:5,name:"offer",kind:"message",T:Vt},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0}]),dh=R.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:R.getEnumType(ze)}]),tt=R.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:R.getEnumType(_k),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),hh=R.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),Kk=R.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),Jk=R.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:Yk,repeated:!0}]),Yk=R.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),Qk=R.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:R.getEnumType(Tk)}]),Xk=R.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:R.getEnumType(fh)},{no:3,name:"message",kind:"scalar",T:9}]),fh=R.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"}]),Zk=R.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]);function eS(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Oi={exports:{}},tS=Oi.exports,Kc;function nS(){return Kc||(Kc=1,function(t){(function(e,n){t.exports?t.exports=n():e.log=n()})(tS,function(){var e=function(){},n="undefined",i=typeof window!==n&&typeof window.navigator!==n&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},o=null;function a(m,b){var v=m[b];if(typeof v.bind=="function")return v.bind(m);try{return Function.prototype.bind.call(v,m)}catch{return function(){return Function.prototype.apply.apply(v,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===n?!1:m==="trace"&&i?c:console[m]!==void 0?a(console,m):console.log!==void 0?a(console,"log"):e}function u(){for(var m=this.getLevel(),b=0;b<r.length;b++){var v=r[b];this[v]=b<m?e:this.methodFactory(v,m,this.name)}if(this.log=this.debug,typeof console===n&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==n&&(u.call(this),this[m].apply(this,arguments))}}function h(m,b,v){return l(m)||d.apply(this,arguments)}function f(m,b){var v=this,T,E,k,y="loglevel";typeof m=="string"?y+=":"+m:typeof m=="symbol"&&(y=void 0);function C(M){var B=(r[M]||"silent").toUpperCase();if(!(typeof window===n||!y)){try{window.localStorage[y]=B;return}catch{}try{window.document.cookie=encodeURIComponent(y)+"="+B+";"}catch{}}}function x(){var M;if(!(typeof window===n||!y)){try{M=window.localStorage[y]}catch{}if(typeof M===n)try{var B=window.document.cookie,K=encodeURIComponent(y),Q=B.indexOf(K+"=");Q!==-1&&(M=/^([^;]+)/.exec(B.slice(Q+K.length+1))[1])}catch{}return v.levels[M]===void 0&&(M=void 0),M}}function _(){if(!(typeof window===n||!y)){try{window.localStorage.removeItem(y)}catch{}try{window.document.cookie=encodeURIComponent(y)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function A(M){var B=M;if(typeof B=="string"&&v.levels[B.toUpperCase()]!==void 0&&(B=v.levels[B.toUpperCase()]),typeof B=="number"&&B>=0&&B<=v.levels.SILENT)return B;throw new TypeError("log.setLevel() called with invalid level: "+M)}v.name=m,v.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},v.methodFactory=b||h,v.getLevel=function(){return k??E??T},v.setLevel=function(M,B){return k=A(M),B!==!1&&C(k),u.call(v)},v.setDefaultLevel=function(M){E=A(M),x()||v.setLevel(M,!1)},v.resetLevel=function(){k=null,_(),u.call(v)},v.enableAll=function(M){v.setLevel(v.levels.TRACE,M)},v.disableAll=function(M){v.setLevel(v.levels.SILENT,M)},v.rebuild=function(){if(o!==v&&(T=A(o.getLevel())),u.call(v),o===v)for(var M in s)s[M].rebuild()},T=A(o?o.getLevel():"WARN");var N=x();N!=null&&(k=A(N)),u.call(v)}o=new f,o.getLogger=function(b){if(typeof b!="symbol"&&typeof b!="string"||b==="")throw new TypeError("You must supply a name when creating a logger.");var v=s[b];return v||(v=s[b]=new f(b,o.methodFactory)),v};var g=typeof window!==n?window.log:void 0;return o.noConflict=function(){return typeof window!==n&&window.log===o&&(window.log=g),o},o.getLoggers=function(){return s},o.default=o,o})}(Oi)),Oi.exports}var Br=nS(),Js;(function(t){t[t.trace=0]="trace",t[t.debug=1]="debug",t[t.info=2]="info",t[t.warn=3]="warn",t[t.error=4]="error",t[t.silent=5]="silent"})(Js||(Js={}));var Je;(function(t){t.Default="livekit",t.Room="livekit-room",t.Participant="livekit-participant",t.Track="livekit-track",t.Publication="livekit-track-publication",t.Engine="livekit-engine",t.Signal="livekit-signal",t.PCManager="livekit-pc-manager",t.PCTransport="livekit-pc-transport",t.E2EE="lk-e2ee"})(Je||(Je={}));let V=Br.getLogger("livekit");Object.values(Je).map(t=>Br.getLogger(t));V.setDefaultLevel(Js.info);function ft(t){const e=Br.getLogger(t);return e.setDefaultLevel(V.getLevel()),e}const iS=Br.getLogger("lk-e2ee"),An=7e3,rS=[0,300,2*2*300,3*3*300,4*4*300,An,An,An,An,An];class sS{constructor(e){this._retryDelays=e!==void 0?[...e]:rS}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const n=this._retryDelays[e.retryCount];return e.retryCount<=1?n:n+Math.random()*1e3}}function S(t,e,n,i){function r(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(u){try{l(i.next(u))}catch(d){o(d)}}function c(u){try{l(i.throw(u))}catch(d){o(d)}}function l(u){u.done?s(u.value):r(u.value).then(a,c)}l((i=i.apply(t,e||[])).next())})}function Jc(t){var e=typeof Symbol=="function"&&Symbol.iterator,n=e&&t[e],i=0;if(n)return n.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Qt(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator],n;return e?e.call(t):(t=typeof Jc=="function"?Jc(t):t[Symbol.iterator](),n={},i("next"),i("throw"),i("return"),n[Symbol.asyncIterator]=function(){return this},n);function i(s){n[s]=t[s]&&function(o){return new Promise(function(a,c){o=t[s](o),r(a,c,o.done,o.value)})}}function r(s,o,a,c){Promise.resolve(c).then(function(l){s({value:l,done:a})},o)}}var Si={exports:{}},Yc;function oS(){if(Yc)return Si.exports;Yc=1;var t=typeof Reflect=="object"?Reflect:null,e=t&&typeof t.apply=="function"?t.apply:function(y,C,x){return Function.prototype.apply.call(y,C,x)},n;t&&typeof t.ownKeys=="function"?n=t.ownKeys:Object.getOwnPropertySymbols?n=function(y){return Object.getOwnPropertyNames(y).concat(Object.getOwnPropertySymbols(y))}:n=function(y){return Object.getOwnPropertyNames(y)};function i(k){console&&console.warn&&console.warn(k)}var r=Number.isNaN||function(y){return y!==y};function s(){s.init.call(this)}Si.exports=s,Si.exports.once=v,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var o=10;function a(k){if(typeof k!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof k)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(k){if(typeof k!="number"||k<0||r(k))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+k+".");o=k}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(y){if(typeof y!="number"||y<0||r(y))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+y+".");return this._maxListeners=y,this};function c(k){return k._maxListeners===void 0?s.defaultMaxListeners:k._maxListeners}s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(y){for(var C=[],x=1;x<arguments.length;x++)C.push(arguments[x]);var _=y==="error",A=this._events;if(A!==void 0)_=_&&A.error===void 0;else if(!_)return!1;if(_){var N;if(C.length>0&&(N=C[0]),N instanceof Error)throw N;var M=new Error("Unhandled error."+(N?" ("+N.message+")":""));throw M.context=N,M}var B=A[y];if(B===void 0)return!1;if(typeof B=="function")e(B,this,C);else for(var K=B.length,Q=g(B,K),x=0;x<K;++x)e(Q[x],this,C);return!0};function l(k,y,C,x){var _,A,N;if(a(C),A=k._events,A===void 0?(A=k._events=Object.create(null),k._eventsCount=0):(A.newListener!==void 0&&(k.emit("newListener",y,C.listener?C.listener:C),A=k._events),N=A[y]),N===void 0)N=A[y]=C,++k._eventsCount;else if(typeof N=="function"?N=A[y]=x?[C,N]:[N,C]:x?N.unshift(C):N.push(C),_=c(k),_>0&&N.length>_&&!N.warned){N.warned=!0;var M=new Error("Possible EventEmitter memory leak detected. "+N.length+" "+String(y)+" listeners added. Use emitter.setMaxListeners() to increase limit");M.name="MaxListenersExceededWarning",M.emitter=k,M.type=y,M.count=N.length,i(M)}return k}s.prototype.addListener=function(y,C){return l(this,y,C,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(y,C){return l(this,y,C,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(k,y,C){var x={fired:!1,wrapFn:void 0,target:k,type:y,listener:C},_=u.bind(x);return _.listener=C,x.wrapFn=_,_}s.prototype.once=function(y,C){return a(C),this.on(y,d(this,y,C)),this},s.prototype.prependOnceListener=function(y,C){return a(C),this.prependListener(y,d(this,y,C)),this},s.prototype.removeListener=function(y,C){var x,_,A,N,M;if(a(C),_=this._events,_===void 0)return this;if(x=_[y],x===void 0)return this;if(x===C||x.listener===C)--this._eventsCount===0?this._events=Object.create(null):(delete _[y],_.removeListener&&this.emit("removeListener",y,x.listener||C));else if(typeof x!="function"){for(A=-1,N=x.length-1;N>=0;N--)if(x[N]===C||x[N].listener===C){M=x[N].listener,A=N;break}if(A<0)return this;A===0?x.shift():m(x,A),x.length===1&&(_[y]=x[0]),_.removeListener!==void 0&&this.emit("removeListener",y,M||C)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(y){var C,x,_;if(x=this._events,x===void 0)return this;if(x.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):x[y]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete x[y]),this;if(arguments.length===0){var A=Object.keys(x),N;for(_=0;_<A.length;++_)N=A[_],N!=="removeListener"&&this.removeAllListeners(N);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(C=x[y],typeof C=="function")this.removeListener(y,C);else if(C!==void 0)for(_=C.length-1;_>=0;_--)this.removeListener(y,C[_]);return this};function h(k,y,C){var x=k._events;if(x===void 0)return[];var _=x[y];return _===void 0?[]:typeof _=="function"?C?[_.listener||_]:[_]:C?b(_):g(_,_.length)}s.prototype.listeners=function(y){return h(this,y,!0)},s.prototype.rawListeners=function(y){return h(this,y,!1)},s.listenerCount=function(k,y){return typeof k.listenerCount=="function"?k.listenerCount(y):f.call(k,y)},s.prototype.listenerCount=f;function f(k){var y=this._events;if(y!==void 0){var C=y[k];if(typeof C=="function")return 1;if(C!==void 0)return C.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]};function g(k,y){for(var C=new Array(y),x=0;x<y;++x)C[x]=k[x];return C}function m(k,y){for(;y+1<k.length;y++)k[y]=k[y+1];k.pop()}function b(k){for(var y=new Array(k.length),C=0;C<y.length;++C)y[C]=k[C].listener||k[C];return y}function v(k,y){return new Promise(function(C,x){function _(N){k.removeListener(y,A),x(N)}function A(){typeof k.removeListener=="function"&&k.removeListener("error",_),C([].slice.call(arguments))}E(k,y,A,{once:!0}),y!=="error"&&T(k,_,{once:!0})})}function T(k,y,C){typeof k.on=="function"&&E(k,"error",y,C)}function E(k,y,C,x){if(typeof k.on=="function")x.once?k.once(y,C):k.on(y,C);else if(typeof k.addEventListener=="function")k.addEventListener(y,function _(A){x.once&&k.removeEventListener(y,_),C(A)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof k)}return Si.exports}var at=oS();let ph=!0,mh=!0;function _i(t,e,n){const i=t.match(e);return i&&i.length>=n&&parseInt(i[n],10)}function Wt(t,e,n){if(!t.RTCPeerConnection)return;const i=t.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(o,a){if(o!==e)return r.apply(this,arguments);const c=l=>{const u=n(l);u&&(a.handleEvent?a.handleEvent(u):a(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[o,c])};const s=i.removeEventListener;i.removeEventListener=function(o,a){if(o!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(a))return s.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(o){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),o&&this.addEventListener(e,this["_on"+e]=o)},enumerable:!0,configurable:!0})}function aS(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(ph=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function cS(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(mh=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function gh(){if(typeof window=="object"){if(ph)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function fa(t,e){mh&&console.warn(t+" is deprecated, please use "+e+" instead.")}function lS(t){const e={browser:null,version:null};if(typeof t>"u"||!t.navigator||!t.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:n}=t;if(n.userAgentData&&n.userAgentData.brands){const i=n.userAgentData.brands.find(r=>r.brand==="Chromium");if(i)return{browser:"chrome",version:parseInt(i.version,10)}}if(n.mozGetUserMedia)e.browser="firefox",e.version=_i(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia||t.isSecureContext===!1&&t.webkitRTCPeerConnection)e.browser="chrome",e.version=_i(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.RTCPeerConnection&&n.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=_i(n.userAgent,/AppleWebKit\/(\d+)\./,1),e.supportsUnifiedPlan=t.RTCRtpTransceiver&&"currentDirection"in t.RTCRtpTransceiver.prototype;else return e.browser="Not a supported browser.",e;return e}function Qc(t){return Object.prototype.toString.call(t)==="[object Object]"}function vh(t){return Qc(t)?Object.keys(t).reduce(function(e,n){const i=Qc(t[n]),r=i?vh(t[n]):t[n],s=i&&!Object.keys(r).length;return r===void 0||s?e:Object.assign(e,{[n]:r})},{}):t}function Ys(t,e,n){!e||n.has(e.id)||(n.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?Ys(t,t.get(e[i]),n):i.endsWith("Ids")&&e[i].forEach(r=>{Ys(t,t.get(r),n)})}))}function Xc(t,e,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const s=[];return t.forEach(o=>{o.type==="track"&&o.trackIdentifier===e.id&&s.push(o)}),s.forEach(o=>{t.forEach(a=>{a.type===i&&a.trackId===o.id&&Ys(t,a,r)})}),r}const Zc=gh;function bh(t,e){const n=t&&t.navigator;if(!n.mediaDevices)return;const i=function(a){if(typeof a!="object"||a.mandatory||a.optional)return a;const c={};return Object.keys(a).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const u=typeof a[l]=="object"?a[l]:{ideal:a[l]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const d=function(h,f){return h?h+f.charAt(0).toUpperCase()+f.slice(1):f==="deviceId"?"sourceId":f};if(u.ideal!==void 0){c.optional=c.optional||[];let h={};typeof u.ideal=="number"?(h[d("min",l)]=u.ideal,c.optional.push(h),h={},h[d("max",l)]=u.ideal,c.optional.push(h)):(h[d("",l)]=u.ideal,c.optional.push(h))}u.exact!==void 0&&typeof u.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[d("",l)]=u.exact):["min","max"].forEach(h=>{u[h]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[d(h,l)]=u[h])})}),a.advanced&&(c.optional=(c.optional||[]).concat(a.advanced)),c},r=function(a,c){if(e.version>=61)return c(a);if(a=JSON.parse(JSON.stringify(a)),a&&typeof a.audio=="object"){const l=function(u,d,h){d in u&&!(h in u)&&(u[h]=u[d],delete u[d])};a=JSON.parse(JSON.stringify(a)),l(a.audio,"autoGainControl","googAutoGainControl"),l(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=i(a.audio)}if(a&&typeof a.video=="object"){let l=a.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const u=e.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&!(n.mediaDevices.getSupportedConstraints&&n.mediaDevices.getSupportedConstraints().facingMode&&!u)){delete a.video.facingMode;let d;if(l.exact==="environment"||l.ideal==="environment"?d=["back","rear"]:(l.exact==="user"||l.ideal==="user")&&(d=["front"]),d)return n.mediaDevices.enumerateDevices().then(h=>{h=h.filter(g=>g.kind==="videoinput");let f=h.find(g=>d.some(m=>g.label.toLowerCase().includes(m)));return!f&&h.length&&d.includes("back")&&(f=h[h.length-1]),f&&(a.video.deviceId=l.exact?{exact:f.deviceId}:{ideal:f.deviceId}),a.video=i(a.video),Zc("chrome: "+JSON.stringify(a)),c(a)})}a.video=i(a.video)}return Zc("chrome: "+JSON.stringify(a)),c(a)},s=function(a){return e.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},o=function(a,c,l){r(a,u=>{n.webkitGetUserMedia(u,c,d=>{l&&l(s(d))})})};if(n.getUserMedia=o.bind(n),n.mediaDevices.getUserMedia){const a=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(c){return r(c,l=>a(l).then(u=>{if(l.audio&&!u.getAudioTracks().length||l.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(d=>{d.stop()}),new DOMException("","NotFoundError");return u},u=>Promise.reject(s(u))))}}}function yh(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function kh(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",r=>{let s;t.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(a=>a.track&&a.track.id===r.track.id):s={track:r.track};const o=new Event("track");o.track=r.track,o.receiver=s,o.transceiver={receiver:s},o.streams=[i.stream],this.dispatchEvent(o)}),i.stream.getTracks().forEach(r=>{let s;t.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(a=>a.track&&a.track.id===r.id):s={track:r};const o=new Event("track");o.track=r,o.receiver=s,o.transceiver={receiver:s},o.streams=[i.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else Wt(t,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Sh(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(a,c){let l=r.apply(this,arguments);return l||(l=e(this,a),this._senders.push(l)),l};const s=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(a){s.apply(this,arguments);const c=this._senders.indexOf(a);c!==-1&&this._senders.splice(c,1)}}const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(s){this._senders=this._senders||[],n.apply(this,[s]),s.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(s){this._senders=this._senders||[],i.apply(this,[s]),s.getTracks().forEach(o=>{const a=this._senders.find(c=>c.track===o);a&&this._senders.splice(this._senders.indexOf(a),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Ch(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){const s=n.apply(this,[]);return s.forEach(o=>o._pc=this),s});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const s=i.apply(this,arguments);return s._pc=this,s}),t.RTCRtpSender.prototype.getStats=function(){const s=this;return this._pc.getStats().then(o=>Xc(o,s.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const n=t.RTCPeerConnection.prototype.getReceivers;n&&(t.RTCPeerConnection.prototype.getReceivers=function(){const r=n.apply(this,[]);return r.forEach(s=>s._pc=this),r}),Wt(t,"track",i=>(i.receiver._pc=i.srcElement,i)),t.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(s=>Xc(s,r.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype&&"getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const i=arguments[0];let r,s,o;return this.getSenders().forEach(a=>{a.track===i&&(r?o=!0:r=a)}),this.getReceivers().forEach(a=>(a.track===i&&(s?o=!0:s=a),a.track===i)),o||r&&s?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():s?s.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function Th(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,a){if(!a)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=e.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(c)===-1&&this._shimmedLocalStreams[a.id].push(c):this._shimmedLocalStreams[a.id]=[a,c],c};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(l=>{if(this.getSenders().find(d=>d.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const a=this.getSenders();n.apply(this,arguments);const c=this.getSenders().filter(l=>a.indexOf(l)===-1);this._shimmedLocalStreams[o.id]=[o].concat(c)};const i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],i.apply(this,arguments)};const r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(a=>{const c=this._shimmedLocalStreams[a].indexOf(o);c!==-1&&this._shimmedLocalStreams[a].splice(c,1),this._shimmedLocalStreams[a].length===1&&delete this._shimmedLocalStreams[a]}),r.apply(this,arguments)}}function Eh(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return Th(t);const n=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const u=n.apply(this);return this._reverseStreams=this._reverseStreams||{},u.map(d=>this._reverseStreams[d.id])};const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(u){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},u.getTracks().forEach(d=>{if(this.getSenders().find(f=>f.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[u.id]){const d=new t.MediaStream(u.getTracks());this._streams[u.id]=d,this._reverseStreams[d.id]=u,u=d}i.apply(this,[u])};const r=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(u){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[u.id]||u]),delete this._reverseStreams[this._streams[u.id]?this._streams[u.id].id:u.id],delete this._streams[u.id]},t.RTCPeerConnection.prototype.addTrack=function(u,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(m=>m===u))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(m=>m.track===u))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const g=this._streams[d.id];if(g)g.addTrack(u),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const m=new t.MediaStream([u]);this._streams[d.id]=m,this._reverseStreams[m.id]=d,this.addStream(m)}return this.getSenders().find(m=>m.track===u)};function s(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const f=l._reverseStreams[h],g=l._streams[f.id];d=d.replace(new RegExp(g.id,"g"),f.id)}),new RTCSessionDescription({type:u.type,sdp:d})}function o(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const f=l._reverseStreams[h],g=l._streams[f.id];d=d.replace(new RegExp(f.id,"g"),g.id)}),new RTCSessionDescription({type:u.type,sdp:d})}["createOffer","createAnswer"].forEach(function(l){const u=t.RTCPeerConnection.prototype[l],d={[l](){const h=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[g=>{const m=s(this,g);h[0].apply(null,[m])},g=>{h[1]&&h[1].apply(null,g)},arguments[2]]):u.apply(this,arguments).then(g=>s(this,g))}};t.RTCPeerConnection.prototype[l]=d[l]});const a=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?a.apply(this,arguments):(arguments[0]=o(this,arguments[0]),a.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const l=c.get.apply(this);return l.type===""?l:s(this,l)}}),t.RTCPeerConnection.prototype.removeTrack=function(u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!u._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(u._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let h;Object.keys(this._streams).forEach(f=>{this._streams[f].getTracks().find(m=>u.track===m)&&(h=this._streams[f])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(u.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Qs(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const i=t.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[n]=r[n]})}function wh(t,e){Wt(t,"negotiationneeded",n=>{const i=n.target;if(!((e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return n})}var el=Object.freeze({__proto__:null,fixNegotiationNeeded:wh,shimAddTrackRemoveTrack:Eh,shimAddTrackRemoveTrackWithNative:Th,shimGetSendersWithDtmf:Sh,shimGetUserMedia:bh,shimMediaStream:yh,shimOnTrack:kh,shimPeerConnection:Qs,shimSenderReceiverGetStats:Ch});function Ph(t,e){const n=t&&t.navigator,i=t&&t.MediaStreamTrack;if(n.getUserMedia=function(r,s,o){fa("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(r).then(s,o)},!(e.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const r=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),s(o)},i&&i.prototype.getSettings){const o=i.prototype.getSettings;i.prototype.getSettings=function(){const a=o.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const o=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function uS(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(i)})}function xh(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Xs(t,e){if(typeof t!="object"||!(t.RTCPeerConnection||t.mozRTCPeerConnection))return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const s=t.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};t.RTCPeerConnection.prototype[r]=o[r]});const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[s,o,a]=arguments;return i.apply(this,[s||null]).then(c=>{if(e.version<53&&!o)try{c.forEach(l=>{l.type=n[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;c.forEach((u,d)=>{c.set(d,Object.assign({},u,{type:n[u.type]||u.type}))})}return c}).then(o,a)}}function Rh(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender)||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(s=>s._pc=this),r});const n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){const r=n.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Ih(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender)||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i}),Wt(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Dh(t){!t.RTCPeerConnection||"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(n){fa("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&n.getTracks().includes(i.track)&&this.removeTrack(i)})})}function Oh(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function _h(t){if(!(typeof t=="object"&&t.RTCPeerConnection))return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const r=i.length>0;r&&i.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const s=e.apply(this,arguments);if(r){const{sender:o}=s,a=o.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=i,o.sendEncodings=i,this.setParametersPromises.push(o.setParameters(a).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return s})}function Ah(t){if(!(typeof t=="object"&&t.RTCRtpSender))return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function Nh(t){if(!(typeof t=="object"&&t.RTCPeerConnection))return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function Mh(t){if(!(typeof t=="object"&&t.RTCPeerConnection))return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var tl=Object.freeze({__proto__:null,shimAddTransceiver:_h,shimCreateAnswer:Mh,shimCreateOffer:Nh,shimGetDisplayMedia:uS,shimGetParameters:Ah,shimGetUserMedia:Ph,shimOnTrack:xh,shimPeerConnection:Xs,shimRTCDataChannel:Oh,shimReceiverGetStats:Ih,shimRemoveStream:Dh,shimSenderGetStats:Rh});function Lh(t){if(!(typeof t!="object"||!t.RTCPeerConnection)){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(r=>e.call(this,r,i)),i.getVideoTracks().forEach(r=>e.call(this,r,i))},t.RTCPeerConnection.prototype.addTrack=function(i){for(var r=arguments.length,s=new Array(r>1?r-1:0),o=1;o<r;o++)s[o-1]=arguments[o];return s&&s.forEach(a=>{this._localStreams?this._localStreams.includes(a)||this._localStreams.push(a):this._localStreams=[a]}),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(n){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(n);if(i===-1)return;this._localStreams.splice(i,1);const r=n.getTracks();this.getSenders().forEach(s=>{r.includes(s.track)&&this.removeTrack(s)})})}}function Uh(t){if(!(typeof t!="object"||!t.RTCPeerConnection)&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(s=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(s)>=0)return;i._remoteStreams.push(s);const o=new Event("addstream");o.stream=s,i.dispatchEvent(o)})}),e.apply(i,arguments)}}}function Fh(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,n=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,s=e.setRemoteDescription,o=e.addIceCandidate;e.createOffer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=n.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h},e.createAnswer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=i.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h};let a=function(c,l,u){const d=r.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d};e.setLocalDescription=a,a=function(c,l,u){const d=s.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.setRemoteDescription=a,a=function(c,l,u){const d=o.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.addIceCandidate=a}function Bh(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const n=e.mediaDevices,i=n.getUserMedia.bind(n);e.mediaDevices.getUserMedia=r=>i(jh(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(i,r,s){e.mediaDevices.getUserMedia(i).then(r,s)}).bind(e))}function jh(t){return t&&t.video!==void 0?Object.assign({},t,{video:vh(t.video)}):t}function Vh(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(i,r){if(i&&i.iceServers){const s=[];for(let o=0;o<i.iceServers.length;o++){let a=i.iceServers[o];a.urls===void 0&&a.url?(fa("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,s.push(a)):s.push(i.iceServers[o])}i.iceServers=s}return new e(i,r)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function $h(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Gh(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const r=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const s=this.getTransceivers().find(o=>o.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&s?s.direction==="sendrecv"?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":s.direction==="recvonly"&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):i.offerToReceiveVideo===!0&&!s&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function Wh(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var nl=Object.freeze({__proto__:null,shimAudioContext:Wh,shimCallbacksAPI:Fh,shimConstraints:jh,shimCreateOfferLegacy:Gh,shimGetUserMedia:Bh,shimLocalStreamsAPI:Lh,shimRTCIceServerUrls:Vh,shimRemoteStreamsAPI:Uh,shimTrackEventTransceiver:$h}),gs={exports:{}},il;function dS(){return il||(il=1,function(t){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(n){return n.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(n){return n.split(`
m=`).map((r,s)=>(s>0?"m="+r:r).trim()+`\r
`)},e.getDescription=function(n){const i=e.splitSections(n);return i&&i[0]},e.getMediaSections=function(n){const i=e.splitSections(n);return i.shift(),i},e.matchPrefix=function(n,i){return e.splitLines(n).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(n){let i;n.indexOf("a=candidate:")===0?i=n.substring(12).split(" "):i=n.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1]);break}return r},e.writeCandidate=function(n){const i=[];i.push(n.foundation);const r=n.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(n.protocol.toUpperCase()),i.push(n.priority),i.push(n.address||n.ip),i.push(n.port);const s=n.type;return i.push("typ"),i.push(s),s!=="host"&&n.relatedAddress&&n.relatedPort&&(i.push("raddr"),i.push(n.relatedAddress),i.push("rport"),i.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(i.push("ufrag"),i.push(n.usernameFragment||n.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(n){return n.substring(14).split(" ")},e.parseRtpMap=function(n){let i=n.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(n){let i=n.payloadType;n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType);const r=n.channels||n.numChannels||1;return"a=rtpmap:"+i+" "+n.name+"/"+n.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(n){const i=n.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},e.parseFmtp=function(n){const i={};let r;const s=n.substring(n.indexOf(" ")+1).split(";");for(let o=0;o<s.length;o++)r=s[o].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(n){let i="",r=n.payloadType;if(n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const s=[];Object.keys(n.parameters).forEach(o=>{n.parameters[o]!==void 0?s.push(o+"="+n.parameters[o]):s.push(o)}),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},e.parseRtcpFb=function(n){const i=n.substring(n.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(n){let i="",r=n.payloadType;return n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),i},e.parseSsrcMedia=function(n){const i=n.indexOf(" "),r={ssrc:parseInt(n.substring(7,i),10)},s=n.indexOf(":",i);return s>-1?(r.attribute=n.substring(i+1,s),r.value=n.substring(s+1)):r.attribute=n.substring(i+1),r},e.parseSsrcGroup=function(n){const i=n.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(n){const i=e.matchPrefix(n,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(n){const i=n.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(n,i){return{role:"auto",fingerprints:e.matchPrefix(n+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(n,i){let r="a=setup:"+i+`\r
`;return n.fingerprints.forEach(s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),r},e.parseCryptoLine=function(n){const i=n.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?e.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;const i=n.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},e.getCryptoParameters=function(n,i){return e.matchPrefix(n+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(n,i){const r=e.matchPrefix(n+i,"a=ice-ufrag:")[0],s=e.matchPrefix(n+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(n){let i="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(n){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=e.splitLines(n)[0].split(" ");i.profile=s[2];for(let a=3;a<s.length;a++){const c=s[a],l=e.matchPrefix(n,"a=rtpmap:"+c+" ")[0];if(l){const u=e.parseRtpMap(l),d=e.matchPrefix(n,"a=fmtp:"+c+" ");switch(u.parameters=d.length?e.parseFmtp(d[0]):{},u.rtcpFeedback=e.matchPrefix(n,"a=rtcp-fb:"+c+" ").map(e.parseRtcpFb),i.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(u.name.toUpperCase());break}}}e.matchPrefix(n,"a=extmap:").forEach(a=>{i.headerExtensions.push(e.parseExtmap(a))});const o=e.matchPrefix(n,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(a=>{o.forEach(c=>{a.rtcpFeedback.find(u=>u.type===c.type&&u.parameter===c.parameter)||a.rtcpFeedback.push(c)})}),i},e.writeRtpDescription=function(n,i){let r="";r+="m="+n+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(o=>{r+=e.writeRtpMap(o),r+=e.writeFmtp(o),r+=e.writeRtcpFb(o)});let s=0;return i.codecs.forEach(o=>{o.maxptime>s&&(s=o.maxptime)}),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(o=>{r+=e.writeExtmap(o)}),r},e.parseRtpEncodingParameters=function(n){const i=[],r=e.parseRtpParameters(n),s=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(n,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=a.length>0&&a[0].ssrc;let l;const u=e.matchPrefix(n,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(g=>parseInt(g,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(l=u[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let f={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&l&&(f.rtx={ssrc:l}),i.push(f),s&&(f=JSON.parse(JSON.stringify(f)),f.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},i.push(f))}}),i.length===0&&c&&i.push({ssrc:c});let d=e.matchPrefix(n,"b=");return d.length&&(d[0].indexOf("b=TIAS:")===0?d=parseInt(d[0].substring(7),10):d[0].indexOf("b=AS:")===0?d=parseInt(d[0].substring(5),10)*1e3*.95-50*40*8:d=void 0,i.forEach(h=>{h.maxBitrate=d})),i},e.parseRtcpParameters=function(n){const i={},r=e.matchPrefix(n,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=e.matchPrefix(n,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const o=e.matchPrefix(n,"a=rtcp-mux");return i.mux=o.length>0,i},e.writeRtcpParameters=function(n){let i="";return n.reducedSize&&(i+=`a=rtcp-rsize\r
`),n.mux&&(i+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(i+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),i},e.parseMsid=function(n){let i;const r=e.matchPrefix(n,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=e.matchPrefix(n,"a=ssrc:").map(o=>e.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");if(s.length>0)return i=s[0].value.split(" "),{stream:i[0],track:i[1]}},e.parseSctpDescription=function(n){const i=e.parseMLine(n),r=e.matchPrefix(n,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const o=e.matchPrefix(n,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const a=e.matchPrefix(n,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},e.writeSctpDescription=function(n,i){let r=[];return n.protocol!=="DTLS/SCTP"?r=["m="+n.kind+" 9 "+n.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:r=["m="+n.kind+" 9 "+n.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(n,i,r){let s;const o=i!==void 0?i:2;return n?s=n:s=e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(n,i){const r=e.splitLines(n);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(n){return e.splitLines(n)[0].split(" ")[0].substring(2)},e.isRejected=function(n){return n.split(" ",2)[1]==="0"},e.parseMLine=function(n){const r=e.splitLines(n)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(n){const r=e.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;const i=e.splitLines(n);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},t.exports=e}(gs)),gs.exports}var qh=dS(),nn=eS(qh),hS=x0({__proto__:null,default:nn},[qh]);function Ai(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substring(2)),i.candidate&&i.candidate.length){const r=new e(i),s=nn.parseCandidate(i.candidate);for(const o in s)o in r||Object.defineProperty(r,o,{value:s[o]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new e(i)},t.RTCIceCandidate.prototype=e.prototype,Wt(t,"icecandidate",n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new t.RTCIceCandidate(n.candidate),writable:"false"}),n))}function Zs(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||Wt(t,"icecandidate",e=>{if(e.candidate){const n=nn.parseCandidate(e.candidate.candidate);n.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return e})}function Ni(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const n=function(a){if(!a||!a.sdp)return!1;const c=nn.splitSections(a.sdp);return c.shift(),c.some(l=>{const u=nn.parseMLine(l);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const l=parseInt(c[1],10);return l!==l?-1:l},r=function(a){let c=65536;return e.browser==="firefox"&&(e.version<57?a===-1?c=16384:c=2147483637:e.version<60?c=e.version===57?65535:65536:c=2147483637),c},s=function(a,c){let l=65536;e.browser==="firefox"&&e.version===57&&(l=65535);const u=nn.matchPrefix(a.sdp,"a=max-message-size:");return u.length>0?l=parseInt(u[0].substring(19),10):e.browser==="firefox"&&c!==-1&&(l=2147483637),l},o=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const c=i(arguments[0]),l=r(c),u=s(arguments[0],c);let d;l===0&&u===0?d=Number.POSITIVE_INFINITY:l===0||u===0?d=Math.max(l,u):d=Math.min(l,u);const h={};Object.defineProperty(h,"maxMessageSize",{get(){return d}}),this._sctp=h}return o.apply(this,arguments)}}function Mi(t){if(!(t.RTCPeerConnection&&"createDataChannel"in t.RTCPeerConnection.prototype))return;function e(i,r){const s=i.send;i.send=function(){const a=arguments[0],c=a.length||a.size||a.byteLength;if(i.readyState==="open"&&r.sctp&&c>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const n=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const r=n.apply(this,arguments);return e(r,this),r},Wt(t,"datachannel",i=>(e(i.channel,i.target),i))}function eo(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(n=>{const i=e[n];e[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const o=new Event("connectionstatechange",r);s.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function to(t,e){if(!t.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const s=r.sdp.split(`
`).filter(o=>o.trim()!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&r instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:r.type,sdp:s}):r.sdp=s}return n.apply(this,arguments)}}function Li(t,e){if(!(t.RTCPeerConnection&&t.RTCPeerConnection.prototype))return;const n=t.RTCPeerConnection.prototype.addIceCandidate;!n||n.length===0||(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Ui(t,e){if(!(t.RTCPeerConnection&&t.RTCPeerConnection.prototype))return;const n=t.RTCPeerConnection.prototype.setLocalDescription;!n||n.length===0||(t.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return n.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?n.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(o=>n.apply(this,[o]))})}var fS=Object.freeze({__proto__:null,removeExtmapAllowMixed:to,shimAddIceCandidateNullOrEmpty:Li,shimConnectionState:eo,shimMaxMessageSize:Ni,shimParameterlessSetLocalDescription:Ui,shimRTCIceCandidate:Ai,shimRTCIceCandidateRelayProtocol:Zs,shimSendThrowTypeError:Mi});function pS(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=gh,i=lS(t),r={browserDetails:i,commonShim:fS,extractVersion:_i,disableLog:aS,disableWarnings:cS,sdp:hS};switch(i.browser){case"chrome":if(!el||!Qs||!e.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(i.version===null)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=el,Li(t,i),Ui(t),bh(t,i),yh(t),Qs(t,i),kh(t),Eh(t,i),Sh(t),Ch(t),wh(t,i),Ai(t),Zs(t),eo(t),Ni(t,i),Mi(t),to(t,i);break;case"firefox":if(!tl||!Xs||!e.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=tl,Li(t,i),Ui(t),Ph(t,i),Xs(t,i),xh(t),Dh(t),Rh(t),Ih(t),Oh(t),_h(t),Ah(t),Nh(t),Mh(t),Ai(t),eo(t),Ni(t,i),Mi(t);break;case"safari":if(!nl||!e.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=nl,Li(t,i),Ui(t),Vh(t),Gh(t),Fh(t),Lh(t),Uh(t),$h(t),Bh(t),Wh(t),Ai(t),Zs(t),Ni(t,i),Mi(t),to(t,i);break;default:n("Unsupported browser!");break}return r}pS({window:typeof window>"u"?void 0:window});const mS=10,Ci="lk_e2ee",gS="LKFrameEncryptionKey",vS={sharedKey:!1,ratchetSalt:gS,ratchetWindowSize:8,failureTolerance:mS,keyringSize:16};var Pt;(function(t){t.SetKey="setKey",t.RatchetRequest="ratchetRequest",t.KeyRatcheted="keyRatcheted"})(Pt||(Pt={}));var rl;(function(t){t.KeyRatcheted="keyRatcheted"})(rl||(rl={}));var Ct;(function(t){t.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",t.EncryptionError="encryptionError"})(Ct||(Ct={}));var sl;(function(t){t.Error="cryptorError"})(sl||(sl={}));function bS(){return yS()||no()}function no(){return typeof window.RTCRtpScriptTransform<"u"}function yS(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}class x1 extends at.EventEmitter{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(n,i)=>{V.debug("key ratcheted event received",{material:n,keyIndex:i})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},vS),e),this.on(Pt.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(e,n,i){const r={key:e,participantIdentity:n,keyIndex:i};if(!this.options.sharedKey&&!n)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(n??"shared","-").concat(i??0),r),this.emit(Pt.SetKey,r)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(e,n){this.emit(Pt.RatchetRequest,e,n)}}class qt extends Error{constructor(e,n){super(n||"an error has occured"),this.code=e}}var ye;(function(t){t[t.NotAllowed=0]="NotAllowed",t[t.ServerUnreachable=1]="ServerUnreachable",t[t.InternalError=2]="InternalError",t[t.Cancelled=3]="Cancelled",t[t.LeaveRequest=4]="LeaveRequest"})(ye||(ye={}));class X extends qt{constructor(e,n,i){super(1,e),this.status=i,this.reason=n}}class pa extends qt{constructor(e){super(21,e??"device is unsupported")}}class rt extends qt{constructor(e){super(20,e??"track is invalid")}}class kS extends qt{constructor(e){super(10,e??"unsupported server")}}class ce extends qt{constructor(e){super(12,e??"unexpected connection state")}}class io extends qt{constructor(e){super(13,e??"unable to negotiate")}}class ol extends qt{constructor(e,n){super(15,e),this.reason=n}}var ni;(function(t){t.PermissionDenied="PermissionDenied",t.NotFound="NotFound",t.DeviceInUse="DeviceInUse",t.Other="Other"})(ni||(ni={}));(function(t){function e(n){if(n&&"name"in n)return n.name==="NotFoundError"||n.name==="DevicesNotFoundError"?t.NotFound:n.name==="NotAllowedError"||n.name==="PermissionDeniedError"?t.PermissionDenied:n.name==="NotReadableError"||n.name==="TrackStartError"?t.DeviceInUse:t.Other}t.getFailure=e})(ni||(ni={}));var al;(function(t){t[t.InvalidKey=0]="InvalidKey",t[t.MissingKey=1]="MissingKey",t[t.InternalError=2]="InternalError"})(al||(al={}));var I;(function(t){t.Connected="connected",t.Reconnecting="reconnecting",t.SignalReconnecting="signalReconnecting",t.Reconnected="reconnected",t.Disconnected="disconnected",t.ConnectionStateChanged="connectionStateChanged",t.MediaDevicesChanged="mediaDevicesChanged",t.ParticipantConnected="participantConnected",t.ParticipantDisconnected="participantDisconnected",t.TrackPublished="trackPublished",t.TrackSubscribed="trackSubscribed",t.TrackSubscriptionFailed="trackSubscriptionFailed",t.TrackUnpublished="trackUnpublished",t.TrackUnsubscribed="trackUnsubscribed",t.TrackMuted="trackMuted",t.TrackUnmuted="trackUnmuted",t.LocalTrackPublished="localTrackPublished",t.LocalTrackUnpublished="localTrackUnpublished",t.LocalAudioSilenceDetected="localAudioSilenceDetected",t.ActiveSpeakersChanged="activeSpeakersChanged",t.ParticipantMetadataChanged="participantMetadataChanged",t.ParticipantNameChanged="participantNameChanged",t.ParticipantAttributesChanged="participantAttributesChanged",t.RoomMetadataChanged="roomMetadataChanged",t.DataReceived="dataReceived",t.SipDTMFReceived="sipDTMFReceived",t.TranscriptionReceived="transcriptionReceived",t.ConnectionQualityChanged="connectionQualityChanged",t.TrackStreamStateChanged="trackStreamStateChanged",t.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",t.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",t.AudioPlaybackStatusChanged="audioPlaybackChanged",t.VideoPlaybackStatusChanged="videoPlaybackChanged",t.MediaDevicesError="mediaDevicesError",t.ParticipantPermissionsChanged="participantPermissionsChanged",t.SignalConnected="signalConnected",t.RecordingStatusChanged="recordingStatusChanged",t.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",t.EncryptionError="encryptionError",t.DCBufferStatusChanged="dcBufferStatusChanged",t.ActiveDeviceChanged="activeDeviceChanged",t.ChatMessage="chatMessage",t.LocalTrackSubscribed="localTrackSubscribed",t.MetricsReceived="metricsReceived"})(I||(I={}));var D;(function(t){t.TrackPublished="trackPublished",t.TrackSubscribed="trackSubscribed",t.TrackSubscriptionFailed="trackSubscriptionFailed",t.TrackUnpublished="trackUnpublished",t.TrackUnsubscribed="trackUnsubscribed",t.TrackMuted="trackMuted",t.TrackUnmuted="trackUnmuted",t.LocalTrackPublished="localTrackPublished",t.LocalTrackUnpublished="localTrackUnpublished",t.ParticipantMetadataChanged="participantMetadataChanged",t.ParticipantNameChanged="participantNameChanged",t.DataReceived="dataReceived",t.SipDTMFReceived="sipDTMFReceived",t.TranscriptionReceived="transcriptionReceived",t.IsSpeakingChanged="isSpeakingChanged",t.ConnectionQualityChanged="connectionQualityChanged",t.TrackStreamStateChanged="trackStreamStateChanged",t.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",t.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",t.MediaDevicesError="mediaDevicesError",t.AudioStreamAcquired="audioStreamAcquired",t.ParticipantPermissionsChanged="participantPermissionsChanged",t.PCTrackAdded="pcTrackAdded",t.AttributesChanged="attributesChanged",t.LocalTrackSubscribed="localTrackSubscribed",t.ChatMessage="chatMessage"})(D||(D={}));var F;(function(t){t.TransportsCreated="transportsCreated",t.Connected="connected",t.Disconnected="disconnected",t.Resuming="resuming",t.Resumed="resumed",t.Restarting="restarting",t.Restarted="restarted",t.SignalResumed="signalResumed",t.SignalRestarted="signalRestarted",t.Closing="closing",t.MediaTrackAdded="mediaTrackAdded",t.ActiveSpeakersUpdate="activeSpeakersUpdate",t.DataPacketReceived="dataPacketReceived",t.RTPVideoMapUpdate="rtpVideoMapUpdate",t.DCBufferStatusChanged="dcBufferStatusChanged",t.ParticipantUpdate="participantUpdate",t.RoomUpdate="roomUpdate",t.SpeakersChanged="speakersChanged",t.StreamStateChanged="streamStateChanged",t.ConnectionQualityUpdate="connectionQualityUpdate",t.SubscriptionError="subscriptionError",t.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",t.RemoteMute="remoteMute",t.SubscribedQualityUpdate="subscribedQualityUpdate",t.LocalTrackUnpublished="localTrackUnpublished",t.LocalTrackSubscribed="localTrackSubscribed",t.Offline="offline",t.SignalRequestResponse="signalRequestResponse"})(F||(F={}));var U;(function(t){t.Message="message",t.Muted="muted",t.Unmuted="unmuted",t.Restarted="restarted",t.Ended="ended",t.Subscribed="subscribed",t.Unsubscribed="unsubscribed",t.UpdateSettings="updateSettings",t.UpdateSubscription="updateSubscription",t.AudioPlaybackStarted="audioPlaybackStarted",t.AudioPlaybackFailed="audioPlaybackFailed",t.AudioSilenceDetected="audioSilenceDetected",t.VisibilityChanged="visibilityChanged",t.VideoDimensionsChanged="videoDimensionsChanged",t.VideoPlaybackStarted="videoPlaybackStarted",t.VideoPlaybackFailed="videoPlaybackFailed",t.ElementAttached="elementAttached",t.ElementDetached="elementDetached",t.UpstreamPaused="upstreamPaused",t.UpstreamResumed="upstreamResumed",t.SubscriptionPermissionChanged="subscriptionPermissionChanged",t.SubscriptionStatusChanged="subscriptionStatusChanged",t.SubscriptionFailed="subscriptionFailed",t.TrackProcessorUpdate="trackProcessorUpdate",t.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",t.TranscriptionReceived="transcriptionReceived",t.TimeSyncUpdate="timeSyncUpdate"})(U||(U={}));function ma(t,e,n){var i,r,s;e===void 0&&(e=50),n===void 0&&(n={});var o=(i=n.isImmediate)!=null&&i,a=(r=n.callback)!=null&&r,c=n.maxWait,l=Date.now(),u=[];function d(){if(c!==void 0){var f=Date.now()-l;if(f+e>=c)return c-f}return e}var h=function(){var f=[].slice.call(arguments),g=this;return new Promise(function(m,b){var v=o&&s===void 0;if(s!==void 0&&clearTimeout(s),s=setTimeout(function(){if(s=void 0,l=Date.now(),!o){var E=t.apply(g,f);a&&a(E),u.forEach(function(k){return(0,k.resolve)(E)}),u=[]}},d()),v){var T=t.apply(g,f);return a&&a(T),m(T)}u.push({resolve:m,reject:b})})};return h.cancel=function(f){s!==void 0&&clearTimeout(s),u.forEach(function(g){return(0,g.reject)(f)}),u=[]},h}const SS=/version\/(\d+(\.?_?\d+)+)/i;let vs;function pt(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const n=navigator.userAgent.toLowerCase();if(vs===void 0||e){const i=CS.find(r=>{let{test:s}=r;return s.test(n)});vs=i==null?void 0:i.describe(n)}return vs}const CS=[{test:/firefox|iceweasel|fxios/i,describe(t){return{name:"Firefox",version:Fi(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,t),os:t.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:bs(t)}}},{test:/chrom|crios|crmo/i,describe(t){return{name:"Chrome",version:Fi(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,t),os:t.toLowerCase().includes("crios")?"iOS":void 0,osVersion:bs(t)}}},{test:/safari|applewebkit/i,describe(t){return{name:"Safari",version:Fi(SS,t),os:t.includes("mobile/")?"iOS":"macOS",osVersion:bs(t)}}}];function Fi(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const i=e.match(t);return i&&i.length>=n&&i[n]||""}function bs(t){return t.includes("mac os")?Fi(/\(.+?(\d+_\d+(:?_\d+)?)/,t,1).replace(/_/g,"."):void 0}var TS="2.6.0";const ES=TS,wS=15;class me{}me.setTimeout=function(){return setTimeout(...arguments)};me.setInterval=function(){return setInterval(...arguments)};me.clearTimeout=function(){return clearTimeout(...arguments)};me.clearInterval=function(){return clearInterval(...arguments)};class J{constructor(e,n,i,r,s){if(typeof e=="object")this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else if(n!==void 0&&i!==void 0)this.width=e,this.height=n,this.aspectRatio=e/n,this.encoding={maxBitrate:i,maxFramerate:r,priority:s};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const PS=["vp8","h264"],xS=["vp8","h264","vp9","av1"];function RS(t){return!!PS.find(e=>e===t)}var ro;(function(t){t.telephone={maxBitrate:12e3},t.speech={maxBitrate:24e3},t.music={maxBitrate:48e3},t.musicStereo={maxBitrate:64e3},t.musicHighQuality={maxBitrate:96e3},t.musicHighQualityStereo={maxBitrate:128e3}})(ro||(ro={}));const ii={h90:new J(160,90,9e4,20),h180:new J(320,180,16e4,20),h216:new J(384,216,18e4,20),h360:new J(640,360,45e4,20),h540:new J(960,540,8e5,25),h720:new J(1280,720,17e5,30),h1080:new J(1920,1080,3e6,30),h1440:new J(2560,1440,5e6,30),h2160:new J(3840,2160,8e6,30)},so={h120:new J(160,120,7e4,20),h180:new J(240,180,125e3,20),h240:new J(320,240,14e4,20),h360:new J(480,360,33e4,20),h480:new J(640,480,5e5,20),h540:new J(720,540,6e5,25),h720:new J(960,720,13e5,30),h1080:new J(1440,1080,23e5,30),h1440:new J(1920,1440,38e5,30)},ga={h360fps3:new J(640,360,2e5,3,"medium"),h360fps15:new J(640,360,4e5,15,"medium"),h720fps5:new J(1280,720,8e5,5,"medium"),h720fps15:new J(1280,720,15e5,15,"medium"),h720fps30:new J(1280,720,2e6,30,"medium"),h1080fps15:new J(1920,1080,25e5,15,"medium"),h1080fps30:new J(1920,1080,5e6,30,"medium"),original:new J(0,0,7e6,30,"medium")};function IS(t){if(!(typeof t>"u"))return typeof structuredClone=="function"?structuredClone(t):JSON.parse(JSON.stringify(t))}const DS=5e3,Nn=[];var Be;(function(t){t[t.LOW=0]="LOW",t[t.MEDIUM=1]="MEDIUM",t[t.HIGH=2]="HIGH"})(Be||(Be={}));class P extends at.EventEmitter{constructor(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var r;super(),this.attachedElements=[],this.isMuted=!1,this.streamState=P.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=V,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),DS):this.handleAppVisibilityChanged()},this.log=ft((r=i.loggerName)!==null&&r!==void 0?r:Je.Track),this.loggerContextCb=i.loggerContextCb,this.setMaxListeners(100),this.kind=n,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=P.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),Y(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let n="audio";this.kind===P.Kind.Video&&(n="video"),this.attachedElements.length===0&&this.kind===P.Kind.Video&&this.addAppVisibilityListener(),e||(n==="audio"&&(Nn.forEach(s=>{s.parentElement===null&&!e&&(e=s)}),e&&Nn.splice(Nn.indexOf(e),1)),e||(e=document.createElement(n))),this.attachedElements.includes(e)||this.attachedElements.push(e),Zt(this.mediaStreamTrack,e);const i=e.srcObject.getTracks(),r=i.some(s=>s.kind==="audio");return e.play().then(()=>{this.emit(r?U.AudioPlaybackStarted:U.VideoPlaybackStarted)}).catch(s=>{s.name==="NotAllowedError"?this.emit(r?U.AudioPlaybackFailed:U.VideoPlaybackFailed,s):s.name==="AbortError"?V.debug("".concat(r?"audio":"video"," playback aborted, likely due to new play request")):V.warn("could not playback ".concat(r?"audio":"video"),s),r&&e&&i.some(o=>o.kind==="video")&&s.name==="NotAllowedError"&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(U.ElementAttached,e),e}detach(e){try{if(e){rn(this.mediaStreamTrack,e);const i=this.attachedElements.indexOf(e);return i>=0&&(this.attachedElements.splice(i,1),this.recycleElement(e),this.emit(U.ElementDetached,e)),e}const n=[];return this.attachedElements.forEach(i=>{rn(this.mediaStreamTrack,i),n.push(i),this.recycleElement(i),this.emit(U.ElementDetached,i)}),this.attachedElements=[],n}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=ft(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let n=!0;e.pause(),Nn.forEach(i=>{i.parentElement||(n=!1)}),n&&Nn.push(e)}}handleAppVisibilityChanged(){return S(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===P.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(e=>e.play().catch(()=>{})),0)})}addAppVisibilityListener(){Oe()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){Oe()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function Zt(t,e){let n;e.srcObject instanceof MediaStream?n=e.srcObject:n=new MediaStream;let i;t.kind==="audio"?i=n.getAudioTracks():i=n.getVideoTracks(),i.includes(t)||(i.forEach(r=>{n.removeTrack(r)}),n.addTrack(t)),(!$t()||!(e instanceof HTMLVideoElement))&&(e.autoplay=!0),e.muted=n.getAudioTracks().length===0,e instanceof HTMLVideoElement&&(e.playsInline=!0),e.srcObject!==n&&(e.srcObject=n,($t()||mn())&&e instanceof HTMLVideoElement&&setTimeout(()=>{e.srcObject=n,e.play().catch(()=>{})},0))}function rn(t,e){if(e.srcObject instanceof MediaStream){const n=e.srcObject;n.removeTrack(t),n.getTracks().length>0?e.srcObject=n:e.srcObject=null}}(function(t){let e;(function(l){l.Audio="audio",l.Video="video",l.Unknown="unknown"})(e=t.Kind||(t.Kind={}));let n;(function(l){l.Camera="camera",l.Microphone="microphone",l.ScreenShare="screen_share",l.ScreenShareAudio="screen_share_audio",l.Unknown="unknown"})(n=t.Source||(t.Source={}));let i;(function(l){l.Active="active",l.Paused="paused",l.Unknown="unknown"})(i=t.StreamState||(t.StreamState={}));function r(l){switch(l){case e.Audio:return He.AUDIO;case e.Video:return He.VIDEO;default:return He.DATA}}t.kindToProto=r;function s(l){switch(l){case He.AUDIO:return e.Audio;case He.VIDEO:return e.Video;default:return e.Unknown}}t.kindFromProto=s;function o(l){switch(l){case n.Camera:return be.CAMERA;case n.Microphone:return be.MICROPHONE;case n.ScreenShare:return be.SCREEN_SHARE;case n.ScreenShareAudio:return be.SCREEN_SHARE_AUDIO;default:return be.UNKNOWN}}t.sourceToProto=o;function a(l){switch(l){case be.CAMERA:return n.Camera;case be.MICROPHONE:return n.Microphone;case be.SCREEN_SHARE:return n.ScreenShare;case be.SCREEN_SHARE_AUDIO:return n.ScreenShareAudio;default:return n.Unknown}}t.sourceFromProto=a;function c(l){switch(l){case Hs.ACTIVE:return i.Active;case Hs.PAUSED:return i.Paused;default:return i.Unknown}}t.streamStateFromProto=c})(P||(P={}));function Hh(t,e,n){var i;const r=(i=IS(t))!==null&&i!==void 0?i:{};return r.audio===!0&&(r.audio={}),r.video===!0&&(r.video={}),r.audio&&oo(r.audio,e),r.video&&oo(r.video,n),r}function oo(t,e){return Object.keys(e).forEach(n=>{t[n]===void 0&&(t[n]=e[n])}),t}function jr(t){const e={};if(t.video)if(typeof t.video=="object"){const n={},i=n,r=t.video;Object.keys(r).forEach(s=>{switch(s){case"resolution":oo(i,r.resolution);break;default:i[s]=r[s]}}),e.video=n}else e.video=t.video;else e.video=!1;return t.audio?typeof t.audio=="object"?e.audio=t.audio:e.audio=!0:e.audio=!1,e}function OS(t){return S(this,arguments,void 0,function(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return function*(){const i=zh();if(i){const r=i.createAnalyser();r.fftSize=2048;const s=r.frequencyBinCount,o=new Uint8Array(s);i.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(r),yield st(n),r.getByteTimeDomainData(o);const c=o.some(l=>l!==128&&l!==0);return i.close(),!c}return!1}()})}function zh(){const t=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(t)return new t({latencyHint:"interactive"})}function cl(t){return t===P.Source.Microphone?"audioinput":t===P.Source.Camera?"videoinput":void 0}function _S(t){var e,n;let i=(e=t.video)!==null&&e!==void 0?e:!0;return t.resolution&&t.resolution.width>0&&t.resolution.height>0&&(i=typeof i=="boolean"?{}:i,$t()?i=Object.assign(Object.assign({},i),{width:{max:t.resolution.width},height:{max:t.resolution.height},frameRate:t.resolution.frameRate}):i=Object.assign(Object.assign({},i),{width:{ideal:t.resolution.width},height:{ideal:t.resolution.height},frameRate:t.resolution.frameRate})),{audio:(n=t.audio)!==null&&n!==void 0?n:!1,video:i,controller:t.controller,selfBrowserSurface:t.selfBrowserSurface,surfaceSwitching:t.surfaceSwitching,systemAudio:t.systemAudio,preferCurrentTab:t.preferCurrentTab}}function Bi(t){return t.split("/")[1].toLowerCase()}function AS(t){const e=[];return t.forEach(n=>{n.track!==void 0&&e.push(new da({cid:n.track.mediaStreamID,track:n.trackInfo}))}),e}function Y(t){return t instanceof P?{trackID:t.sid,source:t.source,muted:t.isMuted,enabled:t.mediaStreamTrack.enabled,kind:t.kind,streamID:t.mediaStreamID,streamTrackID:t.mediaStreamTrack.id}:{trackID:t.trackSid,enabled:t.isEnabled,muted:t.isMuted,trackInfo:Object.assign({mimeType:t.mimeType,name:t.trackName,encrypted:t.isEncrypted,kind:t.kind,source:t.source},t.track?Y(t.track):{})}}function NS(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function MS(t,e){var n;t===void 0&&(t={}),e===void 0&&(e={});const i=[...Object.keys(e),...Object.keys(t)],r={};for(const s of i)t[s]!==e[s]&&(r[s]=(n=e[s])!==null&&n!==void 0?n:"");return r}const LS="|",ll="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function US(t){const e=t.split(LS);return e.length>1?[e[0],t.substr(e[0].length+1)]:[t,""]}function st(t){return S(this,void 0,void 0,function*(){return new Promise(e=>me.setTimeout(e,t))})}function ao(){return"addTransceiver"in RTCPeerConnection.prototype}function co(){return"addTrack"in RTCPeerConnection.prototype}function FS(){if(!("getCapabilities"in RTCRtpSender)||$t())return!1;const t=RTCRtpSender.getCapabilities("video");let e=!1;if(t){for(const n of t.codecs)if(n.mimeType==="video/AV1"){e=!0;break}}return e}function BS(){if(!("getCapabilities"in RTCRtpSender)||mn())return!1;if($t()){const n=pt();if(n!=null&&n.version&&gn(n.version,"16")<0)return!1}const t=RTCRtpSender.getCapabilities("video");let e=!1;if(t){for(const n of t.codecs)if(n.mimeType==="video/VP9"){e=!0;break}}return e}function Gn(t){return t==="av1"||t==="vp9"}function lo(t){return document?(t||(t=document.createElement("audio")),"setSinkId"in t):!1}function jS(){return typeof RTCPeerConnection>"u"?!1:ao()||co()}function mn(){var t;return((t=pt())===null||t===void 0?void 0:t.name)==="Firefox"}function $t(){var t;return((t=pt())===null||t===void 0?void 0:t.name)==="Safari"}function VS(){const t=pt();return(t==null?void 0:t.name)==="Safari"&&t.version.startsWith("17.")}function Kh(){var t,e;return Oe()?(e=(t=navigator.userAgentData)===null||t===void 0?void 0:t.mobile)!==null&&e!==void 0?e:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function $S(){const t=pt(),e="17.2";if(t)return t.name!=="Safari"&&t.os!=="iOS"||t.os==="iOS"&&t.osVersion&&gn(e,t.osVersion)>=0?!0:t.name==="Safari"&&gn(e,t.version)>=0}function Oe(){return typeof document<"u"}function mt(){return navigator.product=="ReactNative"}function uo(t){return t.hostname.endsWith(".livekit.cloud")||t.hostname.endsWith(".livekit.run")}function Jh(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function Yh(){if(!mt())return;let t=Jh();if(t)return t.platform}function ul(){if(Oe())return window.devicePixelRatio;if(mt()){let t=Jh();if(t)return t.devicePixelRatio}return 1}function gn(t,e){const n=t.split("."),i=e.split("."),r=Math.min(n.length,i.length);for(let s=0;s<r;++s){const o=parseInt(n[s],10),a=parseInt(i[s],10);if(o>a)return 1;if(o<a)return-1;if(s===r-1&&o===a)return 0}return t===""&&e!==""?-1:e===""?1:n.length==i.length?0:n.length<i.length?-1:1}function GS(t){for(const e of t)e.target.handleResize(e)}function WS(t){for(const e of t)e.target.handleVisibilityChanged(e)}let ys=null;const dl=()=>(ys||(ys=new ResizeObserver(GS)),ys);let ks=null;const hl=()=>(ks||(ks=new IntersectionObserver(WS,{root:null,rootMargin:"0px"})),ks);function qS(){var t;const e=new Dk({sdk:eh.JS,protocol:wS,version:ES});return mt()&&(e.os=(t=Yh())!==null&&t!==void 0?t:""),e}function fl(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const r=document.createElement("canvas");r.width=t,r.height=e;const s=r.getContext("2d");s==null||s.fillRect(0,0,r.width,r.height),i&&s&&(s.beginPath(),s.arc(t/2,e/2,50,0,Math.PI*2,!0),s.closePath(),s.fillStyle="grey",s.fill());const o=r.captureStream(),[a]=o.getTracks();if(!a)throw Error("Could not get empty media stream video track");return a.enabled=n,a}let Mn;function Ss(){if(!Mn){const t=new AudioContext,e=t.createOscillator(),n=t.createGain();n.gain.setValueAtTime(0,0);const i=t.createMediaStreamDestination();if(e.connect(n),n.connect(i),e.start(),[Mn]=i.stream.getAudioTracks(),!Mn)throw Error("Could not get empty media stream audio track");Mn.enabled=!1}return Mn.clone()}class Qh{constructor(e,n){this.onFinally=n,this.promise=new Promise((i,r)=>S(this,void 0,void 0,function*(){this.resolve=i,this.reject=r,e&&(yield e(i,r))})).finally(()=>{var i;return(i=this.onFinally)===null||i===void 0?void 0:i.call(this)})}}function HS(t){return xS.includes(t)}function ht(t){if(typeof t=="string"||typeof t=="number")return t;if(Array.isArray(t))return t[0];if(t.exact)return Array.isArray(t.exact)?t.exact[0]:t.exact;if(t.ideal)return Array.isArray(t.ideal)?t.ideal[0]:t.ideal;throw Error("could not unwrap constraint")}function zS(t){return t.startsWith("http")?t.replace(/^(http)/,"ws"):t}function pl(t){return t.startsWith("ws")?t.replace(/^(ws)/,"http"):t}function KS(t,e){return t.segments.map(n=>{let{id:i,text:r,language:s,startTime:o,endTime:a,final:c}=n;var l;const u=(l=e.get(i))!==null&&l!==void 0?l:Date.now(),d=Date.now();return c?e.delete(i):e.set(i,u),{id:i,text:r,startTime:Number.parseInt(o.toString()),endTime:Number.parseInt(a.toString()),final:c,language:s,firstReceivedTime:u,lastReceivedTime:d}})}function JS(t){const{id:e,timestamp:n,message:i,editTimestamp:r}=t;return{id:e,timestamp:Number.parseInt(n.toString()),editTimestamp:r?Number.parseInt(r.toString()):void 0,message:i}}const Cs="default";class fe{static getInstance(){return this.instance===void 0&&(this.instance=new fe),this.instance}getDevices(e){return S(this,arguments,void 0,function(n){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var s;if(((s=fe.userMediaPromiseMap)===null||s===void 0?void 0:s.size)>0){V.debug("awaiting getUserMedia promise");try{n?yield fe.userMediaPromiseMap.get(n):yield Promise.all(fe.userMediaPromiseMap.values())}catch{V.warn("error waiting for media permissons")}}let o=yield navigator.mediaDevices.enumerateDevices();if(r&&!($t()&&i.hasDeviceInUse(n))&&(o.filter(c=>c.kind===n).length===0||o.some(c=>{const l=c.label==="",u=n?c.kind===n:!0;return l&&u}))){const c={video:n!=="audioinput"&&n!=="audiooutput",audio:n!=="videoinput"},l=yield navigator.mediaDevices.getUserMedia(c);o=yield navigator.mediaDevices.enumerateDevices(),l.getTracks().forEach(u=>{u.stop()})}return n&&(o=o.filter(a=>a.kind===n)),o}()})}normalizeDeviceId(e,n,i){return S(this,void 0,void 0,function*(){if(n!==Cs)return n;const r=yield this.getDevices(e),s=r.find(a=>a.deviceId===Cs);if(!s){V.warn("could not reliably determine default device");return}const o=r.find(a=>a.deviceId!==Cs&&a.groupId===(i??s.groupId));if(!o){V.warn("could not reliably determine default device");return}return o==null?void 0:o.deviceId})}hasDeviceInUse(e){return e?fe.userMediaPromiseMap.has(e):fe.userMediaPromiseMap.size>0}}fe.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];fe.userMediaPromiseMap=new Map;const YS=1e3;class Bt extends P{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}constructor(e,n,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0;super(e,n,s),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=ma(()=>S(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>S(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(U.Ended,this)},this.reacquireTrack=!1,this.providedByUser=r,this.muteLock=new Re,this.pauseUpstreamLock=new Re,this.processorLock=new Re,this.restartLock=new Re,this.setMediaStreamTrack(e,!0),this._constraints=e.getConstraints(),i&&(this._constraints=i)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==P.Kind.Video)return;const{width:e,height:n}=this._mediaStreamTrack.getSettings();if(e&&n)return{width:e,height:n}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,n;return(n=(e=this.processor)===null||e===void 0?void 0:e.processedTrack)!==null&&n!==void 0?n:this._mediaStreamTrack}setMediaStreamTrack(e,n){return S(this,void 0,void 0,function*(){if(e===this._mediaStreamTrack&&!n)return;this._mediaStreamTrack&&(this.attachedElements.forEach(r=>{rn(this._mediaStreamTrack,r)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints());let i;if(this.processor&&e){const r=yield this.processorLock.lock();try{if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(Zt(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),i=this.processor.processedTrack}finally{r()}}this.sender&&(yield this.sender.replaceTrack(i??e)),!this.providedByUser&&this._mediaStreamTrack!==e&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(r=>{Zt(i??e,r)}))})}waitForDimensions(){return S(this,arguments,void 0,function(){var e=this;let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:YS;return function*(){var i;if(e.kind===P.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((i=pt())===null||i===void 0?void 0:i.os)==="iOS"&&(yield st(10));const r=Date.now();for(;Date.now()-r<n;){const s=e.dimensions;if(s)return s;yield st(50)}throw new rt("unable to get track dimensions after timeout")}()})}getDeviceId(){return S(this,arguments,void 0,function(){var e=this;let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){if(e.source===P.Source.ScreenShare)return;const{deviceId:i,groupId:r}=e._mediaStreamTrack.getSettings(),s=e.kind===P.Kind.Audio?"audioinput":"videoinput";return n?fe.getInstance().normalizeDeviceId(s,i,r):i}()})}mute(){return S(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return S(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e,n){return S(this,void 0,void 0,function*(){if(!this.sender)throw new rt("unable to replace an unpublished track");let i,r;return typeof n=="boolean"?i=n:n!==void 0&&(i=n.userProvidedTrack,r=n.stopProcessor),this.providedByUser=i??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),r&&this.processor&&(yield this.stopProcessor()),this})}restart(e){return S(this,void 0,void 0,function*(){this.manuallyStopped=!1;const n=yield this.restartLock.lock();try{e||(e=this._constraints),this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const i={audio:!1,video:!1};this.kind===P.Kind.Video?i.video=e:i.audio=e,this.attachedElements.forEach(o=>{rn(this.mediaStreamTrack,o)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const s=(yield navigator.mediaDevices.getUserMedia(i)).getTracks()[0];return s.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(s),this._constraints=e,this.emit(U.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{n()}})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),!(this.isMuted===e&&this._mediaStreamTrack.enabled!==e)&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?U.Muted:U.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return S(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),Kh()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(e=this.processor)===null||e===void 0||e.destroy(),this.processor=void 0}pauseUpstream(){return S(this,void 0,void 0,function*(){const e=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(U.UpstreamPaused,this);const n=pt();if((n==null?void 0:n.name)==="Safari"&&gn(n.version,"12.0")<0)throw new pa("pauseUpstream is not supported on Safari < 12.");yield this.sender.replaceTrack(null)}finally{e()}})}resumeUpstream(){return S(this,void 0,void 0,function*(){const e=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(U.UpstreamResumed,this),yield this.sender.replaceTrack(this.mediaStreamTrack)}finally{e()}})}getRTCStatsReport(){return S(this,void 0,void 0,function*(){var e;return!((e=this.sender)===null||e===void 0)&&e.getStats?yield this.sender.getStats():void 0})}setProcessor(e){return S(this,arguments,void 0,function(n){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var s;const o=yield i.processorLock.lock();try{i.log.debug("setting up processor",i.logContext);const a=document.createElement(i.kind),c={kind:i.kind,track:i._mediaStreamTrack,element:a,audioContext:i.audioContext};if(yield n.init(c),i.log.debug("processor initialized",i.logContext),i.processor&&(yield i.stopProcessor()),i.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(Zt(i._mediaStreamTrack,a),a.muted=!0,a.play().catch(l=>i.log.error("failed to play processor element",Object.assign(Object.assign({},i.logContext),{error:l}))),i.processor=n,i.processorElement=a,i.processor.processedTrack){for(const l of i.attachedElements)l!==i.processorElement&&r&&(rn(i._mediaStreamTrack,l),Zt(i.processor.processedTrack,l));yield(s=i.sender)===null||s===void 0?void 0:s.replaceTrack(i.processor.processedTrack)}i.emit(U.TrackProcessorUpdate,i.processor)}finally{o()}}()})}getProcessor(){return this.processor}stopProcessor(){return S(this,arguments,void 0,function(){var e=this;let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){var i,r;e.processor&&(e.log.debug("stopping processor",e.logContext),(i=e.processor.processedTrack)===null||i===void 0||i.stop(),yield e.processor.destroy(),e.processor=void 0,n||((r=e.processorElement)===null||r===void 0||r.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(U.TrackProcessorUpdate))}()})}}class QS extends at.EventEmitter{constructor(e){super(),this.onWorkerMessage=n=>{var i,r;const{kind:s,data:o}=n.data;switch(s){case"error":V.error(o.error.message),this.emit(Ct.EncryptionError,o.error);break;case"initAck":o.enabled&&this.keyProvider.getKeys().forEach(a=>{this.postKey(a)});break;case"enable":if(o.enabled&&this.keyProvider.getKeys().forEach(a=>{this.postKey(a)}),this.encryptionEnabled!==o.enabled&&o.participantIdentity===((i=this.room)===null||i===void 0?void 0:i.localParticipant.identity))this.emit(Ct.ParticipantEncryptionStatusChanged,o.enabled,this.room.localParticipant),this.encryptionEnabled=o.enabled;else if(o.participantIdentity){const a=(r=this.room)===null||r===void 0?void 0:r.getParticipantByIdentity(o.participantIdentity);if(!a)throw TypeError("couldn't set encryption status, participant not found".concat(o.participantIdentity));this.emit(Ct.ParticipantEncryptionStatusChanged,o.enabled,a)}break;case"ratchetKey":this.keyProvider.emit(Pt.KeyRatcheted,o.material,o.keyIndex);break}},this.onWorkerError=n=>{V.error("e2ee worker encountered an error:",{error:n.error}),this.emit(Ct.EncryptionError,n.error)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1}setup(e){if(!bS())throw new pa("tried to setup end-to-end encryption on an unsupported browser");if(V.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const n={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:iS.getLevel()}};this.worker&&(V.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(n))}}setParticipantCryptorEnabled(e,n){V.debug("set e2ee to ".concat(e," for participant ").concat(n)),this.postEnable(e,n)}setSifTrailer(e){!e||e.length===0?V.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(e)}setupEngine(e){e.on(F.RTPVideoMapUpdate,n=>{this.postRTPMap(n)})}setupEventListeners(e,n){e.on(I.TrackPublished,(i,r)=>this.setParticipantCryptorEnabled(i.trackInfo.encryption!==Le.NONE,r.identity)),e.on(I.ConnectionStateChanged,i=>{i===G.Connected&&e.remoteParticipants.forEach(r=>{r.trackPublications.forEach(s=>{this.setParticipantCryptorEnabled(s.trackInfo.encryption!==Le.NONE,r.identity)})})}).on(I.TrackUnsubscribed,(i,r,s)=>{var o;const a={kind:"removeTransform",data:{participantIdentity:s.identity,trackId:i.mediaStreamID}};(o=this.worker)===null||o===void 0||o.postMessage(a)}).on(I.TrackSubscribed,(i,r,s)=>{this.setupE2EEReceiver(i,s.identity,r.trackInfo)}).on(I.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");n.getKeys().forEach(i=>{this.postKey(i)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),e.localParticipant.on(D.LocalTrackPublished,i=>S(this,void 0,void 0,function*(){this.setupE2EESender(i.track,i.track.sender)})),n.on(Pt.SetKey,i=>this.postKey(i)).on(Pt.RatchetRequest,(i,r)=>this.postRatchetRequest(i,r))}postRatchetRequest(e,n){if(!this.worker)throw Error("could not ratchet key, worker is missing");const i={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:n}};this.worker.postMessage(i)}postKey(e){let{key:n,participantIdentity:i,keyIndex:r}=e;var s;if(!this.worker)throw Error("could not set key, worker is missing");const o={kind:"setKey",data:{participantIdentity:i,isPublisher:i===((s=this.room)===null||s===void 0?void 0:s.localParticipant.identity),key:n,keyIndex:r}};this.worker.postMessage(o)}postEnable(e,n){if(this.worker){const i={kind:"enable",data:{enabled:e,participantIdentity:n}};this.worker.postMessage(i)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(e){var n;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((n=this.room)===null||n===void 0)&&n.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const i={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(i)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const n={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(n)}setupE2EEReceiver(e,n,i){if(e.receiver){if(!(i!=null&&i.mimeType)||i.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,n,e.kind==="video"?Bi(i.mimeType):void 0)}}setupE2EESender(e,n){if(!(e instanceof Bt)||!n){n||V.warn("early return because sender is not ready");return}this.handleSender(n,e.mediaStreamID,void 0)}handleReceiver(e,n,i,r){return S(this,void 0,void 0,function*(){if(this.worker){if(no()){const s={kind:"decode",participantIdentity:i,trackId:n,codec:r};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{if(Ci in e&&r){const c={kind:"updateCodec",data:{trackId:n,codec:r,participantIdentity:i}};this.worker.postMessage(c);return}let s=e.writableStream,o=e.readableStream;if(!s||!o){const c=e.createEncodedStreams();e.writableStream=c.writable,s=c.writable,e.readableStream=c.readable,o=c.readable}const a={kind:"decode",data:{readableStream:o,writableStream:s,trackId:n,codec:r,participantIdentity:i}};this.worker.postMessage(a,[o,s])}e[Ci]=!0}})}handleSender(e,n,i){var r;if(!(Ci in e||!this.worker)){if(!(!((r=this.room)===null||r===void 0)&&r.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(no()){V.info("initialize script transform");const s={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:n,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{V.info("initialize encoded streams");const s=e.createEncodedStreams(),o={kind:"encode",data:{readableStream:s.readable,writableStream:s.writable,codec:i,trackId:n,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(o,[s.readable,s.writable])}e[Ci]=!0}}}var Wn;(function(t){t[t.WAITING=0]="WAITING",t[t.RUNNING=1]="RUNNING",t[t.COMPLETED=2]="COMPLETED"})(Wn||(Wn={}));class XS{constructor(){this.pendingTasks=new Map,this.taskMutex=new Re,this.nextTaskIndex=0}run(e){return S(this,void 0,void 0,function*(){const n={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:Wn.WAITING};this.pendingTasks.set(n.id,n);const i=yield this.taskMutex.lock();try{return n.executedAt=Date.now(),n.status=Wn.RUNNING,yield e()}finally{n.status=Wn.COMPLETED,this.pendingTasks.delete(n.id),i()}})}flush(){return S(this,void 0,void 0,function*(){return this.run(()=>S(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}const ZS=["syncState","trickle","offer","answer","simulate","leave"];function eC(t){const e=ZS.indexOf(t.case)>=0;return V.trace("request allowed to bypass queue:",{canPass:e,req:t}),e}var te;(function(t){t[t.CONNECTING=0]="CONNECTING",t[t.CONNECTED=1]="CONNECTED",t[t.RECONNECTING=2]="RECONNECTING",t[t.DISCONNECTING=3]="DISCONNECTING",t[t.DISCONNECTED=4]="DISCONNECTED"})(te||(te={}));class va{get currentState(){return this.state}get isDisconnected(){return this.state===te.DISCONNECTING||this.state===te.DISCONNECTED}get isEstablishingConnection(){return this.state===te.CONNECTING||this.state===te.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;this.rtt=0,this.state=te.DISCONNECTED,this.log=V,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0},this.log=ft((i=n.loggerName)!==null&&i!==void 0?i:Je.Signal),this.loggerContextCb=n.loggerContextCb,this.useJSON=e,this.requestQueue=new XS,this.queuedRequests=[],this.closingLock=new Re,this.connectionLock=new Re,this.state=te.DISCONNECTED}get logContext(){var e,n;return(n=(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this))!==null&&n!==void 0?n:{}}join(e,n,i,r){return S(this,void 0,void 0,function*(){return this.state=te.CONNECTING,this.options=i,yield this.connect(e,n,i,r)})}reconnect(e,n,i,r){return S(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=te.RECONNECTING,this.clearPingInterval(),yield this.connect(e,n,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:i,reconnectReason:r}))})}connect(e,n,i,r){this.connectOptions=i,e=zS(e),e=e.replace(/\/$/,""),e+="/rtc";const s=qS(),o=tC(n,s,i);return new Promise((a,c)=>S(this,void 0,void 0,function*(){const l=yield this.connectionLock.lock();try{const u=()=>S(this,void 0,void 0,function*(){this.close(),clearTimeout(d),c(new X("room connection has been cancelled (signal)"))}),d=setTimeout(()=>{this.close(),c(new X("room connection has timed out (signal)"))},i.websocketTimeout);r!=null&&r.aborted&&u(),r==null||r.addEventListener("abort",u),this.log.debug("connecting to ".concat(e+o),this.logContext),this.ws&&(yield this.close(!1)),this.ws=new WebSocket(e+o),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{clearTimeout(d)},this.ws.onerror=h=>S(this,void 0,void 0,function*(){if(this.state!==te.CONNECTED){this.state=te.DISCONNECTED,clearTimeout(d);try{const f=yield fetch("http".concat(e.substring(2),"/validate").concat(o));if(f.status.toFixed(0).startsWith("4")){const g=yield f.text();c(new X(g,ye.NotAllowed,f.status))}else c(new X("Internal error",ye.InternalError,f.status))}catch{c(new X("server was not reachable",ye.ServerUnreachable))}return}this.handleWSError(h)}),this.ws.onmessage=h=>S(this,void 0,void 0,function*(){var f,g,m;let b;if(typeof h.data=="string"){const v=JSON.parse(h.data);b=zc.fromJson(v,{ignoreUnknownFields:!0})}else if(h.data instanceof ArrayBuffer)b=zc.fromBinary(new Uint8Array(h.data));else{this.log.error("could not decode websocket message: ".concat(typeof h.data),this.logContext);return}if(this.state!==te.CONNECTED){let v=!1;if(((f=b.message)===null||f===void 0?void 0:f.case)==="join"?(this.state=te.CONNECTED,r==null||r.removeEventListener("abort",u),this.pingTimeoutDuration=b.message.value.pingTimeout,this.pingIntervalDuration=b.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&(this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})),this.startPingInterval()),a(b.message.value)):this.state===te.RECONNECTING&&b.message.case!=="leave"?(this.state=te.CONNECTED,r==null||r.removeEventListener("abort",u),this.startPingInterval(),((g=b.message)===null||g===void 0?void 0:g.case)==="reconnect"?a(b.message.value):(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),a(void 0),v=!0)):this.isEstablishingConnection&&b.message.case==="leave"?c(new X("Received leave request while trying to (re)connect",ye.LeaveRequest)):i.reconnect||c(new X("did not receive join response, got ".concat((m=b.message)===null||m===void 0?void 0:m.case," instead"))),!v)return}this.signalLatency&&(yield st(this.signalLatency)),this.handleSignalResponse(b)}),this.ws.onclose=h=>{this.isEstablishingConnection&&c(new X("Websocket got closed during a (re)connection attempt")),this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:h.reason,code:h.code,wasClean:h.wasClean,state:this.state})),this.handleOnClose(h.reason)}}finally{l()}}))}close(){return S(this,arguments,void 0,function(){var e=this;let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){const i=yield e.closingLock.lock();try{if(e.clearPingInterval(),n&&(e.state=te.DISCONNECTING),e.ws){e.ws.onmessage=null,e.ws.onopen=null,e.ws.onclose=null;const r=new Promise(s=>{e.ws?e.ws.onclose=()=>{s()}:s()});e.ws.readyState<e.ws.CLOSING&&(e.ws.close(),yield Promise.race([r,st(250)])),e.ws=void 0}}finally{n&&(e.state=te.DISCONNECTED),i()}}()})}sendOffer(e){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:Zi(e)})}sendAnswer(e){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:Zi(e)})}sendIceCandidate(e,n){return this.log.trace("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new la({candidateInit:JSON.stringify(e),target:n})})}sendMuteTrack(e,n){return this.sendRequest({case:"mute",value:new ua({sid:e,muted:n})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,n){return S(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return function*(){const a=s.getNextRequestId();return yield s.sendRequest({case:"updateMetadata",value:new oh({requestId:a,metadata:i,name:r,attributes:o})}),a}()})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,n){return this.sendRequest({case:"updateLayers",value:new sh({trackSid:e,layers:n})})}sendUpdateSubscriptionPermissions(e,n){return this.sendRequest({case:"subscriptionPermission",value:new lh({allParticipants:e,trackPermissions:n})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:ne.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new hh({timestamp:ne.parse(Date.now()),rtt:ne.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,n){return this.sendRequest({case:"updateAudioTrack",value:new rh({trackSid:e,features:n})})}sendLeave(){return this.sendRequest({case:"leave",value:new Fr({reason:en.CLIENT_INITIATED,action:tn.DISCONNECT})})}sendRequest(e){return S(this,arguments,void 0,function(n){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return function*(){if(!r&&!eC(n)&&i.state===te.RECONNECTING){i.queuedRequests.push(()=>S(i,void 0,void 0,function*(){yield this.sendRequest(n,!0)}));return}if(r||(yield i.requestQueue.flush()),i.signalLatency&&(yield st(i.signalLatency)),!i.ws||i.ws.readyState!==i.ws.OPEN){i.log.error("cannot send signal request before connected, type: ".concat(n==null?void 0:n.case),i.logContext);return}const o=new Ak({message:n});try{i.useJSON?i.ws.send(o.toJsonString()):i.ws.send(o.toBinary())}catch(a){i.log.error("error sending signal message",Object.assign(Object.assign({},i.logContext),{error:a}))}}()})}handleSignalResponse(e){var n,i;const r=e.message;if(r==null){this.log.debug("received unsupported message",this.logContext);return}let s=!1;if(r.case==="answer"){const o=ml(r.value);this.onAnswer&&this.onAnswer(o)}else if(r.case==="offer"){const o=ml(r.value);this.onOffer&&this.onOffer(o)}else if(r.case==="trickle"){const o=JSON.parse(r.value.candidateInit);this.onTrickle&&this.onTrickle(o,r.value.target)}else r.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((n=r.value.participants)!==null&&n!==void 0?n:[]):r.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(r.value):r.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((i=r.value.speakers)!==null&&i!==void 0?i:[]):r.case==="leave"?this.onLeave&&this.onLeave(r.value):r.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(r.value.sid,r.value.muted):r.case==="roomUpdate"?this.onRoomUpdate&&r.value.room&&this.onRoomUpdate(r.value.room):r.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(r.value):r.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(r.value):r.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(r.value):r.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(r.value):r.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(r.value):r.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(r.value):r.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(r.value):r.case==="pong"||(r.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(r.value.lastPingTimestamp.toString()),this.resetPingTimeout(),s=!0):r.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(r.value):r.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(r.value.trackSid):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:r.case})));s||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return S(this,void 0,void 0,function*(){if(this.state===te.DISCONNECTED)return;const n=this.onClose;yield this.close(),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),n&&n(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=me.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&me.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=me.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&me.clearInterval(this.pingInterval)}}function ml(t){const e={type:"offer",sdp:t.sdp};switch(t.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=t.type;break}return e}function Zi(t){return new Vt({sdp:t.sdp,type:t.type})}function tC(t,e,n){var i;const r=new URLSearchParams;return r.set("access_token",t),n.reconnect&&(r.set("reconnect","1"),n.sid&&r.set("sid",n.sid)),r.set("auto_subscribe",n.autoSubscribe?"1":"0"),r.set("sdk",mt()?"reactnative":"js"),r.set("version",e.version),r.set("protocol",e.protocol.toString()),e.deviceModel&&r.set("device_model",e.deviceModel),e.os&&r.set("os",e.os),e.osVersion&&r.set("os_version",e.osVersion),e.browser&&r.set("browser",e.browser),e.browserVersion&&r.set("browser_version",e.browserVersion),n.adaptiveStream&&r.set("adaptive_stream","1"),n.reconnectReason&&r.set("reconnect_reason",n.reconnectReason.toString()),!((i=navigator.connection)===null||i===void 0)&&i.type&&r.set("network",navigator.connection.type),"?".concat(r.toString())}var et={},Ts={},Es={exports:{}},gl;function Xh(){if(gl)return Es.exports;gl=1;var t=Es.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var n="candidate:%s %d %s %d %s %d typ %s";return n+=e.raddr!=null?" raddr %s rport %d":"%v%v",n+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(n+=" generation %d"),n+=e["network-id"]!=null?" network-id %d":"%v",n+=e["network-cost"]!=null?" network-cost %d":"%v",n}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var n="ssrc:%d";return e.attribute!=null&&(n+=" %s",e.value!=null&&(n+=":%s")),n}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var n="mediaclk:";return n+=e.id!=null?"id=%s %s":"%v%s",n+=e.mediaClockValue!=null?"=%s":"",n+=e.rateNumerator!=null?" rate=%s":"",n+=e.rateDenominator!=null?"/%s":"",n}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(t).forEach(function(e){var n=t[e];n.forEach(function(i){i.reg||(i.reg=/(.*)/),i.format||(i.format="%s")})}),Es.exports}var vl;function nC(){return vl||(vl=1,function(t){var e=function(a){return String(Number(a))===a?Number(a):a},n=function(a,c,l,u){if(u&&!l)c[u]=e(a[1]);else for(var d=0;d<l.length;d+=1)a[d+1]!=null&&(c[l[d]]=e(a[d+1]))},i=function(a,c,l){var u=a.name&&a.names;a.push&&!c[a.push]?c[a.push]=[]:u&&!c[a.name]&&(c[a.name]={});var d=a.push?{}:u?c[a.name]:c;n(l.match(a.reg),d,a.names,a.name),a.push&&c[a.push].push(d)},r=Xh(),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(a){var c={},l=[],u=c;return a.split(/(\r\n|\r|\n)/).filter(s).forEach(function(d){var h=d[0],f=d.slice(2);h==="m"&&(l.push({rtp:[],fmtp:[]}),u=l[l.length-1]);for(var g=0;g<(r[h]||[]).length;g+=1){var m=r[h][g];if(m.reg.test(f))return i(m,u,f)}}),c.media=l,c};var o=function(a,c){var l=c.split(/=(.+)/,2);return l.length===2?a[l[0]]=e(l[1]):l.length===1&&c.length>1&&(a[l[0]]=void 0),a};t.parseParams=function(a){return a.split(/;\s?/).reduce(o,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(a){return a.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(a){for(var c=[],l=a.split(" ").map(e),u=0;u<l.length;u+=3)c.push({component:l[u],ip:l[u+1],port:l[u+2]});return c},t.parseImageAttributes=function(a){return a.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(o,{})})},t.parseSimulcastStreamList=function(a){return a.split(";").map(function(c){return c.split(",").map(function(l){var u,d=!1;return l[0]!=="~"?u=e(l):(u=e(l.substring(1,l.length)),d=!0),{scid:u,paused:d}})})}}(Ts)),Ts}var ws,bl;function iC(){if(bl)return ws;bl=1;var t=Xh(),e=/%[sdv%]/g,n=function(o){var a=1,c=arguments,l=c.length;return o.replace(e,function(u){if(a>=l)return u;var d=c[a];switch(a+=1,u){case"%%":return"%";case"%s":return String(d);case"%d":return Number(d);case"%v":return""}})},i=function(o,a,c){var l=a.format instanceof Function?a.format(a.push?c:c[a.name]):a.format,u=[o+"="+l];if(a.names)for(var d=0;d<a.names.length;d+=1){var h=a.names[d];a.name?u.push(c[a.name][h]):u.push(c[a.names[d]])}else u.push(c[a.name]);return n.apply(null,u)},r=["v","o","s","i","u","e","p","c","b","t","r","z","a"],s=["i","c","b","a"];return ws=function(o,a){a=a||{},o.version==null&&(o.version=0),o.name==null&&(o.name=" "),o.media.forEach(function(d){d.payloads==null&&(d.payloads="")});var c=a.outerOrder||r,l=a.innerOrder||s,u=[];return c.forEach(function(d){t[d].forEach(function(h){h.name in o&&o[h.name]!=null?u.push(i(d,h,o)):h.push in o&&o[h.push]!=null&&o[h.push].forEach(function(f){u.push(i(d,h,f))})})}),o.media.forEach(function(d){u.push(i("m",t.m[0],d)),l.forEach(function(h){t[h].forEach(function(f){f.name in d&&d[f.name]!=null?u.push(i(h,f,d)):f.push in d&&d[f.push]!=null&&d[f.push].forEach(function(g){u.push(i(h,f,g))})})})}),u.join(`\r
`)+`\r
`},ws}var yl;function rC(){if(yl)return et;yl=1;var t=nC(),e=iC();return et.write=e,et.parse=t.parse,et.parseParams=t.parseParams,et.parseFmtpConfig=t.parseFmtpConfig,et.parsePayloads=t.parsePayloads,et.parseRemoteCandidates=t.parseRemoteCandidates,et.parseImageAttributes=t.parseImageAttributes,et.parseSimulcastStreamList=t.parseSimulcastStreamList,et}var St=rC();const sC=.7,oC=20,sn={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class kl extends at.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;super(),this.log=V,this.ddExtID=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=ma(r=>S(this,void 0,void 0,function*(){this.emit(sn.NegotiationStarted);try{yield this.createAndSendOffer()}catch(s){if(r)r(s);else throw s}}),oC),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=ft((i=n.loggerName)!==null&&i!==void 0?i:Je.PCTransport),this.loggerOptions=n,this.config=e,this._pc=this.createPC()}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=n=>{var i;n.candidate&&((i=this.onIceCandidate)===null||i===void 0||i.call(this,n.candidate))},e.onicecandidateerror=n=>{var i;(i=this.onIceCandidateError)===null||i===void 0||i.call(this,n)},e.oniceconnectionstatechange=()=>{var n;(n=this.onIceConnectionStateChange)===null||n===void 0||n.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var n;(n=this.onSignalingStatechange)===null||n===void 0||n.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var n;(n=this.onConnectionStateChange)===null||n===void 0||n.call(this,e.connectionState)},e.ondatachannel=n=>{var i;(i=this.onDataChannel)===null||i===void 0||i.call(this,n)},e.ontrack=n=>{var i;(i=this.onTrack)===null||i===void 0||i.call(this,n)},e}get logContext(){var e,n;return Object.assign({},(n=(e=this.loggerOptions).loggerContextCb)===null||n===void 0?void 0:n.call(e))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(e){return S(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e){return S(this,void 0,void 0,function*(){var n;let i;if(e.type==="offer"){let{stereoMids:r,nackMids:s}=aC(e);this.remoteStereoMids=r,this.remoteNackMids=s}else if(e.type==="answer"){const r=St.parse((n=e.sdp)!==null&&n!==void 0?n:"");r.media.forEach(s=>{s.type==="audio"&&this.trackBitrates.some(o=>{if(!o.transceiver||s.mid!=o.transceiver.mid)return!1;let a=0;if(s.rtp.some(l=>l.codec.toUpperCase()===o.codec.toUpperCase()?(a=l.payload,!0):!1),a===0)return!0;let c=!1;for(const l of s.fmtp)if(l.payload===a){l.config=l.config.split(";").filter(u=>!u.includes("maxaveragebitrate")).join(";"),o.maxbr>0&&(l.config+=";maxaveragebitrate=".concat(o.maxbr*1e3)),c=!0;break}return c||o.maxbr>0&&s.fmtp.push({payload:a,config:"maxaveragebitrate=".concat(o.maxbr*1e3)}),!0})}),i=St.write(r)}yield this.setMungedSDP(e,i,!0),this.pendingCandidates.forEach(r=>{this.pc.addIceCandidate(r)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):e.type==="answer"&&(this.emit(sn.NegotiationComplete),e.sdp&&St.parse(e.sdp).media.forEach(s=>{s.type==="video"&&this.emit(sn.RTPVideoPayloadTypes,s.rtp)}))})}createAndSendOffer(e){return S(this,void 0,void 0,function*(){var n;if(this.onOffer===void 0)return;if(e!=null&&e.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const s=this._pc.remoteDescription;if(e!=null&&e.iceRestart&&s)yield this._pc.setRemoteDescription(s);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const i=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:i.sdp},this.logContext));const r=St.parse((n=i.sdp)!==null&&n!==void 0?n:"");r.media.forEach(s=>{s.type==="audio"?Sl(s,[],[]):s.type==="video"&&this.trackBitrates.some(o=>{if(!s.msid||!o.cid||!s.msid.includes(o.cid))return!1;let a=0;if(s.rtp.some(l=>l.codec.toUpperCase()===o.codec.toUpperCase()?(a=l.payload,!0):!1),a===0||(Gn(o.codec)&&this.ensureVideoDDExtensionForSVC(s,r),o.codec!=="av1"))return!0;const c=Math.round(o.maxbr*sC);for(const l of s.fmtp)if(l.payload===a){l.config.includes("x-google-start-bitrate")||(l.config+=";x-google-start-bitrate=".concat(c));break}return!0})}),yield this.setMungedSDP(i,St.write(r)),this.onOffer(i)})}createAndSetAnswer(){return S(this,void 0,void 0,function*(){var e;const n=yield this.pc.createAnswer(),i=St.parse((e=n.sdp)!==null&&e!==void 0?e:"");return i.media.forEach(r=>{r.type==="audio"&&Sl(r,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(n,St.write(i)),n})}createDataChannel(e,n){return this.pc.createDataChannel(e,n)}addTransceiver(e,n){return this.pc.addTransceiver(e,n)}addTrack(e){if(!this._pc)throw new ce("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var n;if(!this._pc)throw new ce("PC closed, cannot configure");return(n=this._pc)===null||n===void 0?void 0:n.setConfiguration(e)}canRemoveTrack(){var e;return!!(!((e=this._pc)===null||e===void 0)&&e.removeTrack)}removeTrack(e){var n;return(n=this._pc)===null||n===void 0?void 0:n.removeTrack(e)}getConnectionState(){var e,n;return(n=(e=this._pc)===null||e===void 0?void 0:e.connectionState)!==null&&n!==void 0?n:"closed"}getICEConnectionState(){var e,n;return(n=(e=this._pc)===null||e===void 0?void 0:e.iceConnectionState)!==null&&n!==void 0?n:"closed"}getSignallingState(){var e,n;return(n=(e=this._pc)===null||e===void 0?void 0:e.signalingState)!==null&&n!==void 0?n:"closed"}getTransceivers(){var e,n;return(n=(e=this._pc)===null||e===void 0?void 0:e.getTransceivers())!==null&&n!==void 0?n:[]}getSenders(){var e,n;return(n=(e=this._pc)===null||e===void 0?void 0:e.getSenders())!==null&&n!==void 0?n:[]}getLocalDescription(){var e;return(e=this._pc)===null||e===void 0?void 0:e.localDescription}getRemoteDescription(){var e;return(e=this.pc)===null||e===void 0?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return S(this,void 0,void 0,function*(){var e;if(!this._pc)return;let n="";const i=new Map,r=new Map;if((yield this._pc.getStats()).forEach(a=>{switch(a.type){case"transport":n=a.selectedCandidatePairId;break;case"candidate-pair":n===""&&a.selected&&(n=a.id),i.set(a.id,a);break;case"remote-candidate":r.set(a.id,"".concat(a.address,":").concat(a.port));break}}),n==="")return;const o=(e=i.get(n))===null||e===void 0?void 0:e.remoteCandidateId;if(o!==void 0)return r.get(o)})}setMungedSDP(e,n,i){return S(this,void 0,void 0,function*(){if(n){const r=e.sdp;e.sdp=n;try{this.log.debug("setting munged ".concat(i?"remote":"local"," description"),this.logContext),i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e);return}catch(s){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:s,sdp:n})),e.sdp=r}}try{i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(r){let s="unknown error";r instanceof Error?s=r.message:typeof r=="string"&&(s=r);const o={error:s,sdp:e.sdp};throw!i&&this.pc.remoteDescription&&(o.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:o})),new io(s)}})}ensureVideoDDExtensionForSVC(e,n){var i,r;if(!((i=e.ext)===null||i===void 0?void 0:i.some(o=>o.uri===ll))){if(this.ddExtID===0){let o=0;n.media.forEach(a=>{var c;a.type==="video"&&((c=a.ext)===null||c===void 0||c.forEach(l=>{l.value>o&&(o=l.value)}))}),this.ddExtID=o+1}(r=e.ext)===null||r===void 0||r.push({value:this.ddExtID,uri:ll})}}}function Sl(t,e,n){let i=0;t.rtp.some(r=>r.codec==="opus"?(i=r.payload,!0):!1),i>0&&(t.rtcpFb||(t.rtcpFb=[]),n.includes(t.mid)&&!t.rtcpFb.some(r=>r.payload===i&&r.type==="nack")&&t.rtcpFb.push({payload:i,type:"nack"}),e.includes(t.mid)&&t.fmtp.some(r=>r.payload===i?(r.config.includes("stereo=1")||(r.config+=";stereo=1"),!0):!1))}function aC(t){var e;const n=[],i=[],r=St.parse((e=t.sdp)!==null&&e!==void 0?e:"");let s=0;return r.media.forEach(o=>{var a;o.type==="audio"&&(o.rtp.some(c=>c.codec==="opus"?(s=c.payload,!0):!1),!((a=o.rtcpFb)===null||a===void 0)&&a.some(c=>c.payload===s&&c.type==="nack")&&i.push(o.mid),o.fmtp.some(c=>c.payload===s?(c.config.includes("sprop-stereo=1")&&n.push(o.mid),!0):!1))}),{stereoMids:n,nackMids:i}}const ho="vp8",cC={audioPreset:ro.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:ga.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:ho,backupCodec:!0},Zh={autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0},ef={resolution:ii.h720.resolution},lC={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new sS,disconnectOnPageLeave:!0,webAudioMix:!1},ba={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var se;(function(t){t[t.NEW=0]="NEW",t[t.CONNECTING=1]="CONNECTING",t[t.CONNECTED=2]="CONNECTED",t[t.FAILED=3]="FAILED",t[t.CLOSING=4]="CLOSING",t[t.CLOSED=5]="CLOSED"})(se||(se={}));class uC{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,n,i){var r;this.peerConnectionTimeout=ba.peerConnectionTimeout,this.log=V,this.updateState=()=>{var s;const o=this.state,a=this.requiredTransports.map(c=>c.getConnectionState());a.every(c=>c==="connected")?this.state=se.CONNECTED:a.some(c=>c==="failed")?this.state=se.FAILED:a.some(c=>c==="connecting")?this.state=se.CONNECTING:a.every(c=>c==="closed")?this.state=se.CLOSED:a.some(c=>c==="closed")?this.state=se.CLOSING:a.every(c=>c==="new")&&(this.state=se.NEW),o!==this.state&&(this.log.debug("pc state change: from ".concat(se[o]," to ").concat(se[this.state]),this.logContext),(s=this.onStateChange)===null||s===void 0||s.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState()))},this.log=ft((r=i.loggerName)!==null&&r!==void 0?r:Je.PCManager),this.loggerOptions=i,this.isPublisherConnectionRequired=!n,this.isSubscriberConnectionRequired=n,this.publisher=new kl(e,i),this.subscriber=new kl(e,i),this.publisher.onConnectionStateChange=this.updateState,this.subscriber.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=s=>{var o;(o=this.onIceCandidate)===null||o===void 0||o.call(this,s,ze.PUBLISHER)},this.subscriber.onIceCandidate=s=>{var o;(o=this.onIceCandidate)===null||o===void 0||o.call(this,s,ze.SUBSCRIBER)},this.subscriber.onDataChannel=s=>{var o;(o=this.onDataChannel)===null||o===void 0||o.call(this,s)},this.subscriber.onTrack=s=>{var o;(o=this.onTrack)===null||o===void 0||o.call(this,s)},this.publisher.onOffer=s=>{var o;(o=this.onPublisherOffer)===null||o===void 0||o.call(this,s)},this.state=se.NEW,this.connectionLock=new Re,this.remoteOfferLock=new Re}get logContext(){var e,n;return Object.assign({},(n=(e=this.loggerOptions).loggerContextCb)===null||n===void 0?void 0:n.call(e))}requirePublisher(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=e,this.updateState()}requireSubscriber(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isSubscriberConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e){return this.publisher.setRemoteDescription(e)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return S(this,void 0,void 0,function*(){if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const e=this.publisher;for(const n of e.getSenders())try{e.canRemoveTrack()&&e.removeTrack(n)}catch(i){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:i}))}}yield Promise.all([this.publisher.close(),this.subscriber.close()]),this.updateState()})}triggerIceRestart(){return S(this,void 0,void 0,function*(){this.subscriber.restartingIce=!0,this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,n){return S(this,void 0,void 0,function*(){n===ze.PUBLISHER?yield this.publisher.addIceCandidate(e):yield this.subscriber.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e){return S(this,void 0,void 0,function*(){this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:this.subscriber.getSignallingState().toString()}));const n=yield this.remoteOfferLock.lock();try{return yield this.subscriber.setRemoteDescription(e),yield this.subscriber.createAndSetAnswer()}finally{n()}})}updateConfiguration(e,n){this.publisher.setConfiguration(e),this.subscriber.setConfiguration(e),n&&this.triggerIceRestart()}ensurePCTransportConnection(e,n){return S(this,void 0,void 0,function*(){var i;const r=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((i=this.requiredTransports)===null||i===void 0?void 0:i.map(s=>this.ensureTransportConnected(s,e,n)))}finally{r()}})}negotiate(e){return S(this,void 0,void 0,function*(){return new Promise((n,i)=>S(this,void 0,void 0,function*(){const r=setTimeout(()=>{i("negotiation timed out")},this.peerConnectionTimeout),s=()=>{clearTimeout(r),i("negotiation aborted")};e.signal.addEventListener("abort",s),this.publisher.once(sn.NegotiationStarted,()=>{e.signal.aborted||this.publisher.once(sn.NegotiationComplete,()=>{clearTimeout(r),n()})}),yield this.publisher.negotiate(o=>{clearTimeout(r),i(o)})}))})}addPublisherTransceiver(e,n){return this.publisher.addTransceiver(e,n)}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,n){return this.publisher.createDataChannel(e,n)}getConnectedAddress(e){return e===ze.PUBLISHER?this.publisher.getConnectedAddress():e===ze.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&e.push(this.subscriber),e}ensureTransportConnected(e,n){return S(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return function*(){if(i.getConnectionState()!=="connected")return new Promise((c,l)=>S(s,void 0,void 0,function*(){const u=()=>{this.log.warn("abort transport connection",this.logContext),me.clearTimeout(d),l(new X("room connection has been cancelled",ye.Cancelled))};r!=null&&r.signal.aborted&&u(),r==null||r.signal.addEventListener("abort",u);const d=me.setTimeout(()=>{r==null||r.signal.removeEventListener("abort",u),l(new X("could not establish pc connection"))},o);for(;this.state!==se.CONNECTED;)if(yield st(50),r!=null&&r.signal.aborted){l(new X("room connection has been cancelled",ye.Cancelled));return}me.clearTimeout(d),r==null||r.signal.removeEventListener("abort",u),c()}))}()})}}const ya=2e3;function Vr(t,e){if(!e)return 0;let n,i;return"bytesReceived"in t?(n=t.bytesReceived,i=e.bytesReceived):"bytesSent"in t&&(n=t.bytesSent,i=e.bytesSent),n===void 0||i===void 0||t.timestamp===void 0||e.timestamp===void 0?0:(n-i)*8*1e3/(t.timestamp-e.timestamp)}class he extends Bt{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;super(e,P.Kind.Audio,n,i,s),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>S(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let o;try{o=yield this.getSenderStats()}catch(a){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:a}));return}o&&this.prevStats&&(this._currentBitrate=Vr(o,this.prevStats)),this.prevStats=o}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(U.AudioTrackFeatureUpdate,this,it.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(U.AudioTrackFeatureUpdate,this,it.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=r,this.checkForSilence()}setDeviceId(e){return S(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===ht(e)?!0:(this._constraints.deviceId=e,this.isMuted||(yield this.restartTrack()),this.isMuted||ht(e)===this._mediaStreamTrack.getSettings().deviceId)})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return S(this,void 0,void 0,function*(){const n=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===P.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{n()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return S(this,void 0,void 0,function*(){const n=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const i=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==ht(this._constraints.deviceId);return this.source===P.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||i)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{n()}})}restartTrack(e){return S(this,void 0,void 0,function*(){let n;if(e){const i=jr({audio:e});typeof i.audio!="boolean"&&(n=i.audio)}yield this.restart(n)})}restart(e){const n=Object.create(null,{restart:{get:()=>super.restart}});return S(this,void 0,void 0,function*(){const i=yield n.restart.call(this,e);return this.checkForSilence(),i})}startMonitor(){Oe()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},ya)))}setProcessor(e){return S(this,void 0,void 0,function*(){var n;const i=yield this.processorLock.lock();try{if(!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.stopProcessor());const r={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(r),this.processor=e,this.processor.processedTrack&&(yield(n=this.sender)===null||n===void 0?void 0:n.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(U.TrackProcessorUpdate,this.processor)}finally{i()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){return S(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return;const n=yield this.sender.getStats();let i;return n.forEach(r=>{r.type==="outbound-rtp"&&(i={type:"audio",streamId:r.id,packetsSent:r.packetsSent,packetsLost:r.packetsLost,bytesSent:r.bytesSent,timestamp:r.timestamp,roundTripTime:r.roundTripTime,jitter:r.jitter})}),i})}checkForSilence(){return S(this,void 0,void 0,function*(){const e=yield OS(this);return e&&(this.isMuted||this.log.warn("silence detected on local audio track",this.logContext),this.emit(U.AudioSilenceDetected)),e})}}function tf(t,e,n){switch(t.kind){case"audio":return new he(t,e,!1,void 0,n);case"video":return new ve(t,e,!1,n);default:throw new rt("unsupported track type: ".concat(t.kind))}}const dC=Object.values(ii),hC=Object.values(so),fC=Object.values(ga),pC=[ii.h180,ii.h360],mC=[so.h180,so.h360],gC=t=>[{scaleResolutionDownBy:2,fps:t.encoding.maxFramerate}].map(n=>{var i,r;return new J(Math.floor(t.width/n.scaleResolutionDownBy),Math.floor(t.height/n.scaleResolutionDownBy),Math.max(15e4,Math.floor(t.encoding.maxBitrate/(Math.pow(n.scaleResolutionDownBy,2)*(((i=t.encoding.maxFramerate)!==null&&i!==void 0?i:30)/((r=n.fps)!==null&&r!==void 0?r:30))))),n.fps,t.encoding.priority)}),fo=["q","h","f"];function po(t,e,n,i){var r,s;let o=i==null?void 0:i.videoEncoding;t&&(o=i==null?void 0:i.screenShareEncoding);const a=i==null?void 0:i.simulcast,c=i==null?void 0:i.scalabilityMode,l=i==null?void 0:i.videoCodec;if(!o&&!a&&!c||!e||!n)return[{}];o||(o=bC(t,e,n,l),V.debug("using video encoding",o));const u=new J(e,n,o.maxBitrate,o.maxFramerate,o.priority);if(c&&Gn(l)){const f=new nf(c),g=[];if(f.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));const m=pt();if($t()||mt()||(m==null?void 0:m.name)==="Chrome"&&gn(m==null?void 0:m.version,"113")<0){const b=f.suffix=="h"?2:3;for(let v=0;v<f.spatial;v+=1)g.push({rid:fo[2-v],maxBitrate:o.maxBitrate/Math.pow(b,v),maxFramerate:u.encoding.maxFramerate});g[0].scalabilityMode=c}else g.push({maxBitrate:o.maxBitrate,maxFramerate:u.encoding.maxFramerate,scalabilityMode:c});return u.encoding.priority&&(g[0].priority=u.encoding.priority,g[0].networkPriority=u.encoding.priority),V.debug("using svc encoding",{encodings:g}),g}if(!a)return[o];let d=[];t?d=(r=Tl(i==null?void 0:i.screenShareSimulcastLayers))!==null&&r!==void 0?r:Cl(t,u):d=(s=Tl(i==null?void 0:i.videoSimulcastLayers))!==null&&s!==void 0?s:Cl(t,u);let h;if(d.length>0){const f=d[0];d.length>1&&([,h]=d);const g=Math.max(e,n);if(g>=960&&h)return Ps(e,n,[f,h,u]);if(g>=480)return Ps(e,n,[f,u])}return Ps(e,n,[u])}function vC(t,e,n){var i,r,s,o;if(!n.backupCodec||n.backupCodec===!0||n.backupCodec.codec===n.videoCodec)return;e!==n.backupCodec.codec&&V.warn("requested a different codec than specified as backup",{serverRequested:e,backup:n.backupCodec.codec}),n.videoCodec=e,n.videoEncoding=n.backupCodec.encoding;const a=t.mediaStreamTrack.getSettings(),c=(i=a.width)!==null&&i!==void 0?i:(r=t.dimensions)===null||r===void 0?void 0:r.width,l=(s=a.height)!==null&&s!==void 0?s:(o=t.dimensions)===null||o===void 0?void 0:o.height;return po(t.source===P.Source.ScreenShare,c,l,n)}function bC(t,e,n,i){const r=yC(t,e,n);let{encoding:s}=r[0];const o=Math.max(e,n);for(let a=0;a<r.length;a+=1){const c=r[a];if(s=c.encoding,c.width>=o)break}if(i)switch(i){case"av1":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.7;break;case"vp9":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.85;break}return s}function yC(t,e,n){if(t)return fC;const i=e>n?e/n:n/e;return Math.abs(i-16/9)<Math.abs(i-4/3)?dC:hC}function Cl(t,e){if(t)return gC(e);const{width:n,height:i}=e,r=n>i?n/i:i/n;return Math.abs(r-16/9)<Math.abs(r-4/3)?pC:mC}function Ps(t,e,n){const i=[];if(n.forEach((r,s)=>{if(s>=fo.length)return;const o=Math.min(t,e),c={rid:fo[s],scaleResolutionDownBy:Math.max(1,o/Math.min(r.width,r.height)),maxBitrate:r.encoding.maxBitrate};r.encoding.maxFramerate&&(c.maxFramerate=r.encoding.maxFramerate);const l=mn()||s===0;r.encoding.priority&&l&&(c.priority=r.encoding.priority,c.networkPriority=r.encoding.priority),i.push(c)}),mt()&&Yh()==="ios"){let r;i.forEach(o=>{r?o.maxFramerate&&o.maxFramerate>r&&(r=o.maxFramerate):r=o.maxFramerate});let s=!0;i.forEach(o=>{var a;o.maxFramerate!=r&&(s&&(s=!1,V.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),V.info('Setting framerate of encoding "'.concat((a=o.rid)!==null&&a!==void 0?a:"",'" to ').concat(r)),o.maxFramerate=r)})}return i}function Tl(t){if(t)return t.sort((e,n)=>{const{encoding:i}=e,{encoding:r}=n;return i.maxBitrate>r.maxBitrate?1:i.maxBitrate<r.maxBitrate?-1:i.maxBitrate===r.maxBitrate&&i.maxFramerate&&r.maxFramerate?i.maxFramerate>r.maxFramerate?1:-1:0})}class nf{constructor(e){const n=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!n)throw new Error("invalid scalability mode");if(this.spatial=parseInt(n[1]),this.temporal=parseInt(n[2]),n.length>3)switch(n[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=n[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat((e=this.suffix)!==null&&e!==void 0?e:"")}}function kC(t){return t.source===P.Source.ScreenShare||t.constraints.height&&ht(t.constraints.height)>=1080?"maintain-resolution":"balanced"}const SC=5e3;class ve extends Bt{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0;super(e,P.Kind.Video,n,i,r),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.monitorSender=()=>S(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let s;try{s=yield this.getSenderStats()}catch(a){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:a}));return}const o=new Map(s.map(a=>[a.rid,a]));if(this.prevStats){let a=0;o.forEach((c,l)=>{var u;const d=(u=this.prevStats)===null||u===void 0?void 0:u.get(l);a+=Vr(c,d)}),this._currentBitrate=a}this.prevStats=o}),this.senderLock=new Re}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var n;if(this.signalClient=e,!Oe())return;const i=(n=this.sender)===null||n===void 0?void 0:n.getParameters();i&&(this.encodings=i.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},ya))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return S(this,void 0,void 0,function*(){var n,i,r,s,o;yield e.pauseUpstream.call(this);try{for(var a=!0,c=Qt(this.simulcastCodecs.values()),l;l=yield c.next(),n=l.done,!n;a=!0)s=l.value,a=!1,yield(o=s.sender)===null||o===void 0?void 0:o.replaceTrack(null)}catch(u){i={error:u}}finally{try{!a&&!n&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return S(this,void 0,void 0,function*(){var n,i,r,s,o;yield e.resumeUpstream.call(this);try{for(var a=!0,c=Qt(this.simulcastCodecs.values()),l;l=yield c.next(),n=l.done,!n;a=!0){s=l.value,a=!1;const u=s;yield(o=u.sender)===null||o===void 0?void 0:o.replaceTrack(u.mediaStreamTrack)}}catch(u){i={error:u}}finally{try{!a&&!n&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return S(this,void 0,void 0,function*(){const n=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===P.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{n()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return S(this,void 0,void 0,function*(){const n=yield this.muteLock.lock();try{return this.isMuted?(this.source===P.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{n()}})}setTrackMuted(e){super.setTrackMuted(e);for(const n of this.simulcastCodecs.values())n.mediaStreamTrack.enabled=!e}getSenderStats(){return S(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return[];const n=[],i=yield this.sender.getStats();return i.forEach(r=>{var s;if(r.type==="outbound-rtp"){const o={type:"video",streamId:r.id,frameHeight:r.frameHeight,frameWidth:r.frameWidth,framesPerSecond:r.framesPerSecond,framesSent:r.framesSent,firCount:r.firCount,pliCount:r.pliCount,nackCount:r.nackCount,packetsSent:r.packetsSent,bytesSent:r.bytesSent,qualityLimitationReason:r.qualityLimitationReason,qualityLimitationDurations:r.qualityLimitationDurations,qualityLimitationResolutionChanges:r.qualityLimitationResolutionChanges,rid:(s=r.rid)!==null&&s!==void 0?s:r.id,retransmittedPacketsSent:r.retransmittedPacketsSent,targetBitrate:r.targetBitrate,timestamp:r.timestamp},a=i.get(r.remoteId);a&&(o.jitter=a.jitter,o.packetsLost=a.packetsLost,o.roundTripTime=a.roundTripTime),n.push(o)}}),n.sort((r,s)=>{var o,a;return((o=s.frameWidth)!==null&&o!==void 0?o:0)-((a=r.frameWidth)!==null&&a!==void 0?a:0)}),n})}setPublishingQuality(e){const n=[];for(let i=Be.LOW;i<=Be.HIGH;i+=1)n.push(new ha({quality:i,enabled:i<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers(n)}setDeviceId(e){return S(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===ht(e)?!0:(this._constraints.deviceId=e,this.isMuted||(yield this.restartTrack()),this.isMuted||ht(e)===this._mediaStreamTrack.getSettings().deviceId)})}restartTrack(e){return S(this,void 0,void 0,function*(){var n,i,r,s;let o;if(e){const u=jr({video:e});typeof u.video!="boolean"&&(o=u.video)}yield this.restart(o);try{for(var a=!0,c=Qt(this.simulcastCodecs.values()),l;l=yield c.next(),n=l.done,!n;a=!0){s=l.value,a=!1;const u=s;u.sender&&(u.mediaStreamTrack=this.mediaStreamTrack.clone(),yield u.sender.replaceTrack(u.mediaStreamTrack))}}catch(u){i={error:u}}finally{try{!a&&!n&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}setProcessor(e){const n=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return S(this,arguments,void 0,function(i){var r=this;let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var o,a,c,l,u,d;if(yield n.setProcessor.call(r,i,s),!((u=r.processor)===null||u===void 0)&&u.processedTrack)try{for(var h=!0,f=Qt(r.simulcastCodecs.values()),g;g=yield f.next(),o=g.done,!o;h=!0)l=g.value,h=!1,yield(d=l.sender)===null||d===void 0?void 0:d.replaceTrack(r.processor.processedTrack)}catch(m){a={error:m}}finally{try{!h&&!o&&(c=f.return)&&(yield c.call(f))}finally{if(a)throw a.error}}}()})}setDegradationPreference(e){return S(this,void 0,void 0,function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const n=this.sender.getParameters();n.degradationPreference=e,this.sender.setParameters(n)}catch(n){this.log.warn("failed to set degradationPreference",Object.assign({error:n},this.logContext))}})}addSimulcastTrack(e,n){if(this.simulcastCodecs.has(e)){this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);return}const i={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:n};return this.simulcastCodecs.set(e,i),i}setSimulcastTrackSender(e,n){const i=this.simulcastCodecs.get(e);i&&(i.sender=n,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},SC))}setPublishingCodecs(e){return S(this,void 0,void 0,function*(){var n,i,r,s,o,a,c;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers(e[0].qualities),[];this.subscribedCodecs=e;const l=[];try{for(n=!0,i=Qt(e);r=yield i.next(),s=r.done,!s;n=!0){c=r.value,n=!1;const u=c;if(!this.codec||this.codec===u.codec)yield this.setPublishingLayers(u.qualities);else{const d=this.simulcastCodecs.get(u.codec);if(this.log.debug("try setPublishingCodec for ".concat(u.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:d})),!d||!d.sender){for(const h of u.qualities)if(h.enabled){l.push(u.codec);break}}else d.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(u.codec),this.logContext),yield El(d.sender,d.encodings,u.qualities,this.senderLock,this.log,this.logContext))}}}catch(u){o={error:u}}finally{try{!n&&!s&&(a=i.return)&&(yield a.call(i))}finally{if(o)throw o.error}}return l})}setPublishingLayers(e){return S(this,void 0,void 0,function*(){this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:e})),!(!this.sender||!this.encodings)&&(yield El(this.sender,this.encodings,e,this.senderLock,this.log,this.logContext))})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return S(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),Kh()&&this.isInBackground&&this.source===P.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function El(t,e,n,i,r,s){return S(this,void 0,void 0,function*(){const o=yield i.lock();r.debug("setPublishingLayersForSender",Object.assign(Object.assign({},s),{sender:t,qualities:n,senderEncodings:e}));try{const a=t.getParameters(),{encodings:c}=a;if(!c)return;if(c.length!==e.length){r.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},s),{encodings:c,senderEncodings:e}));return}let l=!1;!1&&c[0].scalabilityMode||c.forEach((d,h)=>{var f;let g=(f=d.rid)!==null&&f!==void 0?f:"";g===""&&(g="q");const m=rf(g),b=n.find(v=>v.quality===m);b&&d.active!==b.enabled&&(l=!0,d.active=b.enabled,r.debug("setting layer ".concat(b.quality," to ").concat(d.active?"enabled":"disabled"),s),mn()&&(b.enabled?(d.scaleResolutionDownBy=e[h].scaleResolutionDownBy,d.maxBitrate=e[h].maxBitrate,d.maxFrameRate=e[h].maxFrameRate):(d.scaleResolutionDownBy=4,d.maxBitrate=10,d.maxFrameRate=2)))}),l&&(a.encodings=c,r.debug("setting encodings",Object.assign(Object.assign({},s),{encodings:a.encodings})),yield t.setParameters(a))}finally{o()}})}function rf(t){switch(t){case"f":return Be.HIGH;case"h":return Be.MEDIUM;case"q":return Be.LOW;default:return Be.HIGH}}function wl(t,e,n,i){if(!n)return[new Ft({quality:Be.HIGH,width:t,height:e,bitrate:0,ssrc:0})];if(i){const r=n[0].scalabilityMode,s=new nf(r),o=[],a=s.suffix=="h"?1.5:2,c=s.suffix=="h"?2:3;for(let l=0;l<s.spatial;l+=1)o.push(new Ft({quality:Math.min(Be.HIGH,s.spatial-1)-l,width:Math.ceil(t/Math.pow(a,l)),height:Math.ceil(e/Math.pow(a,l)),bitrate:n[0].maxBitrate?Math.ceil(n[0].maxBitrate/Math.pow(c,l)):0,ssrc:0}));return o}return n.map(r=>{var s,o,a;const c=(s=r.scaleResolutionDownBy)!==null&&s!==void 0?s:1;let l=rf((o=r.rid)!==null&&o!==void 0?o:"");return new Ft({quality:l,width:Math.ceil(t/c),height:Math.ceil(e/c),bitrate:(a=r.maxBitrate)!==null&&a!==void 0?a:0,ssrc:0})})}const Pl="_lossy",xl="_reliable",CC=2*1e3,xs="leave-reconnect";var We;(function(t){t[t.New=0]="New",t[t.Connected=1]="Connected",t[t.Disconnected=2]="Disconnected",t[t.Reconnecting=3]="Reconnecting",t[t.Closed=4]="Closed"})(We||(We={}));class TC extends at.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var n;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=ba.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.subscriberPrimary=!1,this.pcState=We.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=V,this.handleDataChannel=i=>S(this,[i],void 0,function(r){var s=this;let{channel:o}=r;return function*(){if(o){if(o.label===xl)s.reliableDCSub=o;else if(o.label===Pl)s.lossyDCSub=o;else return;s.log.debug("on data channel ".concat(o.id,", ").concat(o.label),s.logContext),o.onmessage=s.handleDataMessage}}()}),this.handleDataMessage=i=>S(this,void 0,void 0,function*(){var r,s;const o=yield this.dataProcessLock.lock();try{let a;if(i.data instanceof ArrayBuffer)a=i.data;else if(i.data instanceof Blob)a=yield i.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:i.data}));return}const c=kt.fromBinary(new Uint8Array(a));((r=c.value)===null||r===void 0?void 0:r.case)==="speaker"?this.emit(F.ActiveSpeakersUpdate,c.value.value.speakers):(((s=c.value)===null||s===void 0?void 0:s.case)==="user"&&wC(c,c.value.value),this.emit(F.DataPacketReceived,c))}finally{o()}}),this.handleDataError=i=>{const s=i.currentTarget.maxRetransmits===0?"lossy":"reliable";if(i instanceof ErrorEvent&&i.error){const{error:o}=i.error;this.log.error("DataChannel error on ".concat(s,": ").concat(i.message),Object.assign(Object.assign({},this.logContext),{error:o}))}else this.log.error("Unknown DataChannel error on ".concat(s),Object.assign(Object.assign({},this.logContext),{event:i}))},this.handleBufferedAmountLow=i=>{const s=i.currentTarget.maxRetransmits===0?ee.LOSSY:ee.RELIABLE;this.updateAndEmitDCBufferStatus(s)},this.handleDisconnect=(i,r)=>{if(this._isClosed)return;this.log.warn("".concat(i," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const s=c=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(c,"ms. giving up"),this.logContext),this.emit(F.Disconnected),this.close()},o=Date.now()-this.reconnectStart;let a=this.getNextRetryDelay({elapsedMs:o,retryCount:this.reconnectAttempts});if(a===null){s(o);return}i===xs&&(a=0),this.log.debug("reconnecting in ".concat(a,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=me.setTimeout(()=>this.attemptReconnect(r).finally(()=>this.reconnectTimeout=void 0),a)},this.waitForRestarted=()=>new Promise((i,r)=>{this.pcState===We.Connected&&i();const s=()=>{this.off(F.Disconnected,o),i()},o=()=>{this.off(F.Restarted,s),r()};this.once(F.Restarted,s),this.once(F.Disconnected,o)}),this.updateAndEmitDCBufferStatus=i=>{const r=this.isBufferStatusLow(i);typeof r<"u"&&r!==this.dcBufferStatus.get(i)&&(this.dcBufferStatus.set(i,r),this.emit(F.DCBufferStatusChanged,r,i))},this.isBufferStatusLow=i=>{const r=this.dataChannelForKind(i);if(r)return r.bufferedAmount<=r.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===te.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(Jt.RR_SIGNAL_DISCONNECTED))},this.log=ft((n=e.loggerName)!==null&&n!==void 0?n:Je.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new va(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.registerOnLineListener(),this.closingLock=new Re,this.dataProcessLock=new Re,this.dcBufferStatus=new Map([[ee.LOSSY,!0],[ee.RELIABLE,!0]]),this.client.onParticipantUpdate=i=>this.emit(F.ParticipantUpdate,i),this.client.onConnectionQuality=i=>this.emit(F.ConnectionQualityUpdate,i),this.client.onRoomUpdate=i=>this.emit(F.RoomUpdate,i),this.client.onSubscriptionError=i=>this.emit(F.SubscriptionError,i),this.client.onSubscriptionPermissionUpdate=i=>this.emit(F.SubscriptionPermissionUpdate,i),this.client.onSpeakersChanged=i=>this.emit(F.SpeakersChanged,i),this.client.onStreamStateUpdate=i=>this.emit(F.StreamStateChanged,i),this.client.onRequestResponse=i=>this.emit(F.SignalRequestResponse,i)}get logContext(){var e,n,i,r,s,o,a,c;return{room:(n=(e=this.latestJoinResponse)===null||e===void 0?void 0:e.room)===null||n===void 0?void 0:n.name,roomID:(r=(i=this.latestJoinResponse)===null||i===void 0?void 0:i.room)===null||r===void 0?void 0:r.sid,participant:(o=(s=this.latestJoinResponse)===null||s===void 0?void 0:s.participant)===null||o===void 0?void 0:o.identity,pID:(c=(a=this.latestJoinResponse)===null||a===void 0?void 0:a.participant)===null||c===void 0?void 0:c.sid}}join(e,n,i,r){return S(this,void 0,void 0,function*(){this.url=e,this.token=n,this.signalOpts=i,this.maxJoinAttempts=i.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const s=yield this.client.join(e,n,i,r);return this._isClosed=!1,this.latestJoinResponse=s,this.subscriberPrimary=s.subscriberPrimary,this.pcManager||(yield this.configure(s)),(!this.subscriberPrimary||s.fastPublish)&&this.negotiate(),this.clientConfiguration=s.clientConfiguration,s}catch(s){if(s instanceof X&&s.reason===ye.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(e,n,i,r);throw s}})}close(){return S(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed){e();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(F.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){return S(this,void 0,void 0,function*(){var e;yield(e=this.pcManager)===null||e===void 0?void 0:e.close(),this.pcManager=void 0;const n=i=>{i&&(i.close(),i.onbufferedamountlow=null,i.onclose=null,i.onclosing=null,i.onerror=null,i.onmessage=null,i.onopen=null)};n(this.lossyDC),n(this.lossyDCSub),n(this.reliableDC),n(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0})}cleanupClient(){return S(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new rt("a track with the same ID has already been published");return new Promise((n,i)=>{const r=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],i(new X("publication of local track timed out, no response from server"))},1e4);this.pendingTrackResolvers[e.cid]={resolve:s=>{clearTimeout(r),n(s)},reject:()=>{clearTimeout(r),i(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:n}=this.pendingTrackResolvers[e.track.id];n&&n(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(n){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:n}))}return!1}updateMuteStatus(e,n){this.client.sendMuteTrack(e,n)}get dataSubscriberReadyState(){var e;return(e=this.reliableDCSub)===null||e===void 0?void 0:e.readyState}getConnectedServerAddress(){return S(this,void 0,void 0,function*(){var e;return(e=this.pcManager)===null||e===void 0?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){return S(this,void 0,void 0,function*(){var n,i;if(this.pcManager&&this.pcManager.currentState!==se.NEW)return;this.participantSid=(n=e.participant)===null||n===void 0?void 0:n.sid;const r=this.makeRTCConfiguration(e);this.pcManager=new uC(r,e.subscriberPrimary,this.loggerOptions),this.emit(F.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(s,o)=>{this.client.sendIceCandidate(s,o)},this.pcManager.onPublisherOffer=s=>{this.client.sendOffer(s)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(s,o,a)=>S(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(s),this.logContext),["closed","disconnected","failed"].includes(o)&&(this.publisherConnectionPromise=void 0),s===se.CONNECTED){const u=this.pcState===We.New;this.pcState=We.Connected,u&&this.emit(F.Connected,e)}else s===se.FAILED&&this.pcState===We.Connected&&(this.pcState=We.Disconnected,this.handleDisconnect("peerconnection failed",a==="failed"?Jt.RR_SUBSCRIBER_FAILED:Jt.RR_PUBLISHER_FAILED));const c=this.client.isDisconnected||this.client.currentState===te.RECONNECTING,l=[se.FAILED,se.CLOSING,se.CLOSED].includes(s);c&&l&&!this._isClosed&&this.emit(F.Offline)}),this.pcManager.onTrack=s=>{this.emit(F.MediaTrackAdded,s.track,s.streams[0],s.receiver)},EC((i=e.serverInfo)===null||i===void 0?void 0:i.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=e=>S(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type})),yield this.pcManager.setPublisherAnswer(e))}),this.client.onTrickle=(e,n)=>{this.pcManager&&(this.log.trace("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:n})),this.pcManager.addIceCandidate(e,n))},this.client.onOffer=e=>S(this,void 0,void 0,function*(){if(!this.pcManager)return;const n=yield this.pcManager.createSubscriberAnswerFromOffer(e);this.client.sendAnswer(n)}),this.client.onLocalTrackPublished=e=>{var n;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:(n=e.track)===null||n===void 0?void 0:n.sid})),!this.pendingTrackResolvers[e.cid]){this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));return}const{resolve:i}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],i(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(F.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(F.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{this.token=e},this.client.onRemoteMuteChanged=(e,n)=>{this.emit(F.RemoteMute,e,n)},this.client.onSubscribedQualityUpdate=e=>{this.emit(F.SubscribedQualityUpdate,e)},this.client.onClose=()=>{this.handleDisconnect("signal",Jt.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:e==null?void 0:e.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions(e.regions)),e.action){case tn.DISCONNECT:this.emit(F.Disconnected,e==null?void 0:e.reason),this.close();break;case tn.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(xs);break;case tn.RESUME:this.handleDisconnect(xs)}}}makeRTCConfiguration(e){var n;const i=Object.assign({},this.rtcConfig);if(!((n=this.signalOpts)===null||n===void 0)&&n.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),i.encodedInsertableStreams=!0),e.iceServers&&!i.iceServers){const r=[];e.iceServers.forEach(s=>{const o={urls:s.urls};s.username&&(o.username=s.username),s.credential&&(o.credential=s.credential),r.push(o)}),i.iceServers=r}return e.clientConfiguration&&e.clientConfiguration.forceRelay===ei.ENABLED&&(i.iceTransportPolicy="relay"),i.sdpSemantics="unified-plan",i.continualGatheringPolicy="gather_continually",i}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(Pl,{ordered:!0,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(xl,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender(e,n,i){return S(this,void 0,void 0,function*(){if(ao())return yield this.createTransceiverRTCRtpSender(e,n,i);if(co())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(e.mediaStreamTrack);throw new ce("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,n,i,r){return S(this,void 0,void 0,function*(){if(ao())return this.createSimulcastTransceiverSender(e,n,i,r);if(co())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new ce("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,n,i){return S(this,void 0,void 0,function*(){if(!this.pcManager)throw new ce("publisher is closed");const r=[];e.mediaStream&&r.push(e.mediaStream),e instanceof ve&&(e.codec=n.videoCodec);const s={direction:"sendonly",streams:r};return i&&(s.sendEncodings=i),(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,s)).sender})}createSimulcastTransceiverSender(e,n,i,r){return S(this,void 0,void 0,function*(){if(!this.pcManager)throw new ce("publisher is closed");const s={direction:"sendonly"};r&&(s.sendEncodings=r);const o=yield this.pcManager.addPublisherTransceiver(n.mediaStreamTrack,s);if(i.videoCodec)return e.setSimulcastTrackSender(i.videoCodec,o.sender),o.sender})}createRTCRtpSender(e){return S(this,void 0,void 0,function*(){if(!this.pcManager)throw new ce("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){return S(this,void 0,void 0,function*(){var n,i,r;if(!this._isClosed){if(this.attemptingReconnect){V.warn("already attempting reconnect, returning early",this.logContext);return}(((n=this.clientConfiguration)===null||n===void 0?void 0:n.resumeConnection)===ei.DISABLED||((r=(i=this.pcManager)===null||i===void 0?void 0:i.currentState)!==null&&r!==void 0?r:se.NEW)===se.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(s){this.reconnectAttempts+=1;let o=!0;s instanceof ce?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:s})),o=!1):s instanceof Yt||(this.fullReconnectOnNext=!0),o?this.handleDisconnect("reconnect",Jt.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(F.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(n){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:n}))}return null}restartConnection(e){return S(this,void 0,void 0,function*(){var n,i,r;try{if(!this.url||!this.token)throw new ce("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(F.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let s;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new Yt;s=yield this.join(e??this.url,this.token,this.signalOpts)}catch(o){throw o instanceof X&&o.reason===ye.NotAllowed?new ce("could not reconnect, token might be expired"):new Yt}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(F.SignalRestarted,s),yield this.waitForPCReconnected(),this.client.currentState!==te.CONNECTED)throw new Yt("Signal connection got severed during reconnect");(n=this.regionUrlProvider)===null||n===void 0||n.resetAttempts(),this.emit(F.Restarted)}catch(s){const o=yield(i=this.regionUrlProvider)===null||i===void 0?void 0:i.getNextBestRegionUrl();if(o){yield this.restartConnection(o);return}else throw(r=this.regionUrlProvider)===null||r===void 0||r.resetAttempts(),s}})}resumeConnection(e){return S(this,void 0,void 0,function*(){var n;if(!this.url||!this.token)throw new ce("could not reconnect, url or token not saved");if(!this.pcManager)throw new ce("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(F.Resuming);let i;try{this.setupSignalClientCallbacks(),i=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(r){let s="";throw r instanceof Error&&(s=r.message,this.log.error(r.message,Object.assign(Object.assign({},this.logContext),{error:r}))),r instanceof X&&r.reason===ye.NotAllowed?new ce("could not reconnect, token might be expired"):r instanceof X&&r.reason===ye.LeaveRequest?r:new Yt(s)}if(this.emit(F.SignalResumed),i){const r=this.makeRTCConfiguration(i);this.pcManager.updateConfiguration(r)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==te.CONNECTED)throw new Yt("Signal connection got severed during reconnect");this.client.setReconnected(),((n=this.reliableDC)===null||n===void 0?void 0:n.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),this.emit(F.Resumed)})}waitForPCInitialConnection(e,n){return S(this,void 0,void 0,function*(){if(!this.pcManager)throw new ce("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(n,e)})}waitForPCReconnected(){return S(this,void 0,void 0,function*(){this.pcState=We.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield st(CC),!this.pcManager)throw new ce("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=We.Connected}catch(e){throw this.pcState=We.Disconnected,new X("could not establish PC connection, ".concat(e.message))}})}sendDataPacket(e,n){return S(this,void 0,void 0,function*(){const i=e.toBinary();yield this.ensurePublisherConnected(n);const r=this.dataChannelForKind(n);r&&r.send(i),this.updateAndEmitDCBufferStatus(n)})}ensureDataTransportConnected(e){return S(this,arguments,void 0,function(n){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return function*(){var s;if(!i.pcManager)throw new ce("PC manager is closed");const o=r?i.pcManager.subscriber:i.pcManager.publisher,a=r?"Subscriber":"Publisher";if(!o)throw new X("".concat(a," connection not set"));let c=!1;!r&&!i.dataChannelForKind(n,r)&&(i.createDataChannels(),c=!0),!c&&!r&&!i.pcManager.publisher.isICEConnected&&i.pcManager.publisher.getICEConnectionState()!=="checking"&&(c=!0),c&&i.negotiate();const l=i.dataChannelForKind(n,r);if((l==null?void 0:l.readyState)==="open")return;const u=new Date().getTime()+i.peerConnectionTimeout;for(;new Date().getTime()<u;){if(o.isICEConnected&&((s=i.dataChannelForKind(n,r))===null||s===void 0?void 0:s.readyState)==="open")return;yield st(50)}throw new X("could not establish ".concat(a," connection, state: ").concat(o.getICEConnectionState()))}()})}ensurePublisherConnected(e){return S(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==se.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return S(this,void 0,void 0,function*(){return new Promise((e,n)=>S(this,void 0,void 0,function*(){if(!this.pcManager){n(new io("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const i=new AbortController,r=()=>{i.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&n("cannot negotiate on closed engine"),this.on(F.Closing,r),this.pcManager.publisher.once(sn.RTPVideoPayloadTypes,s=>{const o=new Map;s.forEach(a=>{const c=a.codec.toLowerCase();HS(c)&&o.set(a.payload,c)}),this.emit(F.RTPVideoMapUpdate,o)});try{yield this.pcManager.negotiate(i),e()}catch(s){s instanceof io&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",Jt.RR_UNKNOWN),n(s)}finally{this.off(F.Closing,r)}}))})}dataChannelForKind(e,n){if(n){if(e===ee.LOSSY)return this.lossyDCSub;if(e===ee.RELIABLE)return this.reliableDCSub}else{if(e===ee.LOSSY)return this.lossyDC;if(e===ee.RELIABLE)return this.reliableDC}}sendSyncState(e,n){var i,r;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const s=this.pcManager.subscriber.getLocalDescription(),o=this.pcManager.subscriber.getRemoteDescription(),a=(r=(i=this.signalOpts)===null||i===void 0?void 0:i.autoSubscribe)!==null&&r!==void 0?r:!0,c=new Array,l=new Array;e.forEach(u=>{u.isDesired!==a&&c.push(u.trackSid),u.isEnabled||l.push(u.trackSid)}),this.client.sendSyncState(new uh({answer:s?Zi({sdp:s.sdp,type:s.type}):void 0,offer:o?Zi({sdp:o.sdp,type:o.type}):void 0,subscription:new Ur({trackSids:c,subscribe:!a,participantTracks:[]}),publishTracks:AS(n),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:l}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],n=(i,r)=>{(i==null?void 0:i.id)!==void 0&&i.id!==null&&e.push(new dh({label:i.label,id:i.id,target:r}))};return n(this.dataChannelForKind(ee.LOSSY),ze.PUBLISHER),n(this.dataChannelForKind(ee.RELIABLE),ze.PUBLISHER),n(this.dataChannelForKind(ee.LOSSY,!0),ze.SUBSCRIBER),n(this.dataChannelForKind(ee.RELIABLE,!0),ze.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&me.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){Oe()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){Oe()&&window.removeEventListener("online",this.handleBrowserOnLine)}}class Yt extends Error{}function EC(t){return t!==void 0&&t>13}function wC(t,e){const n=t.participantIdentity?t.participantIdentity:e.participantIdentity;t.participantIdentity=n,e.participantIdentity=n;const i=t.destinationIdentities.length!==0?t.destinationIdentities:e.destinationIdentities;t.destinationIdentities=i,e.destinationIdentities=i}class Rl{constructor(e,n){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=n}updateToken(e){this.token=e}isCloud(){return uo(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(e){return S(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(e));const n=this.regionSettings.regions.filter(i=>!this.attemptedRegions.find(r=>r.url===i.url));if(n.length>0){const i=n[0];return this.attemptedRegions.push(i),V.debug("next region: ".concat(i.region)),i.url}else return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(e){return S(this,void 0,void 0,function*(){const n=yield fetch("".concat(PC(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:e});if(n.ok){const i=yield n.json();return this.lastUpdateAt=Date.now(),i}else throw new X("Could not fetch region settings: ".concat(n.statusText),n.status===401?ye.NotAllowed:void 0,n.status)})}setServerReportedRegions(e){this.regionSettings=e,this.lastUpdateAt=Date.now()}}function PC(t){return"".concat(t.protocol.replace("ws","http"),"//").concat(t.host,"/settings")}class re extends Error{constructor(e,n,i){super(n),this.code=e,this.message=Dl(n,re.MAX_MESSAGE_BYTES),this.data=i?Dl(i,re.MAX_DATA_BYTES):void 0}static fromProto(e){return new re(e.code,e.message,e.data)}toProto(){return new Qd({code:this.code,message:this.message,data:this.data})}static builtIn(e,n){return new re(re.ErrorCode[e],re.ErrorMessage[e],n)}}re.MAX_MESSAGE_BYTES=256;re.MAX_DATA_BYTES=15360;re.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404};re.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const Il=15360;function mo(t){return new TextEncoder().encode(t).length}function Dl(t,e){if(mo(t)<=e)return t;let n=0,i=t.length;const r=new TextEncoder;for(;n<i;){const s=Math.floor((n+i+1)/2);r.encode(t.slice(0,s)).length<=e?n=s:i=s-1}return t.slice(0,n)}class sf extends P{constructor(e,n,i,r,s){super(e,i,s),this.sid=n,this.receiver=r}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?U.Muted:U.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const n=i=>{i.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",n),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(U.Ended,this))};e.addEventListener("removetrack",n)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return S(this,void 0,void 0,function*(){var e;return!((e=this.receiver)===null||e===void 0)&&e.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),ya)),NS()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var n;this.timeSyncHandle=requestAnimationFrame(()=>e());const i=(n=this.receiver)===null||n===void 0?void 0:n.getSynchronizationSources()[0];if(i){const{timestamp:r,rtpTimestamp:s}=i;s&&this.rtpTimestamp!==s&&(this.emit(U.TimeSyncUpdate,{timestamp:r,rtpTimestamp:s}),this.rtpTimestamp=s)}};e()}}class on extends sf{constructor(e,n,i,r,s,o){super(e,n,P.Kind.Audio,i,o),this.monitorReceiver=()=>S(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const a=yield this.getReceiverStats();a&&this.prevStats&&this.receiver&&(this._currentBitrate=Vr(a,this.prevStats)),this.prevStats=a}),this.audioContext=r,this.webAudioPluginNodes=[],s&&(this.sinkId=s.deviceId)}setVolume(e){var n;for(const i of this.attachedElements)this.audioContext?(n=this.gainNode)===null||n===void 0||n.gain.setTargetAtTime(e,0,.1):i.volume=e;mt()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(mt())return 1;let e=0;return this.attachedElements.forEach(n=>{n.volume>e&&(e=n.volume)}),e}setSinkId(e){return S(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(n=>{if(lo(n))return n.setSinkId(e)}))})}attach(e){const n=this.attachedElements.length===0;return e?super.attach(e):e=super.attach(),this.sinkId&&lo(e)&&e.setSinkId(this.sinkId),this.audioContext&&n&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let n;return e?(n=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(n=super.detach(),this.disconnectWebAudio()),n}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,n){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(n.srcObject);let i=this.sourceNode;this.webAudioPluginNodes.forEach(r=>{i.connect(r),i=r}),this.gainNode=e.createGain(),i.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),e.state!=="running"&&e.resume().then(()=>{e.state!=="running"&&this.emit(U.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(r=>{this.emit(U.AudioPlaybackFailed,r)})}disconnectWebAudio(){var e,n;(e=this.gainNode)===null||e===void 0||e.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return S(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let n;return e.forEach(i=>{i.type==="inbound-rtp"&&(n={type:"audio",timestamp:i.timestamp,jitter:i.jitter,bytesReceived:i.bytesReceived,concealedSamples:i.concealedSamples,concealmentEvents:i.concealmentEvents,silentConcealedSamples:i.silentConcealedSamples,silentConcealmentEvents:i.silentConcealmentEvents,totalAudioEnergy:i.totalAudioEnergy,totalSamplesDuration:i.totalSamplesDuration})}),n})}}const Rs=100;class qn extends sf{constructor(e,n,i,r,s){super(e,n,P.Kind.Video,i,s),this.elementInfos=[],this.monitorReceiver=()=>S(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const o=yield this.getReceiverStats();o&&this.prevStats&&this.receiver&&(this._currentBitrate=Vr(o,this.prevStats)),this.prevStats=o}),this.debouncedHandleResize=ma(()=>{this.updateDimensions()},Rs),this.adaptiveStreamSettings=r}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(n=>{e?rn(this._mediaStreamTrack,n):Zt(this._mediaStreamTrack,n)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(n=>n.element===e)===void 0){const n=new xC(e);this.observeElementInfo(n)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&this.elementInfos.find(n=>n===e)===void 0?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const n=this.elementInfos.filter(i=>i===e);for(const i of n)i.stopObserving();this.elementInfos=this.elementInfos.filter(i=>i!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let n=[];if(e)return this.stopObservingElement(e),super.detach(e);n=super.detach();for(const i of n)this.stopObservingElement(i);return n}getDecoderImplementation(){var e;return(e=this.prevStats)===null||e===void 0?void 0:e.decoderImplementation}getReceiverStats(){return S(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let n,i="",r=new Map;return e.forEach(s=>{s.type==="inbound-rtp"?(i=s.codecId,n={type:"video",framesDecoded:s.framesDecoded,framesDropped:s.framesDropped,framesReceived:s.framesReceived,packetsReceived:s.packetsReceived,packetsLost:s.packetsLost,frameWidth:s.frameWidth,frameHeight:s.frameHeight,pliCount:s.pliCount,firCount:s.firCount,nackCount:s.nackCount,jitter:s.jitter,timestamp:s.timestamp,bytesReceived:s.bytesReceived,decoderImplementation:s.decoderImplementation}):s.type==="codec"&&r.set(s.id,s)}),n&&i!==""&&r.get(i)&&(n.mimeType=r.get(i).mimeType),n})}stopObservingElement(e){const n=this.elementInfos.filter(i=>i.element===e);for(const i of n)this.stopObservingElementInfo(i)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return S(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(){var e,n;const i=this.elementInfos.reduce((a,c)=>Math.max(a,c.visibilityChangedAt||0),0),r=!((n=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pauseVideoInBackground)!==null&&n!==void 0)||n?this.isInBackground:!1,s=this.elementInfos.some(a=>a.pictureInPicture),o=this.elementInfos.some(a=>a.visible)&&!r||s;if(this.lastVisible!==o){if(!o&&Date.now()-i<Rs){me.setTimeout(()=>{this.updateVisibility()},Rs);return}this.lastVisible=o,this.emit(U.VisibilityChanged,o,this)}}updateDimensions(){var e,n;let i=0,r=0;const s=this.getPixelDensity();for(const o of this.elementInfos){const a=o.width()*s,c=o.height()*s;a+c>i+r&&(i=a,r=c)}((e=this.lastDimensions)===null||e===void 0?void 0:e.width)===i&&((n=this.lastDimensions)===null||n===void 0?void 0:n.height)===r||(this.lastDimensions={width:i,height:r},this.emit(U.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const n=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pixelDensity;return n==="screen"?ul():n||(ul()>2?2:1)}}class xC{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,n){this.onVisibilityChanged=i=>{var r;const{target:s,isIntersecting:o}=i;s===this.element&&(this.isIntersecting=o,this.visibilityChangedAt=Date.now(),(r=this.handleVisibilityChanged)===null||r===void 0||r.call(this))},this.onEnterPiP=()=>{var i;this.isPiP=!0,(i=this.handleVisibilityChanged)===null||i===void 0||i.call(this)},this.onLeavePiP=()=>{var i;this.isPiP=!1,(i=this.handleVisibilityChanged)===null||i===void 0||i.call(this)},this.element=e,this.isIntersecting=n??Ol(e),this.isPiP=Oe()&&document.pictureInPictureElement===e,this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){this.isIntersecting=Ol(this.element),this.isPiP=document.pictureInPictureElement===this.element,this.element.handleResize=()=>{var e;(e=this.handleResize)===null||e===void 0||e.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,hl().observe(this.element),dl().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP)}stopObserving(){var e,n;(e=hl())===null||e===void 0||e.unobserve(this.element),(n=dl())===null||n===void 0||n.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP)}}function Ol(t){let e=t.offsetTop,n=t.offsetLeft;const i=t.offsetWidth,r=t.offsetHeight,{hidden:s}=t,{opacity:o,display:a}=getComputedStyle(t);for(;t.offsetParent;)t=t.offsetParent,e+=t.offsetTop,n+=t.offsetLeft;return e<window.pageYOffset+window.innerHeight&&n<window.pageXOffset+window.innerWidth&&e+r>window.pageYOffset&&n+i>window.pageXOffset&&!s&&(o!==""?parseFloat(o)>0:!0)&&a!=="none"}class ut extends at.EventEmitter{constructor(e,n,i,r){var s;super(),this.metadataMuted=!1,this.encryption=Le.NONE,this.log=V,this.handleMuted=()=>{this.emit(U.Muted)},this.handleUnmuted=()=>{this.emit(U.Unmuted)},this.log=ft((s=r==null?void 0:r.loggerName)!==null&&s!==void 0?s:Je.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=n,this.trackName=i,this.source=P.Source.Unknown}setTrack(e){this.track&&(this.track.off(U.Muted,this.handleMuted),this.track.off(U.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(U.Muted,this.handleMuted),e.on(U.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),Y(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==Le.NONE}get audioTrack(){if(this.track instanceof he||this.track instanceof on)return this.track}get videoTrack(){if(this.track instanceof ve||this.track instanceof qn)return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=P.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===P.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}(function(t){(function(e){e.Desired="desired",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed"})(t.SubscriptionStatus||(t.SubscriptionStatus={})),function(e){e.Allowed="allowed",e.NotAllowed="not_allowed"}(t.PermissionStatus||(t.PermissionStatus={}))})(ut||(ut={}));class ri extends ut{get isUpstreamPaused(){var e;return(e=this.track)===null||e===void 0?void 0:e.isUpstreamPaused}constructor(e,n,i,r){super(e,n.sid,n.name,r),this.track=void 0,this.handleTrackEnded=()=>{this.emit(U.Ended)},this.updateInfo(n),this.setTrack(i)}setTrack(e){this.track&&this.track.off(U.Ended,this.handleTrackEnded),super.setTrack(e),e&&e.on(U.Ended,this.handleTrackEnded)}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}mute(){return S(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.mute()})}unmute(){return S(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.unmute()})}pauseUpstream(){return S(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.pauseUpstream()})}resumeUpstream(){return S(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.resumeUpstream()})}getTrackFeatures(){var e;if(this.track instanceof he){const n=this.track.mediaStreamTrack.getSettings(),i=new Set;return n.autoGainControl&&i.add(it.TF_AUTO_GAIN_CONTROL),n.echoCancellation&&i.add(it.TF_ECHO_CANCELLATION),n.noiseSuppression&&i.add(it.TF_NOISE_SUPPRESSION),n.channelCount&&n.channelCount>1&&i.add(it.TF_STEREO),!((e=this.options)===null||e===void 0)&&e.dtx||i.add(it.TF_NO_DTX),this.track.enhancedNoiseCancellation&&i.add(it.TF_ENHANCED_NOISE_CANCELLATION),Array.from(i.values())}else return[]}}function of(t){let e,n;return typeof t.audio=="object"&&t.audio.processor&&(e=t.audio.processor),typeof t.video=="object"&&t.video.processor&&(n=t.video.processor),{audioProcessor:e,videoProcessor:n}}function af(t){return S(this,void 0,void 0,function*(){var e,n;t??(t={}),(e=t.audio)!==null&&e!==void 0||(t.audio=!0),(n=t.video)!==null&&n!==void 0||(t.video=!0);const{audioProcessor:i,videoProcessor:r}=of(t),s=Hh(t,Zh,ef),o=jr(s),a=navigator.mediaDevices.getUserMedia(o);t.audio&&(fe.userMediaPromiseMap.set("audioinput",a),a.catch(()=>fe.userMediaPromiseMap.delete("audioinput"))),t.video&&(fe.userMediaPromiseMap.set("videoinput",a),a.catch(()=>fe.userMediaPromiseMap.delete("videoinput")));const c=yield a;return Promise.all(c.getTracks().map(l=>S(this,void 0,void 0,function*(){const u=l.kind==="audio";u?s.audio:s.video;let d;const h=u?o.audio:o.video;typeof h!="boolean"&&(d=h),d?d.deviceId=l.getSettings().deviceId:d={deviceId:l.getSettings().deviceId};const f=tf(l,d);return f.kind===P.Kind.Video?f.source=P.Source.Camera:f.kind===P.Kind.Audio&&(f.source=P.Source.Microphone),f.mediaStream=c,f instanceof he&&i?yield f.setProcessor(i):f instanceof ve&&r&&(yield f.setProcessor(r)),f})))})}function RC(t){return S(this,void 0,void 0,function*(){return(yield af({audio:!1,video:t}))[0]})}function IC(t){return S(this,void 0,void 0,function*(){return(yield af({audio:t,video:!1}))[0]})}var Ue;(function(t){t.Excellent="excellent",t.Good="good",t.Poor="poor",t.Lost="lost",t.Unknown="unknown"})(Ue||(Ue={}));function DC(t){switch(t){case Un.EXCELLENT:return Ue.Excellent;case Un.GOOD:return Ue.Good;case Un.POOR:return Ue.Poor;case Un.LOST:return Ue.Lost;default:return Ue.Unknown}}class cf extends at.EventEmitter{get logContext(){var e,n;return Object.assign({},(n=(e=this.loggerOptions)===null||e===void 0?void 0:e.loggerContextCb)===null||n===void 0?void 0:n.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(e=>e.isEncrypted)}get isAgent(){var e;return((e=this.permissions)===null||e===void 0?void 0:e.agent)||this.kind===Xi.AGENT}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,n,i,r,s){let o=arguments.length>5&&arguments[5]!==void 0?arguments[5]:Xi.STANDARD;var a;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=Ue.Unknown,this.log=V,this.log=ft((a=s==null?void 0:s.loggerName)!==null&&a!==void 0?a:Je.Participant),this.loggerOptions=s,this.setMaxListeners(100),this.sid=e,this.identity=n,this.name=i,this.metadata=r,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=o,this._attributes={}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,n]of this.trackPublications)if(n.source===e)return n}getTrackPublicationByName(e){for(const[,n]of this.trackPublications)if(n.trackName===e)return n}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const n=this.getTrackPublication(P.Source.Camera);return!(!((e=n==null?void 0:n.isMuted)!==null&&e!==void 0)||e)}get isMicrophoneEnabled(){var e;const n=this.getTrackPublication(P.Source.Microphone);return!(!((e=n==null?void 0:n.isMuted)!==null&&e!==void 0)||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(P.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(e){return this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version?!1:(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,this.log.trace("update participant info",Object.assign(Object.assign({},this.logContext),{info:e})),!0)}_setMetadata(e){const n=this.metadata!==e,i=this.metadata;this.metadata=e,n&&this.emit(D.ParticipantMetadataChanged,i)}_setName(e){const n=this.name!==e;this.name=e,n&&this.emit(D.ParticipantNameChanged,e)}_setAttributes(e){const n=MS(this.attributes,e);this._attributes=e,Object.keys(n).length>0&&this.emit(D.AttributesChanged,n)}setPermissions(e){var n,i,r,s,o,a;const c=this.permissions,l=e.canPublish!==((n=this.permissions)===null||n===void 0?void 0:n.canPublish)||e.canSubscribe!==((i=this.permissions)===null||i===void 0?void 0:i.canSubscribe)||e.canPublishData!==((r=this.permissions)===null||r===void 0?void 0:r.canPublishData)||e.hidden!==((s=this.permissions)===null||s===void 0?void 0:s.hidden)||e.recorder!==((o=this.permissions)===null||o===void 0?void 0:o.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((u,d)=>{var h;return u!==((h=this.permissions)===null||h===void 0?void 0:h.canPublishSources[d])})||e.canSubscribeMetrics!==((a=this.permissions)===null||a===void 0?void 0:a.canSubscribeMetrics);return this.permissions=e,l&&this.emit(D.ParticipantPermissionsChanged,c),l}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(D.IsSpeakingChanged,e))}setConnectionQuality(e){const n=this._connectionQuality;this._connectionQuality=DC(e),n!==this._connectionQuality&&this.emit(D.ConnectionQualityChanged,this._connectionQuality)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach(n=>(n.track instanceof on||n.track instanceof he)&&n.track.setAudioContext(e))}addTrackPublication(e){e.on(U.Muted,()=>{this.emit(D.TrackMuted,e)}),e.on(U.Unmuted,()=>{this.emit(D.TrackUnmuted,e)});const n=e;switch(n.track&&(n.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case P.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case P.Kind.Video:this.videoTrackPublications.set(e.trackSid,e);break}}}function OC(t){var e,n,i;if(!t.participantSid&&!t.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new ch({participantIdentity:(e=t.participantIdentity)!==null&&e!==void 0?e:"",participantSid:(n=t.participantSid)!==null&&n!==void 0?n:"",allTracks:(i=t.allowAll)!==null&&i!==void 0?i:!1,trackSids:t.allowedTrackSids||[]})}class si extends cf{constructor(e,n,i,r){super(e,n,void 0,void 0,{loggerName:r.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=Le.NONE,this.enabledPublishVideoCodecs=[],this.rpcHandlers=new Map,this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Qh)},this.handleReconnected=()=>{var s,o;(o=(s=this.reconnectFuture)===null||s===void 0?void 0:s.resolve)===null||o===void 0||o.call(s),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleDisconnected=()=>{var s,o;this.reconnectFuture&&(this.reconnectFuture.promise.catch(a=>this.log.warn(a.message,this.logContext)),(o=(s=this.reconnectFuture)===null||s===void 0?void 0:s.reject)===null||o===void 0||o.call(s,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0)},this.handleSignalRequestResponse=s=>{const{requestId:o,reason:a,message:c}=s,l=this.pendingSignalRequests.get(o);l&&(a!==fh.OK&&l.reject(new ol(c,a)),this.pendingSignalRequests.delete(o))},this.handleDataPacket=s=>{switch(s.value.case){case"rpcRequest":let o=s.value.value;this.handleIncomingRpcRequest(s.participantIdentity,o.id,o.method,o.payload,o.responseTimeoutMs,o.version);break;case"rpcResponse":let a=s.value.value,c=null,l=null;a.value.case==="payload"?c=a.value.value:a.value.case==="error"&&(l=re.fromProto(a.value.value)),this.handleIncomingRpcResponse(a.requestId,c,l);break;case"rpcAck":let u=s.value.value;this.handleIncomingRpcAck(u.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(s=>OC(s)))},this.onTrackUnmuted=s=>{this.onTrackMuted(s,s.isUpstreamPaused)},this.onTrackMuted=(s,o)=>{if(o===void 0&&(o=!0),!s.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),Y(s)));return}this.engine.updateMuteStatus(s.sid,o)},this.onTrackUpstreamPaused=s=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),Y(s))),this.onTrackMuted(s,!0)},this.onTrackUpstreamResumed=s=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),Y(s))),this.onTrackMuted(s,s.isMuted)},this.onTrackFeatureUpdate=s=>{const o=this.audioTrackPublications.get(s.sid);if(!o){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(s.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(o.trackSid,o.getTrackFeatures())},this.handleSubscribedQualityUpdate=s=>S(this,void 0,void 0,function*(){var o,a,c,l,u,d;if(!(!((u=this.roomOptions)===null||u===void 0)&&u.dynacast))return;const h=this.videoTrackPublications.get(s.trackSid);if(!h){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:s.trackSid}));return}if(s.subscribedCodecs.length>0){if(!h.videoTrack)return;const b=yield h.videoTrack.setPublishingCodecs(s.subscribedCodecs);try{for(var f=!0,g=Qt(b),m;m=yield g.next(),o=m.done,!o;f=!0){l=m.value,f=!1;const v=l;RS(v)&&(this.log.debug("publish ".concat(v," for ").concat(h.videoTrack.sid),Object.assign(Object.assign({},this.logContext),Y(h))),yield this.publishAdditionalCodecForTrack(h.videoTrack,v,h.options))}}catch(v){a={error:v}}finally{try{!f&&!o&&(c=g.return)&&(yield c.call(g))}finally{if(a)throw a.error}}}else s.subscribedQualities.length>0&&(yield(d=h.videoTrack)===null||d===void 0?void 0:d.setPublishingLayers(s.subscribedQualities))}),this.handleLocalTrackUnpublished=s=>{const o=this.trackPublications.get(s.trackSid);if(!o){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:s.trackSid}));return}this.unpublishTrack(o.track)},this.handleTrackEnded=s=>S(this,void 0,void 0,function*(){if(s.source===P.Source.ScreenShare||s.source===P.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),Y(s))),this.unpublishTrack(s);else if(s.isUserProvided)yield s.mute();else if(s instanceof he||s instanceof ve)try{if(Oe())try{const o=yield navigator==null?void 0:navigator.permissions.query({name:s.source===P.Source.Camera?"camera":"microphone"});if(o&&o.state==="denied")throw this.log.warn("user has revoked access to ".concat(s.source),Object.assign(Object.assign({},this.logContext),Y(s))),o.onchange=()=>{o.state!=="denied"&&(s.isMuted||s.restartTrack(),o.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}s.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),Y(s))),s instanceof he?yield s.restartTrack({deviceId:"default"}):yield s.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),Y(s))),yield s.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=i,this.roomOptions=r,this.setupEngine(i),this.activeDeviceMap=new Map,this.pendingSignalRequests=new Map}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==Le.NONE}getTrackPublication(e){const n=super.getTrackPublication(e);if(n)return n}getTrackPublicationByName(e){const n=super.getTrackPublicationByName(e);if(n)return n}setupEngine(e){this.engine=e,this.engine.on(F.RemoteMute,(n,i)=>{const r=this.trackPublications.get(n);!r||!r.track||(i?r.mute():r.unmute())}),this.engine.on(F.Connected,this.handleReconnected).on(F.SignalRestarted,this.handleReconnected).on(F.SignalResumed,this.handleReconnected).on(F.Restarting,this.handleReconnecting).on(F.Resuming,this.handleReconnecting).on(F.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(F.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(F.Disconnected,this.handleDisconnected).on(F.SignalRequestResponse,this.handleSignalRequestResponse).on(F.DataPacketReceived,this.handleDataPacket)}setMetadata(e){return S(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:e})})}setName(e){return S(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:e})})}setAttributes(e){return S(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:e})})}requestMetadataUpdate(e){return S(this,arguments,void 0,function(n){var i=this;let{metadata:r,name:s,attributes:o}=n;return function*(){return new Promise((a,c)=>S(i,void 0,void 0,function*(){var l,u;try{let d=!1;const h=yield this.engine.client.sendUpdateLocalMetadata((l=r??this.metadata)!==null&&l!==void 0?l:"",(u=s??this.name)!==null&&u!==void 0?u:"",o),f=performance.now();for(this.pendingSignalRequests.set(h,{resolve:a,reject:g=>{c(g),d=!0},values:{name:s,metadata:r,attributes:o}});performance.now()-f<5e3&&!d;){if((!s||this.name===s)&&(!r||this.metadata===r)&&(!o||Object.entries(o).every(g=>{let[m,b]=g;return this.attributes[m]===b||b===""&&!this.attributes[m]}))){this.pendingSignalRequests.delete(h),a();return}yield st(50)}c(new ol("Request to update local metadata timed out","TimeoutError"))}catch(d){d instanceof Error&&c(d)}}))}()})}setCameraEnabled(e,n,i){return this.setTrackEnabled(P.Source.Camera,e,n,i)}setMicrophoneEnabled(e,n,i){return this.setTrackEnabled(P.Source.Microphone,e,n,i)}setScreenShareEnabled(e,n,i){return this.setTrackEnabled(P.Source.ScreenShare,e,n,i)}setPermissions(e){const n=this.permissions,i=super.setPermissions(e);return i&&n&&this.emit(D.ParticipantPermissionsChanged,n),i}setE2EEEnabled(e){return S(this,void 0,void 0,function*(){this.encryptionType=e?Le.GCM:Le.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,n,i,r){return S(this,void 0,void 0,function*(){var s,o;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:n})),this.republishPromise&&(yield this.republishPromise);let a=this.getTrackPublication(e);if(n)if(a)yield a.unmute();else{let c;if(this.pendingPublishing.has(e)){const l=yield this.waitForPendingPublicationOfSource(e);return l||this.log.info("skipping duplicate published source",Object.assign(Object.assign({},this.logContext),{source:e})),yield l==null?void 0:l.unmute(),l}this.pendingPublishing.add(e);try{switch(e){case P.Source.Camera:c=yield this.createTracks({video:(s=i)!==null&&s!==void 0?s:!0});break;case P.Source.Microphone:c=yield this.createTracks({audio:(o=i)!==null&&o!==void 0?o:!0});break;case P.Source.ScreenShare:c=yield this.createScreenTracks(Object.assign({},i));break;default:throw new rt(e)}const l=[];for(const d of c)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),Y(d))),l.push(this.publishTrack(d,r));[a]=yield Promise.all(l)}catch(l){throw c==null||c.forEach(u=>{u.stop()}),l instanceof Error&&!(l instanceof rt)&&this.emit(D.MediaDevicesError,l),l}finally{this.pendingPublishing.delete(e)}}else if(a!=null&&a.track||(a=yield this.waitForPendingPublicationOfSource(e)),a&&a.track)if(e===P.Source.ScreenShare){a=yield this.unpublishTrack(a.track);const c=this.getTrackPublication(P.Source.ScreenShareAudio);c&&c.track&&this.unpublishTrack(c.track)}else yield a.mute();return a})}enableCameraAndMicrophone(){return S(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(P.Source.Camera)||this.pendingPublishing.has(P.Source.Microphone))){this.pendingPublishing.add(P.Source.Camera),this.pendingPublishing.add(P.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(n=>this.publishTrack(n)))}finally{this.pendingPublishing.delete(P.Source.Camera),this.pendingPublishing.delete(P.Source.Microphone)}}})}createTracks(e){return S(this,void 0,void 0,function*(){var n,i;e??(e={});const{audioProcessor:r,videoProcessor:s}=of(e),o=Hh(e,(n=this.roomOptions)===null||n===void 0?void 0:n.audioCaptureDefaults,(i=this.roomOptions)===null||i===void 0?void 0:i.videoCaptureDefaults),a=jr(o);let c;try{c=yield navigator.mediaDevices.getUserMedia(a)}catch(l){throw l instanceof Error&&(a.audio&&(this.microphoneError=l),a.video&&(this.cameraError=l)),l}return a.audio&&(this.microphoneError=void 0,this.emit(D.AudioStreamAcquired)),a.video&&(this.cameraError=void 0),Promise.all(c.getTracks().map(l=>S(this,void 0,void 0,function*(){const u=l.kind==="audio";u?o.audio:o.video;let d;const h=u?a.audio:a.video;typeof h!="boolean"&&(d=h);const f=tf(l,d,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return f.kind===P.Kind.Video?f.source=P.Source.Camera:f.kind===P.Kind.Audio&&(f.source=P.Source.Microphone,f.setAudioContext(this.audioContext)),f.mediaStream=c,f instanceof he&&r?yield f.setProcessor(r):f instanceof ve&&s&&(yield f.setProcessor(s)),f})))})}createScreenTracks(e){return S(this,void 0,void 0,function*(){if(e===void 0&&(e={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new pa("getDisplayMedia not supported");e.resolution===void 0&&!VS()&&(e.resolution=ga.h1080fps30.resolution);const n=_S(e),i=yield navigator.mediaDevices.getDisplayMedia(n),r=i.getVideoTracks();if(r.length===0)throw new rt("no video track found");const s=new ve(r[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});s.source=P.Source.ScreenShare,e.contentHint&&(s.mediaStreamTrack.contentHint=e.contentHint);const o=[s];if(i.getAudioTracks().length>0){this.emit(D.AudioStreamAcquired);const a=new he(i.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});a.source=P.Source.ScreenShareAudio,o.push(a)}return o})}publishTrack(e,n){return S(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(e,n)})}publishOrRepublishTrack(e,n){return S(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return function*(){var a,c,l,u;i instanceof he&&i.setAudioContext(s.audioContext),yield(a=s.reconnectFuture)===null||a===void 0?void 0:a.promise,s.republishPromise&&!o&&(yield s.republishPromise),i instanceof Bt&&s.pendingPublishPromises.has(i)&&(yield s.pendingPublishPromises.get(i));let d;if(i instanceof MediaStreamTrack)d=i.getConstraints();else{d=i.constraints;let v;switch(i.source){case P.Source.Microphone:v="audioinput";break;case P.Source.Camera:v="videoinput"}v&&s.activeDeviceMap.has(v)&&(d=Object.assign(Object.assign({},d),{deviceId:s.activeDeviceMap.get(v)}))}if(i instanceof MediaStreamTrack)switch(i.kind){case"audio":i=new he(i,d,!0,s.audioContext,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;case"video":i=new ve(i,d,!0,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;default:throw new rt("unsupported MediaStreamTrack kind ".concat(i.kind))}else i.updateLoggerOptions({loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});let h;if(s.trackPublications.forEach(v=>{v.track&&v.track===i&&(h=v)}),h)return s.log.warn("track has already been published, skipping",Object.assign(Object.assign({},s.logContext),Y(h))),h;const f="channelCount"in i.mediaStreamTrack.getSettings()&&i.mediaStreamTrack.getSettings().channelCount===2||i.mediaStreamTrack.getConstraints().channelCount===2,g=(c=r==null?void 0:r.forceStereo)!==null&&c!==void 0?c:f;g&&(r||(r={}),r.dtx===void 0&&s.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},s.logContext),Y(i))),r.red===void 0&&s.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(l=r.dtx)!==null&&l!==void 0||(r.dtx=!1),(u=r.red)!==null&&u!==void 0||(r.red=!1));const m=Object.assign(Object.assign({},s.roomOptions.publishDefaults),r);!$S()&&s.roomOptions.e2ee&&(s.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},s.logContext)),m.simulcast=!1),m.source&&(i.source=m.source);const b=s.publish(i,m,g);s.pendingPublishPromises.set(i,b);try{return yield b}catch(v){throw v}finally{s.pendingPublishPromises.delete(i)}}()})}publish(e,n,i){return S(this,void 0,void 0,function*(){var r,s,o,a,c,l,u,d,h,f;Array.from(this.trackPublications.values()).find(y=>e instanceof Bt&&y.source===e.source)&&e.source!==P.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),Y(e))),n.stopMicTrackOnMute&&e instanceof he&&(e.stopOnMute=!0),e.source===P.Source.ScreenShare&&mn()&&(n.simulcast=!1),n.videoCodec==="av1"&&!FS()&&(n.videoCodec=void 0),n.videoCodec==="vp9"&&!BS()&&(n.videoCodec=void 0),n.videoCodec===void 0&&(n.videoCodec=ho),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(y=>n.videoCodec===Bi(y.mime))||(n.videoCodec=Bi(this.enabledPublishVideoCodecs[0].mime)));const m=n.videoCodec;e.on(U.Muted,this.onTrackMuted),e.on(U.Unmuted,this.onTrackUnmuted),e.on(U.Ended,this.handleTrackEnded),e.on(U.UpstreamPaused,this.onTrackUpstreamPaused),e.on(U.UpstreamResumed,this.onTrackUpstreamResumed),e.on(U.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const b=new Ks({cid:e.mediaStreamTrack.id,name:n.name,type:P.kindToProto(e.kind),muted:e.isMuted,source:P.sourceToProto(e.source),disableDtx:!(!((r=n.dtx)!==null&&r!==void 0)||r),encryption:this.encryptionType,stereo:i,disableRed:this.isE2EEEnabled||!(!((s=n.red)!==null&&s!==void 0)||s),stream:n==null?void 0:n.stream});let v;if(e.kind===P.Kind.Video){let y={width:0,height:0};try{y=yield e.waitForDimensions()}catch{const x=(a=(o=this.roomOptions.videoCaptureDefaults)===null||o===void 0?void 0:o.resolution)!==null&&a!==void 0?a:ii.h720.resolution;y={width:x.width,height:x.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),Y(e)),{dims:y}))}b.width=y.width,b.height=y.height,e instanceof ve&&(Gn(m)&&(e.source===P.Source.ScreenShare&&(n.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),Y(e))))),n.scalabilityMode=(c=n.scalabilityMode)!==null&&c!==void 0?c:"L3T3_KEY"),b.simulcastCodecs=[new zs({codec:m,cid:e.mediaStreamTrack.id})],n.backupCodec===!0&&(n.backupCodec={codec:ho}),n.backupCodec&&m!==n.backupCodec.codec&&b.encryption===Le.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),b.simulcastCodecs.push(new zs({codec:n.backupCodec.codec,cid:""})))),v=po(e.source===P.Source.ScreenShare,b.width,b.height,n),b.layers=wl(b.width,b.height,v,Gn(n.videoCodec))}else e.kind===P.Kind.Audio&&(v=[{maxBitrate:(l=n.audioPreset)===null||l===void 0?void 0:l.maxBitrate,priority:(d=(u=n.audioPreset)===null||u===void 0?void 0:u.priority)!==null&&d!==void 0?d:"high",networkPriority:(f=(h=n.audioPreset)===null||h===void 0?void 0:h.priority)!==null&&f!==void 0?f:"high"}]);if(!this.engine||this.engine.isClosed)throw new ce("cannot publish track when not connected");const T=()=>S(this,void 0,void 0,function*(){var y,C,x;if(!this.engine.pcManager)throw new ce("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,n,v),e instanceof ve&&((y=n.degradationPreference)!==null&&y!==void 0||(n.degradationPreference=kC(e)),e.setDegradationPreference(n.degradationPreference)),v)if(mn()&&e.kind===P.Kind.Audio){let _;for(const A of this.engine.pcManager.publisher.getTransceivers())if(A.sender===e.sender){_=A;break}_&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:_,codec:"opus",maxbr:!((C=v[0])===null||C===void 0)&&C.maxBitrate?v[0].maxBitrate/1e3:0})}else e.codec&&Gn(e.codec)&&(!((x=v[0])===null||x===void 0)&&x.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:b.cid,codec:e.codec,maxbr:v[0].maxBitrate/1e3});yield this.engine.negotiate()});let E;if(this.enabledPublishVideoCodecs.length>0)E=(yield Promise.all([this.engine.addTrack(b),T()]))[0];else{E=yield this.engine.addTrack(b);let y;if(E.codecs.forEach(C=>{y===void 0&&(y=C.mimeType)}),y&&e.kind===P.Kind.Video){const C=Bi(y);C!==m&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),Y(e)),{codec:C})),n.videoCodec=C,v=po(e.source===P.Source.ScreenShare,b.width,b.height,n))}yield T()}const k=new ri(e.kind,E,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return k.options=n,e.sid=E.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:v,trackInfo:E})),e instanceof ve?e.startMonitor(this.engine.client):e instanceof he&&e.startMonitor(),this.addTrackPublication(k),this.emit(D.LocalTrackPublished,k),k})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,n,i){return S(this,void 0,void 0,function*(){var r;if(this.encryptionType!==Le.NONE)return;let s;if(this.trackPublications.forEach(f=>{f.track&&f.track===e&&(s=f)}),!s)throw new rt("track is not published");if(!(e instanceof ve))throw new rt("track is not a video track");const o=Object.assign(Object.assign({},(r=this.roomOptions)===null||r===void 0?void 0:r.publishDefaults),i),a=vC(e,n,o);if(!a){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),Y(e)));return}const c=e.addSimulcastTrack(n,a);if(!c)return;const l=new Ks({cid:c.mediaStreamTrack.id,type:P.kindToProto(e.kind),muted:e.isMuted,source:P.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:o.videoCodec,cid:c.mediaStreamTrack.id}]});if(l.layers=wl(l.width,l.height,a),!this.engine||this.engine.isClosed)throw new ce("cannot publish track when not connected");const u=()=>S(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(e,c,o,a),yield this.engine.negotiate()}),h=(yield Promise.all([this.engine.addTrack(l),u()]))[0];this.log.debug("published ".concat(n," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:a,trackInfo:h}))})}unpublishTrack(e,n){return S(this,void 0,void 0,function*(){var i,r;if(e instanceof Bt){const l=this.pendingPublishPromises.get(e);l&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),Y(e))),yield l)}const s=this.getPublicationForTrack(e),o=s?Y(s):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),o)),!s||!s.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),o));return}e=s.track,e.off(U.Muted,this.onTrackMuted),e.off(U.Unmuted,this.onTrackUnmuted),e.off(U.Ended,this.handleTrackEnded),e.off(U.UpstreamPaused,this.onTrackUpstreamPaused),e.off(U.UpstreamResumed,this.onTrackUpstreamResumed),e.off(U.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),n===void 0&&(n=(r=(i=this.roomOptions)===null||i===void 0?void 0:i.stopLocalTrackOnUnpublish)!==null&&r!==void 0?r:!0),n&&e.stop();let a=!1;const c=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<se.FAILED&&c)try{for(const l of this.engine.pcManager.publisher.getTransceivers())l.sender===c&&(l.direction="inactive",a=!0);if(this.engine.removeTrack(c)&&(a=!0),e instanceof ve){for(const[,l]of e.simulcastCodecs)l.sender&&(this.engine.removeTrack(l.sender)&&(a=!0),l.sender=void 0);e.simulcastCodecs.clear()}}catch(l){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),o),{error:l}))}switch(this.trackPublications.delete(s.trackSid),s.kind){case P.Kind.Audio:this.audioTrackPublications.delete(s.trackSid);break;case P.Kind.Video:this.videoTrackPublications.delete(s.trackSid);break}return this.emit(D.LocalTrackUnpublished,s),s.setTrack(void 0),a&&(yield this.engine.negotiate()),s})}unpublishTracks(e){return S(this,void 0,void 0,function*(){return(yield Promise.all(e.map(i=>this.unpublishTrack(i)))).filter(i=>i instanceof ri)})}republishAllTracks(e){return S(this,arguments,void 0,function(n){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){i.republishPromise&&(yield i.republishPromise),i.republishPromise=new Promise((s,o)=>S(i,void 0,void 0,function*(){try{const a=[];this.trackPublications.forEach(c=>{c.track&&(n&&(c.options=Object.assign(Object.assign({},c.options),n)),a.push(c))}),yield Promise.all(a.map(c=>S(this,void 0,void 0,function*(){const l=c.track;yield this.unpublishTrack(l,!1),r&&!l.isMuted&&l.source!==P.Source.ScreenShare&&l.source!==P.Source.ScreenShareAudio&&(l instanceof he||l instanceof ve)&&!l.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:c.trackSid})),yield l.restartTrack()),yield this.publishOrRepublishTrack(l,c.options,!0)}))),s()}catch(a){o(a)}finally{this.republishPromise=void 0}})),yield i.republishPromise}()})}publishData(e){return S(this,arguments,void 0,function(n){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return function*(){const s=r.reliable?ee.RELIABLE:ee.LOSSY,o=r.destinationIdentities,a=r.topic,c=new kt({kind:s,value:{case:"user",value:new Hd({participantIdentity:i.identity,payload:n,destinationIdentities:o,topic:a})}});yield i.engine.sendDataPacket(c,s)}()})}publishDtmf(e,n){return S(this,void 0,void 0,function*(){const i=new kt({kind:ee.RELIABLE,value:{case:"sipDtmf",value:new zd({code:e,digit:n})}});yield this.engine.sendDataPacket(i,ee.RELIABLE)})}sendChatMessage(e){return S(this,void 0,void 0,function*(){const n={id:crypto.randomUUID(),message:e,timestamp:Date.now()},i=new kt({value:{case:"chatMessage",value:new qs(Object.assign(Object.assign({},n),{timestamp:ne.parse(n.timestamp)}))}});return yield this.engine.sendDataPacket(i,ee.RELIABLE),this.emit(D.ChatMessage,n),n})}editChatMessage(e,n){return S(this,void 0,void 0,function*(){const i=Object.assign(Object.assign({},n),{message:e,editTimestamp:Date.now()}),r=new kt({value:{case:"chatMessage",value:new qs(Object.assign(Object.assign({},i),{timestamp:ne.parse(i.timestamp),editTimestamp:ne.parse(i.editTimestamp)}))}});return yield this.engine.sendDataPacket(r,ee.RELIABLE),this.emit(D.ChatMessage,i),i})}performRpc(e){return S(this,arguments,void 0,function(n){var i=this;let{destinationIdentity:r,method:s,payload:o,responseTimeout:a=1e4}=n;return function*(){return new Promise((l,u)=>S(i,void 0,void 0,function*(){var d,h,f,g;if(mo(o)>Il){u(re.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((h=(d=this.engine.latestJoinResponse)===null||d===void 0?void 0:d.serverInfo)===null||h===void 0)&&h.version&&gn((g=(f=this.engine.latestJoinResponse)===null||f===void 0?void 0:f.serverInfo)===null||g===void 0?void 0:g.version,"1.8.0")<0){u(re.builtIn("UNSUPPORTED_SERVER"));return}const m=crypto.randomUUID();yield this.publishRpcRequest(r,m,s,o,a-2e3);const b=setTimeout(()=>{this.pendingAcks.delete(m),u(re.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(m),clearTimeout(v)},2e3);this.pendingAcks.set(m,{resolve:()=>{clearTimeout(b)},participantIdentity:r});const v=setTimeout(()=>{this.pendingResponses.delete(m),u(re.builtIn("RESPONSE_TIMEOUT"))},a);this.pendingResponses.set(m,{resolve:(T,E)=>{clearTimeout(v),this.pendingAcks.has(m)&&(console.warn("RPC response received before ack",m),this.pendingAcks.delete(m),clearTimeout(b)),E?u(E):l(T??"")},participantIdentity:r})}))}()})}registerRpcMethod(e,n){this.rpcHandlers.set(e,n)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setTrackSubscriptionPermissions(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=n,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const n=this.pendingAcks.get(e);n?(n.resolve(),this.pendingAcks.delete(e)):console.error("Ack received for unexpected RPC request",e)}handleIncomingRpcResponse(e,n,i){const r=this.pendingResponses.get(e);r?(r.resolve(n,i),this.pendingResponses.delete(e)):console.error("Response received for unexpected RPC request",e)}handleIncomingRpcRequest(e,n,i,r,s,o){return S(this,void 0,void 0,function*(){if(yield this.publishRpcAck(e,n),o!==1){yield this.publishRpcResponse(e,n,null,re.builtIn("UNSUPPORTED_VERSION"));return}const a=this.rpcHandlers.get(i);if(!a){yield this.publishRpcResponse(e,n,null,re.builtIn("UNSUPPORTED_METHOD"));return}let c=null,l=null;try{const u=yield a({requestId:n,callerIdentity:e,payload:r,responseTimeout:s});mo(u)>Il?(c=re.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),console.warn("RPC Response payload too large for ".concat(i))):l=u}catch(u){u instanceof re?c=u:(console.warn("Uncaught error returned by RPC handler for ".concat(i,". Returning APPLICATION_ERROR instead."),u),c=re.builtIn("APPLICATION_ERROR"))}yield this.publishRpcResponse(e,n,l,c)})}publishRpcRequest(e,n,i,r,s){return S(this,void 0,void 0,function*(){const o=new kt({destinationIdentities:[e],kind:ee.RELIABLE,value:{case:"rpcRequest",value:new Kd({id:n,method:i,payload:r,responseTimeoutMs:s,version:1})}});yield this.engine.sendDataPacket(o,ee.RELIABLE)})}publishRpcResponse(e,n,i,r){return S(this,void 0,void 0,function*(){const s=new kt({destinationIdentities:[e],kind:ee.RELIABLE,value:{case:"rpcResponse",value:new Yd({requestId:n,value:r?{case:"error",value:r.toProto()}:{case:"payload",value:i??""}})}});yield this.engine.sendDataPacket(s,ee.RELIABLE)})}publishRpcAck(e,n){return S(this,void 0,void 0,function*(){const i=new kt({destinationIdentities:[e],kind:ee.RELIABLE,value:{case:"rpcAck",value:new Jd({requestId:n})}});yield this.engine.sendDataPacket(i,ee.RELIABLE)})}handleParticipantDisconnected(e){for(const[n,{participantIdentity:i}]of this.pendingAcks)i===e&&this.pendingAcks.delete(n);for(const[n,{participantIdentity:i,resolve:r}]of this.pendingResponses)i===e&&(r(null,re.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(n))}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter(n=>n.mime.split("/")[0].toLowerCase()==="video")}updateInfo(e){return e.sid!==this.sid||!super.updateInfo(e)?!1:(e.tracks.forEach(n=>{var i,r;const s=this.trackPublications.get(n.sid);if(s){const o=s.isMuted||((r=(i=s.track)===null||i===void 0?void 0:i.isUpstreamPaused)!==null&&r!==void 0?r:!1);o!==n.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),Y(s)),{mutedOnServer:o})),this.engine.client.sendMuteTrack(n.sid,o))}}),!0)}getPublicationForTrack(e){let n;return this.trackPublications.forEach(i=>{const r=i.track;r&&(e instanceof MediaStreamTrack?(r instanceof he||r instanceof ve)&&r.mediaStreamTrack===e&&(n=i):e===r&&(n=i))}),n}waitForPendingPublicationOfSource(e){return S(this,void 0,void 0,function*(){const n=Array.from(this.pendingPublishPromises.entries()).find(i=>{let[r]=i;return r.source===e});if(n)return n[1]})}}class oi extends ut{constructor(e,n,i,r){super(e,n.sid,n.name,r),this.track=void 0,this.allowed=!0,this.disabled=!1,this.currentVideoQuality=Be.HIGH,this.handleEnded=s=>{this.setTrack(void 0),this.emit(U.Ended,s)},this.handleVisibilityChange=s=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(s),this.logContext),this.disabled=!s,this.emitTrackUpdate()},this.handleVideoDimensionsChange=s=>{this.log.debug("adaptivestream video dimensions ".concat(s.width,"x").concat(s.height),this.logContext),this.videoDimensions=s,this.emitTrackUpdate()},this.subscribed=i,this.updateInfo(n)}setSubscribed(e){const n=this.subscriptionStatus,i=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const r=new Ur({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new Xd({participantSid:"",trackSids:[this.trackSid]})]});this.emit(U.UpdateSubscription,r),this.emitSubscriptionUpdateIfChanged(n),this.emitPermissionUpdateIfChanged(i)}get subscriptionStatus(){return this.subscribed===!1?ut.SubscriptionStatus.Unsubscribed:super.isSubscribed?ut.SubscriptionStatus.Subscribed:ut.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?ut.PermissionStatus.Allowed:ut.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return!this.disabled}setEnabled(e){!this.isManualOperationAllowed()||this.disabled===!e||(this.disabled=!e,this.emitTrackUpdate())}setVideoQuality(e){!this.isManualOperationAllowed()||this.currentVideoQuality===e||(this.currentVideoQuality=e,this.videoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var n,i;this.isManualOperationAllowed()&&(((n=this.videoDimensions)===null||n===void 0?void 0:n.width)===e.width&&((i=this.videoDimensions)===null||i===void 0?void 0:i.height)===e.height||(this.track instanceof qn&&(this.videoDimensions=e),this.currentVideoQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&this.track instanceof qn&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){return this.currentVideoQuality}setTrack(e){const n=this.subscriptionStatus,i=this.permissionStatus,r=this.track;r!==e&&(r&&(r.off(U.VideoDimensionsChanged,this.handleVideoDimensionsChange),r.off(U.VisibilityChanged,this.handleVisibilityChange),r.off(U.Ended,this.handleEnded),r.detach(),r.stopMonitor(),this.emit(U.Unsubscribed,r)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(U.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(U.VisibilityChanged,this.handleVisibilityChange),e.on(U.Ended,this.handleEnded),this.emit(U.Subscribed,e)),this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(n))}setAllowed(e){const n=this.subscriptionStatus,i=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(n)}setSubscriptionError(e){this.emit(U.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const n=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):n!==e.muted&&this.emit(e.muted?U.Muted:U.Unmuted)}emitSubscriptionUpdateIfChanged(e){const n=this.subscriptionStatus;e!==n&&this.emit(U.SubscriptionStatusChanged,n,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(U.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return this.kind===P.Kind.Video&&this.isAdaptiveStream?(this.log.warn("adaptive stream is enabled, cannot change video track settings",this.logContext),!1):this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return this.track instanceof qn&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new ih({trackSids:[this.trackSid],disabled:this.disabled,fps:this.fps});this.videoDimensions?(e.width=Math.ceil(this.videoDimensions.width),e.height=Math.ceil(this.videoDimensions.height)):this.currentVideoQuality!==void 0?e.quality=this.currentVideoQuality:e.quality=Be.HIGH,this.emit(U.UpdateSettings,e)}}class er extends cf{static fromParticipantInfo(e,n,i){return new er(e,n.sid,n.identity,n.name,n.metadata,i,n.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,n,i,r,s,o){let a=arguments.length>6&&arguments[6]!==void 0?arguments[6]:Xi.STANDARD;super(n,i||"",r,s,o,a),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(U.UpdateSettings,n=>{this.log.debug("send update settings",Object.assign(Object.assign({},this.logContext),Y(e))),this.signalClient.sendUpdateTrackSettings(n)}),e.on(U.UpdateSubscription,n=>{n.participantTracks.forEach(i=>{i.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(n)}),e.on(U.SubscriptionPermissionChanged,n=>{this.emit(D.TrackSubscriptionPermissionChanged,e,n)}),e.on(U.SubscriptionStatusChanged,n=>{this.emit(D.TrackSubscriptionStatusChanged,e,n)}),e.on(U.Subscribed,n=>{this.emit(D.TrackSubscribed,n,e)}),e.on(U.Unsubscribed,n=>{this.emit(D.TrackUnsubscribed,n,e)}),e.on(U.SubscriptionFailed,n=>{this.emit(D.TrackSubscriptionFailed,e.trackSid,n)})}getTrackPublication(e){const n=super.getTrackPublication(e);if(n)return n}getTrackPublicationByName(e){const n=super.getTrackPublicationByName(e);if(n)return n}setVolume(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:P.Source.Microphone;this.volumeMap.set(n,e);const i=this.getTrackPublication(n);i&&i.track&&i.track.setVolume(e)}getVolume(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:P.Source.Microphone;const n=this.getTrackPublication(e);return n&&n.track?n.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,n,i,r,s,o){let a=this.getTrackPublicationBySid(n);if(a||n.startsWith("TR")||this.trackPublications.forEach(u=>{!a&&e.kind===u.kind.toString()&&(a=u)}),!a){if(o===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:n})),this.emit(D.TrackSubscriptionFailed,n);return}o===void 0&&(o=20),setTimeout(()=>{this.addSubscribedMediaTrack(e,n,i,r,s,o-1)},150);return}if(e.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),Y(a))),this.emit(D.TrackSubscriptionFailed,n);return}const c=e.kind==="video";let l;return c?l=new qn(e,n,r,s):l=new on(e,n,r,this.audioContext,this.audioOutput),l.source=a.source,l.isMuted=a.isMuted,l.setMediaStream(i),l.start(),a.setTrack(l),this.volumeMap.has(a.source)&&l instanceof on&&l.setVolume(this.volumeMap.get(a.source)),a}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const n=new Map,i=new Map;return e.tracks.forEach(r=>{var s,o;let a=this.getTrackPublicationBySid(r.sid);if(a)a.updateInfo(r);else{const c=P.kindFromProto(r.type);if(!c)return;a=new oi(c,r,(s=this.signalClient.connectOptions)===null||s===void 0?void 0:s.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(o=this.loggerOptions)===null||o===void 0?void 0:o.loggerName}),a.updateInfo(r),i.set(r.sid,a);const l=Array.from(this.trackPublications.values()).find(u=>u.source===(a==null?void 0:a.source));l&&a.source!==P.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(a.source),Object.assign(Object.assign({},this.logContext),{oldTrack:Y(l),newTrack:Y(a)})),this.addTrackPublication(a)}n.set(r.sid,a)}),this.trackPublications.forEach(r=>{n.has(r.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),Y(r))),this.unpublishTrack(r.trackSid,!0))}),i.forEach(r=>{this.emit(D.TrackPublished,r)}),!0}unpublishTrack(e,n){const i=this.trackPublications.get(e);if(!i)return;const{track:r}=i;switch(r&&(r.stop(),i.setTrack(void 0)),this.trackPublications.delete(e),i.kind){case P.Kind.Audio:this.audioTrackPublications.delete(e);break;case P.Kind.Video:this.videoTrackPublications.delete(e);break}n&&this.emit(D.TrackUnpublished,i)}setAudioOutput(e){return S(this,void 0,void 0,function*(){this.audioOutput=e;const n=[];this.audioTrackPublications.forEach(i=>{var r;i.track instanceof on&&n.push(i.track.setSinkId((r=e.deviceId)!==null&&r!==void 0?r:"default"))}),yield Promise.all(n)})}emit(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:i})),super.emit(e,...i)}}var G;(function(t){t.Disconnected="disconnected",t.Connecting="connecting",t.Connected="connected",t.Reconnecting="reconnecting",t.SignalReconnecting="signalReconnecting"})(G||(G={}));const _C=4*1e3;class tr extends at.EventEmitter{constructor(e){var n,i,r;super(),n=this,this.state=G.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=V,this.bufferedEvents=[],this.isResuming=!1,this.connect=(s,o,a)=>S(this,void 0,void 0,function*(){var c;if(!jS())throw mt()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const l=yield this.disconnectLock.lock();if(this.state===G.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),l(),Promise.resolve();if(this.connectFuture)return l(),this.connectFuture.promise;this.setAndEmitConnectionState(G.Connecting),((c=this.regionUrlProvider)===null||c===void 0?void 0:c.getServerUrl().toString())!==s&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),uo(new URL(s))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new Rl(s,o):this.regionUrlProvider.updateToken(o),this.regionUrlProvider.fetchRegionSettings().then(h=>{var f;(f=this.regionUrlProvider)===null||f===void 0||f.setServerReportedRegions(h)}).catch(h=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:h}))}));const u=(h,f,g)=>S(this,void 0,void 0,function*(){var m,b;this.abortController&&this.abortController.abort();const v=new AbortController;this.abortController=v,l==null||l();try{yield this.attemptConnection(g??s,o,a,v),this.abortController=void 0,h()}catch(T){if(this.regionUrlProvider&&T instanceof X&&T.reason!==ye.Cancelled&&T.reason!==ye.NotAllowed){let E=null;try{E=yield this.regionUrlProvider.getNextBestRegionUrl((m=this.abortController)===null||m===void 0?void 0:m.signal)}catch(k){if(k instanceof X&&(k.status===401||k.reason===ye.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),f(k);return}}E&&!(!((b=this.abortController)===null||b===void 0)&&b.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(T.message,". Retrying with another region: ").concat(E),this.logContext),this.recreateEngine(),yield u(h,f,E)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),f(T))}else this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),f(T)}}),d=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Qh((h,f)=>{u(h,f,d)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(s,o,a,c,l,u)=>S(this,void 0,void 0,function*(){var d,h,f;const g=yield a.join(s,o,{autoSubscribe:c.autoSubscribe,adaptiveStream:typeof l.adaptiveStream=="object"?!0:l.adaptiveStream,maxRetries:c.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:c.websocketTimeout},u.signal);let m=g.serverInfo;if(m||(m={version:g.serverVersion,region:g.serverRegion}),this.serverInfo=m,this.log.debug("connected to Livekit Server ".concat(Object.entries(m).map(b=>{let[v,T]=b;return"".concat(v,": ").concat(T)}).join(", ")),{room:(d=g.room)===null||d===void 0?void 0:d.name,roomSid:(h=g.room)===null||h===void 0?void 0:h.sid,identity:(f=g.participant)===null||f===void 0?void 0:f.identity}),!m.version)throw new kS("unknown server version");return m.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),l.dynacast=!1),g}),this.applyJoinResponse=s=>{const o=s.participant;if(this.localParticipant.sid=o.sid,this.localParticipant.identity=o.identity,this.localParticipant.setEnabledPublishCodecs(s.enabledPublishCodecs),this.options.e2ee&&this.e2eeManager)try{this.e2eeManager.setSifTrailer(s.sifTrailer)}catch(a){this.log.error(a instanceof Error?a.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:a}))}this.handleParticipantUpdates([o,...s.otherParticipants]),s.room&&this.handleRoomUpdate(s.room)},this.attemptConnection=(s,o,a,c)=>S(this,void 0,void 0,function*(){var l,u,d;this.state===G.Reconnecting||this.isResuming||!((l=this.engine)===null||l===void 0)&&l.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((u=this.regionUrlProvider)===null||u===void 0)&&u.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},ba),a),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const h=yield this.connectSignal(s,o,this.engine,this.connOptions,this.options,c);this.applyJoinResponse(h),this.setupLocalParticipantEvents(),this.emit(I.SignalConnected)}catch(h){yield this.engine.close(),this.recreateEngine();const f=new X("could not establish signal connection");throw h instanceof Error&&(f.message="".concat(f.message,": ").concat(h.message)),h instanceof X&&(f.reason=h.reason,f.status=h.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:h})),f}if(c.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new X("Connection attempt aborted");try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,c)}catch(h){throw yield this.engine.close(),this.recreateEngine(),h}Oe()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),Oe()&&(document.addEventListener("freeze",this.onPageLeave),(d=navigator.mediaDevices)===null||d===void 0||d.addEventListener("devicechange",this.handleDeviceChange)),this.setAndEmitConnectionState(G.Connected),this.emit(I.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return S(n,[...o],void 0,function(){var c=this;let l=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){var u,d,h,f;const g=yield c.disconnectLock.lock();try{if(c.state===G.Disconnected){c.log.debug("already disconnected",c.logContext);return}c.log.info("disconnect from room",Object.assign({},c.logContext)),(c.state===G.Connecting||c.state===G.Reconnecting||c.isResuming)&&(c.log.warn("abort connection attempt",c.logContext),(u=c.abortController)===null||u===void 0||u.abort(),(h=(d=c.connectFuture)===null||d===void 0?void 0:d.reject)===null||h===void 0||h.call(d,new X("Client initiated disconnect")),c.connectFuture=void 0),!((f=c.engine)===null||f===void 0)&&f.client.isDisconnected||(yield c.engine.client.sendLeave()),c.engine&&(yield c.engine.close()),c.handleDisconnect(l,en.CLIENT_INITIATED),c.engine=void 0}finally{g()}}()})},this.onPageLeave=()=>S(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>S(this,void 0,void 0,function*(){const s=[],o=pt();if(o&&o.os==="iOS"){const a="livekit-dummy-audio-el";let c=document.getElementById(a);if(!c){c=document.createElement("audio"),c.id=a,c.autoplay=!0,c.hidden=!0;const l=Ss();l.enabled=!0;const u=new MediaStream([l]);c.srcObject=u,document.addEventListener("visibilitychange",()=>{c&&(c.srcObject=document.hidden?null:u,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(c),this.once(I.Disconnected,()=>{c==null||c.remove(),c=null})}s.push(c)}this.remoteParticipants.forEach(a=>{a.audioTrackPublications.forEach(c=>{c.track&&c.track.attachedElements.forEach(l=>{s.push(l)})})});try{yield Promise.all([this.acquireAudioContext(),...s.map(a=>(a.muted=!1,a.play()))]),this.handleAudioPlaybackStarted()}catch(a){throw this.handleAudioPlaybackFailed(a),a}}),this.startVideo=()=>S(this,void 0,void 0,function*(){const s=[];for(const o of this.remoteParticipants.values())o.videoTrackPublications.forEach(a=>{var c;(c=a.track)===null||c===void 0||c.attachedElements.forEach(l=>{s.includes(l)||s.push(l)})});yield Promise.all(s.map(o=>o.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(o=>{o.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const s of this.remoteParticipants.values())this.handleParticipantDisconnected(s.identity,s);this.setAndEmitConnectionState(G.Reconnecting)&&this.emit(I.Reconnecting)},this.handleSignalRestarted=s=>S(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(s.serverRegion),Object.assign(Object.assign({},this.logContext),{region:s.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(s);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(o){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:o}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:s.serverRegion}))}catch{return}this.setAndEmitConnectionState(G.Connected),this.emit(I.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=s=>{s.forEach(o=>{var a;if(o.identity===this.localParticipant.identity){this.localParticipant.updateInfo(o);return}o.identity===""&&(o.identity=(a=this.sidToIdentity.get(o.sid))!==null&&a!==void 0?a:"");let c=this.remoteParticipants.get(o.identity);o.state===Ws.DISCONNECTED?this.handleParticipantDisconnected(o.identity,c):c=this.getOrCreateParticipant(o.identity,o)})},this.handleActiveSpeakersUpdate=s=>{const o=[],a={};s.forEach(c=>{if(a[c.sid]=!0,c.sid===this.localParticipant.sid)this.localParticipant.audioLevel=c.level,this.localParticipant.setIsSpeaking(!0),o.push(this.localParticipant);else{const l=this.getRemoteParticipantBySid(c.sid);l&&(l.audioLevel=c.level,l.setIsSpeaking(!0),o.push(l))}}),a[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(c=>{a[c.sid]||(c.audioLevel=0,c.setIsSpeaking(!1))}),this.activeSpeakers=o,this.emitWhenConnected(I.ActiveSpeakersChanged,o)},this.handleSpeakersChanged=s=>{const o=new Map;this.activeSpeakers.forEach(c=>{const l=this.remoteParticipants.get(c.identity);l&&l.sid!==c.sid||o.set(c.sid,c)}),s.forEach(c=>{let l=this.getRemoteParticipantBySid(c.sid);c.sid===this.localParticipant.sid&&(l=this.localParticipant),l&&(l.audioLevel=c.level,l.setIsSpeaking(c.active),c.active?o.set(c.sid,l):o.delete(c.sid))});const a=Array.from(o.values());a.sort((c,l)=>l.audioLevel-c.audioLevel),this.activeSpeakers=a,this.emitWhenConnected(I.ActiveSpeakersChanged,a)},this.handleStreamStateUpdate=s=>{s.streamStates.forEach(o=>{const a=this.getRemoteParticipantBySid(o.participantSid);if(!a)return;const c=a.getTrackPublicationBySid(o.trackSid);if(!c||!c.track)return;const l=P.streamStateFromProto(o.state);l!==c.track.streamState&&(c.track.streamState=l,a.emit(D.TrackStreamStateChanged,c,c.track.streamState),this.emitWhenConnected(I.TrackStreamStateChanged,c,c.track.streamState,a))})},this.handleSubscriptionPermissionUpdate=s=>{const o=this.getRemoteParticipantBySid(s.participantSid);if(!o)return;const a=o.getTrackPublicationBySid(s.trackSid);a&&a.setAllowed(s.allowed)},this.handleSubscriptionError=s=>{const o=Array.from(this.remoteParticipants.values()).find(c=>c.trackPublications.has(s.trackSid));if(!o)return;const a=o.getTrackPublicationBySid(s.trackSid);a&&a.setSubscriptionError(s.err)},this.handleDataPacket=s=>{const o=this.remoteParticipants.get(s.participantIdentity);s.value.case==="user"?this.handleUserPacket(o,s.value.value,s.kind):s.value.case==="transcription"?this.handleTranscription(o,s.value.value):s.value.case==="sipDtmf"?this.handleSipDtmf(o,s.value.value):s.value.case==="chatMessage"?this.handleChatMessage(o,s.value.value):s.value.case==="metrics"&&this.handleMetrics(s.value.value,o)},this.handleUserPacket=(s,o,a)=>{this.emit(I.DataReceived,o.payload,s,a,o.topic),s==null||s.emit(D.DataReceived,o.payload,a)},this.handleSipDtmf=(s,o)=>{this.emit(I.SipDTMFReceived,o,s),s==null||s.emit(D.SipDTMFReceived,o)},this.bufferedSegments=new Map,this.handleTranscription=(s,o)=>{const a=o.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(o.transcribedParticipantIdentity),c=a==null?void 0:a.trackPublications.get(o.trackId),l=KS(o,this.transcriptionReceivedTimes);c==null||c.emit(U.TranscriptionReceived,l),a==null||a.emit(D.TranscriptionReceived,l,c),this.emit(I.TranscriptionReceived,l,a,c)},this.handleChatMessage=(s,o)=>{const a=JS(o);this.emit(I.ChatMessage,a,s)},this.handleMetrics=(s,o)=>{this.emit(I.MetricsReceived,s,o)},this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(I.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=s=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:s})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(I.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(I.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(I.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>S(this,void 0,void 0,function*(){const s=yield fe.getInstance().getDevices(void 0,!1),o=["audiooutput"];for(let a of o){const c=s.filter(l=>l.kind===a);c.length>0&&!c.find(l=>l.deviceId===this.getActiveDevice(a))&&(yield this.switchActiveDevice(a,c[0].deviceId))}this.emit(I.MediaDevicesChanged)}),this.handleRoomUpdate=s=>{const o=this.roomInfo;this.roomInfo=s,o&&o.metadata!==s.metadata&&this.emitWhenConnected(I.RoomMetadataChanged,s.metadata),(o==null?void 0:o.activeRecording)!==s.activeRecording&&this.emitWhenConnected(I.RecordingStatusChanged,s.activeRecording)},this.handleConnectionQualityUpdate=s=>{s.updates.forEach(o=>{if(o.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(o.quality);return}const a=this.getRemoteParticipantBySid(o.participantSid);a&&a.setConnectionQuality(o.quality)})},this.onLocalParticipantMetadataChanged=s=>{this.emit(I.ParticipantMetadataChanged,s,this.localParticipant)},this.onLocalParticipantNameChanged=s=>{this.emit(I.ParticipantNameChanged,s,this.localParticipant)},this.onLocalAttributesChanged=s=>{this.emit(I.ParticipantAttributesChanged,s,this.localParticipant)},this.onLocalTrackMuted=s=>{this.emit(I.TrackMuted,s,this.localParticipant)},this.onLocalTrackUnmuted=s=>{this.emit(I.TrackUnmuted,s,this.localParticipant)},this.onTrackProcessorUpdate=s=>{var o;(o=s==null?void 0:s.onPublish)===null||o===void 0||o.call(s,this)},this.onLocalTrackPublished=s=>S(this,void 0,void 0,function*(){var o,a,c,l,u,d;(o=s.track)===null||o===void 0||o.on(U.TrackProcessorUpdate,this.onTrackProcessorUpdate),(a=s.track)===null||a===void 0||a.on(U.Restarted,this.onLocalTrackRestarted),(u=(l=(c=s.track)===null||c===void 0?void 0:c.getProcessor())===null||l===void 0?void 0:l.onPublish)===null||u===void 0||u.call(l,this),this.emit(I.LocalTrackPublished,s,this.localParticipant),s.track instanceof he&&(yield s.track.checkForSilence())&&this.emit(I.LocalAudioSilenceDetected,s);const h=yield(d=s.track)===null||d===void 0?void 0:d.getDeviceId(),f=cl(s.source);f&&h&&h!==this.localParticipant.activeDeviceMap.get(f)&&(this.localParticipant.activeDeviceMap.set(f,h),this.emit(I.ActiveDeviceChanged,f,h))}),this.onLocalTrackUnpublished=s=>{var o,a;(o=s.track)===null||o===void 0||o.off(U.TrackProcessorUpdate,this.onTrackProcessorUpdate),(a=s.track)===null||a===void 0||a.off(U.Restarted,this.onLocalTrackRestarted),this.emit(I.LocalTrackUnpublished,s,this.localParticipant)},this.onLocalTrackRestarted=s=>S(this,void 0,void 0,function*(){const o=yield s.getDeviceId(!1),a=cl(s.source);a&&o&&o!==this.localParticipant.activeDeviceMap.get(a)&&(this.log.debug("local track restarted, setting ".concat(a," ").concat(o," active"),this.logContext),this.localParticipant.activeDeviceMap.set(a,o),this.emit(I.ActiveDeviceChanged,a,o))}),this.onLocalConnectionQualityChanged=s=>{this.emit(I.ConnectionQualityChanged,s,this.localParticipant)},this.onMediaDevicesError=s=>{this.emit(I.MediaDevicesError,s)},this.onLocalParticipantPermissionsChanged=s=>{this.emit(I.ParticipantPermissionsChanged,s,this.localParticipant)},this.onLocalChatMessageSent=s=>{this.emit(I.ChatMessage,s,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},lC),e),this.log=ft((i=this.options.loggerName)!==null&&i!==void 0?i:Je.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},Zh),e==null?void 0:e.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},ef),e==null?void 0:e.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},cC),e==null?void 0:e.publishDefaults),this.maybeCreateEngine(),this.disconnectLock=new Re,this.localParticipant=new si("","",this.engine,this.options),this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",ht(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",ht(this.options.audioCaptureDefaults.deviceId)),!((r=this.options.audioOutput)===null||r===void 0)&&r.deviceId&&this.switchActiveDevice("audiooutput",ht(this.options.audioOutput.deviceId)).catch(s=>this.log.warn("Could not set audio output: ".concat(s.message),this.logContext)),this.options.e2ee&&this.setupE2EE()}setE2EEEnabled(e){return S(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var e;this.options.e2ee&&(this.e2eeManager=new QS(this.options.e2ee),this.e2eeManager.on(Ct.ParticipantEncryptionStatusChanged,(n,i)=>{i instanceof si&&(this.isE2EEEnabled=n),this.emit(I.ParticipantEncryptionStatusChanged,n,i)}),this.e2eeManager.on(Ct.EncryptionError,n=>this.emit(I.EncryptionError,n)),(e=this.e2eeManager)===null||e===void 0||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:(e=this.roomInfo)===null||e===void 0?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,n;return(n=(e=this.roomInfo)===null||e===void 0?void 0:e.activeRecording)!==null&&n!==void 0?n:!1}getSid(){return S(this,void 0,void 0,function*(){return this.state===G.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise((e,n)=>{const i=r=>{r.sid!==""&&(this.engine.off(F.RoomUpdate,i),e(r.sid))};this.engine.on(F.RoomUpdate,i),this.once(I.Disconnected,()=>{this.engine.off(F.RoomUpdate,i),n("Room disconnected before room server id was available")})})})}get name(){var e,n;return(n=(e=this.roomInfo)===null||e===void 0?void 0:e.name)!==null&&n!==void 0?n:""}get metadata(){var e;return(e=this.roomInfo)===null||e===void 0?void 0:e.metadata}get numParticipants(){var e,n;return(n=(e=this.roomInfo)===null||e===void 0?void 0:e.numParticipants)!==null&&n!==void 0?n:0}get numPublishers(){var e,n;return(n=(e=this.roomInfo)===null||e===void 0?void 0:e.numPublishers)!==null&&n!==void 0?n:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new TC(this.options),this.engine.on(F.ParticipantUpdate,this.handleParticipantUpdates).on(F.RoomUpdate,this.handleRoomUpdate).on(F.SpeakersChanged,this.handleSpeakersChanged).on(F.StreamStateChanged,this.handleStreamStateUpdate).on(F.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(F.SubscriptionError,this.handleSubscriptionError).on(F.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(F.MediaTrackAdded,(e,n,i)=>{this.onTrackAdded(e,n,i)}).on(F.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(F.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(F.DataPacketReceived,this.handleDataPacket).on(F.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(G.SignalReconnecting)&&this.emit(I.SignalReconnecting)}).on(F.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(G.Connected)&&this.emit(I.Reconnected)}).on(F.SignalResumed,()=>{this.bufferedEvents=[],(this.state===G.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(F.Restarting,this.handleRestarting).on(F.SignalRestarted,this.handleSignalRestarted).on(F.Offline,()=>{this.setAndEmitConnectionState(G.Reconnecting)&&this.emit(I.Reconnecting)}).on(F.DCBufferStatusChanged,(e,n)=>{this.emit(I.DCBufferStatusChanged,e,n)}).on(F.LocalTrackSubscribed,e=>{const n=this.localParticipant.getTrackPublications().find(i=>{let{trackSid:r}=i;return r===e});if(!n){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(D.LocalTrackSubscribed,n),this.emitWhenConnected(I.LocalTrackSubscribed,n,this.localParticipant)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine))}static getLocalDevices(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return fe.getInstance().getDevices(e,n)}prepareConnection(e,n){return S(this,void 0,void 0,function*(){if(this.state===G.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(uo(new URL(e))&&n){this.regionUrlProvider=new Rl(e,n);const i=yield this.regionUrlProvider.getNextBestRegionUrl();i&&this.state===G.Disconnected&&(this.regionUrl=i,yield fetch(pl(i),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(i),this.logContext))}else yield fetch(pl(e),{method:"HEAD"})}catch(i){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:i}))}}})}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,n){return S(this,void 0,void 0,function*(){let i=()=>{},r;switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":r=new tt({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":r=new tt({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":r=new tt({scenario:{case:"serverLeave",value:!0}});break;case"migration":r=new tt({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>S(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new tt({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":i=()=>S(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new tt({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":r=new tt({scenario:{case:"switchCandidateProtocol",value:e==="force-tls"?2:1}}),i=()=>S(this,void 0,void 0,function*(){const s=this.engine.client.onLeave;s&&s(new Fr({reason:en.CLIENT_INITIATED,action:tn.RECONNECT}))});break;case"subscriber-bandwidth":if(n===void 0||typeof n!="number")throw new Error("subscriber-bandwidth requires a number as argument");r=new tt({scenario:{case:"subscriberBandwidth",value:BigInt(n)}});break;case"leave-full-reconnect":r=new tt({scenario:{case:"leaveRequestFullReconnect",value:!0}})}r&&(yield this.engine.client.sendSimulateScenario(r),yield i())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,n){return S(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return function*(){var a,c,l,u,d,h,f;let g=!1,m=!0;const b=o?{exact:r}:r;if(i==="audioinput"){const v=(a=s.getActiveDevice(i))!==null&&a!==void 0?a:s.options.audioCaptureDefaults.deviceId;s.options.audioCaptureDefaults.deviceId=b,g=v!==b;const T=Array.from(s.localParticipant.audioTrackPublications.values()).filter(E=>E.source===P.Source.Microphone);try{m=(yield Promise.all(T.map(E=>{var k;return(k=E.audioTrack)===null||k===void 0?void 0:k.setDeviceId(b)}))).every(E=>E===!0)}catch(E){throw s.options.audioCaptureDefaults.deviceId=v,E}}else if(i==="videoinput"){const v=(c=s.getActiveDevice(i))!==null&&c!==void 0?c:s.options.videoCaptureDefaults.deviceId;s.options.videoCaptureDefaults.deviceId=b,g=v!==b;const T=Array.from(s.localParticipant.videoTrackPublications.values()).filter(E=>E.source===P.Source.Camera);try{m=(yield Promise.all(T.map(E=>{var k;return(k=E.videoTrack)===null||k===void 0?void 0:k.setDeviceId(b)}))).every(E=>E===!0)}catch(E){throw s.options.videoCaptureDefaults.deviceId=v,E}}else if(i==="audiooutput"){if(!lo()&&!s.options.webAudioMix||s.options.webAudioMix&&s.audioContext&&!("setSinkId"in s.audioContext))throw new Error("cannot switch audio output, setSinkId not supported");s.options.webAudioMix&&(r=(l=yield fe.getInstance().normalizeDeviceId("audiooutput",r))!==null&&l!==void 0?l:""),(u=(f=s.options).audioOutput)!==null&&u!==void 0||(f.audioOutput={});const v=(d=s.getActiveDevice(i))!==null&&d!==void 0?d:s.options.audioOutput.deviceId;s.options.audioOutput.deviceId=r,g=v!==b;try{s.options.webAudioMix&&((h=s.audioContext)===null||h===void 0||h.setSinkId(r)),yield Promise.all(Array.from(s.remoteParticipants.values()).map(T=>T.setAudioOutput({deviceId:r})))}catch(T){throw s.options.audioOutput.deviceId=v,T}}return g&&m&&(s.localParticipant.activeDeviceMap.set(i,r),s.emit(I.ActiveDeviceChanged,i,r)),m}()})}setupLocalParticipantEvents(){this.localParticipant.on(D.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(D.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(D.AttributesChanged,this.onLocalAttributesChanged).on(D.TrackMuted,this.onLocalTrackMuted).on(D.TrackUnmuted,this.onLocalTrackUnmuted).on(D.LocalTrackPublished,this.onLocalTrackPublished).on(D.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(D.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(D.MediaDevicesError,this.onMediaDevicesError).on(D.AudioStreamAcquired,this.startAudio).on(D.ChatMessage,this.onLocalChatMessageSent).on(D.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;(e=this.engine)===null||e===void 0||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,n,i){if(this.state===G.Connecting||this.state===G.Reconnecting){const u=()=>{this.onTrackAdded(e,n,i),d()},d=()=>{this.off(I.Reconnected,u),this.off(I.Connected,u),this.off(I.Disconnected,d)};this.once(I.Reconnected,u),this.once(I.Connected,u),this.once(I.Disconnected,d);return}if(this.state===G.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}const r=US(n.id),s=r[0];let o=r[1],a=e.id;if(o&&o.startsWith("TR")&&(a=o),s===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const c=Array.from(this.remoteParticipants.values()).find(u=>u.sid===s);if(!c){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(s),this.logContext);return}let l;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?l=this.options.adaptiveStream:l={}),c.addSubscribedMediaTrack(e,a,n,i,l)}handleDisconnect(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,n=arguments.length>1?arguments[1]:void 0;var i;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.state!==G.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach(r=>{r.trackPublications.forEach(s=>{r.unpublishTrack(s.trackSid)})}),this.localParticipant.trackPublications.forEach(r=>{var s,o;r.track&&this.localParticipant.unpublishTrack(r.track,e),e&&((s=r.track)===null||s===void 0||s.detach(),(o=r.track)===null||o===void 0||o.stop())}),this.localParticipant.off(D.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(D.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(D.AttributesChanged,this.onLocalAttributesChanged).off(D.TrackMuted,this.onLocalTrackMuted).off(D.TrackUnmuted,this.onLocalTrackUnmuted).off(D.LocalTrackPublished,this.onLocalTrackPublished).off(D.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(D.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(D.MediaDevicesError,this.onMediaDevicesError).off(D.AudioStreamAcquired,this.startAudio).off(D.ChatMessage,this.onLocalChatMessageSent).off(D.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),Oe()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(i=navigator.mediaDevices)===null||i===void 0||i.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(G.Disconnected),this.emit(I.Disconnected,n)}}}handleParticipantDisconnected(e,n){var i;this.remoteParticipants.delete(e),n&&(n.trackPublications.forEach(r=>{n.unpublishTrack(r.trackSid,!0)}),this.emit(I.ParticipantDisconnected,n),(i=this.localParticipant)===null||i===void 0||i.handleParticipantDisconnected(n.identity))}acquireAudioContext(){return S(this,void 0,void 0,function*(){var e,n;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(e=zh())!==null&&e!==void 0?e:void 0),this.audioContext&&this.audioContext.state==="suspended")try{yield this.audioContext.resume()}catch(r){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:r}))}this.options.webAudioMix&&this.remoteParticipants.forEach(r=>r.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext);const i=((n=this.audioContext)===null||n===void 0?void 0:n.state)==="running";i!==this.canPlaybackAudio&&(this.audioEnabled=i,this.emit(I.AudioPlaybackStatusChanged,i))})}createParticipant(e,n){var i;let r;return n?r=er.fromParticipantInfo(this.engine.client,n,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):r=new er(this.engine.client,"",e,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&r.setAudioContext(this.audioContext),!((i=this.options.audioOutput)===null||i===void 0)&&i.deviceId&&r.setAudioOutput(this.options.audioOutput).catch(s=>this.log.warn("Could not set audio output: ".concat(s.message),this.logContext)),r}getOrCreateParticipant(e,n){if(this.remoteParticipants.has(e)){const r=this.remoteParticipants.get(e);return n&&r.updateInfo(n)&&this.sidToIdentity.set(n.sid,n.identity),r}const i=this.createParticipant(e,n);return this.remoteParticipants.set(e,i),this.sidToIdentity.set(n.sid,n.identity),this.emitWhenConnected(I.ParticipantConnected,i),i.on(D.TrackPublished,r=>{this.emitWhenConnected(I.TrackPublished,r,i)}).on(D.TrackSubscribed,(r,s)=>{r.kind===P.Kind.Audio?(r.on(U.AudioPlaybackStarted,this.handleAudioPlaybackStarted),r.on(U.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):r.kind===P.Kind.Video&&(r.on(U.VideoPlaybackFailed,this.handleVideoPlaybackFailed),r.on(U.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(I.TrackSubscribed,r,s,i)}).on(D.TrackUnpublished,r=>{this.emit(I.TrackUnpublished,r,i)}).on(D.TrackUnsubscribed,(r,s)=>{this.emit(I.TrackUnsubscribed,r,s,i)}).on(D.TrackSubscriptionFailed,r=>{this.emit(I.TrackSubscriptionFailed,r,i)}).on(D.TrackMuted,r=>{this.emitWhenConnected(I.TrackMuted,r,i)}).on(D.TrackUnmuted,r=>{this.emitWhenConnected(I.TrackUnmuted,r,i)}).on(D.ParticipantMetadataChanged,r=>{this.emitWhenConnected(I.ParticipantMetadataChanged,r,i)}).on(D.ParticipantNameChanged,r=>{this.emitWhenConnected(I.ParticipantNameChanged,r,i)}).on(D.AttributesChanged,r=>{this.emitWhenConnected(I.ParticipantAttributesChanged,r,i)}).on(D.ConnectionQualityChanged,r=>{this.emitWhenConnected(I.ConnectionQualityChanged,r,i)}).on(D.ParticipantPermissionsChanged,r=>{this.emitWhenConnected(I.ParticipantPermissionsChanged,r,i)}).on(D.TrackSubscriptionStatusChanged,(r,s)=>{this.emitWhenConnected(I.TrackSubscriptionStatusChanged,r,s,i)}).on(D.TrackSubscriptionFailed,(r,s)=>{this.emit(I.TrackSubscriptionFailed,r,i,s)}).on(D.TrackSubscriptionPermissionChanged,(r,s)=>{this.emitWhenConnected(I.TrackSubscriptionPermissionChanged,r,s,i)}),n&&i.updateInfo(n),i}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce((i,r)=>(i.push(...r.getTrackPublications()),i),[]),n=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,n)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const n of e.videoTrackPublications.values())n.isSubscribed&&n instanceof oi&&n.emitTrackUpdate()}getRemoteParticipantBySid(e){const n=this.sidToIdentity.get(e);if(n)return this.remoteParticipants.get(n)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=me.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,en.STATE_MISMATCH))):e=0},_C)}clearConnectionReconcile(){this.connectionReconcileInterval&&me.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e===this.state?!1:(this.state=e,this.emit(I.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[n,i]=e;this.emit(n,...i)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];if(this.state===G.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,i]);else if(this.state===G.Connected)return this.emit(e,...i);return!1}simulateParticipants(e){return S(this,void 0,void 0,function*(){var n,i;const r=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),s=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new ca({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:ne.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new ti({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(I.SignalConnected),this.emit(I.Connected),this.setAndEmitConnectionState(G.Connected),r.video){const o=new ri(P.Kind.Video,new Xt({source:be.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:He.AUDIO,name:"video-dummy"}),new ve(r.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:fl(160*((n=s.aspectRatios[0])!==null&&n!==void 0?n:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(D.LocalTrackPublished,o)}if(r.audio){const o=new ri(P.Kind.Audio,new Xt({source:be.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:He.AUDIO}),new he(r.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:Ss(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(D.LocalTrackPublished,o)}for(let o=0;o<s.count-1;o+=1){let a=new ti({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(o),state:Ws.ACTIVE,tracks:[],joinedAt:ne.parse(Date.now())});const c=this.getOrCreateParticipant(a.identity,a);if(s.video){const l=fl(160*((i=s.aspectRatios[o%s.aspectRatios.length])!==null&&i!==void 0?i:1),160,!1,!0),u=new Xt({source:be.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:He.AUDIO});c.addSubscribedMediaTrack(l,u.sid,new MediaStream([l]),new RTCRtpReceiver),a.tracks=[...a.tracks,u]}if(s.audio){const l=Ss(),u=new Xt({source:be.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:He.AUDIO});c.addSubscribedMediaTrack(l,u.sid,new MediaStream([l]),new RTCRtpReceiver),a.tracks=[...a.tracks,u]}c.updateInfo(a)}})}emit(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];if(e!==I.ActiveSpeakersChanged){const s=lf(i).filter(o=>o!==void 0);this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s}))}return super.emit(e,...i)}}function lf(t){return t.map(e=>{if(e)return Array.isArray(e)?lf(e):typeof e=="object"?"logContext"in e&&e.logContext:e})}var qe;(function(t){t[t.IDLE=0]="IDLE",t[t.RUNNING=1]="RUNNING",t[t.SKIPPED=2]="SKIPPED",t[t.SUCCESS=3]="SUCCESS",t[t.FAILED=4]="FAILED"})(qe||(qe={}));class En extends at.EventEmitter{constructor(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=qe.IDLE,this.logs=[],this.errorsAsWarnings=!1,this.url=e,this.token=n,this.name=this.constructor.name,this.room=new tr(i.roomOptions),this.connectOptions=i.connectOptions,i.errorsAsWarnings&&(this.errorsAsWarnings=i.errorsAsWarnings)}run(e){return S(this,void 0,void 0,function*(){if(this.status!==qe.IDLE)throw Error("check is running already");this.setStatus(qe.RUNNING);try{yield this.perform()}catch(n){n instanceof Error&&(this.errorsAsWarnings?this.appendWarning(n.message):this.appendError(n.message))}return yield this.disconnect(),yield new Promise(n=>setTimeout(n,500)),this.status!==qe.SKIPPED&&this.setStatus(this.isSuccess()?qe.SUCCESS:qe.FAILED),e&&e(),this.getInfo()})}isSuccess(){return!this.logs.some(e=>e.level==="error")}connect(){return S(this,void 0,void 0,function*(){return this.room.state===G.Connected?this.room:(yield this.room.connect(this.url,this.token,this.connectOptions),this.room)})}disconnect(){return S(this,void 0,void 0,function*(){this.room&&this.room.state!==G.Disconnected&&(yield this.room.disconnect(),yield new Promise(e=>setTimeout(e,500)))})}skip(){this.setStatus(qe.SKIPPED)}appendMessage(e){this.logs.push({level:"info",message:e}),this.emit("update",this.getInfo())}appendWarning(e){this.logs.push({level:"warning",message:e}),this.emit("update",this.getInfo())}appendError(e){this.logs.push({level:"error",message:e}),this.emit("update",this.getInfo())}setStatus(e){this.status=e,this.emit("update",this.getInfo())}get engine(){var e;return(e=this.room)===null||e===void 0?void 0:e.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class AC extends En{get description(){return"Can publish audio"}perform(){return S(this,void 0,void 0,function*(){var e;const n=yield this.connect(),i=yield IC();n.localParticipant.publishTrack(i),yield new Promise(o=>setTimeout(o,3e3));const r=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let s=0;if(r.forEach(o=>{o.type==="outbound-rtp"&&(o.kind==="audio"||!o.kind&&o.mediaType==="audio")&&(s=o.packetsSent)}),s===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(s," audio packets"))})}}class NC extends En{get description(){return"Can publish video"}perform(){return S(this,void 0,void 0,function*(){var e;const n=yield this.connect(),i=yield RC();n.localParticipant.publishTrack(i),yield new Promise(o=>setTimeout(o,5e3));const r=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let s=0;if(r.forEach(o=>{o.type==="outbound-rtp"&&(o.kind==="video"||!o.kind&&o.mediaType==="video")&&(s+=o.packetsSent)}),s===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(s," video packets"))})}}class MC extends En{get description(){return"Resuming connection after interruption"}perform(){return S(this,void 0,void 0,function*(){var e;const n=yield this.connect();let i=!1,r=!1,s;const o=new Promise(l=>{setTimeout(l,5e3),s=l}),a=()=>{i=!0};n.on(I.SignalReconnecting,a).on(I.Reconnecting,a).on(I.Reconnected,()=>{r=!0,s(!0)}),(e=n.engine.client.ws)===null||e===void 0||e.close();const c=n.engine.client.onClose;if(c&&c(""),yield o,i){if(!r||n.state!==G.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class LC extends En{get description(){return"Can connect via TURN"}perform(){return S(this,void 0,void 0,function*(){var e,n;const i=new va,r=yield i.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});let s=!1,o=!1,a=!1;for(let c of r.iceServers)for(let l of c.urls)l.startsWith("turn:")?(o=!0,a=!0):l.startsWith("turns:")&&(o=!0,a=!0,s=!0),l.startsWith("stun:")&&(a=!0);a?o&&!s&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield i.close(),!((n=(e=this.connectOptions)===null||e===void 0?void 0:e.rtcConfig)===null||n===void 0)&&n.iceServers||o?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(c=>setTimeout(c,0)))})}}class UC extends En{get description(){return"Establishing WebRTC connection"}perform(){return S(this,void 0,void 0,function*(){let e=!1,n=!1;this.room.on(I.SignalConnected,()=>{const i=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(r,s)=>{if(r.candidate){const o=new RTCIceCandidate(r);let a="".concat(o.protocol," ").concat(o.address,":").concat(o.port," ").concat(o.type);o.address&&(FC(o.address)?a+=" (private)":o.protocol==="tcp"&&o.tcpType==="passive"?(e=!0,a+=" (passive)"):o.protocol==="udp"&&(n=!0)),this.appendMessage(a)}i&&i(r,s)},this.room.engine.pcManager&&(this.room.engine.pcManager.subscriber.onIceCandidateError=r=>{r instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(r.errorCode," ").concat(r.errorText," ").concat(r.url))})});try{yield this.connect(),V.info("now the room is connected")}catch(i){throw this.appendWarning("ports need to be open on firewall in order to connect."),i}e||this.appendWarning("Server is not configured for ICE/TCP"),n||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function FC(t){const e=t.split(".");if(e.length===4){if(e[0]==="10")return!0;if(e[0]==="192"&&e[1]==="168")return!0;if(e[0]==="172"){const n=parseInt(e[1],10);if(n>=16&&n<=31)return!0}}return!1}class BC extends En{get description(){return"Connecting to signal connection via WebSocket"}perform(){return S(this,void 0,void 0,function*(){var e,n,i;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let r=new va;const s=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});this.appendMessage("Connected to server, version ".concat(s.serverVersion,".")),((e=s.serverInfo)===null||e===void 0?void 0:e.edition)===Zd.Cloud&&(!((n=s.serverInfo)===null||n===void 0)&&n.region)&&this.appendMessage("LiveKit Cloud: ".concat((i=s.serverInfo)===null||i===void 0?void 0:i.region)),yield r.close()})}}class R1 extends at.EventEmitter{constructor(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=e,this.token=n,this.options=i}getNextCheckId(){const e=this.checkResults.size;return this.checkResults.set(e,{logs:[],status:qe.IDLE,name:"",description:""}),e}updateCheck(e,n){this.checkResults.set(e,n),this.emit("checkUpdate",e,n)}isSuccess(){return Array.from(this.checkResults.values()).every(e=>e.status!==qe.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(e){return S(this,void 0,void 0,function*(){const n=this.getNextCheckId(),i=new e(this.url,this.token,this.options),r=o=>{this.updateCheck(n,o)};i.on("update",r);const s=yield i.run();return i.off("update",r),s})}checkWebsocket(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(BC)})}checkWebRTC(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(UC)})}checkTURN(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(LC)})}checkReconnect(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(MC)})}checkPublishAudio(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(AC)})}checkPublishVideo(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(NC)})}}function jC(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var n;const i=t instanceof Bt?t.mediaStreamTrack:t,r=i.getSettings();let s={facingMode:(n=e.defaultFacingMode)!==null&&n!==void 0?n:"user",confidence:"low"};if("facingMode"in r){const o=r.facingMode;V.trace("rawFacingMode",{rawFacingMode:o}),o&&typeof o=="string"&&GC(o)&&(s={facingMode:o,confidence:"high"})}if(["low","medium"].includes(s.confidence)){V.trace("Try to get facing mode from device label: (".concat(i.label,")"));const o=$C(i.label);o!==void 0&&(s=o)}return s}const _l=new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]),VC=new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);function $C(t){var e;const n=t.trim().toLowerCase();if(n!=="")return _l.has(n)?_l.get(n):(e=Array.from(VC.entries()).find(i=>{let[r]=i;return n.includes(r)}))===null||e===void 0?void 0:e[1]}function GC(t){return t===void 0||["user","environment","left","right"].includes(t)}const go=Math.min,an=Math.max,nr=Math.round,Dt=t=>({x:t,y:t}),WC={left:"right",right:"left",bottom:"top",top:"bottom"},qC={start:"end",end:"start"};function Al(t,e,n){return an(t,go(e,n))}function $r(t,e){return typeof t=="function"?t(e):t}function Gt(t){return t.split("-")[0]}function Gr(t){return t.split("-")[1]}function uf(t){return t==="x"?"y":"x"}function df(t){return t==="y"?"height":"width"}function Wr(t){return["top","bottom"].includes(Gt(t))?"y":"x"}function hf(t){return uf(Wr(t))}function HC(t,e,n){n===void 0&&(n=!1);const i=Gr(t),r=hf(t),s=df(r);let o=r==="x"?i===(n?"end":"start")?"right":"left":i==="start"?"bottom":"top";return e.reference[s]>e.floating[s]&&(o=ir(o)),[o,ir(o)]}function zC(t){const e=ir(t);return[vo(t),e,vo(e)]}function vo(t){return t.replace(/start|end/g,e=>qC[e])}function KC(t,e,n){const i=["left","right"],r=["right","left"],s=["top","bottom"],o=["bottom","top"];switch(t){case"top":case"bottom":return n?e?r:i:e?i:r;case"left":case"right":return e?s:o;default:return[]}}function JC(t,e,n,i){const r=Gr(t);let s=KC(Gt(t),n==="start",i);return r&&(s=s.map(o=>o+"-"+r),e&&(s=s.concat(s.map(vo)))),s}function ir(t){return t.replace(/left|right|bottom|top/g,e=>WC[e])}function YC(t){return{top:0,right:0,bottom:0,left:0,...t}}function QC(t){return typeof t!="number"?YC(t):{top:t,right:t,bottom:t,left:t}}function rr(t){const{x:e,y:n,width:i,height:r}=t;return{width:i,height:r,top:n,left:e,right:e+i,bottom:n+r,x:e,y:n}}function Nl(t,e,n){let{reference:i,floating:r}=t;const s=Wr(e),o=hf(e),a=df(o),c=Gt(e),l=s==="y",u=i.x+i.width/2-r.width/2,d=i.y+i.height/2-r.height/2,h=i[a]/2-r[a]/2;let f;switch(c){case"top":f={x:u,y:i.y-r.height};break;case"bottom":f={x:u,y:i.y+i.height};break;case"right":f={x:i.x+i.width,y:d};break;case"left":f={x:i.x-r.width,y:d};break;default:f={x:i.x,y:i.y}}switch(Gr(e)){case"start":f[o]-=h*(n&&l?-1:1);break;case"end":f[o]+=h*(n&&l?-1:1);break}return f}const XC=async(t,e,n)=>{const{placement:i="bottom",strategy:r="absolute",middleware:s=[],platform:o}=n,a=s.filter(Boolean),c=await(o.isRTL==null?void 0:o.isRTL(e));let l=await o.getElementRects({reference:t,floating:e,strategy:r}),{x:u,y:d}=Nl(l,i,c),h=i,f={},g=0;for(let m=0;m<a.length;m++){const{name:b,fn:v}=a[m],{x:T,y:E,data:k,reset:y}=await v({x:u,y:d,initialPlacement:i,placement:h,strategy:r,middlewareData:f,rects:l,platform:o,elements:{reference:t,floating:e}});u=T??u,d=E??d,f={...f,[b]:{...f[b],...k}},y&&g<=50&&(g++,typeof y=="object"&&(y.placement&&(h=y.placement),y.rects&&(l=y.rects===!0?await o.getElementRects({reference:t,floating:e,strategy:r}):y.rects),{x:u,y:d}=Nl(l,h,c)),m=-1)}return{x:u,y:d,placement:h,strategy:r,middlewareData:f}};async function ff(t,e){var n;e===void 0&&(e={});const{x:i,y:r,platform:s,rects:o,elements:a,strategy:c}=t,{boundary:l="clippingAncestors",rootBoundary:u="viewport",elementContext:d="floating",altBoundary:h=!1,padding:f=0}=$r(e,t),g=QC(f),m=a[h?d==="floating"?"reference":"floating":d],b=rr(await s.getClippingRect({element:(n=await(s.isElement==null?void 0:s.isElement(m)))==null||n?m:m.contextElement||await(s.getDocumentElement==null?void 0:s.getDocumentElement(a.floating)),boundary:l,rootBoundary:u,strategy:c})),v=d==="floating"?{...o.floating,x:i,y:r}:o.reference,T=await(s.getOffsetParent==null?void 0:s.getOffsetParent(a.floating)),E=await(s.isElement==null?void 0:s.isElement(T))?await(s.getScale==null?void 0:s.getScale(T))||{x:1,y:1}:{x:1,y:1},k=rr(s.convertOffsetParentRelativeRectToViewportRelativeRect?await s.convertOffsetParentRelativeRectToViewportRelativeRect({elements:a,rect:v,offsetParent:T,strategy:c}):v);return{top:(b.top-k.top+g.top)/E.y,bottom:(k.bottom-b.bottom+g.bottom)/E.y,left:(b.left-k.left+g.left)/E.x,right:(k.right-b.right+g.right)/E.x}}const ZC=function(t){return t===void 0&&(t={}),{name:"flip",options:t,async fn(e){var n,i;const{placement:r,middlewareData:s,rects:o,initialPlacement:a,platform:c,elements:l}=e,{mainAxis:u=!0,crossAxis:d=!0,fallbackPlacements:h,fallbackStrategy:f="bestFit",fallbackAxisSideDirection:g="none",flipAlignment:m=!0,...b}=$r(t,e);if((n=s.arrow)!=null&&n.alignmentOffset)return{};const v=Gt(r),T=Gt(a)===a,E=await(c.isRTL==null?void 0:c.isRTL(l.floating)),k=h||(T||!m?[ir(a)]:zC(a));!h&&g!=="none"&&k.push(...JC(a,m,g,E));const y=[a,...k],C=await ff(e,b),x=[];let _=((i=s.flip)==null?void 0:i.overflows)||[];if(u&&x.push(C[v]),d){const B=HC(r,o,E);x.push(C[B[0]],C[B[1]])}if(_=[..._,{placement:r,overflows:x}],!x.every(B=>B<=0)){var A,N;const B=(((A=s.flip)==null?void 0:A.index)||0)+1,K=y[B];if(K)return{data:{index:B,overflows:_},reset:{placement:K}};let Q=(N=_.filter(ie=>ie.overflows[0]<=0).sort((ie,Ne)=>ie.overflows[1]-Ne.overflows[1])[0])==null?void 0:N.placement;if(!Q)switch(f){case"bestFit":{var M;const ie=(M=_.map(Ne=>[Ne.placement,Ne.overflows.filter(Ge=>Ge>0).reduce((Ge,At)=>Ge+At,0)]).sort((Ne,Ge)=>Ne[1]-Ge[1])[0])==null?void 0:M[0];ie&&(Q=ie);break}case"initialPlacement":Q=a;break}if(r!==Q)return{reset:{placement:Q}}}return{}}}};async function eT(t,e){const{placement:n,platform:i,elements:r}=t,s=await(i.isRTL==null?void 0:i.isRTL(r.floating)),o=Gt(n),a=Gr(n),c=Wr(n)==="y",l=["left","top"].includes(o)?-1:1,u=s&&c?-1:1,d=$r(e,t);let{mainAxis:h,crossAxis:f,alignmentAxis:g}=typeof d=="number"?{mainAxis:d,crossAxis:0,alignmentAxis:null}:{mainAxis:0,crossAxis:0,alignmentAxis:null,...d};return a&&typeof g=="number"&&(f=a==="end"?g*-1:g),c?{x:f*u,y:h*l}:{x:h*l,y:f*u}}const tT=function(t){return t===void 0&&(t=0),{name:"offset",options:t,async fn(e){var n,i;const{x:r,y:s,placement:o,middlewareData:a}=e,c=await eT(e,t);return o===((n=a.offset)==null?void 0:n.placement)&&(i=a.arrow)!=null&&i.alignmentOffset?{}:{x:r+c.x,y:s+c.y,data:{...c,placement:o}}}}},nT=function(t){return t===void 0&&(t={}),{name:"shift",options:t,async fn(e){const{x:n,y:i,placement:r}=e,{mainAxis:s=!0,crossAxis:o=!1,limiter:a={fn:b=>{let{x:v,y:T}=b;return{x:v,y:T}}},...c}=$r(t,e),l={x:n,y:i},u=await ff(e,c),d=Wr(Gt(r)),h=uf(d);let f=l[h],g=l[d];if(s){const b=h==="y"?"top":"left",v=h==="y"?"bottom":"right",T=f+u[b],E=f-u[v];f=Al(T,f,E)}if(o){const b=d==="y"?"top":"left",v=d==="y"?"bottom":"right",T=g+u[b],E=g-u[v];g=Al(T,g,E)}const m=a.fn({...e,[h]:f,[d]:g});return{...m,data:{x:m.x-n,y:m.y-i}}}}};function qr(){return typeof window<"u"}function wn(t){return pf(t)?(t.nodeName||"").toLowerCase():"#document"}function _e(t){var e;return(t==null||(e=t.ownerDocument)==null?void 0:e.defaultView)||window}function vt(t){var e;return(e=(pf(t)?t.ownerDocument:t.document)||window.document)==null?void 0:e.documentElement}function pf(t){return qr()?t instanceof Node||t instanceof _e(t).Node:!1}function Ye(t){return qr()?t instanceof Element||t instanceof _e(t).Element:!1}function ot(t){return qr()?t instanceof HTMLElement||t instanceof _e(t).HTMLElement:!1}function Ml(t){return!qr()||typeof ShadowRoot>"u"?!1:t instanceof ShadowRoot||t instanceof _e(t).ShadowRoot}function hi(t){const{overflow:e,overflowX:n,overflowY:i,display:r}=Qe(t);return/auto|scroll|overlay|hidden|clip/.test(e+i+n)&&!["inline","contents"].includes(r)}function iT(t){return["table","td","th"].includes(wn(t))}function Hr(t){return[":popover-open",":modal"].some(e=>{try{return t.matches(e)}catch{return!1}})}function ka(t){const e=Sa(),n=Ye(t)?Qe(t):t;return n.transform!=="none"||n.perspective!=="none"||(n.containerType?n.containerType!=="normal":!1)||!e&&(n.backdropFilter?n.backdropFilter!=="none":!1)||!e&&(n.filter?n.filter!=="none":!1)||["transform","perspective","filter"].some(i=>(n.willChange||"").includes(i))||["paint","layout","strict","content"].some(i=>(n.contain||"").includes(i))}function rT(t){let e=Ot(t);for(;ot(e)&&!vn(e);){if(ka(e))return e;if(Hr(e))return null;e=Ot(e)}return null}function Sa(){return typeof CSS>"u"||!CSS.supports?!1:CSS.supports("-webkit-backdrop-filter","none")}function vn(t){return["html","body","#document"].includes(wn(t))}function Qe(t){return _e(t).getComputedStyle(t)}function zr(t){return Ye(t)?{scrollLeft:t.scrollLeft,scrollTop:t.scrollTop}:{scrollLeft:t.scrollX,scrollTop:t.scrollY}}function Ot(t){if(wn(t)==="html")return t;const e=t.assignedSlot||t.parentNode||Ml(t)&&t.host||vt(t);return Ml(e)?e.host:e}function mf(t){const e=Ot(t);return vn(e)?t.ownerDocument?t.ownerDocument.body:t.body:ot(e)&&hi(e)?e:mf(e)}function bo(t,e,n){var i;e===void 0&&(e=[]),n===void 0&&(n=!0);const r=mf(t),s=r===((i=t.ownerDocument)==null?void 0:i.body),o=_e(r);if(s){const a=yo(o);return e.concat(o,o.visualViewport||[],hi(r)?r:[],a&&n?bo(a):[])}return e.concat(r,bo(r,[],n))}function yo(t){return t.parent&&Object.getPrototypeOf(t.parent)?t.frameElement:null}function gf(t){const e=Qe(t);let n=parseFloat(e.width)||0,i=parseFloat(e.height)||0;const r=ot(t),s=r?t.offsetWidth:n,o=r?t.offsetHeight:i,a=nr(n)!==s||nr(i)!==o;return a&&(n=s,i=o),{width:n,height:i,$:a}}function vf(t){return Ye(t)?t:t.contextElement}function cn(t){const e=vf(t);if(!ot(e))return Dt(1);const n=e.getBoundingClientRect(),{width:i,height:r,$:s}=gf(e);let o=(s?nr(n.width):n.width)/i,a=(s?nr(n.height):n.height)/r;return(!o||!Number.isFinite(o))&&(o=1),(!a||!Number.isFinite(a))&&(a=1),{x:o,y:a}}const sT=Dt(0);function bf(t){const e=_e(t);return!Sa()||!e.visualViewport?sT:{x:e.visualViewport.offsetLeft,y:e.visualViewport.offsetTop}}function oT(t,e,n){return e===void 0&&(e=!1),!n||e&&n!==_e(t)?!1:e}function ai(t,e,n,i){e===void 0&&(e=!1),n===void 0&&(n=!1);const r=t.getBoundingClientRect(),s=vf(t);let o=Dt(1);e&&(i?Ye(i)&&(o=cn(i)):o=cn(t));const a=oT(s,n,i)?bf(s):Dt(0);let c=(r.left+a.x)/o.x,l=(r.top+a.y)/o.y,u=r.width/o.x,d=r.height/o.y;if(s){const h=_e(s),f=i&&Ye(i)?_e(i):i;let g=h,m=yo(g);for(;m&&i&&f!==g;){const b=cn(m),v=m.getBoundingClientRect(),T=Qe(m),E=v.left+(m.clientLeft+parseFloat(T.paddingLeft))*b.x,k=v.top+(m.clientTop+parseFloat(T.paddingTop))*b.y;c*=b.x,l*=b.y,u*=b.x,d*=b.y,c+=E,l+=k,g=_e(m),m=yo(g)}}return rr({width:u,height:d,x:c,y:l})}function aT(t){let{elements:e,rect:n,offsetParent:i,strategy:r}=t;const s=r==="fixed",o=vt(i),a=e?Hr(e.floating):!1;if(i===o||a&&s)return n;let c={scrollLeft:0,scrollTop:0},l=Dt(1);const u=Dt(0),d=ot(i);if((d||!d&&!s)&&((wn(i)!=="body"||hi(o))&&(c=zr(i)),ot(i))){const h=ai(i);l=cn(i),u.x=h.x+i.clientLeft,u.y=h.y+i.clientTop}return{width:n.width*l.x,height:n.height*l.y,x:n.x*l.x-c.scrollLeft*l.x+u.x,y:n.y*l.y-c.scrollTop*l.y+u.y}}function cT(t){return Array.from(t.getClientRects())}function ko(t,e){const n=zr(t).scrollLeft;return e?e.left+n:ai(vt(t)).left+n}function lT(t){const e=vt(t),n=zr(t),i=t.ownerDocument.body,r=an(e.scrollWidth,e.clientWidth,i.scrollWidth,i.clientWidth),s=an(e.scrollHeight,e.clientHeight,i.scrollHeight,i.clientHeight);let o=-n.scrollLeft+ko(t);const a=-n.scrollTop;return Qe(i).direction==="rtl"&&(o+=an(e.clientWidth,i.clientWidth)-r),{width:r,height:s,x:o,y:a}}function uT(t,e){const n=_e(t),i=vt(t),r=n.visualViewport;let s=i.clientWidth,o=i.clientHeight,a=0,c=0;if(r){s=r.width,o=r.height;const l=Sa();(!l||l&&e==="fixed")&&(a=r.offsetLeft,c=r.offsetTop)}return{width:s,height:o,x:a,y:c}}function dT(t,e){const n=ai(t,!0,e==="fixed"),i=n.top+t.clientTop,r=n.left+t.clientLeft,s=ot(t)?cn(t):Dt(1),o=t.clientWidth*s.x,a=t.clientHeight*s.y,c=r*s.x,l=i*s.y;return{width:o,height:a,x:c,y:l}}function Ll(t,e,n){let i;if(e==="viewport")i=uT(t,n);else if(e==="document")i=lT(vt(t));else if(Ye(e))i=dT(e,n);else{const r=bf(t);i={...e,x:e.x-r.x,y:e.y-r.y}}return rr(i)}function yf(t,e){const n=Ot(t);return n===e||!Ye(n)||vn(n)?!1:Qe(n).position==="fixed"||yf(n,e)}function hT(t,e){const n=e.get(t);if(n)return n;let i=bo(t,[],!1).filter(a=>Ye(a)&&wn(a)!=="body"),r=null;const s=Qe(t).position==="fixed";let o=s?Ot(t):t;for(;Ye(o)&&!vn(o);){const a=Qe(o),c=ka(o);!c&&a.position==="fixed"&&(r=null),(s?!c&&!r:!c&&a.position==="static"&&r&&["absolute","fixed"].includes(r.position)||hi(o)&&!c&&yf(t,o))?i=i.filter(l=>l!==o):r=a,o=Ot(o)}return e.set(t,i),i}function fT(t){let{element:e,boundary:n,rootBoundary:i,strategy:r}=t;const s=[...n==="clippingAncestors"?Hr(e)?[]:hT(e,this._c):[].concat(n),i],o=s[0],a=s.reduce((c,l)=>{const u=Ll(e,l,r);return c.top=an(u.top,c.top),c.right=go(u.right,c.right),c.bottom=go(u.bottom,c.bottom),c.left=an(u.left,c.left),c},Ll(e,o,r));return{width:a.right-a.left,height:a.bottom-a.top,x:a.left,y:a.top}}function pT(t){const{width:e,height:n}=gf(t);return{width:e,height:n}}function mT(t,e,n){const i=ot(e),r=vt(e),s=n==="fixed",o=ai(t,!0,s,e);let a={scrollLeft:0,scrollTop:0};const c=Dt(0);if(i||!i&&!s)if((wn(e)!=="body"||hi(r))&&(a=zr(e)),i){const f=ai(e,!0,s,e);c.x=f.x+e.clientLeft,c.y=f.y+e.clientTop}else r&&(c.x=ko(r));let l=0,u=0;if(r&&!i&&!s){const f=r.getBoundingClientRect();u=f.top+a.scrollTop,l=f.left+a.scrollLeft-ko(r,f)}const d=o.left+a.scrollLeft-c.x-l,h=o.top+a.scrollTop-c.y-u;return{x:d,y:h,width:o.width,height:o.height}}function Is(t){return Qe(t).position==="static"}function Ul(t,e){if(!ot(t)||Qe(t).position==="fixed")return null;if(e)return e(t);let n=t.offsetParent;return vt(t)===n&&(n=n.ownerDocument.body),n}function kf(t,e){const n=_e(t);if(Hr(t))return n;if(!ot(t)){let r=Ot(t);for(;r&&!vn(r);){if(Ye(r)&&!Is(r))return r;r=Ot(r)}return n}let i=Ul(t,e);for(;i&&iT(i)&&Is(i);)i=Ul(i,e);return i&&vn(i)&&Is(i)&&!ka(i)?n:i||rT(t)||n}const gT=async function(t){const e=this.getOffsetParent||kf,n=this.getDimensions,i=await n(t.floating);return{reference:mT(t.reference,await e(t.floating),t.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}};function vT(t){return Qe(t).direction==="rtl"}const bT={convertOffsetParentRelativeRectToViewportRelativeRect:aT,getDocumentElement:vt,getClippingRect:fT,getOffsetParent:kf,getElementRects:gT,getClientRects:cT,getDimensions:pT,getScale:cn,isElement:Ye,isRTL:vT},yT=tT,kT=nT,ST=ZC,CT=(t,e,n)=>{const i=new Map,r={platform:bT,...n},s={...r.platform,_c:i};return XC(t,e,{...r,platform:s})};var Fn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Sf(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Cf={exports:{}};(function(t){(function(e,n){t.exports?t.exports=n():e.log=n()})(Fn,function(){var e=function(){},n="undefined",i=typeof window!==n&&typeof window.navigator!==n&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},o=null;function a(m,b){var v=m[b];if(typeof v.bind=="function")return v.bind(m);try{return Function.prototype.bind.call(v,m)}catch{return function(){return Function.prototype.apply.apply(v,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===n?!1:m==="trace"&&i?c:console[m]!==void 0?a(console,m):console.log!==void 0?a(console,"log"):e}function u(){for(var m=this.getLevel(),b=0;b<r.length;b++){var v=r[b];this[v]=b<m?e:this.methodFactory(v,m,this.name)}if(this.log=this.debug,typeof console===n&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==n&&(u.call(this),this[m].apply(this,arguments))}}function h(m,b,v){return l(m)||d.apply(this,arguments)}function f(m,b){var v=this,T,E,k,y="loglevel";typeof m=="string"?y+=":"+m:typeof m=="symbol"&&(y=void 0);function C(M){var B=(r[M]||"silent").toUpperCase();if(!(typeof window===n||!y)){try{window.localStorage[y]=B;return}catch{}try{window.document.cookie=encodeURIComponent(y)+"="+B+";"}catch{}}}function x(){var M;if(!(typeof window===n||!y)){try{M=window.localStorage[y]}catch{}if(typeof M===n)try{var B=window.document.cookie,K=encodeURIComponent(y),Q=B.indexOf(K+"=");Q!==-1&&(M=/^([^;]+)/.exec(B.slice(Q+K.length+1))[1])}catch{}return v.levels[M]===void 0&&(M=void 0),M}}function _(){if(!(typeof window===n||!y)){try{window.localStorage.removeItem(y)}catch{}try{window.document.cookie=encodeURIComponent(y)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function A(M){var B=M;if(typeof B=="string"&&v.levels[B.toUpperCase()]!==void 0&&(B=v.levels[B.toUpperCase()]),typeof B=="number"&&B>=0&&B<=v.levels.SILENT)return B;throw new TypeError("log.setLevel() called with invalid level: "+M)}v.name=m,v.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},v.methodFactory=b||h,v.getLevel=function(){return k??E??T},v.setLevel=function(M,B){return k=A(M),B!==!1&&C(k),u.call(v)},v.setDefaultLevel=function(M){E=A(M),x()||v.setLevel(M,!1)},v.resetLevel=function(){k=null,_(),u.call(v)},v.enableAll=function(M){v.setLevel(v.levels.TRACE,M)},v.disableAll=function(M){v.setLevel(v.levels.SILENT,M)},v.rebuild=function(){if(o!==v&&(T=A(o.getLevel())),u.call(v),o===v)for(var M in s)s[M].rebuild()},T=A(o?o.getLevel():"WARN");var N=x();N!=null&&(k=A(N)),u.call(v)}o=new f,o.getLogger=function(m){if(typeof m!="symbol"&&typeof m!="string"||m==="")throw new TypeError("You must supply a name when creating a logger.");var b=s[m];return b||(b=s[m]=new f(m,o.methodFactory)),b};var g=typeof window!==n?window.log:void 0;return o.noConflict=function(){return typeof window!==n&&window.log===o&&(window.log=g),o},o.getLoggers=function(){return s},o.default=o,o})})(Cf);var TT=Cf.exports;const ET=Sf(TT);var So=function(t,e){return So=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(n[r]=i[r])},So(t,e)};function bt(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");So(t,e);function n(){this.constructor=t}t.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}function wT(t,e,n,i){function r(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(u){try{l(i.next(u))}catch(d){o(d)}}function c(u){try{l(i.throw(u))}catch(d){o(d)}}function l(u){u.done?s(u.value):r(u.value).then(a,c)}l((i=i.apply(t,[])).next())})}function Tf(t,e){var n={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,r,s,o=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(u){return c([l,u])}}function c(l){if(i)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(n=0)),n;)try{if(i=1,r&&(s=l[0]&2?r.return:l[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,l[1])).done)return s;switch(r=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return n.label++,{value:l[1],done:!1};case 5:n.label++,r=l[1],l=[0];continue;case 7:l=n.ops.pop(),n.trys.pop();continue;default:if(s=n.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){n=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){n.label=l[1];break}if(l[0]===6&&n.label<s[1]){n.label=s[1],s=l;break}if(s&&n.label<s[2]){n.label=s[2],n.ops.push(l);break}s[2]&&n.ops.pop(),n.trys.pop();continue}l=e.call(t,n)}catch(u){l=[6,u],r=0}finally{i=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function bn(t){var e=typeof Symbol=="function"&&Symbol.iterator,n=e&&t[e],i=0;if(n)return n.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function yn(t,e){var n=typeof Symbol=="function"&&t[Symbol.iterator];if(!n)return t;var i=n.call(t),r,s=[],o;try{for(;(e===void 0||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(a){o={error:a}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s}function ci(t,e,n){if(arguments.length===2)for(var i=0,r=e.length,s;i<r;i++)(s||!(i in e))&&(s||(s=Array.prototype.slice.call(e,0,i)),s[i]=e[i]);return t.concat(s||Array.prototype.slice.call(e))}function ln(t){return this instanceof ln?(this.v=t,this):new ln(t)}function PT(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=n.apply(t,e||[]),r,s=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",o),r[Symbol.asyncIterator]=function(){return this},r;function o(f){return function(g){return Promise.resolve(g).then(f,d)}}function a(f,g){i[f]&&(r[f]=function(m){return new Promise(function(b,v){s.push([f,m,b,v])>1||c(f,m)})},g&&(r[f]=g(r[f])))}function c(f,g){try{l(i[f](g))}catch(m){h(s[0][3],m)}}function l(f){f.value instanceof ln?Promise.resolve(f.value.v).then(u,d):h(s[0][2],f)}function u(f){c("next",f)}function d(f){c("throw",f)}function h(f,g){f(g),s.shift(),s.length&&c(s[0][0],s[0][1])}}function xT(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator],n;return e?e.call(t):(t=typeof bn=="function"?bn(t):t[Symbol.iterator](),n={},i("next"),i("throw"),i("return"),n[Symbol.asyncIterator]=function(){return this},n);function i(s){n[s]=t[s]&&function(o){return new Promise(function(a,c){o=t[s](o),r(a,c,o.done,o.value)})}}function r(s,o,a,c){Promise.resolve(c).then(function(l){s({value:l,done:a})},o)}}function Z(t){return typeof t=="function"}function Ca(t){var e=function(i){Error.call(i),i.stack=new Error().stack},n=t(e);return n.prototype=Object.create(Error.prototype),n.prototype.constructor=n,n}var Ds=Ca(function(t){return function(e){t(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(n,i){return i+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function sr(t,e){if(t){var n=t.indexOf(e);0<=n&&t.splice(n,1)}}var fi=function(){function t(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return t.prototype.unsubscribe=function(){var e,n,i,r,s;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var a=bn(o),c=a.next();!c.done;c=a.next()){var l=c.value;l.remove(this)}}catch(m){e={error:m}}finally{try{c&&!c.done&&(n=a.return)&&n.call(a)}finally{if(e)throw e.error}}else o.remove(this);var u=this.initialTeardown;if(Z(u))try{u()}catch(m){s=m instanceof Ds?m.errors:[m]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var h=bn(d),f=h.next();!f.done;f=h.next()){var g=f.value;try{Fl(g)}catch(m){s=s??[],m instanceof Ds?s=ci(ci([],yn(s)),yn(m.errors)):s.push(m)}}}catch(m){i={error:m}}finally{try{f&&!f.done&&(r=h.return)&&r.call(h)}finally{if(i)throw i.error}}}if(s)throw new Ds(s)}},t.prototype.add=function(e){var n;if(e&&e!==this)if(this.closed)Fl(e);else{if(e instanceof t){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(n=this._finalizers)!==null&&n!==void 0?n:[]).push(e)}},t.prototype._hasParent=function(e){var n=this._parentage;return n===e||Array.isArray(n)&&n.includes(e)},t.prototype._addParent=function(e){var n=this._parentage;this._parentage=Array.isArray(n)?(n.push(e),n):n?[n,e]:e},t.prototype._removeParent=function(e){var n=this._parentage;n===e?this._parentage=null:Array.isArray(n)&&sr(n,e)},t.prototype.remove=function(e){var n=this._finalizers;n&&sr(n,e),e instanceof t&&e._removeParent(this)},t.EMPTY=function(){var e=new t;return e.closed=!0,e}(),t}(),Ef=fi.EMPTY;function wf(t){return t instanceof fi||t&&"closed"in t&&Z(t.remove)&&Z(t.add)&&Z(t.unsubscribe)}function Fl(t){Z(t)?t():t.unsubscribe()}var Pf={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},RT={setTimeout:function(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return setTimeout.apply(void 0,ci([t,e],yn(n)))},clearTimeout:function(t){return clearTimeout(t)},delegate:void 0};function xf(t){RT.setTimeout(function(){throw t})}function Co(){}function ji(t){t()}var Ta=function(t){bt(e,t);function e(n){var i=t.call(this)||this;return i.isStopped=!1,n?(i.destination=n,wf(n)&&n.add(i)):i.destination=_T,i}return e.create=function(n,i,r){return new To(n,i,r)},e.prototype.next=function(n){this.isStopped||this._next(n)},e.prototype.error=function(n){this.isStopped||(this.isStopped=!0,this._error(n))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(n){this.destination.next(n)},e.prototype._error=function(n){try{this.destination.error(n)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(fi),IT=Function.prototype.bind;function Os(t,e){return IT.call(t,e)}var DT=function(){function t(e){this.partialObserver=e}return t.prototype.next=function(e){var n=this.partialObserver;if(n.next)try{n.next(e)}catch(i){Ti(i)}},t.prototype.error=function(e){var n=this.partialObserver;if(n.error)try{n.error(e)}catch(i){Ti(i)}else Ti(e)},t.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(n){Ti(n)}},t}(),To=function(t){bt(e,t);function e(n,i,r){var s=t.call(this)||this,o;if(Z(n)||!n)o={next:n??void 0,error:i??void 0,complete:r??void 0};else{var a;s&&Pf.useDeprecatedNextContext?(a=Object.create(n),a.unsubscribe=function(){return s.unsubscribe()},o={next:n.next&&Os(n.next,a),error:n.error&&Os(n.error,a),complete:n.complete&&Os(n.complete,a)}):o=n}return s.destination=new DT(o),s}return e}(Ta);function Ti(t){xf(t)}function OT(t){throw t}var _T={closed:!0,next:Co,error:OT,complete:Co},Ea=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function wa(t){return t}function AT(t){return t.length===0?wa:t.length===1?t[0]:function(e){return t.reduce(function(n,i){return i(n)},e)}}var Se=function(){function t(e){e&&(this._subscribe=e)}return t.prototype.lift=function(e){var n=new t;return n.source=this,n.operator=e,n},t.prototype.subscribe=function(e,n,i){var r=this,s=MT(e)?e:new To(e,n,i);return ji(function(){var o=r,a=o.operator,c=o.source;s.add(a?a.call(s,c):c?r._subscribe(s):r._trySubscribe(s))}),s},t.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(n){e.error(n)}},t.prototype.forEach=function(e,n){var i=this;return n=Bl(n),new n(function(r,s){var o=new To({next:function(a){try{e(a)}catch(c){s(c),o.unsubscribe()}},error:s,complete:r});i.subscribe(o)})},t.prototype._subscribe=function(e){var n;return(n=this.source)===null||n===void 0?void 0:n.subscribe(e)},t.prototype[Ea]=function(){return this},t.prototype.pipe=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return AT(e)(this)},t.prototype.toPromise=function(e){var n=this;return e=Bl(e),new e(function(i,r){var s;n.subscribe(function(o){return s=o},function(o){return r(o)},function(){return i(s)})})},t.create=function(e){return new t(e)},t}();function Bl(t){var e;return(e=t??Pf.Promise)!==null&&e!==void 0?e:Promise}function NT(t){return t&&Z(t.next)&&Z(t.error)&&Z(t.complete)}function MT(t){return t&&t instanceof Ta||NT(t)&&wf(t)}function LT(t){return Z(t==null?void 0:t.lift)}function ct(t){return function(e){if(LT(e))return e.lift(function(n){try{return t(n,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function gt(t,e,n,i,r){return new UT(t,e,n,i,r)}var UT=function(t){bt(e,t);function e(n,i,r,s,o,a){var c=t.call(this,n)||this;return c.onFinalize=o,c.shouldUnsubscribe=a,c._next=i?function(l){try{i(l)}catch(u){n.error(u)}}:t.prototype._next,c._error=s?function(l){try{s(l)}catch(u){n.error(u)}finally{this.unsubscribe()}}:t.prototype._error,c._complete=r?function(){try{r()}catch(l){n.error(l)}finally{this.unsubscribe()}}:t.prototype._complete,c}return e.prototype.unsubscribe=function(){var n;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;t.prototype.unsubscribe.call(this),!i&&((n=this.onFinalize)===null||n===void 0||n.call(this))}},e}(Ta),FT=Ca(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),kn=function(t){bt(e,t);function e(){var n=t.call(this)||this;return n.closed=!1,n.currentObservers=null,n.observers=[],n.isStopped=!1,n.hasError=!1,n.thrownError=null,n}return e.prototype.lift=function(n){var i=new jl(this,this);return i.operator=n,i},e.prototype._throwIfClosed=function(){if(this.closed)throw new FT},e.prototype.next=function(n){var i=this;ji(function(){var r,s;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var o=bn(i.currentObservers),a=o.next();!a.done;a=o.next()){var c=a.value;c.next(n)}}catch(l){r={error:l}}finally{try{a&&!a.done&&(s=o.return)&&s.call(o)}finally{if(r)throw r.error}}}})},e.prototype.error=function(n){var i=this;ji(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=n;for(var r=i.observers;r.length;)r.shift().error(n)}})},e.prototype.complete=function(){var n=this;ji(function(){if(n._throwIfClosed(),!n.isStopped){n.isStopped=!0;for(var i=n.observers;i.length;)i.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var n;return((n=this.observers)===null||n===void 0?void 0:n.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(n){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,n)},e.prototype._subscribe=function(n){return this._throwIfClosed(),this._checkFinalizedStatuses(n),this._innerSubscribe(n)},e.prototype._innerSubscribe=function(n){var i=this,r=this,s=r.hasError,o=r.isStopped,a=r.observers;return s||o?Ef:(this.currentObservers=null,a.push(n),new fi(function(){i.currentObservers=null,sr(a,n)}))},e.prototype._checkFinalizedStatuses=function(n){var i=this,r=i.hasError,s=i.thrownError,o=i.isStopped;r?n.error(s):o&&n.complete()},e.prototype.asObservable=function(){var n=new Se;return n.source=this,n},e.create=function(n,i){return new jl(n,i)},e}(Se),jl=function(t){bt(e,t);function e(n,i){var r=t.call(this)||this;return r.destination=n,r.source=i,r}return e.prototype.next=function(n){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.next)===null||r===void 0||r.call(i,n)},e.prototype.error=function(n){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.error)===null||r===void 0||r.call(i,n)},e.prototype.complete=function(){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.complete)===null||i===void 0||i.call(n)},e.prototype._subscribe=function(n){var i,r;return(r=(i=this.source)===null||i===void 0?void 0:i.subscribe(n))!==null&&r!==void 0?r:Ef},e}(kn),BT=function(t){bt(e,t);function e(n){var i=t.call(this)||this;return i._value=n,i}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(n){var i=t.prototype._subscribe.call(this,n);return!i.closed&&n.next(this._value),i},e.prototype.getValue=function(){var n=this,i=n.hasError,r=n.thrownError,s=n._value;if(i)throw r;return this._throwIfClosed(),s},e.prototype.next=function(n){t.prototype.next.call(this,this._value=n)},e}(kn),jT={now:function(){return Date.now()},delegate:void 0},VT=function(t){bt(e,t);function e(n,i){return t.call(this)||this}return e.prototype.schedule=function(n,i){return this},e}(fi),Vl={setInterval:function(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return setInterval.apply(void 0,ci([t,e],yn(n)))},clearInterval:function(t){return clearInterval(t)},delegate:void 0},$T=function(t){bt(e,t);function e(n,i){var r=t.call(this,n,i)||this;return r.scheduler=n,r.work=i,r.pending=!1,r}return e.prototype.schedule=function(n,i){var r;if(i===void 0&&(i=0),this.closed)return this;this.state=n;var s=this.id,o=this.scheduler;return s!=null&&(this.id=this.recycleAsyncId(o,s,i)),this.pending=!0,this.delay=i,this.id=(r=this.id)!==null&&r!==void 0?r:this.requestAsyncId(o,this.id,i),this},e.prototype.requestAsyncId=function(n,i,r){return r===void 0&&(r=0),Vl.setInterval(n.flush.bind(n,this),r)},e.prototype.recycleAsyncId=function(n,i,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return i;i!=null&&Vl.clearInterval(i)},e.prototype.execute=function(n,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(n,i);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(n,i){var r=!1,s;try{this.work(n)}catch(o){r=!0,s=o||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),s},e.prototype.unsubscribe=function(){if(!this.closed){var n=this,i=n.id,r=n.scheduler,s=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,sr(s,this),i!=null&&(this.id=this.recycleAsyncId(r,i,null)),this.delay=null,t.prototype.unsubscribe.call(this)}},e}(VT),$l=function(){function t(e,n){n===void 0&&(n=t.now),this.schedulerActionCtor=e,this.now=n}return t.prototype.schedule=function(e,n,i){return n===void 0&&(n=0),new this.schedulerActionCtor(this,e).schedule(i,n)},t.now=jT.now,t}(),GT=function(t){bt(e,t);function e(n,i){i===void 0&&(i=$l.now);var r=t.call(this,n,i)||this;return r.actions=[],r._active=!1,r}return e.prototype.flush=function(n){var i=this.actions;if(this._active){i.push(n);return}var r;this._active=!0;do if(r=n.execute(n.state,n.delay))break;while(n=i.shift());if(this._active=!1,r){for(;n=i.shift();)n.unsubscribe();throw r}},e}($l),WT=new GT($T);function qT(t){return t&&Z(t.schedule)}function HT(t){return t[t.length-1]}function Pa(t){return qT(HT(t))?t.pop():void 0}var xa=function(t){return t&&typeof t.length=="number"&&typeof t!="function"};function Rf(t){return Z(t==null?void 0:t.then)}function If(t){return Z(t[Ea])}function Df(t){return Symbol.asyncIterator&&Z(t==null?void 0:t[Symbol.asyncIterator])}function Of(t){return new TypeError("You provided "+(t!==null&&typeof t=="object"?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function zT(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var _f=zT();function Af(t){return Z(t==null?void 0:t[_f])}function Nf(t){return PT(this,arguments,function(){var e,n,i,r;return Tf(this,function(s){switch(s.label){case 0:e=t.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,ln(e.read())];case 3:return n=s.sent(),i=n.value,r=n.done,r?[4,ln(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,ln(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function Mf(t){return Z(t==null?void 0:t.getReader)}function _t(t){if(t instanceof Se)return t;if(t!=null){if(If(t))return KT(t);if(xa(t))return JT(t);if(Rf(t))return YT(t);if(Df(t))return Lf(t);if(Af(t))return QT(t);if(Mf(t))return XT(t)}throw Of(t)}function KT(t){return new Se(function(e){var n=t[Ea]();if(Z(n.subscribe))return n.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function JT(t){return new Se(function(e){for(var n=0;n<t.length&&!e.closed;n++)e.next(t[n]);e.complete()})}function YT(t){return new Se(function(e){t.then(function(n){e.closed||(e.next(n),e.complete())},function(n){return e.error(n)}).then(null,xf)})}function QT(t){return new Se(function(e){var n,i;try{for(var r=bn(t),s=r.next();!s.done;s=r.next()){var o=s.value;if(e.next(o),e.closed)return}}catch(a){n={error:a}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(n)throw n.error}}e.complete()})}function Lf(t){return new Se(function(e){ZT(t,e).catch(function(n){return e.error(n)})})}function XT(t){return Lf(Nf(t))}function ZT(t,e){var n,i,r,s;return wT(this,void 0,void 0,function(){var o,a;return Tf(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),n=xT(t),c.label=1;case 1:return[4,n.next()];case 2:if(i=c.sent(),!!i.done)return[3,4];if(o=i.value,e.next(o),e.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=c.sent(),r={error:a},[3,11];case 6:return c.trys.push([6,,9,10]),i&&!i.done&&(s=n.return)?[4,s.call(n)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function xt(t,e,n,i,r){i===void 0&&(i=0),r===void 0&&(r=!1);var s=e.schedule(function(){n(),r?t.add(this.schedule(null,i)):this.unsubscribe()},i);if(t.add(s),!r)return s}function Uf(t,e){return e===void 0&&(e=0),ct(function(n,i){n.subscribe(gt(i,function(r){return xt(i,t,function(){return i.next(r)},e)},function(){return xt(i,t,function(){return i.complete()},e)},function(r){return xt(i,t,function(){return i.error(r)},e)}))})}function Ff(t,e){return e===void 0&&(e=0),ct(function(n,i){i.add(t.schedule(function(){return n.subscribe(i)},e))})}function eE(t,e){return _t(t).pipe(Ff(e),Uf(e))}function tE(t,e){return _t(t).pipe(Ff(e),Uf(e))}function nE(t,e){return new Se(function(n){var i=0;return e.schedule(function(){i===t.length?n.complete():(n.next(t[i++]),n.closed||this.schedule())})})}function iE(t,e){return new Se(function(n){var i;return xt(n,e,function(){i=t[_f](),xt(n,e,function(){var r,s,o;try{r=i.next(),s=r.value,o=r.done}catch(a){n.error(a);return}o?n.complete():n.next(s)},0,!0)}),function(){return Z(i==null?void 0:i.return)&&i.return()}})}function Bf(t,e){if(!t)throw new Error("Iterable cannot be null");return new Se(function(n){xt(n,e,function(){var i=t[Symbol.asyncIterator]();xt(n,e,function(){i.next().then(function(r){r.done?n.complete():n.next(r.value)})},0,!0)})})}function rE(t,e){return Bf(Nf(t),e)}function sE(t,e){if(t!=null){if(If(t))return eE(t,e);if(xa(t))return nE(t,e);if(Rf(t))return tE(t,e);if(Df(t))return Bf(t,e);if(Af(t))return iE(t,e);if(Mf(t))return rE(t,e)}throw Of(t)}function jf(t,e){return e?sE(t,e):_t(t)}function Gl(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Pa(t);return jf(t,n)}function oE(t){return t instanceof Date&&!isNaN(t)}var aE=Ca(function(t){return function(e){e===void 0&&(e=null),t(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=e}});function cE(t,e){var n=oE(t)?{first:t}:typeof t=="number"?{each:t}:t,i=n.first,r=n.each,s=n.with,o=s===void 0?lE:s,a=n.scheduler,c=a===void 0?WT:a,l=n.meta,u=l===void 0?null:l;if(i==null&&r==null)throw new TypeError("No timeout provided.");return ct(function(d,h){var f,g,m=null,b=0,v=function(T){g=xt(h,c,function(){try{f.unsubscribe(),_t(o({meta:u,lastValue:m,seen:b})).subscribe(h)}catch(E){h.error(E)}},T)};f=d.subscribe(gt(h,function(T){g==null||g.unsubscribe(),b++,h.next(m=T),r>0&&v(r)},void 0,void 0,function(){g!=null&&g.closed||g==null||g.unsubscribe(),m=null})),!b&&v(i!=null?typeof i=="number"?i:+i-c.now():r)})}function lE(t){throw new aE(t)}function ge(t,e){return ct(function(n,i){var r=0;n.subscribe(gt(i,function(s){i.next(t.call(e,s,r++))}))})}var uE=Array.isArray;function dE(t,e){return uE(e)?t.apply(void 0,ci([],yn(e))):t(e)}function hE(t){return ge(function(e){return dE(t,e)})}function fE(t,e,n,i,r,s,o,a){var c=[],l=0,u=0,d=!1,h=function(){d&&!c.length&&!l&&e.complete()},f=function(m){return l<i?g(m):c.push(m)},g=function(m){l++;var b=!1;_t(n(m,u++)).subscribe(gt(e,function(v){e.next(v)},function(){b=!0},void 0,function(){if(b)try{l--;for(var v=function(){var T=c.shift();o||g(T)};c.length&&l<i;)v();h()}catch(T){e.error(T)}}))};return t.subscribe(gt(e,f,function(){d=!0,h()})),function(){}}function Ra(t,e,n){return n===void 0&&(n=1/0),Z(e)?Ra(function(i,r){return ge(function(s,o){return e(i,s,r,o)})(_t(t(i,r)))},n):(typeof e=="number"&&(n=e),ct(function(i,r){return fE(i,r,t,n)}))}function pE(t){return Ra(wa,t)}function mE(){return pE(1)}function or(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return mE()(jf(t,Pa(t)))}var gE=["addListener","removeListener"],vE=["addEventListener","removeEventListener"],bE=["on","off"];function Eo(t,e,n,i){if(Z(n)&&(i=n,n=void 0),i)return Eo(t,e,n).pipe(hE(i));var r=yn(SE(t)?vE.map(function(a){return function(c){return t[a](e,c,n)}}):yE(t)?gE.map(Wl(t,e)):kE(t)?bE.map(Wl(t,e)):[],2),s=r[0],o=r[1];if(!s&&xa(t))return Ra(function(a){return Eo(a,e,n)})(_t(t));if(!s)throw new TypeError("Invalid event target");return new Se(function(a){var c=function(){for(var l=[],u=0;u<arguments.length;u++)l[u]=arguments[u];return a.next(1<l.length?l:l[0])};return s(c),function(){return o(c)}})}function Wl(t,e){return function(n){return function(i){return t[n](e,i)}}}function yE(t){return Z(t.addListener)&&Z(t.removeListener)}function kE(t){return Z(t.on)&&Z(t.off)}function SE(t){return Z(t.addEventListener)&&Z(t.removeEventListener)}function Vf(t,e){return ct(function(n,i){var r=0;n.subscribe(gt(i,function(s){return t.call(e,s,r++)&&i.next(s)}))})}function CE(t,e){return e===void 0&&(e=wa),t=t??TE,ct(function(n,i){var r,s=!0;n.subscribe(gt(i,function(o){var a=e(o);(s||!t(r,a))&&(s=!1,r=a,i.next(o))}))})}function TE(t,e){return t===e}function EE(t){return ct(function(e,n){try{e.subscribe(n)}finally{n.add(t)}})}function wE(t){return ct(function(e,n){var i=!1,r=gt(n,function(){r==null||r.unsubscribe(),i=!0},Co);_t(t).subscribe(r),e.subscribe(gt(n,function(s){return i&&n.next(s)}))})}function Xe(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Pa(t);return ct(function(i,r){(n?or(t,i,n):or(t,i)).subscribe(r)})}var PE=Object.defineProperty,ql=Object.getOwnPropertySymbols,xE=Object.prototype.hasOwnProperty,RE=Object.prototype.propertyIsEnumerable,Hl=(t,e,n)=>e in t?PE(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,zl=(t,e)=>{for(var n in e||(e={}))xE.call(e,n)&&Hl(t,n,e[n]);if(ql)for(var n of ql(e))RE.call(e,n)&&Hl(t,n,e[n]);return t},Ht=(t,e,n)=>new Promise((i,r)=>{var s=c=>{try{a(n.next(c))}catch(l){r(l)}},o=c=>{try{a(n.throw(c))}catch(l){r(l)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,o);a((n=n.apply(t,e)).next())}),$f="lk";function we(t){return typeof t>"u"?!1:IE(t)||DE(t)}function IE(t){var e;return t?t.hasOwnProperty("participant")&&t.hasOwnProperty("source")&&t.hasOwnProperty("track")&&typeof((e=t.publication)==null?void 0:e.track)<"u":!1}function DE(t){return t?t.hasOwnProperty("participant")&&t.hasOwnProperty("source")&&t.hasOwnProperty("publication")&&typeof t.publication<"u":!1}function li(t){return t?t.hasOwnProperty("participant")&&t.hasOwnProperty("source")&&typeof t.publication>"u":!1}function ke(t){if(typeof t=="string"||typeof t=="number")return`${t}`;if(li(t))return`${t.participant.identity}_${t.source}_placeholder`;if(we(t))return`${t.participant.identity}_${t.publication.source}_${t.publication.trackSid}`;throw new Error(`Can't generate a id for the given track reference: ${t}`)}function Gf(t,e){return typeof e>"u"?!1:we(t)?e.some(n=>n.participant.identity===t.participant.identity&&we(n)&&n.publication.trackSid===t.publication.trackSid):li(t)?e.some(n=>n.participant.identity===t.participant.identity&&li(n)&&n.source===t.source):!1}function OE(t,e){return li(t)&&we(e)&&e.participant.identity===t.participant.identity&&e.source===t.source}function Wf(t){return t instanceof si}function _E(t,e){return Ht(this,null,function*(){const{x:n,y:i}=yield CT(t,e,{placement:"top",middleware:[yT(6),ST(),kT({padding:5})]});return{x:n,y:i}})}function AE(t,e){return!t.contains(e.target)}var NE=[I.ConnectionStateChanged,I.RoomMetadataChanged,I.ActiveSpeakersChanged,I.ConnectionQualityChanged,I.ParticipantConnected,I.ParticipantDisconnected,I.ParticipantPermissionsChanged,I.ParticipantMetadataChanged,I.ParticipantNameChanged,I.ParticipantAttributesChanged,I.TrackMuted,I.TrackUnmuted,I.TrackPublished,I.TrackUnpublished,I.TrackStreamStateChanged,I.TrackSubscriptionFailed,I.TrackSubscriptionPermissionChanged,I.TrackSubscriptionStatusChanged],ME=[...NE,I.LocalTrackPublished,I.LocalTrackUnpublished];D.TrackPublished,D.TrackUnpublished,D.TrackMuted,D.TrackUnmuted,D.TrackStreamStateChanged,D.TrackSubscribed,D.TrackUnsubscribed,D.TrackSubscriptionPermissionChanged,D.TrackSubscriptionFailed,D.LocalTrackPublished,D.LocalTrackUnpublished;var LE=[D.ConnectionQualityChanged,D.IsSpeakingChanged,D.ParticipantMetadataChanged,D.ParticipantPermissionsChanged,D.TrackMuted,D.TrackUnmuted,D.TrackPublished,D.TrackUnpublished,D.TrackStreamStateChanged,D.TrackSubscriptionFailed,D.TrackSubscriptionPermissionChanged,D.TrackSubscriptionStatusChanged];[...LE,D.LocalTrackPublished,D.LocalTrackUnpublished];var W=ET.getLogger("lk-components-js");W.setDefaultLevel("WARN");var UE=[{columns:1,rows:1},{columns:1,rows:2,orientation:"portrait"},{columns:2,rows:1,orientation:"landscape"},{columns:2,rows:2,minWidth:560},{columns:3,rows:3,minWidth:700},{columns:4,rows:4,minWidth:960},{columns:5,rows:5,minWidth:1100}];function qf(t,e,n,i){if(t.length<1)throw new Error("At least one grid layout definition must be provided.");const r=FE(t);if(n<=0||i<=0)return r[0];let s=0;const o=n/i>1?"landscape":"portrait";let a=r.find((c,l,u)=>{s=l;const d=u.findIndex((h,f)=>{const g=!h.orientation||h.orientation===o,m=f>l,b=h.maxTiles===c.maxTiles;return m&&b&&g})!==-1;return c.maxTiles>=e&&!d});if(a===void 0)if(a=r[r.length-1],a)W.warn(`No layout found for: participantCount: ${e}, width/height: ${n}/${i} fallback to biggest available layout (${a}).`);else throw new Error("No layout or fallback layout found.");if((n<a.minWidth||i<a.minHeight)&&s>0){const c=r[s-1];a=qf(r.slice(0,s),c.maxTiles,n,i)}return a}function FE(t){return[...t].map(e=>{var n,i;return{name:`${e.columns}x${e.rows}`,columns:e.columns,rows:e.rows,maxTiles:e.columns*e.rows,minWidth:(n=e.minWidth)!=null?n:0,minHeight:(i=e.minHeight)!=null?i:0,orientation:e.orientation}}).sort((e,n)=>e.maxTiles!==n.maxTiles?e.maxTiles-n.maxTiles:e.minWidth!==0||n.minWidth!==0?e.minWidth-n.minWidth:e.minHeight!==0||n.minHeight!==0?e.minHeight-n.minHeight:0)}function BE(){return typeof navigator<"u"&&navigator.mediaDevices&&!!navigator.mediaDevices.getDisplayMedia}function Hf(t){return typeof t=="object"}function zf(t){return Array.isArray(t)&&t.filter(Hf).length>0}function jE(t,e){return e.audioLevel-t.audioLevel}function VE(t,e){return t.isSpeaking===e.isSpeaking?0:t.isSpeaking?-1:1}function $E(t,e){var n,i,r,s;return t.lastSpokeAt!==void 0||e.lastSpokeAt!==void 0?((i=(n=e.lastSpokeAt)==null?void 0:n.getTime())!=null?i:0)-((s=(r=t.lastSpokeAt)==null?void 0:r.getTime())!=null?s:0):0}function wo(t,e){var n,i,r,s;return((i=(n=t.joinedAt)==null?void 0:n.getTime())!=null?i:0)-((s=(r=e.joinedAt)==null?void 0:r.getTime())!=null?s:0)}function GE(t,e){return we(t)?we(e)?0:-1:we(e)?1:0}function WE(t,e){const n=t.participant.isCameraEnabled,i=e.participant.isCameraEnabled;return n!==i?n?-1:1:0}function qE(t){const e=[],n=[],i=[],r=[];t.forEach(a=>{a.participant.isLocal&&a.source===P.Source.Camera?e.push(a):a.source===P.Source.ScreenShare?n.push(a):a.source===P.Source.Camera?i.push(a):r.push(a)});const s=HE(n),o=zE(i);return[...e,...s,...o,...r]}function HE(t){const e=[],n=[];return t.forEach(i=>{i.participant.isLocal?e.push(i):n.push(i)}),e.sort((i,r)=>wo(i.participant,r.participant)),n.sort((i,r)=>wo(i.participant,r.participant)),[...n,...e]}function zE(t){const e=[],n=[];return t.forEach(i=>{i.participant.isLocal?e.push(i):n.push(i)}),n.sort((i,r)=>i.participant.isSpeaking&&r.participant.isSpeaking?jE(i.participant,r.participant):i.participant.isSpeaking!==r.participant.isSpeaking?VE(i.participant,r.participant):i.participant.lastSpokeAt!==r.participant.lastSpokeAt?$E(i.participant,r.participant):we(i)!==we(r)?GE(i,r):i.participant.isCameraEnabled!==r.participant.isCameraEnabled?WE(i,r):wo(i.participant,r.participant)),[...e,...n]}function KE(t,e){return t.reduce((n,i,r)=>r%e===0?[...n,[i]]:[...n.slice(0,-1),[...n.slice(-1)[0],i]],[])}function Kl(t,e){const n=Math.max(t.length,e.length);return new Array(n).fill([]).map((i,r)=>[t[r],e[r]])}function ar(t,e,n){return t.filter(i=>!e.map(r=>n(r)).includes(n(i)))}function Po(t){return t.map(e=>typeof e=="string"||typeof e=="number"?`${e}`:ke(e))}function JE(t,e){return{dropped:ar(t,e,ke),added:ar(e,t,ke)}}function YE(t){return t.added.length!==0||t.dropped.length!==0}function xo(t,e){const n=e.findIndex(i=>ke(i)===ke(t));if(n===-1)throw new Error(`Element not part of the array: ${ke(t)} not in ${Po(e)}`);return n}function QE(t,e,n){const i=xo(t,n),r=xo(e,n);return n.splice(i,1,e),n.splice(r,1,t),n}function XE(t,e){const n=xo(t,e);return e.splice(n,1),e}function ZE(t,e){return[...e,t]}function _s(t,e){return KE(t,e)}function ew(t,e,n){let i=tw(t,e);if(i.length<e.length){const o=ar(e,i,ke);i=[...i,...o]}const r=_s(i,n),s=_s(e,n);if(Kl(r,s).forEach(([o,a],c)=>{if(o&&a){const l=_s(i,n)[c],u=JE(l,a);YE(u)&&(W.debug(`Detected visual changes on page: ${c}, current: ${Po(o)}, next: ${Po(a)}`,{changes:u}),u.added.length===u.dropped.length&&Kl(u.added,u.dropped).forEach(([d,h])=>{if(d&&h)i=QE(d,h,i);else throw new Error(`For a swap action we need a addition and a removal one is missing: ${d}, ${h}`)}),u.added.length===0&&u.dropped.length>0&&u.dropped.forEach(d=>{i=XE(d,i)}),u.added.length>0&&u.dropped.length===0&&u.added.forEach(d=>{i=ZE(d,i)}))}}),i.length>e.length){const o=ar(i,e,ke);i=i.filter(a=>!o.map(ke).includes(ke(a)))}return i}function tw(t,e){return t.map(n=>e.find(r=>ke(n)===ke(r)||typeof n!="number"&&li(n)&&we(r)&&OE(n,r))??n)}function Pe(t){return`${$f}-${t}`}function nw(t){const e=Ro(t),n=Kf(t.participant).pipe(ge(()=>Ro(t)),Xe(e));return{className:Pe(t.source===P.Source.Camera||t.source===P.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:n}}function Ro(t){if(we(t))return t.publication;{const{source:e,name:n,participant:i}=t;if(e&&n)return i.getTrackPublications().find(r=>r.source===e&&r.trackName===n);if(n)return i.getTrackPublicationByName(n);if(e)return i.getTrackPublication(e);throw new Error("At least one of source and name needs to be defined")}}function Ia(t,...e){return new Se(n=>{const i=()=>{n.next(t)};return e.forEach(r=>{t.on(r,i)}),()=>{e.forEach(r=>{t.off(r,i)})}}).pipe(Xe(t))}function Da(t,e){return new Se(n=>{const i=(...r)=>{n.next(r)};return t.on(e,i),()=>{t.off(e,i)}})}function iw(t){return Da(t,I.ConnectionStateChanged).pipe(ge(([e])=>e),Xe(t.state))}function rw(t,e,n=!0){var i;const r=()=>Ht(this,null,function*(){try{const a=yield tr.getLocalDevices(t,n);s.next(a)}catch(a){e==null||e(a)}}),s=new kn,o=s.pipe(EE(()=>{var a;(a=navigator==null?void 0:navigator.mediaDevices)==null||a.removeEventListener("devicechange",r)}));if(typeof window<"u"){if(!window.isSecureContext)throw new Error("Accessing media devices is available only in secure contexts (HTTPS and localhost), in some or all supporting browsers. See: https://developer.mozilla.org/en-US/docs/Web/API/Navigator/mediaDevices");(i=navigator==null?void 0:navigator.mediaDevices)==null||i.addEventListener("devicechange",r)}return or(tr.getLocalDevices(t,n).catch(a=>(e==null||e(a),[])),o)}function sw(t){return Ia(t,I.AudioPlaybackStatusChanged).pipe(ge(e=>({canPlayAudio:e.canPlaybackAudio})))}function ow(t){return Ia(t,I.VideoPlaybackStatusChanged).pipe(ge(e=>({canPlayVideo:e.canPlaybackVideo})))}function aw(t,e){return Da(t,I.ActiveDeviceChanged).pipe(Vf(([n])=>n===e),ge(([n,i])=>(W.debug("activeDeviceObservable | RoomEvent.ActiveDeviceChanged",{kind:n,deviceId:i}),i)))}function cw(t,e){return Da(t,I.ParticipantEncryptionStatusChanged).pipe(Vf(([,n])=>(e==null?void 0:e.identity)===(n==null?void 0:n.identity)||!n&&(e==null?void 0:e.identity)===t.localParticipant.identity),ge(([n])=>n),Xe(e instanceof si?e.isE2EEEnabled:!!(e!=null&&e.isEncrypted)))}function Oa(t,...e){return new Se(n=>{const i=()=>{n.next(t)};return e.forEach(r=>{t.on(r,i)}),()=>{e.forEach(r=>{t.off(r,i)})}}).pipe(Xe(t))}function Kf(t){return Oa(t,D.TrackMuted,D.TrackUnmuted,D.ParticipantPermissionsChanged,D.TrackPublished,D.TrackUnpublished,D.LocalTrackPublished,D.LocalTrackUnpublished,D.MediaDevicesError,D.TrackSubscriptionStatusChanged).pipe(ge(e=>{const{isMicrophoneEnabled:n,isCameraEnabled:i,isScreenShareEnabled:r}=e,s=e.getTrackPublication(P.Source.Microphone),o=e.getTrackPublication(P.Source.Camera);return{isCameraEnabled:i,isMicrophoneEnabled:n,isScreenShareEnabled:r,cameraTrack:o,microphoneTrack:s,participant:e}}))}function lw(t){return t?Oa(t,D.ParticipantMetadataChanged,D.ParticipantNameChanged).pipe(ge(({name:e,identity:n,metadata:i})=>({name:e,identity:n,metadata:i})),Xe({name:t.name,identity:t.identity,metadata:t.metadata})):void 0}function uw(t){return _a(t,D.ConnectionQualityChanged).pipe(ge(([e])=>e),Xe(t.connectionQuality))}function _a(t,e){return new Se(n=>{const i=(...r)=>{n.next(r)};return t.on(e,i),()=>{t.off(e,i)}})}function Jf(t){var e,n,i,r;return Oa(t.participant,D.TrackMuted,D.TrackUnmuted,D.TrackSubscribed,D.TrackUnsubscribed,D.LocalTrackPublished,D.LocalTrackUnpublished).pipe(ge(s=>{var o,a;const c=(o=t.publication)!=null?o:s.getTrackPublication(t.source);return(a=c==null?void 0:c.isMuted)!=null?a:!0}),Xe((r=(i=(e=t.publication)==null?void 0:e.isMuted)!=null?i:(n=t.participant.getTrackPublication(t.source))==null?void 0:n.isMuted)!=null?r:!0))}function dw(t){return _a(t,D.IsSpeakingChanged).pipe(ge(([e])=>e))}function hw(t){return _a(t,D.ParticipantPermissionsChanged).pipe(ge(()=>t.permissions),Xe(t.permissions))}function fw(t,e,n,i,r){const{localParticipant:s}=e,o=(u,d)=>{let h=!1;switch(u){case P.Source.Camera:h=d.isCameraEnabled;break;case P.Source.Microphone:h=d.isMicrophoneEnabled;break;case P.Source.ScreenShare:h=d.isScreenShareEnabled;break}return h},a=Kf(s).pipe(ge(u=>o(t,u.participant)),Xe(o(t,s))),c=new kn,l=(u,d)=>Ht(this,null,function*(){try{switch(d??(d=n),c.next(!0),t){case P.Source.Camera:return yield s.setCameraEnabled(u??!s.isCameraEnabled,d,i),s.isCameraEnabled;case P.Source.Microphone:return yield s.setMicrophoneEnabled(u??!s.isMicrophoneEnabled,d,i),s.isMicrophoneEnabled;case P.Source.ScreenShare:return yield s.setScreenShareEnabled(u??!s.isScreenShareEnabled,d,i),s.isScreenShareEnabled;default:throw new TypeError("Tried to toggle unsupported source")}}catch(h){if(r&&h instanceof Error){r==null||r(h);return}else throw h}finally{c.next(!1)}});return{className:Pe("button"),toggle:l,enabledObserver:a,pendingObserver:c.asObservable()}}function pw(){let t=!1;const e=new kn,n=new kn,i=r=>Ht(this,null,function*(){n.next(!0),t=r??!t,e.next(t),n.next(!1)});return{className:Pe("button"),toggle:i,enabledObserver:e.asObservable(),pendingObserver:n.asObservable()}}function mw(t,e,n){const i=new BT(void 0),r=e?aw(e,t):i.asObservable(),s=(o,...a)=>Ht(this,[o,...a],function*(c,l={}){var u,d,h;if(e){W.debug(`Switching active device of kind "${t}" with id ${c}.`),yield e.switchActiveDevice(t,c,l.exact);const f=(u=e.getActiveDevice(t))!=null?u:c;f!==c&&c!=="default"&&W.info(`We tried to select the device with id (${c}), but the browser decided to select the device with id (${f}) instead.`);let g;t==="audioinput"?g=(d=e.localParticipant.getTrackPublication(P.Source.Microphone))==null?void 0:d.track:t==="videoinput"&&(g=(h=e.localParticipant.getTrackPublication(P.Source.Camera))==null?void 0:h.track);const m=c==="default"&&!g||c==="default"&&(g==null?void 0:g.mediaStreamTrack.label.startsWith("Default"));i.next(m?c:f)}else if(n){yield n.setDeviceId(l.exact?{exact:c}:c);const f=yield n.getDeviceId();i.next(c==="default"&&n.mediaStreamTrack.label.startsWith("Default")?c:f)}else i.value!==c&&(W.warn("device switch skipped, please provide either a room or a local track to switch on. "),i.next(c))});return{className:Pe("media-device-select"),activeDeviceObservable:r,setActiveMediaDevice:s}}function gw(t){const e=n=>{t.disconnect(n)};return{className:Pe("disconnect-button"),disconnect:e}}function vw(t){const e=Pe("connection-quality"),n=uw(t);return{className:e,connectionQualityObserver:n}}function bw(t){let e="track-muted-indicator-camera";switch(t.source){case P.Source.Camera:e="track-muted-indicator-camera";break;case P.Source.Microphone:e="track-muted-indicator-microphone";break}const n=Pe(e),i=Jf(t);return{className:n,mediaMutedObserver:i}}function yw(t){return{className:"lk-participant-name",infoObserver:lw(t)}}function kw(){return{className:Pe("participant-tile")}}new TextEncoder;new TextDecoder;function Sw(){const t=e=>Ht(this,null,function*(){W.info("Start Audio for room: ",e),yield e.startAudio()});return{className:Pe("start-audio-button"),roomAudioPlaybackAllowedObservable:sw,handleStartAudioPlayback:t}}function Cw(){const t=e=>Ht(this,null,function*(){W.info("Start Video for room: ",e),yield e.startVideo()});return{className:Pe("start-audio-button"),roomVideoPlaybackAllowedObservable:ow,handleStartVideoPlayback:t}}function Tw(){return{className:[Pe("button"),Pe("chat-toggle")].join(" ")}}function Ew(){return{className:[Pe("button"),Pe("focus-toggle-button")].join(" ")}}function ww(){return{className:"lk-room-container"}}function Jl(t,e,n=!0){const i=[t.localParticipant,...Array.from(t.remoteParticipants.values())],r=[];return i.forEach(s=>{e.forEach(o=>{const a=Array.from(s.trackPublications.values()).filter(c=>c.source===o&&(!n||c.track)).map(c=>({participant:s,publication:c,source:c.source}));r.push(...a)})}),{trackReferences:r,participants:i}}function Pw(t,e,n){var i,r;const s=(i=n.additionalRoomEvents)!=null?i:ME,o=(r=n.onlySubscribed)!=null?r:!0,a=Array.from(new Set([I.ParticipantConnected,I.ParticipantDisconnected,I.ConnectionStateChanged,I.LocalTrackPublished,I.LocalTrackUnpublished,I.TrackPublished,I.TrackUnpublished,I.TrackSubscriptionStatusChanged,...s]).values());return Ia(t,...a).pipe(ge(c=>{const l=Jl(c,e,o);return W.debug(`TrackReference[] was updated. (length ${l.trackReferences.length})`,l),l}),Xe(Jl(t,e,o)))}function xw(t,e=1e3){if(t===null)return Gl(!1);const n=Eo(t,"mousemove",{passive:!0}).pipe(ge(()=>!0)),i=n.pipe(cE({each:e,with:()=>or(Gl(!1),i.pipe(wE(n)))}),CE());return i}function Rw(t,e){if(typeof localStorage>"u"){W.error("Local storage is not available.");return}try{if(e){const n=Object.fromEntries(Object.entries(e).filter(([,i])=>i!==""));localStorage.setItem(t,JSON.stringify(n))}}catch(n){W.error(`Error setting item to local storage: ${n}`)}}function Iw(t){if(typeof localStorage>"u"){W.error("Local storage is not available.");return}try{const e=localStorage.getItem(t);if(!e){W.warn(`Item with key ${t} does not exist in local storage.`);return}return JSON.parse(e)}catch(e){W.error(`Error getting item from local storage: ${e}`);return}}function Dw(t){return{load:()=>Iw(t),save:e=>Rw(t,e)}}var Ow=`${$f}-user-choices`,Ln={videoEnabled:!0,audioEnabled:!0,videoDeviceId:"",audioDeviceId:"",username:""},{load:_w,save:Aw}=Dw(Ow);function Nw(t,e=!1){e!==!0&&Aw(t)}function Mw(t,e=!1){var n,i,r,s,o;const a={videoEnabled:(n=t==null?void 0:t.videoEnabled)!=null?n:Ln.videoEnabled,audioEnabled:(i=t==null?void 0:t.audioEnabled)!=null?i:Ln.audioEnabled,videoDeviceId:(r=t==null?void 0:t.videoDeviceId)!=null?r:Ln.videoDeviceId,audioDeviceId:(s=t==null?void 0:t.audioDeviceId)!=null?s:Ln.audioDeviceId,username:(o=t==null?void 0:t.username)!=null?o:Ln.username};if(e)return a;{const c=_w();return zl(zl({},a),c??{})}}const Aa=p.createContext(void 0);function Yf(){const t=p.useContext(Aa);if(!t)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return t}function Na(){return p.useContext(Aa)}const Ma=p.createContext(void 0);function Kr(){return p.useContext(Ma)}function Pn(t){const e=Kr(),n=t??e;if(!n)throw new Error("No TrackRef, make sure you are inside a TrackRefContext or pass the TrackRef explicitly");return n}const Qf=p.createContext(void 0);function Xf(){return p.useContext(Qf)}function pi(t){const e=Xf(),n=Kr(),i=t??e??(n==null?void 0:n.participant);if(!i)throw new Error("No participant provided, make sure you are inside a participant context or pass the participant explicitly");return i}const La=p.createContext(void 0);function Ua(){const t=p.useContext(La);if(!t)throw Error("tried to access room context outside of livekit room component");return t}function Jr(){return p.useContext(La)}function mi(t){const e=Jr(),n=t??e;if(!n)throw new Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return n}const Zf=p.createContext(void 0);function Lw(t){return p.useContext(Zf)}function ep(t){var e,n,i="";if(typeof t=="string"||typeof t=="number")i+=t;else if(typeof t=="object")if(Array.isArray(t)){var r=t.length;for(e=0;e<r;e++)t[e]&&(n=ep(t[e]))&&(i&&(i+=" "),i+=n)}else for(n in t)t[n]&&(i&&(i+=" "),i+=n);return i}function tp(){for(var t,e,n=0,i="",r=arguments.length;n<r;n++)(t=arguments[n])&&(e=ep(t))&&(i&&(i+=" "),i+=e);return i}function Uw(...t){return(...e)=>{for(const n of t)if(typeof n=="function")try{n(...e)}catch(i){console.error(i)}}}function lt(...t){const e={...t[0]};for(let n=1;n<t.length;n++){const i=t[n];for(const r in i){const s=e[r],o=i[r];typeof s=="function"&&typeof o=="function"&&r[0]==="o"&&r[1]==="n"&&r.charCodeAt(2)>=65&&r.charCodeAt(2)<=90?e[r]=Uw(s,o):(r==="className"||r==="UNSAFE_className")&&typeof s=="string"&&typeof o=="string"?e[r]=tp(s,o):e[r]=o!==void 0?o:s}}return e}const Fw={connect:!0,audio:!1,video:!1};function Bw(t){const{token:e,serverUrl:n,options:i,room:r,connectOptions:s,connect:o,audio:a,video:c,screen:l,onConnected:u,onDisconnected:d,onError:h,onMediaDeviceFailure:f,onEncryptionError:g,simulateParticipants:m,...b}={...Fw,...t};i&&r&&W.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[v,T]=p.useState();p.useEffect(()=>{T(r??new tr(i))},[r]);const E=p.useMemo(()=>{const{className:k}=ww();return lt(b,{className:k})},[b]);return p.useEffect(()=>{if(!v)return;const k=()=>{const x=v.localParticipant;W.debug("trying to publish local tracks"),Promise.all([x.setMicrophoneEnabled(!!a,typeof a!="boolean"?a:void 0),x.setCameraEnabled(!!c,typeof c!="boolean"?c:void 0),x.setScreenShareEnabled(!!l,typeof l!="boolean"?l:void 0)]).catch(_=>{W.warn(_),h==null||h(_)})},y=x=>{const _=ni.getFailure(x);f==null||f(_)},C=x=>{g==null||g(x)};return v.on(I.SignalConnected,k).on(I.MediaDevicesError,y).on(I.EncryptionError,C),()=>{v.off(I.SignalConnected,k).off(I.MediaDevicesError,y).off(I.EncryptionError,C)}},[v,a,c,l,h,g,f]),p.useEffect(()=>{if(v){if(m){v.simulateParticipants({participants:{count:m},publish:{audio:!0,useRealTracks:!0}});return}if(!e){W.debug("no token yet");return}if(!n){W.warn("no livekit url provided"),h==null||h(Error("no livekit url provided"));return}o?(W.debug("connecting"),v.connect(n,e,s).catch(k=>{W.warn(k),h==null||h(k)})):(W.debug("disconnecting because connect is false"),v.disconnect())}},[o,e,JSON.stringify(s),v,h,n,m]),p.useEffect(()=>{if(!v)return;const k=y=>{switch(y){case G.Disconnected:d&&d();break;case G.Connected:u&&u();break}};return v.on(I.ConnectionStateChanged,k),()=>{v.off(I.ConnectionStateChanged,k)}},[e,u,d,v]),p.useEffect(()=>{if(v)return()=>{W.info("disconnecting on onmount"),v.disconnect()}},[v]),{room:v,htmlProps:E}}const jw=p.forwardRef(function(t,e){const{room:n,htmlProps:i}=Bw(t);return p.createElement("div",{ref:e,...i},n&&p.createElement(La.Provider,{value:n},p.createElement(Zf.Provider,{value:t.featureFlags},t.children)))}),Vw=t=>{const e=p.useRef(t);return p.useEffect(()=>{e.current=t}),e};function $w(t,e){const n=Ww(),i=Vw(e);return p.useLayoutEffect(()=>{let r=!1;const s=t.current;if(!s)return;function o(a,c){r||i.current(a,c)}return n==null||n.subscribe(s,o),()=>{r=!0,n==null||n.unsubscribe(s,o)}},[t.current,n,i]),n==null?void 0:n.observer}function Gw(){let t=!1,e=[];const n=new Map;if(typeof window>"u")return;const i=new ResizeObserver((r,s)=>{e=e.concat(r),t||window.requestAnimationFrame(()=>{const o=new Set;for(let a=0;a<e.length;a++){if(o.has(e[a].target))continue;o.add(e[a].target);const c=n.get(e[a].target);c==null||c.forEach(l=>l(e[a],s))}e=[],t=!1}),t=!0});return{observer:i,subscribe(r,s){i.observe(r);const o=n.get(r)??[];o.push(s),n.set(r,o)},unsubscribe(r,s){const o=n.get(r)??[];if(o.length===1){i.unobserve(r),n.delete(r);return}const a=o.indexOf(s);a!==-1&&o.splice(a,1),n.set(r,o)}}}let Yl;const Ww=()=>Yl||(Yl=Gw()),qw=t=>{const[e,n]=p.useState({width:0,height:0});p.useLayoutEffect(()=>{if(t.current){const{width:r,height:s}=t.current.getBoundingClientRect();n({width:r,height:s})}},[t.current]);const i=p.useCallback(r=>n(r.contentRect),[]);return $w(t,i),e};function Ve(t,e,n=!0){const[i,r]=p.useState(e);return p.useEffect(()=>{if(n&&r(e),typeof window>"u"||!t)return;const s=t.subscribe(r);return()=>s.unsubscribe()},[t,n]),i}function Hw(t){const e=s=>typeof window<"u"?window.matchMedia(s).matches:!1,[n,i]=p.useState(e(t));function r(){i(e(t))}return p.useEffect(()=>{const s=window.matchMedia(t);return r(),s.addListener?s.addListener(r):s.addEventListener("change",r),()=>{s.removeListener?s.removeListener(r):s.removeEventListener("change",r)}},[t]),n}function zw(t={}){const e=pi(t.participant),{className:n,connectionQualityObserver:i}=p.useMemo(()=>vw(e),[e]),r=Ve(i,Ue.Unknown);return{className:n,quality:r}}function Kw(t){const e=mi(t),n=p.useMemo(()=>iw(e),[e]);return Ve(n,e.state)}function Jw(t){const e=Ua(),n=Kw(e);return{buttonProps:p.useMemo(()=>{const{className:i,disconnect:r}=gw(e);return lt(t,{className:i,onClick:()=>r(t.stopTracks??!0),disabled:n===G.Disconnected})},[e,t,n])}}function Yw(t){if(t.publication instanceof ri){const e=t.publication.track;if(e){const{facingMode:n}=jC(e);return n}}return"undefined"}function Qw({trackRef:t,props:e}){const n=Pn(t),i=Na(),{className:r}=p.useMemo(()=>Ew(),[]),s=p.useMemo(()=>Gf(n,i==null?void 0:i.pin.state),[n,i==null?void 0:i.pin.state]);return{mergedProps:p.useMemo(()=>lt(e,{className:r,onClick:o=>{var a,c,l,u,d;(a=e.onClick)==null||a.call(e,o),s?(l=i==null?void 0:(c=i.pin).dispatch)==null||l.call(c,{msg:"clear_pin"}):(d=i==null?void 0:(u=i.pin).dispatch)==null||d.call(u,{msg:"set_pin",trackReference:n})}}),[e,r,n,s,i==null?void 0:i.pin]),inFocus:s}}function Xw(t,e,n={}){const i=n.gridLayouts??UE,{width:r,height:s}=qw(t),o=qf(i,e,r,s);return p.useEffect(()=>{t.current&&o&&(t.current.style.setProperty("--lk-col-count",o==null?void 0:o.columns.toString()),t.current.style.setProperty("--lk-row-count",o==null?void 0:o.rows.toString()))},[t,o]),{layout:o,containerWidth:r,containerHeight:s}}function Ql(t,e={}){var n,i;const r=typeof t=="string"?e.participant:t.participant,s=pi(r),o=typeof t=="string"?{participant:s,source:t}:t,[a,c]=p.useState(!!((n=o.publication)!=null&&n.isMuted||(i=s.getTrackPublication(o.source))!=null&&i.isMuted));return p.useEffect(()=>{const l=Jf(o).subscribe(c);return()=>l.unsubscribe()},[ke(o)]),a}function Zw(t){const e=pi(t),n=p.useMemo(()=>dw(e),[e]);return Ve(n,e.isSpeaking)}function eP(){const t=Ua(),e=p.useMemo(()=>hw(t.localParticipant),[t]);return Ve(e,t.localParticipant.permissions)}function tP({kind:t,room:e,track:n,requestPermissions:i,onError:r}){const s=Jr(),o=p.useMemo(()=>rw(t,r,i),[t,i,r]),a=Ve(o,[]),[c,l]=p.useState((s==null?void 0:s.getActiveDevice(t))??""),{className:u,activeDeviceObservable:d,setActiveMediaDevice:h}=p.useMemo(()=>mw(t,e??s,n),[t,e,s,n]);return p.useEffect(()=>{const f=d.subscribe(g=>{g&&g!==c&&(W.info("setCurrentDeviceId",g),l(g))});return()=>{f==null||f.unsubscribe()}},[d]),{devices:a,className:u,activeDeviceId:c,setActiveMediaDevice:h}}function nP(t,e,n={}){const i=p.useRef([]),r=p.useRef(-1),s=e!==r.current,o=typeof n.customSortFunction=="function"?n.customSortFunction(t):qE(t);let a=[...o];if(s===!1)try{a=ew(i.current,o,e)}catch(c){W.error("Error while running updatePages(): ",c)}return s?i.current=o:i.current=a,r.current=e,a}function iP(t,e){const[n,i]=p.useState(1),r=Math.max(Math.ceil(e.length/t),1);n>r&&i(r);const s=n*t,o=s-t,a=u=>{i(d=>u==="next"?d===r?d:d+1:d===1?d:d-1)},c=u=>{u>r?i(r):u<1?i(1):i(u)},l=nP(e,t).slice(o,s);return{totalPageCount:r,nextPage:()=>a("next"),prevPage:()=>a("previous"),setPage:c,firstItemIndex:o,lastItemIndex:s,tracks:l,currentPage:n}}function rP({trackRef:t,onParticipantClick:e,disableSpeakingIndicator:n,htmlProps:i}){const r=Pn(t),s=p.useMemo(()=>{const{className:h}=kw();return lt(i,{className:h,onClick:f=>{var g;if((g=i.onClick)==null||g.call(i,f),typeof e=="function"){const m=r.publication??r.participant.getTrackPublication(r.source);e({participant:r.participant,track:m})}}})},[i,e,r.publication,r.source,r.participant]),o=r.participant.getTrackPublication(P.Source.Microphone),a=p.useMemo(()=>({participant:r.participant,source:P.Source.Microphone,publication:o}),[o,r.participant]),c=Ql(r),l=Ql(a),u=Zw(r.participant),d=Yw(r);return{elementProps:{"data-lk-audio-muted":l,"data-lk-video-muted":c,"data-lk-speaking":n===!0?!1:u,"data-lk-local-participant":r.participant.isLocal,"data-lk-source":r.source,"data-lk-facing-mode":d,...s}}}function sP({room:t,props:e}){const n=mi(t),{className:i,roomAudioPlaybackAllowedObservable:r,handleStartAudioPlayback:s}=p.useMemo(()=>Sw(),[]),o=p.useMemo(()=>r(n),[n,r]),{canPlayAudio:a}=Ve(o,{canPlayAudio:n.canPlaybackAudio});return{mergedProps:p.useMemo(()=>lt(e,{className:i,onClick:()=>{s(n)},style:{display:a?"none":"block"}}),[e,i,a,s,n]),canPlayAudio:a}}function oP({room:t,props:e}){const n=mi(t),{className:i,roomVideoPlaybackAllowedObservable:r,handleStartVideoPlayback:s}=p.useMemo(()=>Cw(),[]),o=p.useMemo(()=>r(n),[n,r]),{canPlayVideo:a}=Ve(o,{canPlayVideo:n.canPlaybackVideo});return{mergedProps:p.useMemo(()=>lt(e,{className:i,onClick:()=>{s(n)},style:{display:a?"none":"block"}}),[e,i,a,s,n]),canPlayVideo:a}}function aP(t,e={}){const n=p.useRef(null),i=p.useRef(null),r=e.minSwipeDistance??50,s=c=>{i.current=null,n.current=c.targetTouches[0].clientX},o=c=>{i.current=c.targetTouches[0].clientX},a=p.useCallback(()=>{if(!n.current||!i.current)return;const c=n.current-i.current,l=c>r,u=c<-r;l&&e.onLeftSwipe&&e.onLeftSwipe(),u&&e.onRightSwipe&&e.onRightSwipe()},[r,e]);p.useEffect(()=>{const c=t.current;return c&&(c.addEventListener("touchstart",s,{passive:!0}),c.addEventListener("touchmove",o,{passive:!0}),c.addEventListener("touchend",a,{passive:!0})),()=>{c&&(c.removeEventListener("touchstart",s),c.removeEventListener("touchmove",o),c.removeEventListener("touchend",a))}},[t,a])}function cP({props:t}){const{dispatch:e,state:n}=Yf().widget,{className:i}=p.useMemo(()=>Tw(),[]);return{mergedProps:p.useMemo(()=>lt(t,{className:i,onClick:()=>{e&&e({msg:"toggle_chat"})},"aria-pressed":n!=null&&n.showChat?"true":"false","data-lk-unread-msgs":n?n.unreadMessages<10?n.unreadMessages.toFixed(0):"9+":"0"}),[t,i,e,n])}}function lP(t){var e,n;const i=Pn(t),{className:r,mediaMutedObserver:s}=p.useMemo(()=>bw(i),[ke(i)]);return{isMuted:Ve(s,!!((e=i.publication)!=null&&e.isMuted||(n=i.participant.getTrackPublication(i.source))!=null&&n.isMuted)),className:r}}function uP({source:t,onChange:e,initialState:n,captureOptions:i,publishOptions:r,onDeviceError:s,...o}){var a;const c=Jr(),l=(a=c==null?void 0:c.localParticipant)==null?void 0:a.getTrackPublication(t),u=p.useRef(!1),{toggle:d,className:h,pendingObserver:f,enabledObserver:g}=p.useMemo(()=>c?fw(t,c,i,r,s):pw(),[c,t,JSON.stringify(i),r]),m=Ve(f,!1),b=Ve(g,n??!!(l!=null&&l.isEnabled));p.useEffect(()=>{e==null||e(b,u.current),u.current=!1},[b,e]),p.useEffect(()=>{n!==void 0&&(W.debug("forcing initial toggle state",t,n),d(n))},[]);const v=p.useMemo(()=>lt(o,{className:h}),[o,h]),T=p.useCallback(E=>{var k;u.current=!0,d().catch(()=>u.current=!1),(k=o.onClick)==null||k.call(o,E)},[o,d]);return{toggle:d,enabled:b,pending:m,track:l,buttonProps:{...v,"aria-pressed":b,"data-lk-source":t,"data-lk-enabled":b,disabled:m,onClick:T}}}function np(t=[P.Source.Camera,P.Source.Microphone,P.Source.ScreenShare,P.Source.ScreenShareAudio,P.Source.Unknown],e={}){const n=mi(e.room),[i,r]=p.useState([]),[s,o]=p.useState([]),a=p.useMemo(()=>t.map(c=>Hf(c)?c.source:c),[JSON.stringify(t)]);return p.useEffect(()=>{const c=Pw(n,a,{additionalRoomEvents:e.updateOnlyOn,onlySubscribed:e.onlySubscribed}).subscribe(({trackReferences:l,participants:u})=>{W.debug("setting track bundles",l,u),r(l),o(u)});return()=>c.unsubscribe()},[n,JSON.stringify(e.onlySubscribed),JSON.stringify(e.updateOnlyOn),JSON.stringify(t)]),p.useMemo(()=>{if(zf(t)){const c=hP(t,s),l=Array.from(i);return s.forEach(u=>{c.has(u.identity)&&(c.get(u.identity)??[]).forEach(d=>{if(i.find(({participant:f,publication:g})=>u.identity===f.identity&&g.source===d))return;W.debug(`Add ${d} placeholder for participant ${u.identity}.`);const h={participant:u,source:d};l.push(h)})}),l}else return i},[i,s,t])}function dP(t,e){const n=new Set(t);for(const i of e)n.delete(i);return n}function hP(t,e){const n=new Map;if(zf(t)){const i=t.filter(r=>r.withPlaceholder).map(r=>r.source);e.forEach(r=>{const s=r.getTrackPublications().map(a=>{var c;return(c=a.track)==null?void 0:c.source}).filter(a=>a!==void 0),o=Array.from(dP(new Set(i),new Set(s)));o.length>0&&n.set(r.identity,o)})}return n}function fP(t={}){const[e,n]=p.useState(Mw(t.defaults,t.preventLoad??!1)),i=p.useCallback(c=>{n(l=>({...l,audioEnabled:c}))},[]),r=p.useCallback(c=>{n(l=>({...l,videoEnabled:c}))},[]),s=p.useCallback(c=>{n(l=>({...l,audioDeviceId:c}))},[]),o=p.useCallback(c=>{n(l=>({...l,videoDeviceId:c}))},[]),a=p.useCallback(c=>{n(l=>({...l,username:c}))},[]);return p.useEffect(()=>{Nw(e,t.preventSave??!1)},[e,t.preventSave]),{userChoices:e,saveAudioInputEnabled:i,saveVideoInputEnabled:r,saveAudioInputDeviceId:s,saveVideoInputDeviceId:o,saveUsername:a}}function pP(t,e={}){const n=pi(t),i=mi(e.room),r=p.useMemo(()=>cw(i,n),[i,n]);return Ve(r,n instanceof si?n.isE2EEEnabled:!!(n!=null&&n.isEncrypted))}const mP=p.forwardRef(function(t,e){const{mergedProps:n}=cP({props:t});return p.createElement("button",{ref:e,...n},t.children)}),gP=p.forwardRef(function(t,e){const{buttonProps:n}=Jw(t);return p.createElement("button",{ref:e,...n},t.children)}),vP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...t},p.createElement("path",{d:"M1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708L11 10.293V4.5A1.5 1.5 0 0 0 9.5 3H3.707zM0 4.5a1.5 1.5 0 0 1 .943-1.393l9.532 9.533c-.262.224-.603.36-.975.36h-8A1.5 1.5 0 0 1 0 11.5z"}),p.createElement("path",{d:"m15.2 3.6-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),bP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...t},p.createElement("path",{d:"M0 4.5A1.5 1.5 0 0 1 1.5 3h8A1.5 1.5 0 0 1 11 4.5v7A1.5 1.5 0 0 1 9.5 13h-8A1.5 1.5 0 0 1 0 11.5zM15.2 3.6l-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),yP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:18,fill:"none",...t},p.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h10.5A2.75 2.75 0 0 1 16 2.75v13.594a.75.75 0 0 1-1.234.572l-3.691-3.12a1.25 1.25 0 0 0-.807-.296H2.75A2.75 2.75 0 0 1 0 10.75v-8ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v8c0 .69.56 1.25 1.25 1.25h7.518c.65 0 1.279.23 1.775.65l2.457 2.077V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),p.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5Z",clipRule:"evenodd"})),Xl=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...t},p.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M5.293 2.293a1 1 0 0 1 1.414 0l4.823 4.823a1.25 1.25 0 0 1 0 1.768l-4.823 4.823a1 1 0 0 1-1.414-1.414L9.586 8 5.293 3.707a1 1 0 0 1 0-1.414z",clipRule:"evenodd"})),kP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...t},p.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},p.createElement("path",{d:"M10 1.75h4.25m0 0V6m0-4.25L9 7M6 14.25H1.75m0 0V10m0 4.25L7 9"}))),SP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...t},p.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M8.961.894C8.875-.298 7.125-.298 7.04.894c-.066.912-1.246 1.228-1.76.472-.67-.99-2.186-.115-1.664.96.399.824-.465 1.688-1.288 1.289-1.076-.522-1.95.994-.961 1.665.756.513.44 1.693-.472 1.759-1.192.086-1.192 1.836 0 1.922.912.066 1.228 1.246.472 1.76-.99.67-.115 2.186.96 1.664.824-.399 1.688.465 1.289 1.288-.522 1.076.994 1.95 1.665.961.513-.756 1.693-.44 1.759.472.086 1.192 1.836 1.192 1.922 0 .066-.912 1.246-1.228 1.76-.472.67.99 2.186.115 1.664-.96-.399-.824.465-1.688 1.288-1.289 1.076.522 1.95-.994.961-1.665-.756-.513-.44-1.693.472-1.759 1.192-.086 1.192-1.836 0-1.922-.912-.066-1.228-1.246-.472-1.76.99-.67.115-2.186-.96-1.664-.824.399-1.688-.465-1.289-1.288.522-1.076-.994-1.95-1.665-.961-.513.756-1.693.44-1.759-.472ZM8 13A5 5 0 1 0 8 3a5 5 0 0 0 0 10Z",clipRule:"evenodd"})),CP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...t},p.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M2 2.75A2.75 2.75 0 0 1 4.75 0h6.5A2.75 2.75 0 0 1 14 2.75v10.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-.5a.75.75 0 0 1 1.5 0v.5c0 .69.56 1.25 1.25 1.25h6.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25h-6.5c-.69 0-1.25.56-1.25 1.25v.5a.75.75 0 0 1-1.5 0v-.5Z",clipRule:"evenodd"}),p.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8.78 7.47a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 1 1-1.06-1.06l.97-.97H1.75a.75.75 0 0 1 0-1.5h4.69l-.97-.97a.75.75 0 0 1 1.06-1.06l2.25 2.25Z",clipRule:"evenodd"})),TP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...t},p.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M4 6.104V4a4 4 0 1 1 8 0v2.104c1.154.326 2 1.387 2 2.646v4.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-4.5c0-1.259.846-2.32 2-2.646ZM5.5 4a2.5 2.5 0 0 1 5 0v2h-5V4Z",clipRule:"evenodd"})),EP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...t},p.createElement("path",{d:"M12.227 11.52a5.477 5.477 0 0 0 1.246-2.97.5.5 0 0 0-.995-.1 4.478 4.478 0 0 1-.962 2.359l-1.07-1.07C10.794 9.247 11 8.647 11 8V3a3 3 0 0 0-6 0v1.293L1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708zM8 12.5c.683 0 1.33-.152 1.911-.425l.743.743c-.649.359-1.378.59-2.154.66V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .995-.098A4.5 4.5 0 0 0 8 12.5z"}),p.createElement("path",{d:"M8.743 10.907 5 7.164V8a3 3 0 0 0 3.743 2.907z"})),wP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...t},p.createElement("path",{fillRule:"evenodd",d:"M2.975 8.002a.5.5 0 0 1 .547.449 4.5 4.5 0 0 0 8.956 0 .5.5 0 1 1 .995.098A5.502 5.502 0 0 1 8.5 13.478V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .448-.547z",clipRule:"evenodd"}),p.createElement("path",{d:"M5 3a3 3 0 1 1 6 0v5a3 3 0 0 1-6 0z"})),PP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...t},p.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),p.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"})),xP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...t},p.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),p.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),p.createElement("g",{opacity:.25},p.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),p.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),RP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...t},p.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),p.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),p.createElement("g",{opacity:.25},p.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),p.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),p.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),IP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...t},p.createElement("g",{opacity:.25},p.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}),p.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}))),ip=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...t},p.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h14.5A2.75 2.75 0 0 1 20 2.75v10.5A2.75 2.75 0 0 1 17.25 16H2.75A2.75 2.75 0 0 1 0 13.25V2.75ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v10.5c0 .69.56 1.25 1.25 1.25h14.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),p.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9.47 4.22a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1-1.06 1.06l-.97-.97v4.69a.75.75 0 0 1-1.5 0V6.56l-.97.97a.75.75 0 0 1-1.06-1.06l2.25-2.25Z",clipRule:"evenodd"})),DP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...t},p.createElement("g",{fill:"currentColor"},p.createElement("path",{d:"M7.28 4.22a.75.75 0 0 0-1.06 1.06L8.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L10 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L11.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L10 6.94z"}),p.createElement("path",{fillRule:"evenodd",d:"M2.75 0A2.75 2.75 0 0 0 0 2.75v10.5A2.75 2.75 0 0 0 2.75 16h14.5A2.75 2.75 0 0 0 20 13.25V2.75A2.75 2.75 0 0 0 17.25 0zM1.5 2.75c0-.69.56-1.25 1.25-1.25h14.5c.69 0 1.25.56 1.25 1.25v10.5c0 .69-.56 1.25-1.25 1.25H2.75c-.69 0-1.25-.56-1.25-1.25z",clipRule:"evenodd"}))),OP=t=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...t},p.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},p.createElement("path",{d:"M13.25 7H9m0 0V2.75M9 7l5.25-5.25M2.75 9H7m0 0v4.25M7 9l-5.25 5.25"}))),_P=p.forwardRef(function({trackRef:t,...e},n){const i=Kr(),{mergedProps:r,inFocus:s}=Qw({trackRef:t??i,props:e});return p.createElement(Aa.Consumer,null,o=>o!==void 0&&p.createElement("button",{ref:n,...r},e.children?e.children:s?p.createElement(OP,null):p.createElement(kP,null)))});function AP(t){return t!==void 0}function zt(...t){return lt(...t.filter(AP))}function NP(t,e,n){return p.Children.map(t,i=>p.isValidElement(i)&&p.Children.only(t)?(i.props.class&&(e??(e={}),e.class=tp(i.props.class,e.class),e.style={...i.props.style,...e.style}),p.cloneElement(i,{...e,key:n})):i)}const As=p.forwardRef(function({kind:t,initialSelection:e,onActiveDeviceChange:n,onDeviceListChange:i,onDeviceSelectError:r,exactMatch:s,track:o,requestPermissions:a,onError:c,...l},u){const d=Jr(),h=p.useCallback(k=>{d&&d.emit(I.MediaDevicesError,k),c==null||c(k)},[d,c]),{devices:f,activeDeviceId:g,setActiveMediaDevice:m,className:b}=tP({kind:t,room:d,track:o,requestPermissions:a,onError:h});p.useEffect(()=>{e!==void 0&&m(e)},[m]),p.useEffect(()=>{typeof i=="function"&&i(f)},[i,f]),p.useEffect(()=>{g&&g!==""&&(n==null||n(g))},[g]);const v=async k=>{try{await m(k,{exact:s})}catch(y){if(y instanceof Error)r==null||r(y);else throw y}},T=p.useMemo(()=>zt(l,{className:b},{className:"lk-list"}),[b,l]);function E(k,y,C){return k===y||C===0&&y==="default"}return p.createElement("ul",{ref:u,...T},f.map((k,y)=>p.createElement("li",{key:k.deviceId,id:k.deviceId,"data-lk-active":E(k.deviceId,g,y),"aria-selected":E(k.deviceId,g,y),role:"option"},p.createElement("button",{className:"lk-button",onClick:()=>v(k.deviceId)},k.label))))}),MP=p.forwardRef(function({label:t,...e},n){const i=Ua(),{mergedProps:r,canPlayAudio:s}=sP({room:i,props:e}),{mergedProps:o,canPlayVideo:a}=oP({room:i,props:r}),{style:c,...l}=o;return c.display=s&&a?"none":"block",p.createElement("button",{ref:n,style:c,...l},t??`Start ${s?"Video":"Audio"}`)});function rp(t,e){switch(t){case P.Source.Microphone:return e?p.createElement(wP,null):p.createElement(EP,null);case P.Source.Camera:return e?p.createElement(bP,null):p.createElement(vP,null);case P.Source.ScreenShare:return e?p.createElement(DP,null):p.createElement(ip,null);default:return}}function LP(t){switch(t){case Ue.Excellent:return p.createElement(PP,null);case Ue.Good:return p.createElement(xP,null);case Ue.Poor:return p.createElement(RP,null);default:return p.createElement(IP,null)}}const Ns=p.forwardRef(function({showIcon:t,...e},n){const{buttonProps:i,enabled:r}=uP(e);return p.createElement("button",{ref:n,...i},(t??!0)&&rp(e.source,r),e.children)}),UP=p.forwardRef(function(t,e){const{className:n,quality:i}=zw(t),r=p.useMemo(()=>({...zt(t,{className:n}),"data-lk-quality":i}),[i,t,n]);return p.createElement("div",{ref:e,...r},t.children??LP(i))}),Zl=p.forwardRef(function({participant:t,...e},n){const i=pi(t),{className:r,infoObserver:s}=p.useMemo(()=>yw(i),[i]),{identity:o,name:a}=Ve(s,{name:i.name,identity:i.identity,metadata:i.metadata}),c=p.useMemo(()=>zt(e,{className:r,"data-lk-participant-name":a}),[e,r,a]);return p.createElement("span",{ref:n,...c},a!==""?a:o,e.children)}),FP=p.forwardRef(function({trackRef:t,show:e="always",...n},i){const{className:r,isMuted:s}=lP(t),o=e==="always"||e==="muted"&&s||e==="unmuted"&&!s,a=p.useMemo(()=>zt(n,{className:r}),[r,n]);return o?p.createElement("div",{ref:i,...a,"data-lk-muted":s},n.children??rp(t.source,!s)):null}),BP=t=>p.createElement("svg",{width:320,height:320,viewBox:"0 0 320 320",preserveAspectRatio:"xMidYMid meet",fill:"none",xmlns:"http://www.w3.org/2000/svg",...t},p.createElement("path",{d:"M160 180C204.182 180 240 144.183 240 100C240 55.8172 204.182 20 160 20C115.817 20 79.9997 55.8172 79.9997 100C79.9997 144.183 115.817 180 160 180Z",fill:"white",fillOpacity:.25}),p.createElement("path",{d:"M97.6542 194.614C103.267 191.818 109.841 192.481 115.519 195.141C129.025 201.466 144.1 205 159.999 205C175.899 205 190.973 201.466 204.48 195.141C210.158 192.481 216.732 191.818 222.345 194.614C262.703 214.719 291.985 253.736 298.591 300.062C300.15 310.997 291.045 320 280 320H39.9997C28.954 320 19.8495 310.997 21.4087 300.062C28.014 253.736 57.2966 214.72 97.6542 194.614Z",fill:"white",fillOpacity:.25}));function sp(t,e={}){const[n,i]=p.useState(Ro(t)),[r,s]=p.useState(n==null?void 0:n.isMuted),[o,a]=p.useState(n==null?void 0:n.isSubscribed),[c,l]=p.useState(n==null?void 0:n.track),[u,d]=p.useState("landscape"),h=p.useRef(),{className:f,trackObserver:g}=p.useMemo(()=>nw(t),[t.participant.sid??t.participant.identity,t.source,we(t)&&t.publication.trackSid]);return p.useEffect(()=>{const m=g.subscribe(b=>{W.debug("update track",b),i(b),s(b==null?void 0:b.isMuted),a(b==null?void 0:b.isSubscribed),l(b==null?void 0:b.track)});return()=>m==null?void 0:m.unsubscribe()},[g]),p.useEffect(()=>{var m,b;return c&&(h.current&&c.detach(h.current),(m=e.element)!=null&&m.current&&!(Wf(t.participant)&&(c==null?void 0:c.kind)==="audio")&&c.attach(e.element.current)),h.current=(b=e.element)==null?void 0:b.current,()=>{h.current&&(c==null||c.detach(h.current))}},[c,e.element]),p.useEffect(()=>{var m,b;if(typeof((m=n==null?void 0:n.dimensions)==null?void 0:m.width)=="number"&&typeof((b=n==null?void 0:n.dimensions)==null?void 0:b.height)=="number"){const v=n.dimensions.width>n.dimensions.height?"landscape":"portrait";d(v)}},[n]),{publication:n,isMuted:r,isSubscribed:o,track:c,elementProps:zt(e.props,{className:f,"data-lk-local-participant":t.participant.isLocal,"data-lk-source":n==null?void 0:n.source,...(n==null?void 0:n.kind)==="video"&&{"data-lk-orientation":u}})}}var jP="Expected a function",eu=NaN,VP="[object Symbol]",$P=/^\s+|\s+$/g,GP=/^[-+]0x[0-9a-f]+$/i,WP=/^0b[01]+$/i,qP=/^0o[0-7]+$/i,HP=parseInt,zP=typeof Fn=="object"&&Fn&&Fn.Object===Object&&Fn,KP=typeof self=="object"&&self&&self.Object===Object&&self,JP=zP||KP||Function("return this")(),YP=Object.prototype,QP=YP.toString,XP=Math.max,ZP=Math.min,Ms=function(){return JP.Date.now()};function e1(t,e,n){var i,r,s,o,a,c,l=0,u=!1,d=!1,h=!0;if(typeof t!="function")throw new TypeError(jP);e=tu(e)||0,Io(n)&&(u=!!n.leading,d="maxWait"in n,s=d?XP(tu(n.maxWait)||0,e):s,h="trailing"in n?!!n.trailing:h);function f(C){var x=i,_=r;return i=r=void 0,l=C,o=t.apply(_,x),o}function g(C){return l=C,a=setTimeout(v,e),u?f(C):o}function m(C){var x=C-c,_=C-l,A=e-x;return d?ZP(A,s-_):A}function b(C){var x=C-c,_=C-l;return c===void 0||x>=e||x<0||d&&_>=s}function v(){var C=Ms();if(b(C))return T(C);a=setTimeout(v,m(C))}function T(C){return a=void 0,h&&i?f(C):(i=r=void 0,o)}function E(){a!==void 0&&clearTimeout(a),l=0,i=c=r=a=void 0}function k(){return a===void 0?o:T(Ms())}function y(){var C=Ms(),x=b(C);if(i=arguments,r=this,c=C,x){if(a===void 0)return g(c);if(d)return a=setTimeout(v,e),f(c)}return a===void 0&&(a=setTimeout(v,e)),o}return y.cancel=E,y.flush=k,y}function Io(t){var e=typeof t;return!!t&&(e=="object"||e=="function")}function t1(t){return!!t&&typeof t=="object"}function n1(t){return typeof t=="symbol"||t1(t)&&QP.call(t)==VP}function tu(t){if(typeof t=="number")return t;if(n1(t))return eu;if(Io(t)){var e=typeof t.valueOf=="function"?t.valueOf():t;t=Io(e)?e+"":e}if(typeof t!="string")return t===0?t:+t;t=t.replace($P,"");var n=WP.test(t);return n||qP.test(t)?HP(t.slice(2),n?2:8):GP.test(t)?eu:+t}var i1=e1;const nu=Sf(i1);function r1(t){const e=p.useRef(t);e.current=t,p.useEffect(()=>()=>{e.current()},[])}function s1(t,e=500,n){const i=p.useRef();r1(()=>{i.current&&i.current.cancel()});const r=p.useMemo(()=>{const s=nu(t,e,n),o=(...a)=>s(...a);return o.cancel=()=>{s.cancel()},o.isPending=()=>!!i.current,o.flush=()=>s.flush(),o},[t,e,n]);return p.useEffect(()=>{i.current=nu(t,e,n)},[t,e,n]),r}function o1(t,e,n){const i=(l,u)=>l===u,r=t instanceof Function?t():t,[s,o]=p.useState(r),a=p.useRef(r),c=s1(o,e,n);return i(a.current,r)||(c(r),a.current=r),[s,c]}function a1({threshold:t=0,root:e=null,rootMargin:n="0%",freezeOnceVisible:i=!1,initialIsIntersecting:r=!1,onChange:s}={}){var o;const[a,c]=p.useState(null),[l,u]=p.useState(()=>({isIntersecting:r,entry:void 0})),d=p.useRef();d.current=s;const h=((o=l.entry)==null?void 0:o.isIntersecting)&&i;p.useEffect(()=>{if(!a||!("IntersectionObserver"in window)||h)return;let m;const b=new IntersectionObserver(v=>{const T=Array.isArray(b.thresholds)?b.thresholds:[b.thresholds];v.forEach(E=>{const k=E.isIntersecting&&T.some(y=>E.intersectionRatio>=y);u({isIntersecting:k,entry:E}),d.current&&d.current(k,E),k&&i&&m&&(m(),m=void 0)})},{threshold:t,root:e,rootMargin:n});return b.observe(a),()=>{b.disconnect()}},[a,JSON.stringify(t),e,n,h,i]);const f=p.useRef(null);p.useEffect(()=>{var m;!a&&(m=l.entry)!=null&&m.target&&!i&&!h&&f.current!==l.entry.target&&(f.current=l.entry.target,u({isIntersecting:r,entry:void 0}))},[a,l.entry,i,h,r]);const g=[c,!!l.isIntersecting,l.entry];return g.ref=g[0],g.isIntersecting=g[1],g.entry=g[2],g}const c1=p.forwardRef(function({onTrackClick:t,onClick:e,onSubscriptionStatusChanged:n,trackRef:i,manageSubscription:r,...s},o){const a=Pn(i),c=p.useRef(null);p.useImperativeHandle(o,()=>c.current);const l=a1({root:c.current}),[u]=o1(l,3e3);p.useEffect(()=>{r&&a.publication instanceof oi&&(u==null?void 0:u.isIntersecting)===!1&&(l==null?void 0:l.isIntersecting)===!1&&a.publication.setSubscribed(!1)},[u,a,r]),p.useEffect(()=>{r&&a.publication instanceof oi&&(l==null?void 0:l.isIntersecting)===!0&&a.publication.setSubscribed(!0)},[l,a,r]);const{elementProps:d,publication:h,isSubscribed:f}=sp(a,{element:c,props:s});p.useEffect(()=>{n==null||n(!!f)},[f,n]);const g=m=>{e==null||e(m),t==null||t({participant:a==null?void 0:a.participant,track:h})};return p.createElement("video",{ref:c,...d,muted:!0,onClick:g})}),op=p.forwardRef(function({trackRef:t,onSubscriptionStatusChanged:e,volume:n,muted:i,...r},s){const o=Pn(t),a=p.useRef(null);p.useImperativeHandle(s,()=>a.current);const{elementProps:c,isSubscribed:l,track:u,publication:d}=sp(o,{element:a,props:r});return p.useEffect(()=>{e==null||e(!!l)},[l,e]),p.useEffect(()=>{u===void 0||n===void 0||(u instanceof on?u.setVolume(n):W.warn("Volume can only be set on remote audio tracks."))},[n,u]),p.useEffect(()=>{d===void 0||i===void 0||(d instanceof oi?d.setEnabled(!i):W.warn("Can only call setEnabled on remote track publications."))},[i,d,u]),p.createElement("audio",{ref:a,...c})});function l1(t){const e=!!Xf();return t.participant&&!e?p.createElement(Qf.Provider,{value:t.participant},t.children):p.createElement(p.Fragment,null,t.children)}function u1(t){const e=!!Kr();return t.trackRef&&!e?p.createElement(Ma.Provider,{value:t.trackRef},t.children):p.createElement(p.Fragment,null,t.children)}const d1=p.forwardRef(function({trackRef:t,children:e,onParticipantClick:n,disableSpeakingIndicator:i,...r},s){var o,a;const c=Pn(t),{elementProps:l}=rP({htmlProps:r,disableSpeakingIndicator:i,onParticipantClick:n,trackRef:c}),u=pP(c.participant),d=Na(),h=(o=Lw())==null?void 0:o.autoSubscription,f=p.useCallback(g=>{c.source&&!g&&d&&d.pin.dispatch&&Gf(c,d.pin.state)&&d.pin.dispatch({msg:"clear_pin"})},[c,d]);return p.createElement("div",{ref:s,style:{position:"relative"},...l},p.createElement(u1,{trackRef:c},p.createElement(l1,{participant:c.participant},e??p.createElement(p.Fragment,null,we(c)&&(((a=c.publication)==null?void 0:a.kind)==="video"||c.source===P.Source.Camera||c.source===P.Source.ScreenShare)?p.createElement(c1,{trackRef:c,onSubscriptionStatusChanged:f,manageSubscription:h}):we(c)&&p.createElement(op,{trackRef:c,onSubscriptionStatusChanged:f}),p.createElement("div",{className:"lk-participant-placeholder"},p.createElement(BP,null)),p.createElement("div",{className:"lk-participant-metadata"},p.createElement("div",{className:"lk-participant-metadata-item"},c.source===P.Source.Camera?p.createElement(p.Fragment,null,u&&p.createElement(TP,{style:{marginRight:"0.25rem"}}),p.createElement(FP,{trackRef:{participant:c.participant,source:P.Source.Microphone},show:"muted"}),p.createElement(Zl,null)):p.createElement(p.Fragment,null,p.createElement(ip,{style:{marginRight:"0.25rem"}}),p.createElement(Zl,null,"'s screen"))),p.createElement(UP,{className:"lk-participant-metadata-item"}))),p.createElement(_P,{trackRef:c}))))});function h1({tracks:t,...e}){return p.createElement(p.Fragment,null,t.map(n=>p.createElement(Ma.Provider,{value:n,key:ke(n)},NP(e.children))))}function f1({totalPageCount:t,nextPage:e,prevPage:n,currentPage:i,pagesContainer:r}){const[s,o]=p.useState(!1);return p.useEffect(()=>{let a;return r&&(a=xw(r.current,2e3).subscribe(o)),()=>{a&&a.unsubscribe()}},[r]),p.createElement("div",{className:"lk-pagination-control","data-lk-user-interaction":s},p.createElement("button",{className:"lk-button",onClick:n},p.createElement(Xl,null)),p.createElement("span",{className:"lk-pagination-count"},`${i} of ${t}`),p.createElement("button",{className:"lk-button",onClick:e},p.createElement(Xl,null)))}const p1=p.forwardRef(function({totalPageCount:t,currentPage:e},n){const i=new Array(t).fill("").map((r,s)=>s+1===e?p.createElement("span",{"data-lk-active":!0,key:s}):p.createElement("span",{key:s}));return p.createElement("div",{ref:n,className:"lk-pagination-indicator"},i)});function m1({tracks:t,...e}){const n=p.createRef(),i=p.useMemo(()=>zt(e,{className:"lk-grid-layout"}),[e]),{layout:r}=Xw(n,t.length),s=iP(r.maxTiles,t);return aP(n,{onLeftSwipe:s.nextPage,onRightSwipe:s.prevPage}),p.createElement("div",{ref:n,"data-lk-pagination":s.totalPageCount>1,...i},p.createElement(h1,{tracks:s.tracks},e.children),t.length>r.maxTiles&&p.createElement(p.Fragment,null,p.createElement(p1,{totalPageCount:s.totalPageCount,currentPage:s.currentPage}),p.createElement(f1,{pagesContainer:n,...s})))}function g1({volume:t,muted:e}){const n=np([P.Source.Microphone,P.Source.ScreenShareAudio,P.Source.Unknown],{updateOnlyOn:[],onlySubscribed:!0}).filter(i=>!Wf(i.participant)&&i.publication.kind===P.Kind.Audio);return p.createElement("div",{style:{display:"none"}},n.map(i=>p.createElement(op,{key:ke(i),trackRef:i,volume:t,muted:e})))}function iu({kind:t,initialSelection:e,onActiveDeviceChange:n,tracks:i,requestPermissions:r=!1,...s}){const[o,a]=p.useState(!1),[c,l]=p.useState([]),[u,d]=p.useState(!0),[h,f]=p.useState(r),g=(T,E)=>{W.debug("handle device change"),a(!1),n==null||n(T,E)},m=p.useRef(null),b=p.useRef(null);p.useLayoutEffect(()=>{o&&f(!0)},[o]),p.useLayoutEffect(()=>{m.current&&b.current&&(c||u)&&_E(m.current,b.current).then(({x:T,y:E})=>{b.current&&Object.assign(b.current.style,{left:`${T}px`,top:`${E}px`})}),d(!1)},[m,b,c,u]);const v=p.useCallback(T=>{b.current&&T.target!==m.current&&o&&AE(b.current,T)&&a(!1)},[o,b,m]);return p.useEffect(()=>(document.addEventListener("click",v),window.addEventListener("resize",()=>d(!0)),()=>{document.removeEventListener("click",v),window.removeEventListener("resize",()=>d(!0))}),[v,d]),p.createElement(p.Fragment,null,p.createElement("button",{className:"lk-button lk-button-menu","aria-pressed":o,...s,onClick:()=>a(!o),ref:m},s.children),!s.disabled&&p.createElement("div",{className:"lk-device-menu",ref:b,style:{visibility:o?"visible":"hidden"}},t?p.createElement(As,{initialSelection:e,onActiveDeviceChange:T=>g(t,T),onDeviceListChange:l,kind:t,track:i==null?void 0:i[t],requestPermissions:h}):p.createElement(p.Fragment,null,p.createElement("div",{className:"lk-device-menu-heading"},"Audio inputs"),p.createElement(As,{kind:"audioinput",onActiveDeviceChange:T=>g("audioinput",T),onDeviceListChange:l,track:i==null?void 0:i.audioinput,requestPermissions:h}),p.createElement("div",{className:"lk-device-menu-heading"},"Video inputs"),p.createElement(As,{kind:"videoinput",onActiveDeviceChange:T=>g("videoinput",T),onDeviceListChange:l,track:i==null?void 0:i.videoinput,requestPermissions:h}))))}function v1({props:t}){const{dispatch:e,state:n}=Yf().widget,i="lk-button lk-settings-toggle";return{mergedProps:p.useMemo(()=>lt(t,{className:i,onClick:()=>{e&&e({msg:"toggle_settings"})},"aria-pressed":n!=null&&n.showSettings?"true":"false"}),[t,i,e,n])}}const b1=p.forwardRef(function(t,e){const{mergedProps:n}=v1({props:t});return p.createElement("button",{ref:e,...n},t.children)});function y1({variation:t,controls:e,saveUserChoices:n=!0,onDeviceError:i,...r}){var s;const[o,a]=p.useState(!1),c=Na();p.useEffect(()=>{var A,N;((A=c==null?void 0:c.widget.state)==null?void 0:A.showChat)!==void 0&&a((N=c==null?void 0:c.widget.state)==null?void 0:N.showChat)},[(s=c==null?void 0:c.widget.state)==null?void 0:s.showChat]);const l=Hw(`(max-width: ${o?1e3:760}px)`)?"minimal":"verbose";t??(t=l);const u={leave:!0,...e},d=eP();d?(u.camera??(u.camera=d.canPublish),u.microphone??(u.microphone=d.canPublish),u.screenShare??(u.screenShare=d.canPublish),u.chat??(u.chat=d.canPublishData&&(e==null?void 0:e.chat))):(u.camera=!1,u.chat=!1,u.microphone=!1,u.screenShare=!1);const h=p.useMemo(()=>t==="minimal"||t==="verbose",[t]),f=p.useMemo(()=>t==="textOnly"||t==="verbose",[t]),g=BE(),[m,b]=p.useState(!1),v=p.useCallback(A=>{b(A)},[b]),T=zt({className:"lk-control-bar"},r),{saveAudioInputEnabled:E,saveVideoInputEnabled:k,saveAudioInputDeviceId:y,saveVideoInputDeviceId:C}=fP({preventSave:!n}),x=p.useCallback((A,N)=>N?E(A):null,[E]),_=p.useCallback((A,N)=>N?k(A):null,[k]);return p.createElement("div",{...T},u.microphone&&p.createElement("div",{className:"lk-button-group"},p.createElement(Ns,{source:P.Source.Microphone,showIcon:h,onChange:x,onDeviceError:A=>i==null?void 0:i({source:P.Source.Microphone,error:A})},f&&"Microphone"),p.createElement("div",{className:"lk-button-group-menu"},p.createElement(iu,{kind:"audioinput",onActiveDeviceChange:(A,N)=>y(N??"")}))),u.camera&&p.createElement("div",{className:"lk-button-group"},p.createElement(Ns,{source:P.Source.Camera,showIcon:h,onChange:_,onDeviceError:A=>i==null?void 0:i({source:P.Source.Camera,error:A})},f&&"Camera"),p.createElement("div",{className:"lk-button-group-menu"},p.createElement(iu,{kind:"videoinput",onActiveDeviceChange:(A,N)=>C(N??"")}))),u.screenShare&&g&&p.createElement(Ns,{source:P.Source.ScreenShare,captureOptions:{audio:!0,selfBrowserSurface:"include"},showIcon:h,onChange:v,onDeviceError:A=>i==null?void 0:i({source:P.Source.ScreenShare,error:A})},f&&(m?"Stop screen share":"Share screen")),u.chat&&p.createElement(mP,null,h&&p.createElement(yP,null),f&&"Chat"),u.settings&&p.createElement(b1,null,h&&p.createElement(SP,null),f&&"Settings"),u.leave&&p.createElement(gP,null,h&&p.createElement(CP,null),f&&"Leave"),p.createElement(MP,null))}function k1({token:t,url:e,onTokenChange:n,onUrlChange:i}){return console.log("token",t),console.log("url",e),w.jsx("div",{children:w.jsxs(jw,{className:"mt-3",video:!0,audio:!0,token:t,serverUrl:e,"data-lk-theme":"default",connect:!0,style:{height:"40vh"},onConnected:()=>{console.log("Connected to the room")},onDisconnected:()=>{n(null),i(null),console.log("Disconnected from the room")},children:[w.jsx(S1,{}),w.jsx(g1,{}),w.jsx(y1,{})]})})}function S1(){const t=np([{source:P.Source.Camera,withPlaceholder:!0},{source:P.Source.ScreenShare,withPlaceholder:!1}],{onlySubscribed:!1});return w.jsx(m1,{tracks:t,style:{height:"calc(100vh - var(--lk-control-bar-height))"},children:w.jsx(d1,{})})}const C1=({question:t,duration:e,testAttemptId:n,onAnswerChange:i})=>{const[r,{isLoading:s,error:o}]=dp(),[a,c]=p.useState(null),[l,u]=p.useState(null),d=f=>{c(f)},h=f=>{u(f)};return console.log("token",a),console.log("url",l),w.jsxs("div",{className:"space-y-4",children:[w.jsxs("div",{className:"font-medium",children:["Topic: ",t.questionText]}),e&&w.jsxs("div",{className:"text-sm text-gray-600",children:["Time Limit: ",e," minutes"]}),w.jsx("button",{onClick:async()=>{const f=await r({question:t.questionText,duration:e,testAttemptId:n});i(null),console.log("response",f),f.data&&(c(f.data.token),u(f.data.url))},disabled:s,children:"Start"}),a&&l&&w.jsx(k1,{token:a,url:l,onTokenChange:d,onUrlChange:h}),s&&w.jsx(hp,{}),o&&w.jsxs("div",{children:["Error: ",o.message]})]})},ru=({question:t,onAnswerChange:e,currentAnswer:n,index:i,duration:r,testAttemptId:s})=>{if(!t)return w.jsxs("div",{className:"border rounded-lg p-4 mb-4 dark:border-gray-800 dark:bg-gray-900 transition-colors",children:[w.jsxs("h3",{className:"font-medium mb-2 dark:text-gray-200",children:["Question ",i+1,":"]}),w.jsx("div",{children:"Failed to load question or the question is not available"})]});const o=()=>{switch(t.type){case"open_ended":return w.jsx(C1,{question:t,duration:r,testAttemptId:s,onAnswerChange:e,currentAnswer:n});case"multiple_choice":return w.jsx(wp,{question:t,onAnswerChange:e,currentAnswer:n});case"single_choice":return w.jsx(Pp,{question:t,onAnswerChange:e,currentAnswer:n});case"true_false":return w.jsx(xp,{question:t,onAnswerChange:e,currentAnswer:n});case"fill_in_the_blank":return w.jsx(Rp,{question:t,onAnswerChange:e,currentAnswer:n});case"matching":return w.jsx(P0,{question:t,onAnswerChange:e,currentAnswer:n});case"ordering":return w.jsx(E0,{question:t,onAnswerChange:e,currentAnswer:n});case"essay":return w.jsx(w0,{question:t,onAnswerChange:e,currentAnswer:n});default:return w.jsxs("div",{children:["Unsupported question type: ",t.type]})}};return w.jsxs("div",{className:"border rounded-lg p-4 mb-4 dark:border-gray-800 dark:bg-gray-900 transition-colors",children:[w.jsxs("h3",{className:"font-medium mb-2 dark:text-gray-200",children:["Question ",i+1,":"]}),o()]})},T1=({duration:t,startTime:e,onTimeUp:n})=>{const[i,r]=p.useState(s());function s(){const a=new Date(e),u=new Date(a.getTime()+t*6e4)-new Date;return u<=0?{hours:0,minutes:0,seconds:0}:{hours:Math.floor(u/(1e3*60*60)),minutes:Math.floor(u/1e3/60%60),seconds:Math.floor(u/1e3%60)}}p.useEffect(()=>{const a=setInterval(()=>{const c=s();r(c),c.hours===0&&c.minutes===0&&c.seconds===0&&(clearInterval(a),n())},1e3);return()=>clearInterval(a)},[e,t]);const o=a=>String(a).padStart(2,"0");return w.jsx("div",{className:"fixed top-[65px] right-4 bg-white rounded-lg shadow p-3",children:w.jsxs("div",{className:"text-center",children:[w.jsx("div",{className:"text-sm font-medium text-gray-500 mb-1",children:"Time Left"}),w.jsxs("div",{className:"text-2xl font-bold",children:[o(i.hours),":",o(i.minutes),":",o(i.seconds)]})]})})},I1=()=>{const{testAttemptId:t}=fp(),e=pp(),n=su(),i=mp(gp),[r,{isLoading:s,error:o}]=vp(),{data:a,isLoading:c,error:l,refetch:u}=bp(t,{refetchOnMountOrArgChange:!0}),{test:d,testAttempt:h}=a||{};console.log("savedAttempt",h);const[f,{isLoading:g}]=yp();p.useEffect(()=>{var y,C;l&&(n(Ei()),Nt.error(((y=l.data)==null?void 0:y.errors)||"Failed to load test attempt"),console.log("attemptError",l)),o&&Nt.error(((C=o.data)==null?void 0:C.errors)||"Failed to complete test")},[l,e,o]);const m=async()=>{var y;try{await r(h._id).unwrap(),n(Ei()),Nt.success("Test completed successfully"),e("/tests")}catch(C){Nt.error(((y=C.data)==null?void 0:y.message)||"Failed to complete test")}};p.useEffect(()=>{h!=null&&h.answers&&!c&&h.answers.forEach(({question:y,userAnswer:C})=>{y&&C!==void 0&&n($a({questionId:y,answer:C}))})},[h,c,n]);const b=p.useCallback((y,C)=>{y&&C!==void 0&&n($a({questionId:y,answer:C}))},[n]),v=p.useCallback(y=>{const C=i.find(x=>x.question===y&&x.answer!==void 0);return C==null?void 0:C.answer},[i]),T=p.useCallback(async()=>{if(i.length>0)try{await f({testAttemptId:h._id,answers:i}).unwrap()}catch{Nt.error("Failed to save answers")}},[i,h==null?void 0:h._id,f]);p.useEffect(()=>{const y=setTimeout(T,15e3);return()=>clearTimeout(y)},[T]),p.useEffect(()=>{const y=C=>{Object.keys(i).length>0&&(C.preventDefault(),C.returnValue="")};return window.addEventListener("beforeunload",y),()=>window.removeEventListener("beforeunload",y)},[i]);const E=async()=>{var y;try{if(!window.confirm("Are you sure you want to submit the test? This action cannot be undone."))return;await f({testAttemptId:h._id,answers:i}).unwrap(),await r(h._id).unwrap(),n(Ei()),Nt.success("Test completed successfully"),e("/tests")}catch(C){Nt.error(((y=C.data)==null?void 0:y.message)||"Failed to complete test")}};p.useEffect(()=>{const y=()=>{document.visibilityState==="visible"&&(d==null?void 0:d.status)==="in-progress"&&u()};return document.addEventListener("visibilitychange",y),()=>{document.removeEventListener("visibilitychange",y)}},[u,d==null?void 0:d.status]);const k=y=>[...y].sort((C,x)=>C.name==="speaking"?1:x.name==="speaking"?-1:0);return c||!a?w.jsx("div",{children:"Loading..."}):!d||!h?w.jsx("div",{children:"Test not found or not properly initialized"}):w.jsxs("div",{className:"container mx-auto p-4",children:[w.jsx(Cp,{title:d.title,description:d.description}),w.jsx(T1,{duration:d.duration,startTime:h.startTime,onTimeUp:m}),w.jsx("div",{className:"flex justify-end mb-4",children:g||s?w.jsx("div",{className:"w-8 h-8",children:w.jsx(kp,{})}):w.jsx("button",{onClick:E,className:"bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline",children:"Submit Test"})}),w.jsxs("div",{className:"lg:grid lg:grid-cols-12 gap-4",children:[w.jsx("div",{className:"lg:col-span-3 mb-4 lg:mb-0",children:w.jsx("div",{className:"sticky top-20 max-h-[calc(100vh-6rem)] overflow-y-auto",children:w.jsx(Tp,{sections:d.sections||[]})})}),w.jsx("div",{className:"lg:col-span-9",children:k(d.sections||[]).map((y,C)=>{var x,_;return w.jsxs("div",{id:`section-${y._id}`,className:"scroll-mt-24",children:[w.jsxs("h2",{className:"text-xl font-semibold mb-4 dark:text-gray-200",children:[y.name.charAt(0).toUpperCase()+y.name.slice(1)," ","Section"]}),w.jsx("p",{className:"mb-4",children:y.instruction}),(y.name==="reading"||y.name==="listening")&&((x=y.passages)==null?void 0:x.map((A,N)=>{var M,B,K;return w.jsxs("div",{children:[w.jsx(Ep,{passage:A._id,index:N}),(B=(M=A._id)==null?void 0:M.questions)==null?void 0:B.map((Q,ie)=>{var Ne;return w.jsx(ru,{question:Q,onAnswerChange:Ge=>b(Q._id,Ge),currentAnswer:v(Q._id),index:ie},((Ne=Q._id)==null?void 0:Ne._id)||Q._id||ie)})]},((K=A._id)==null?void 0:K._id)||A._id||N)})),!y.passages&&((_=y.questions)==null?void 0:_.map((A,N)=>{var M,B;return w.jsx(ru,{question:A._id,onAnswerChange:K=>{var Q;return b(((Q=A._id)==null?void 0:Q._id)||A._id,K)},currentAnswer:v(((M=A._id)==null?void 0:M._id)||A._id),index:N,duration:y.duration,testAttemptId:h._id},((B=A._id)==null?void 0:B._id)||A._id||N)}))]},y._id)})})]}),g&&w.jsx("div",{className:"text-sm text-gray-500",children:"Saving..."})]})};export{I1 as default};
